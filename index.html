<!DOCTYPE html>
<html lang="zh-CN" data-theme="pink">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>TSUKIMI OS // ä¸»é¡µ</title>
    <script src="cordova.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="background.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="cordova.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet" />
    <style>
      :root {
        --font-pixel: 'DotGothic16', sans-serif;
        --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      }

      /* === ğŸŒ¸ Pink Theme === */
      [data-theme='pink'] {
        --bg-color: #fff5f8;
        --bg-pattern: radial-gradient(#ffd1dc 15%, transparent 16%) 0 0;
        --panel-bg: #fff;
        --text-main: #6d597a;
        --text-sub: #b5838d;
        --border-color: #ffc8dd;
        --shadow-color: #ffafcc;
        --accent-color: #ffafcc;
        --card-bg: #fff0f5;
        --btn-hover: #ffe5ec;
        /* [æ–°å¢] æŒ‰é’®é¢œè‰²å˜é‡ */
        --btn-save-bg: #cdb4db; /* ç¡®å®š/ä¿å­˜æŒ‰é’® */
        --btn-new-bg: #bde0fe; /* å–æ¶ˆ/æ™®é€šæŒ‰é’® */
        --modal-overlay: rgba(255, 245, 248, 0.8);
        --btn-del-bg: #ffafcc; /* [æ–°å¢] åˆ é™¤æŒ‰é’®é¢œè‰² */
      }

      /* === â˜ï¸ Blue Theme === */
      [data-theme='blue'] {
        --bg-color: #f0f8ff;
        --bg-pattern: linear-gradient(rgba(162, 210, 255, 0.4) 1px, transparent 1px),
          linear-gradient(90deg, rgba(162, 210, 255, 0.4) 1px, transparent 1px);
        --panel-bg: #fdfffd;
        --text-main: #546a7b;
        --text-sub: #98c1d9;
        --border-color: #a2d2ff;
        --shadow-color: #bde0fe;
        --accent-color: #bde0fe;
        --card-bg: #f0f8ff;
        --btn-hover: #e0fbfc;
        /* [æ–°å¢] æŒ‰é’®é¢œè‰²å˜é‡ */
        --btn-save-bg: #b7e4c7;
        --btn-new-bg: #ffcdb2;
        --modal-overlay: rgba(240, 248, 255, 0.8);
        --btn-del-bg: #ffafcc; /* [æ–°å¢] åˆ é™¤æŒ‰é’®é¢œè‰² */
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: var(--font-pixel);
        background-color: var(--bg-color);
        background-image: var(--bg-pattern);
        background-size: 20px 20px;
        color: var(--text-main);
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow-x: hidden;
        user-select: none;
        transition: background 0.3s;
      }

      /* === é¡¶éƒ¨çŠ¶æ€æ  === */
      .status-bar {
        width: 100%;
        max-width: 600px;
        height: 50px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
        font-size: 1.2rem;
        font-weight: bold;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(5px);
        border-bottom: 2px dashed var(--border-color);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .clock {
        letter-spacing: 2px;
      }

      .theme-toggle {
        cursor: pointer;
        font-size: 1.2rem;
        transition: transform 0.2s;
      }
      .theme-toggle:active {
        transform: rotate(15deg) scale(0.9);
      }

      /* === ä¸»å®¹å™¨ === */
      .container {
        width: 100%;
        max-width: 600px;
        padding: 20px 20px 7px 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        animation: floatIn 0.5s ease-out;
      }

      @keyframes floatIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* === å°ç»„ä»¶åŒºåŸŸ === */
      .widget-row {
        display: flex;
        gap: 15px;
        height: 160px;
      }

      /* æ‹ç«‹å¾—ç›¸æ¡†ç»„ä»¶ */
      .widget-polaroid {
        flex: 1;
        background: #fff;
        border: 2px solid var(--border-color);
        padding: 10px 10px 10px 10px;
        box-shadow: 4px 4px 0 var(--shadow-color);
        transform: rotate(-2deg);
        transition: transform 0.3s;
        cursor: pointer;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        /* â˜…â˜…â˜… é‡ç‚¹ä¿®æ”¹ï¼šè¿™é‡Œåƒä¸‡ä¸èƒ½æœ‰ overflow: hiddenï¼Œå¦åˆ™èƒ¶å¸¦ä¼šè¢«åˆ‡æ‰ â˜…â˜…â˜… */
        overflow: visible;
      }
      .widget-polaroid:hover {
        transform: rotate(0deg) scale(1.02);
        z-index: 10;
      }
      .polaroid-img {
        width: 100%;
        height: 100%;
        background: var(--bg-color);
        object-fit: cover;
        border: 1px solid #eee;
      }
      .polaroid-placeholder {
        position: absolute;
        color: var(--text-sub);
        font-size: 0.8rem;
        text-align: center;
        pointer-events: none;
      }
      /* ä¿®æ”¹èƒ¶å¸¦ï¼šå®šä½åˆ°é¡¶éƒ¨è´Ÿè·ç¦»ï¼Œå±‚çº§è°ƒé«˜ */
      .polaroid-tape {
        position: absolute;
        top: -12px; /* è®©å®ƒå¾€ä¸Šè·‘ï¼Œè¶…å‡ºç›¸æ¡†è¾¹ç•Œ */
        left: 50%;
        transform: translateX(-50%) rotate(-1deg); /* ç¨å¾®æ­ªä¸€ç‚¹æ›´çœŸå® */
        width: 90px; /* ç¨å¾®åŠ å®½ä¸€ç‚¹ */
        height: 24px;
        background: var(--border-color); /* åŠé€æ˜ç™½ */
        border: 1px solid rgba(0, 0, 0, 0.1); /* æ·¡æ·¡çš„è¾¹æ¡† */

        backdrop-filter: blur(2px); /* ç£¨ç ‚è´¨æ„Ÿ */
        z-index: 20; /* å…³é”®ï¼šå±‚çº§è¦æ¯”å›¾ç‰‡é«˜ */
        box-shadow: 0 3px 0 rgba(0, 0, 0, 0.1);

        transition: transform 0.1s;
        border: 2px solid #fff;
      }

      /* ä¾¿ç­¾ç»„ä»¶ */
      .widget-memo {
        flex: 1;
        background: var(--panel-bg);
        border: 2px solid var(--border-color);
        border-radius: 15px;
        box-shadow: 4px 4px 0 var(--shadow-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .memo-header {
        background: var(--border-color);
        color: #fff;
        padding: 5px 10px;
        font-size: 0.8rem;
        font-weight: bold;
      }
      .memo-content {
        flex: 1;
        border: none;
        resize: none;
        padding: 10px;
        font-family: var(--font-pixel);
        font-size: 0.9rem;
        color: var(--text-main);
        background: transparent;
        outline: none;
        line-height: 1.4;
      }

      /* === æ¬¢è¿è¯­ === */
      .welcome-banner {
        background: var(--panel-bg);
        border: 2px dashed var(--border-color);
        border-radius: 20px;
        padding: 15px;
        text-align: center;
        color: var(--text-sub);
        font-size: 0.9rem;
      }

      /* === APP å›¾æ ‡ç½‘æ ¼ === */
      .app-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* ä¸¤åˆ—å¸ƒå±€ */
        gap: 15px;
      }

      /* å æ®æ•´è¡Œçš„ APP (Chat) */
      .app-item.full-width {
        grid-column: span 2;
        background: linear-gradient(135deg, var(--panel-bg) 0%, var(--card-bg) 100%);
      }

      .app-item {
        background: var(--panel-bg);
        border: 2px solid var(--border-color);
        border-radius: 18px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;
        text-decoration: none;
        color: var(--text-main);
        box-shadow: 4px 4px 0 var(--shadow-color);
        transition: all 0.1s;
        position: relative;
        overflow: hidden;
      }

      .app-item:active {
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0 var(--shadow-color);
      }

      .app-icon {
        font-size: 2.5rem;
        background: var(--bg-color);
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--border-color);
      }

      .app-name {
        font-weight: bold;
        font-size: 1rem;
      }

      .app-desc {
        font-size: 0.7rem;
        color: var(--text-sub);
        opacity: 0.8;
      }

      /* === åº•éƒ¨ === */
      .footer-sign {
        text-align: center;
        color: var(--text-sub);
        font-size: 0.77rem;
        margin-top: 0px;
        opacity: 0.9;
        padding-bottom: 0px;
      }

      /* éšè—æ–‡ä»¶ä¸Šä¼  */
      #cover-upload {
        display: none;
      }
      /* === è®¾ç½®å¼¹çª—æ ·å¼ === */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(4px);
        z-index: 2000;
        display: none;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.2s ease;
      }
      .modal-box {
        background: var(--panel-bg);
        border: 2px solid var(--border-color);
        box-shadow: 6px 6px 0 var(--shadow-color);
        padding: 20px;
        width: 85%;
        max-width: 320px;
        border-radius: 15px;
        text-align: center;
        transform: scale(0.95);
        animation: popUp 0.2s forwards;
      }
      .modal-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--text-main);
        margin-bottom: 15px;
        border-bottom: 2px dashed var(--border-color);
        padding-bottom: 10px;
      }
      .setting-btn {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        background: var(--btn-hover); /* ä½¿ç”¨ä¸»é¢˜å®šä¹‰çš„é¢œè‰² */
        border: 2px solid var(--border-color);
        color: var(--text-main);
        font-family: var(--font-pixel);
        font-size: 1rem;
        cursor: pointer;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: transform 0.1s;
        box-shadow: 0 3px 0 rgba(0, 0, 0, 0.1);
        transition: transform 0.1s;
        border: 2px solid #fff;
      }
      .setting-btn:active {
        transform: scale(0.98);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes popUp {
        from {
          transform: scale(0.9);
        }
        to {
          transform: scale(1);
        }
      }
      /* === [æ–°å¢] é€šç”¨å¼¹çª—æŒ‰é’®æ ·å¼ === */
      .modal-content {
        margin-bottom: 20px;
        line-height: 1.5;
        color: var(--text-sub);
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .pixel-btn {
        flex: 1;
        padding: 10px 12px;
        border: 2px solid #fff; /* åƒç´ é£åŒå±‚è¾¹æ¡† */
        border-radius: 10px;
        font-family: var(--font-pixel);
        font-size: 0.9rem;
        cursor: pointer;
        color: #fff;
        box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
        transition: transform 0.1s;
      }

      .pixel-btn:active {
        transform: translateY(3px);
        box-shadow: none;
      }

      .btn-confirm {
        background-color: var(--btn-save-bg);
      }
      .btn-cancel {
        background-color: var(--btn-new-bg);
        color: #555;
      }
      /* === [æ–°å¢] æ–‡ä»¶å¤¹ç»„ä»¶æ ·å¼ === */
      .app-folder-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 4px;
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 12px;
        padding: 8px;
        box-sizing: border-box;
      }
      .folder-mini-icon {
        width: 100%;
        height: 100%;
        background: var(--text-sub);
        border-radius: 4px;
        opacity: 0.6;
      }
      /* æ–‡ä»¶å¤¹å±•å¼€åçš„ç½‘æ ¼ */
      .folder-modal-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        padding: 10px;
      }
      .folder-app-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        cursor: pointer;
      }
      .folder-app-icon {
        width: 50px;
        height: 50px;
        background: var(--btn-new-bg);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
      }
      .folder-app-name {
        font-size: 0.7rem;
        color: var(--text-main);
      }
      /* === ğŸ”‹ åƒç´ ç”µé‡ç»„ä»¶æ ·å¼ === */
      .battery-widget {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-left: 5px; /* ä¸å·¦è¾¹å›¾æ ‡çš„é—´è· */
        font-family: var(--font-pixel);
        cursor: default;
      }

      /* ç”µé‡ç™¾åˆ†æ¯”æ–‡å­— */
      .battery-text {
        font-size: 0.9rem;
        font-weight: bold;
        color: var(--text-main);
        min-width: 32px; /* é˜²æ­¢æ•°å­—è·³åŠ¨å¯¼è‡´å¸ƒå±€æŠ–åŠ¨ */
        text-align: right;
      }

      /* ç”µæ± å¤–å£³ */
      .battery-shell {
        width: 32px;
        height: 16px;
        border: 2px solid var(--text-main);
        padding: 2px;
        position: relative;
        display: flex;
        align-items: center;
        /* åƒç´ é£ç”µæ± å¤´ */
        margin-right: 4px; /* ç»™ç”µæ± å¤´ç•™ä½ç½® */
      }

      /* ç”µæ± æ­£æå¤´ (ç”¨ä¼ªå…ƒç´ ç”») */
      .battery-shell::after {
        content: '';
        position: absolute;
        right: -5px;
        top: 50%;
        transform: translateY(-50%);
        width: 3px;
        height: 8px;
        background: var(--text-main);
        border-top-right-radius: 2px;
        border-bottom-right-radius: 2px;
      }

      /* å†…éƒ¨ç”µé‡æ¡ */
      .battery-level {
        height: 100%;
        width: 0%; /* JSæ§åˆ¶ */
        background: var(--text-sub); /* é»˜è®¤è·Ÿéšä¸»é¢˜è‰² */
        transition: width 0.5s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.3s;
        position: relative;
        overflow: hidden;
      }

      /* === âš¡ å……ç”µç‰¹æ•ˆ === */
      /* å……ç”µæ—¶çš„æ–œçº¹åŠ¨ç”» */
      .battery-shell.charging .battery-level {
        background-image: linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.5) 25%,
          transparent 25%,
          transparent 50%,
          rgba(255, 255, 255, 0.5) 50%,
          rgba(255, 255, 255, 0.5) 75%,
          transparent 75%,
          transparent
        );
        background-size: 10px 10px;
        animation: chargeFlow 1s linear infinite;
        background-color: var(--btn-save-bg) !important; /* å……ç”µæ—¶å˜ç»¿/ä¸»é¢˜äº®è‰² */
      }

      /* å……ç”µé—ªç”µå›¾æ ‡ */
      .bolt-icon {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        color: #fff;
        font-size: 12px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 10;
        pointer-events: none;
      }
      .battery-shell.charging .bolt-icon {
        display: block;
        animation: pulseBolt 0.8s infinite alternate;
      }

      /* === âš ï¸ ä½ç”µé‡æ ·å¼ === */
      .battery-level.low {
        background-color: #ff6b6b !important; /* å¼ºåˆ¶çº¢è‰² */
      }
      .battery-text.low {
        color: #ff6b6b;
        animation: blinkText 1s infinite;
      }

      /* åŠ¨ç”»å®šä¹‰ */
      @keyframes chargeFlow {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: 20px 0;
        }
      }
      @keyframes pulseBolt {
        0% {
          transform: translate(-50%, -50%) scale(0.8);
          opacity: 0.8;
        }
        100% {
          transform: translate(-50%, -50%) scale(1.2);
          opacity: 1;
        }
      }
      @keyframes blinkText {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body>
    <nav class="status-bar">
      <div class="clock" id="clock" style="font-size: 1.1rem">00:00</div>
      <div style="font-size: 1.1rem; color: var(--text-sub)">TSUKIMI OS</div>
      <div style="display: flex; gap: 9px">
        <div class="theme-toggle" onclick="toggleSettingsModal()">âš™ï¸</div>
        <div class="theme-toggle" onclick="toggleTheme()">ğŸ¨</div>

        <div class="battery-widget">
          <span class="battery-text" id="bat-text">--%</span>
          <div class="battery-shell" id="bat-shell">
            <div class="battery-level" id="bat-level"></div>
            <div class="bolt-icon">âš¡</div>
          </div>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="welcome-banner" id="welcome-text">(ï½¡ï½¥Ï‰ï½¥ï½¡)ï¾‰â™¡ Welcome Back!</div>

      <div class="widget-row">
        <div class="widget-polaroid" onclick="document.getElementById('cover-upload').click()">
          <div class="polaroid-tape"></div>
          <img id="polaroid-img" class="polaroid-img" src="" style="display: none" />
          <div class="polaroid-placeholder" id="polaroid-ph">
            <div style="font-size: 2rem">ğŸ“·</div>
            <div>TAP TO ADD</div>
          </div>
        </div>

        <div class="widget-memo">
          <div class="memo-header">MEMO PAD</div>
          <textarea id="memo-text" class="memo-content" placeholder="å†™ç‚¹ä»€ä¹ˆå§...(â—â€²Ë˜â€µâ—)"></textarea>
        </div>
      </div>

      <div class="app-grid">
        <a href="Chat.html" class="app-item full-width">
          <div style="display: flex; align-items: center; gap: 15px; width: 100%">
            <div class="app-icon">ğŸ’¬</div>
            <div style="flex: 1; text-align: left">
              <div class="app-name">PIXEL CHAT</div>
              <div class="app-desc">å®æ—¶é€šè®¯ / å‰§æƒ…æ¨¡æ‹Ÿ / æ²‰æµ¸å¼å¯¹è¯</div>
            </div>
            <div style="font-size: 1.5rem; color: var(--border-color)">â¤</div>
          </div>
        </a>

        <a href="Roleplay Cards.html" class="app-item">
          <div class="app-icon">ğŸ“‡</div>
          <div class="app-name">CARDS</div>
          <div class="app-desc">è§’è‰²æ¡£æ¡ˆç®¡ç†</div>
        </a>

        <a href="API Config.html" class="app-item">
          <div class="app-icon">âš™ï¸</div>
          <div class="app-name">CONFIG</div>
          <div class="app-desc">ç³»ç»Ÿè¿æ¥é…ç½®</div>
        </a>
        <a href="BackgroundSettings.html" class="app-item">
          <div class="app-icon">ğŸ“¡</div>
          <div class="app-name">BG CHAT</div>
          <div class="app-desc">åå°æ¶ˆæ¯è®¾å®š</div>
        </a>

        <div class="app-item" onclick="openAppFolder()">
          <div class="app-folder-grid">
            <div class="folder-mini-icon" style="background: #ffcfd2"></div>
            <div class="folder-mini-icon"></div>
            <div class="folder-mini-icon"></div>
            <div class="folder-mini-icon"></div>
          </div>
          <div class="app-name">TOOLS</div>
          <div class="app-desc">ç³»ç»Ÿå·¥å…·ç®±</div>
        </div>

        <div id="folder-modal" class="modal-overlay" onclick="closeAppFolder(event)">
          <div class="modal-box" style="width: 90%; max-width: 350px">
            <div class="modal-title">ğŸ“‚ TOOLS</div>

            <div class="folder-modal-grid">
              <div class="folder-app-item" onclick="window.location.href='BatteryConfig.html'">
                <div class="folder-app-icon" style="background: #ffcfd2">âš¡</div>
                <span class="folder-app-name">Battery</span>
              </div>

              <div class="folder-app-item" onclick="window.location.href='PromptConfig.html'">
                <div class="folder-app-icon" style="background: #fff9c4; border-color: #ffe082">ğŸ“</div>
                <span class="folder-app-name">Prompts</span>
              </div>

              <div class="folder-app-item" onclick="window.location.href='discover.html'">
                <div class="folder-app-icon" style="opacity: 1">ğŸ§</div>
                <span class="folder-app-name">Discover</span>
              </div>

              <div class="folder-app-item" onclick="showPixelAlert('å¼€å‘ä¸­...å’•å’•å’•', 'PENDING')">
                <div class="folder-app-icon" style="opacity: 0.5">ğŸš§</div>
                <span class="folder-app-name">Pending</span>
              </div>

              <div class="folder-app-item" onclick="window.location.href='BackgroundSettings.html'">
                <div class="folder-app-icon">ğŸ“¡</div>
                <span class="folder-app-name">BG Chat</span>
              </div>
            </div>

            <button class="setting-btn" style="margin-top: 15px; background: #eee" onclick="closeAppFolder(null, true)">
              <span>âœ•</span> å…³é—­
            </button>
          </div>
        </div>
      </div>

      <div class="footer-sign">
        Â© 2025 DESIGN BY æœˆè¦‹tsukimi<br />
        All Systems Operational.
      </div>
    </div>

    <input type="file" id="cover-upload" accept="image/*" onchange="handleCoverUpload(this)" />

    <div id="settings-modal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-title">SYSTEM SETTINGS</div>

        <button class="setting-btn" onclick="exportAllData()"><span>ğŸ“¦</span> å¤‡ä»½å…¨éƒ¨æ•°æ® (ZIP)</button>

        <button class="setting-btn" onclick="document.getElementById('zip-import').click()">
          <span>ğŸ“¥</span> æ¢å¤æ•°æ® (ZIP)
        </button>

        <button class="setting-btn" style="background: var(--btn-del-bg); color: #fff" onclick="clearAllData()">
          <span>ğŸ—‘ï¸</span> æ¸…ç©ºå…¨éƒ¨æ•°æ® (Reset)
        </button>

        <button class="setting-btn" style="margin-top: 10px; background: #eee" onclick="toggleSettingsModal()">
          <span>âœ•</span> å…³é—­
        </button>
      </div>
    </div>

    <input type="file" id="zip-import" accept=".zip" style="display: none" onchange="importAllData(this)" />

    <div id="pixel-modal-generic" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-title" id="gen-modal-title">System Hint</div>
        <div class="modal-content" id="gen-modal-message"></div>
        <div class="modal-actions" id="gen-modal-actions"></div>
      </div>
    </div>
    <script>
      // ================= [æ–°å¢] è‡ªå®šä¹‰å¼¹çª—é€»è¾‘ =================

      // 1. é€šç”¨å¼¹çª—æ˜¾ç¤ºæ ¸å¿ƒ
      function showModalCore(message, title, type = 'alert') {
        return new Promise(resolve => {
          const modal = document.getElementById('pixel-modal-generic');
          const titleEl = document.getElementById('gen-modal-title');
          const msgEl = document.getElementById('gen-modal-message');
          const actionsEl = document.getElementById('gen-modal-actions');

          titleEl.innerText = title;
          msgEl.innerText = message; // æ”¯æŒç®€å•æ–‡æœ¬ï¼Œå¦‚æœéœ€è¦æ¢è¡Œå¯ç”¨ innerHTML
          actionsEl.innerHTML = ''; // æ¸…ç©ºæ—§æŒ‰é’®

          // å®šä¹‰å…³é—­å‡½æ•°
          const close = () => {
            modal.style.display = 'none';
          };

          if (type === 'confirm') {
            // === Confirm æ¨¡å¼ (å–æ¶ˆ + ç¡®å®š) ===
            const btnCancel = document.createElement('button');
            btnCancel.className = 'pixel-btn btn-cancel';
            btnCancel.innerText = 'å–æ¶ˆ / Cancel';
            btnCancel.onclick = () => {
              close();
              resolve(false);
            };

            const btnConfirm = document.createElement('button');
            btnConfirm.className = 'pixel-btn btn-confirm';
            btnConfirm.innerText = 'ç¡®å®š / Confirm';
            btnConfirm.onclick = () => {
              close();
              resolve(true);
            };

            actionsEl.appendChild(btnCancel);
            actionsEl.appendChild(btnConfirm);
          } else {
            // === Alert æ¨¡å¼ (ä»…ç¡®å®š) ===
            const btnOk = document.createElement('button');
            btnOk.className = 'pixel-btn btn-confirm';
            btnOk.innerText = 'çŸ¥é“äº† / OK';
            btnOk.onclick = () => {
              close();
              resolve(true);
            };

            actionsEl.appendChild(btnOk);
          }

          // æ˜¾ç¤ºå¼¹çª— (ä½¿ç”¨ flex å¸ƒå±€)
          modal.style.display = 'flex';
        });
      }

      // 2. å¿«æ·è°ƒç”¨å°è£…
      async function showPixelAlert(message, title = 'System Hint') {
        await showModalCore(message, title, 'alert');
      }

      async function showPixelConfirm(message, title = 'System Warning') {
        return await showModalCore(message, title, 'confirm');
      }
      // ================= 1. æ—¶é’Ÿé€»è¾‘ =================
      function updateClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('clock').innerText = `${hours}:${minutes}`;
      }
      setInterval(updateClock, 1000);
      updateClock();

      // ================= 2. ä¸»é¢˜åˆ‡æ¢é€»è¾‘ =================
      // ================= ğŸ¨ å…¨å±€ä¸»é¢˜ç®¡ç† (è¯·å¤åˆ¶åˆ°æ‰€æœ‰ 4 ä¸ªæ–‡ä»¶çš„ script ä¸­) =================

      // 1. åˆå§‹åŒ–ä¸»é¢˜ (æ‰“å¼€é¡µé¢æ—¶ç«‹å³æ‰§è¡Œ)
      function initTheme() {
        // å°è¯•è¯»å–æœ¬åœ°å­˜å‚¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º 'pink'
        const savedTheme = localStorage.getItem('momo_theme') || 'pink';
        document.documentElement.setAttribute('data-theme', savedTheme);
      }

      // 2. åˆ‡æ¢ä¸»é¢˜ (ç‚¹å‡»æŒ‰é’®æ—¶æ‰§è¡Œ)
      function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute('data-theme');
        // å¦‚æœæ˜¯ pink å°±åˆ‡ blueï¼Œå¦åˆ™åˆ‡ pink
        const next = current === 'pink' ? 'blue' : 'pink';

        // åº”ç”¨å¹¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        html.setAttribute('data-theme', next);
        localStorage.setItem('momo_theme', next);

        // â˜… ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ä¸»é¡µ(index.html)ï¼Œè¿˜éœ€è¦æ›´æ–°æ¬¢è¿è¯­
        if (typeof updateWelcomeText === 'function') {
          updateWelcomeText(next);
        }
      }

      // â˜… 3. ç«‹å³è¿è¡Œåˆå§‹åŒ–
      initTheme();

      // ================= 3. å°ç»„ä»¶é€»è¾‘ =================

      // A. ä¾¿ç­¾è‡ªåŠ¨ä¿å­˜
      const memoArea = document.getElementById('memo-text');
      memoArea.value = localStorage.getItem('momo_home_memo') || '';
      memoArea.addEventListener('input', () => {
        localStorage.setItem('momo_home_memo', memoArea.value);
      });

      // B. æ‹ç«‹å¾—ç…§ç‰‡é€»è¾‘
      const imgEl = document.getElementById('polaroid-img');
      const phEl = document.getElementById('polaroid-ph');

      // åŠ è½½ä¿å­˜çš„ç…§ç‰‡
      const savedCover = localStorage.getItem('momo_home_cover');
      if (savedCover) {
        imgEl.src = savedCover;
        imgEl.style.display = 'block';
        phEl.style.display = 'none';
      }

      function handleCoverUpload(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const base64 = e.target.result;
            // å‹ç¼©/ä¿å­˜å›¾ç‰‡åˆ° localStorage
            localStorage.setItem('momo_home_cover', base64);
            imgEl.src = base64;
            imgEl.style.display = 'block';
            phEl.style.display = 'none';
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // C. éšæœºæ¬¢è¿è¯­
      const kaomojis = [
        '(ï½¡ï½¥Ï‰ï½¥ï½¡)ï¾‰â™¡ Welcome Back!',
        'â™ª(Â´â–½ï½€) ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒé¸­',
        '(oï¾Ÿvï¾Ÿ)ãƒ ç³»ç»Ÿè¿è¡Œæ­£å¸¸',
        'â˜…_â˜… åˆæ˜¯å……æ»¡å¸Œæœ›çš„ä¸€å¤©',
        '(*/Ï‰ï¼¼*) éšæ—¶å‡†å¤‡å¾…å‘½',
      ];

      function updateWelcomeText(theme) {
        const el = document.getElementById('welcome-text');
        // éšæœºå–ä¸€ä¸ª
        const text = kaomojis[Math.floor(Math.random() * kaomojis.length)];
        el.innerText = text;
      }
      updateWelcomeText(); // Init

      // ================= 4. ç³»ç»Ÿè®¾ç½®ä¸å¤‡ä»½é€»è¾‘ =================

      // åˆ‡æ¢å¼¹çª—æ˜¾ç¤º
      function toggleSettingsModal() {
        const el = document.getElementById('settings-modal');
        el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
      }

      // --- æ ¸å¿ƒï¼šå¯¼å‡ºå…¨éƒ¨æ•°æ® ---
      async function exportAllData() {
        const btn = document.querySelector('.setting-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'â³ æ‰“åŒ…ä¸­...';

        try {
          const zip = new JSZip();

          // 1. å¤‡ä»½ LocalStorage (APIé…ç½®ã€ä¸»é¡µä¾¿ç­¾ã€ä¸»é¢˜ç­‰)
          const lsData = {};
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            lsData[key] = localStorage.getItem(key);
          }
          zip.file('local_storage_backup.json', JSON.stringify(lsData, null, 2));

          // 2. å¤‡ä»½ IndexedDB (Chat & Cards æ•°æ®)
          // è¿æ¥æ•°æ®åº“ (å¿…é¡»ä¸ Chat.html å®šä¹‰çš„ä¸€è‡´)
          const dbName = 'PixelChatDB';
          if (await Dexie.exists(dbName)) {
            const db = new Dexie(dbName);
            await db.open();

            const dbFolder = zip.folder('indexed_db');

            // éå†æ‰€æœ‰è¡¨ (history, images, stickers, characters)
            for (const table of db.tables) {
              let rows = await table.toArray();

              // â˜… å…³é”®å¤„ç†ï¼šå°† Blob å¯¹è±¡è½¬æ¢ä¸º Base64 å­—ç¬¦ä¸²
              // å› ä¸º JSON ä¸æ”¯æŒ Blobï¼Œç›´æ¥å­˜ä¼šå˜æˆç©ºå¯¹è±¡
              if (table.name === 'images' || table.name === 'stickers') {
                for (let row of rows) {
                  if (row.blob && row.blob instanceof Blob) {
                    row.blob_base64 = await blobToBase64(row.blob);
                    delete row.blob; // ç§»é™¤åŸå§‹ Blob å¯¹è±¡
                  }
                }
              }

              dbFolder.file(`${table.name}.json`, JSON.stringify(rows));
            }
          }

          // === ğŸ‘‡ ä¿®æ”¹è¿™é‡Œ ğŸ‘‡ ===

          // 3. ç”Ÿæˆ ZIP äºŒè¿›åˆ¶æµ
          const content = await zip.generateAsync({ type: 'blob' });
          const dateStr = new Date().toISOString().slice(0, 10);
          const fileName = `TsukimiOS_Backup_${dateStr}.zip`;

          // [ä¿®æ”¹] ä½¿ç”¨ smartSave æ›¿ä»£ saveAs æˆ– navigator.share
          // smartSave ä¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯ APP è¿˜æ˜¯ ç½‘é¡µ
          smartSave(content, fileName);

          // æ³¨æ„ï¼šsmartSave å†…éƒ¨æœ‰å¼‚æ­¥æç¤ºï¼Œè¿™é‡Œä¸éœ€è¦å†å¼¹ Alert äº†
          // é™¤éåœ¨ç½‘é¡µç«¯ smartSave æ²¡å¼¹æç¤ºï¼Œå¯ä»¥ä¿ç•™ä¸‹é¢çš„
          // await showPixelAlert(...)
        } catch (e) {
          console.error(e);
          await showPixelAlert('å¤‡ä»½å¤±è´¥: ' + e.message, 'System Error');
        } finally {
          btn.innerHTML = originalText;
        }
      }

      // --- æ ¸å¿ƒï¼šå¯¼å…¥æ¢å¤æ•°æ® ---
      async function importAllData(input) {
        if (!input.files[0]) return;
        const file = input.files[0];

        // [ä¿®æ”¹] æ›¿æ¢ confirm ä¸ºè‡ªå®šä¹‰ showPixelConfirm
        const isConfirmed = await showPixelConfirm(
          'âš ï¸ è­¦å‘Šï¼šå¯¼å…¥æ•°æ®å°†ã€è¦†ç›–ã€‘å½“å‰æ‰€æœ‰èŠå¤©è®°å½•ã€è§’è‰²å¡å’Œè®¾ç½®ã€‚\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
          'DANGER ZONE',
        );

        if (!isConfirmed) {
          input.value = ''; // æ¸…ç©ºé€‰æ‹©
          return;
        }

        try {
          const zip = await JSZip.loadAsync(file);

          // 1. æ¢å¤ LocalStorage
          const lsFile = zip.file('local_storage_backup.json');
          if (lsFile) {
            const lsStr = await lsFile.async('string');
            const lsData = JSON.parse(lsStr);
            localStorage.clear(); // æ¸…ç©ºæ—§çš„
            for (const key in lsData) {
              localStorage.setItem(key, lsData[key]);
            }
          }

          // 2. æ¢å¤ IndexedDB
          const dbName = 'PixelChatDB';
          const db = new Dexie(dbName);

          // å£°æ˜æ•°æ®åº“ç»“æ„ (å¿…é¡»ä¸ Chat.html å®Œå…¨ä¸€è‡´)
          db.version(2).stores({
            history: '++id, charId, role, content, type, timestamp',
            images: '++id, blob',
            stickers: '++id, blob, timestamp',
            characters: 'id, name, avatar, user_avatar',
          });

          await db.open();

          // æ¸…ç©ºç°æœ‰æ•°æ®åº“
          await db.transaction('rw', db.tables, async () => {
            for (const table of db.tables) {
              await table.clear();
            }
          });

          // å†™å…¥æ–°æ•°æ®
          const dbFolder = zip.folder('indexed_db');
          if (dbFolder) {
            const files = [];
            dbFolder.forEach((relativePath, file) => files.push(file));

            for (const jsonFile of files) {
              const tableName = jsonFile.name.replace('.json', '').split('/').pop();
              const jsonStr = await jsonFile.async('string');
              const rows = JSON.parse(jsonStr);

              // â˜… å…³é”®å¤„ç†ï¼šå°† Base64 è½¬å› Blob
              if (tableName === 'images' || tableName === 'stickers') {
                for (let row of rows) {
                  if (row.blob_base64) {
                    row.blob = await base64ToBlob(row.blob_base64);
                    delete row.blob_base64;
                  }
                }
              }

              if (db[tableName]) {
                await db[tableName].bulkAdd(rows);
              }
            }
          }

          // [ä¿®æ”¹] æ›¿æ¢ alert
          await showPixelAlert('ğŸ‰ æ•°æ®æ¢å¤æˆåŠŸè€¶(â—â€²Ë˜â€µâ—) é¡µé¢å³å°†åˆ·æ–°', 'Restore Complete');
          location.reload();
        } catch (e) {
          console.error(e);
          // [ä¿®æ”¹] æ›¿æ¢ alert
          await showPixelAlert('æ¢å¤å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²æŸå: ' + e.message, 'Restore Failed');
        }
        input.value = '';
      }

      // --- [æ–°å¢] æ¸…ç©ºå…¨éƒ¨æ•°æ® ---
      async function clearAllData() {
        // 1. ä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—è¿›è¡Œè­¦å‘Š
        const isConfirmed = await showPixelConfirm(
          'âš ï¸ å±é™©æ“ä½œï¼š\nè¿™å°†åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•ã€è§’è‰²å¡ã€è®¾ç½®å’Œå›¾ç‰‡å“¦\næ•°æ®ä¸€æ—¦æ¸…ç©ºæ— æ³•æ¢å¤qaq\n\nç¡®å®šè¦é‡ç½®ç³»ç»Ÿå—ï¼Ÿ',
          'FACTORY RESET',
        );

        if (!isConfirmed) return; // ç”¨æˆ·ç‚¹å–æ¶ˆåˆ™åœæ­¢

        try {
          // 2. æ¸…ç©º LocalStorage (è®¾ç½®ã€ä¾¿ç­¾ã€ä¸»é¢˜ç­‰)
          localStorage.clear();

          // 3. åˆ é™¤ IndexedDB æ•°æ®åº“ (èŠå¤©è®°å½•ã€å›¾ç‰‡ç­‰)
          const dbName = 'PixelChatDB';
          // Dexie æä¾›äº†ç›´æ¥åˆ é™¤æ•°æ®åº“çš„æ–¹æ³•
          await Dexie.delete(dbName);

          // 4. æç¤ºæˆåŠŸå¹¶åˆ·æ–°
          await showPixelAlert('ç³»ç»Ÿå·²é‡ç½®ä¸ºåˆå§‹çŠ¶æ€ (ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)', 'System Reset');
          location.reload(); // åˆ·æ–°é¡µé¢ä»¥é‡æ–°åˆå§‹åŒ–
        } catch (e) {
          console.error(e);
          await showPixelAlert('é‡ç½®å¤±è´¥: ' + e.message, 'Error');
        }
      }

      // --- è¾…åŠ©å·¥å…·ï¼šBlob <-> Base64 ---
      function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      async function base64ToBlob(base64) {
        const res = await fetch(base64);
        return await res.blob();
      }
      // ================= [æ–°å¢] æ™ºèƒ½ä¿å­˜é€»è¾‘ (é€‚é…å®‰å“APP) =================

      /**
       * æ™ºèƒ½ä¿å­˜ï¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯ ç½‘é¡µç«¯ä¸‹è½½ è¿˜æ˜¯ æ‰‹æœºç«¯å†™å…¥
       */
      function smartSave(blob, filename) {
        // æ£€æµ‹æ˜¯å¦å­˜åœ¨ Cordova æ–‡ä»¶æ’ä»¶
        if (window.cordova && cordova.file) {
          saveToMobile(blob, filename);
        } else {
          // ç½‘é¡µç«¯é™çº§å¤„ç†
          saveAs(blob, filename);
          // å¦‚æœä½ æœ‰è‡ªå®šä¹‰æç¤º showPixelAlertï¼Œå¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨
          if (typeof showPixelAlert === 'function') {
            showPixelAlert('æ–‡ä»¶å·²æ¨é€åˆ°æµè§ˆå™¨ä¸‹è½½ (ï½¡ï½¥Ï‰ï½¥ï½¡)', 'Download Started');
          }
        }
      }

      /**
       * æ‰‹æœºç«¯ä¸“ç”¨ï¼šå†™å…¥åˆ° Download ç›®å½• (åˆ†å—å†™å…¥é˜²æ­¢å´©æºƒ)
       */
      function saveToMobile(blob, filename) {
        // æç¤ºå¼€å§‹
        if (typeof showPixelAlert === 'function') {
          showPixelAlert('â³ æ­£åœ¨ä¿å­˜åˆ°æ‰‹æœº Download ç›®å½•...\nè¯·ç¨å€™ï¼Œå®Œæˆåä¼šæœ‰æç¤º (ï½¡ï½¥Ï‰ï½¥ï½¡)', 'Saving...');
        }

        // è·å–å­˜å‚¨è·¯å¾„ (å®‰å“é€šå¸¸æ˜¯ externalRootDirectory)
        const storageLocation = cordova.file.externalRootDirectory || cordova.file.externalDataDirectory;

        window.resolveLocalFileSystemURL(
          storageLocation,
          function (dirEntry) {
            // è¿›å…¥ Download æ–‡ä»¶å¤¹
            dirEntry.getDirectory(
              'Download',
              { create: true, exclusive: false },
              function (downDir) {
                // åˆ›å»º/è¦†ç›–æ–‡ä»¶
                downDir.getFile(
                  filename,
                  { create: true, exclusive: false },
                  function (fileEntry) {
                    fileEntry.createWriter(function (fileWriter) {
                      const CHUNK_SIZE = 1024 * 1024; // æ¯æ¬¡å†™å…¥ 1MB
                      let offset = 0;

                      // 1. å®šä¹‰å†™å…¥ç»“æŸçš„å›è°ƒ
                      fileWriter.onwriteend = function () {
                        offset += CHUNK_SIZE;
                        if (offset < blob.size) {
                          // æ²¡å†™å®Œï¼Œç§»åŠ¨æŒ‡é’ˆç»§ç»­å†™ä¸‹ä¸€å—
                          fileWriter.seek(fileWriter.length);
                          writeNextChunk();
                        } else {
                          // å…¨éƒ¨å†™å®Œ
                          if (typeof showPixelAlert === 'function') {
                            showPixelAlert(
                              `âœ… ä¿å­˜æˆåŠŸï¼\næ–‡ä»¶å·²å­˜å…¥ï¼šå†…éƒ¨å­˜å‚¨/Download/${filename}`,
                              'Export Success',
                            );
                          } else {
                            alert(`âœ… ä¿å­˜æˆåŠŸï¼šDownload/${filename}`);
                          }
                        }
                      };

                      // 2. é”™è¯¯å¤„ç†
                      fileWriter.onerror = function (e) {
                        if (typeof showPixelAlert === 'function') {
                          showPixelAlert('âŒ å†™å…¥å¤±è´¥ï¼š' + e.toString(), 'Write Error');
                        }
                      };

                      // 3. å†™å…¥å—çš„å‡½æ•°
                      function writeNextChunk() {
                        const slice = blob.slice(offset, offset + CHUNK_SIZE);
                        fileWriter.write(slice);
                      }

                      // 4. å¯åŠ¨é€»è¾‘ï¼šå…ˆæ¸…ç©ºæ–‡ä»¶ï¼Œå†å¼€å§‹å†™
                      // é‡å†™ onwriteend ä»¥ä¾¿åœ¨ truncate å®Œæˆåè§¦å‘ç¬¬ä¸€æ¬¡å†™å…¥
                      fileWriter.onwriteend = function () {
                        // æ¢å¤æ­£å¸¸çš„å¾ªç¯å†™å…¥å›è°ƒ
                        fileWriter.onwriteend = function () {
                          offset += CHUNK_SIZE;
                          if (offset < blob.size) {
                            fileWriter.seek(fileWriter.length);
                            writeNextChunk();
                          } else {
                            if (typeof showPixelAlert === 'function') {
                              showPixelAlert(
                                `âœ… ä¿å­˜æˆåŠŸï¼\næ–‡ä»¶å·²å­˜å…¥ï¼šå†…éƒ¨å­˜å‚¨/Download/${filename}`,
                                'Export Success',
                              );
                            }
                          }
                        };
                        // å¼€å§‹å†™ç¬¬ä¸€å—
                        writeNextChunk();
                      };

                      // æ‰§è¡Œæ¸…ç©º
                      fileWriter.truncate(0);
                    });
                  },
                  function (err) {
                    console.error(err);
                    if (typeof showPixelAlert === 'function') showPixelAlert('âŒ åˆ›å»ºæ–‡ä»¶å¤±è´¥', 'Error');
                  },
                );
              },
              function (err) {
                console.error(err);
                if (typeof showPixelAlert === 'function') showPixelAlert('âŒ æ‰¾ä¸åˆ° Download ç›®å½•', 'Error');
              },
            );
          },
          function (err) {
            console.error(err);
            if (typeof showPixelAlert === 'function') showPixelAlert('âŒ æ— æ³•è®¿é—®å­˜å‚¨æƒé™', 'Permission Error');
          },
        );
      }
      // === æ–‡ä»¶å¤¹é€»è¾‘ ===
      function openAppFolder() {
        document.getElementById('folder-modal').style.display = 'flex';
      }

      function closeAppFolder(event, force = false) {
        // ç‚¹å‡»é®ç½©å±‚æˆ–å…³é—­æŒ‰é’®æ—¶å…³é—­
        if (force || event.target.id === 'folder-modal') {
          document.getElementById('folder-modal').style.display = 'none';
        }
      }
      // ================= [æ–°å¢] åƒç´ ç”µé‡æ¡é€»è¾‘ =================
      (function initBatteryWidget() {
        const batText = document.getElementById('bat-text');
        const batLevel = document.getElementById('bat-level');
        const batShell = document.getElementById('bat-shell');

        function updateBatteryUI(battery) {
          const level = Math.round(battery.level * 100);
          const isCharging = battery.charging;

          // 1. æ›´æ–°æ–‡å­—
          batText.innerText = level + '%';

          // 2. æ›´æ–°é•¿åº¦
          batLevel.style.width = level + '%';

          // 3. å¤„ç†å……ç”µçŠ¶æ€ (æ·»åŠ åŠ¨ç”»ç±»)
          if (isCharging) {
            batShell.classList.add('charging');
            batText.classList.remove('low');
            batLevel.classList.remove('low');
          } else {
            batShell.classList.remove('charging');

            // 4. å¤„ç†ä½ç”µé‡ (çº¢è‰²è­¦æŠ¥)
            if (level <= 20) {
              batLevel.classList.add('low');
              batText.classList.add('low');
            } else {
              batLevel.classList.remove('low');
              batText.classList.remove('low');
            }
          }
        }

        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        if ('getBattery' in navigator) {
          navigator.getBattery().then(function (battery) {
            // åˆå§‹åŒ–
            updateBatteryUI(battery);

            // ç›‘å¬å˜åŒ–
            battery.addEventListener('levelchange', () => updateBatteryUI(battery));
            battery.addEventListener('chargingchange', () => updateBatteryUI(battery));
          });
        } else {
          // ä¸æ”¯æŒçš„æƒ…å†µæ˜¾ç¤ºæ»¡ç”µå‡è±¡æˆ–éšè—
          batText.innerText = '100%';
          batLevel.style.width = '100%';
        }
      })();
    </script>
  </body>
</html>
