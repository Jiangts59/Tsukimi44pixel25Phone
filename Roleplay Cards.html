<!DOCTYPE html>
<html lang="zh-CN" data-theme="pink">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>CHARA_CARD // è§’è‰²ç»ˆç«¯</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet" />
    <style>
      :root {
        --font-pixel: 'DotGothic16', sans-serif;
        --transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      /* === ğŸŒ¸ ä¸»é¢˜ï¼šæ¨±èŠ±é©¬å¡é¾™ (Pink) === */
      [data-theme='pink'] {
        --bg-color: #fff5f8;
        --bg-pattern: radial-gradient(#ffd1dc 15%, transparent 16%) 0 0;
        --panel-bg: #fff;
        --text-main: #6d597a;
        --text-sub: #b5838d;
        --border-color: #ffc8dd;
        --shadow-color: #ffafcc;
        --primary: #ffc8dd;
        --btn-save-bg: #cdb4db;
        --btn-new-bg: #bde0fe;
        --btn-del-bg: #ffafcc;
        --btn-import-bg: #ffdfd3;
        --input-bg: #fffbfb;
        --modal-overlay: rgba(255, 245, 248, 0.9);
      }

      /* === â˜ï¸ ä¸»é¢˜ï¼šè–„è·æµ·ç› (Blue) === */
      [data-theme='blue'] {
        --bg-color: #f0f8ff;
        --bg-pattern: radial-gradient(#a2d2ff 15%, transparent 16%) 0 0;
        --panel-bg: #fdfffd;
        --text-main: #546a7b;
        --text-sub: #98c1d9;
        --border-color: #a2d2ff;
        --shadow-color: #bde0fe;
        --primary: #a2d2ff;
        --btn-save-bg: #b7e4c7;
        --btn-new-bg: #ffcdb2;
        --btn-del-bg: #ffb4a2;
        --btn-import-bg: #e2f0cb;
        --input-bg: #f9fcff;
        --modal-overlay: rgba(240, 248, 255, 0.9);
      }

      body {
        font-family: var(--font-pixel);
        background-color: var(--bg-color);
        background-image: var(--bg-pattern);
        background-size: 20px 20px;
        color: var(--text-main);
        margin: 0;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        transition: background 0.5s;
        font-size: 14px;
      }

      /* === é€šç”¨ç»„ä»¶ === */
      .header-sign {
        width: 100%;
        text-align: center;
        color: var(--text-sub);
        font-size: 0.8rem;
        letter-spacing: 2px;
        opacity: 0.8;
        margin: 5px 0 10px 0;
        text-shadow: 1px 1px 0 #fff;
      }
      .top-bar {
        width: 100%;
        max-width: 900px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        background: var(--panel-bg);
        border: 2px solid var(--border-color);
        border-radius: 10px;
        padding: 8px 15px;
        box-shadow: 0 4px 0 var(--shadow-color);
        box-sizing: border-box;
      }
      .app-title h1 {
        margin: 0;
        font-size: 1.2rem;
      }
      .app-title span {
        color: var(--btn-save-bg);
      }
      .theme-toggle-btn {
        background: var(--btn-new-bg);
        border: 1px solid var(--text-main);
        border-radius: 15px;
        padding: 4px 10px;
        font-size: 0.8rem;
        font-family: var(--font-pixel);
        cursor: pointer;
        color: var(--text-main);
        box-shadow: 1px 1px 0 rgba(0, 0, 0, 0.1);
      }
      .main-container {
        width: 100%;
        max-width: 900px;
        position: relative;
      }

      /* === æŒ‰é’® === */
      .pixel-btn {
        padding: 8px 12px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        font-family: var(--font-pixel);
        font-size: 0.85rem;
        cursor: pointer;
        color: #fff;
        box-shadow: 0 3px 0 rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.1s;
        border: 2px solid #fff;
      }
      .pixel-btn:active {
        transform: translateY(3px);
        box-shadow: none;
      }
      .btn-new {
        background-color: var(--btn-new-bg);
        color: #555;
      }
      .btn-save {
        background-color: var(--btn-save-bg);
      }
      .btn-del {
        background-color: var(--btn-del-bg);
      }
      .btn-import {
        background-color: var(--btn-import-bg);
        color: #555;
      }
      .btn-back {
        background-color: #eee;
        color: #666;
        width: auto;
        display: inline-flex;
        border: 2px solid #fff;
      }
      /* å°æŒ‰é’®å˜ä½“ */
      .btn-mini {
        padding: 2px 6px;
        font-size: 0.5rem;
        min-width: 24px;
      }

      /* === åˆ—è¡¨è§†å›¾ === */
      #view-list {
        display: block;
        animation: floatIn 0.3s ease-out;
      }
      .char-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      .char-card-item {
        background: var(--panel-bg);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 4px 0 var(--shadow-color);
        position: relative;
        overflow: hidden;
      }
      .char-card-item:hover {
        transform: translateY(-3px);
      }
      .char-avatar-small {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--border-color);
        background: var(--bg-color);
        margin-bottom: 5px;
      }
      .char-name {
        font-size: 0.9rem;
        font-weight: bold;
        color: var(--text-main);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* === ç¼–è¾‘è§†å›¾ === */
      #view-edit {
        display: none;
        animation: floatIn 0.3s ease-out;
      }
      .edit-panel {
        background: var(--panel-bg);
        border: 2px solid var(--border-color);
        border-radius: 15px;
        padding: 15px;
        box-shadow: 0 5px 0 var(--shadow-color);
      }
      .edit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 2px dashed var(--border-color);
        padding-bottom: 10px;
      }

      /* è¡¨å•å…ƒç´  */
      .pixel-form-group {
        margin-bottom: 12px;
      }
      .pixel-label {
        display: block;
        margin-bottom: 4px;
        color: var(--text-main);
        font-size: 0.85rem;
        font-weight: bold;
      }
      .pixel-input,
      .pixel-textarea {
        width: 100%;
        padding: 8px 10px;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-main);
        font-family: var(--font-pixel);
        font-size: 0.9rem;
        box-sizing: border-box;
        box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.03);
      }
      .pixel-textarea {
        min-height: 100px;
        resize: vertical;
        line-height: 1.4;
      }
      .pixel-input:focus,
      .pixel-textarea:focus {
        outline: none;
        border-color: var(--text-sub);
      }

      /* å¤´åƒä¸Šä¼ åŒº */
      .avatar-upload-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        background: var(--bg-color);
        padding: 15px;
        border-radius: 12px;
        border: 2px dashed var(--border-color);
      }
      .avatar-preview-big {
        width: 100px;
        height: 100px;
        border-radius: 15px;
        object-fit: cover;
        border: 2px solid var(--border-color);
        background: #fff;
      }

      /* ä¸–ç•Œä¹¦åˆ—è¡¨ */
      .wb-section {
        margin-top: 20px;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.5);
      }
      .wb-header {
        font-size: 0.95rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: var(--text-sub);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .wb-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .wb-item {
        background: var(--panel-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 8px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        font-size: 0.85rem;
        position: relative;
      }
      .wb-row-main {
        display: flex;
        gap: 8px;
        align-items: flex-start;
        justify-content: space-between;
      }
      .wb-row-tools {
        display: flex;
        gap: 5px;
        justify-content: flex-end;
        margin-top: 5px;
        border-top: 1px dashed var(--border-color);
        padding-top: 5px;
      }
      .wb-prio-badge {
        background: var(--btn-import-bg);
        color: #666;
        padding: 2px 6px;
        border-radius: 7px;
        font-size: 0.75rem;
        cursor: pointer;
        box-shadow: 0 3px 0 rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.1s;
        border: 2px solid #fff;
      }

      /* ç”¨æˆ·ç»‘å®šæ¨¡å— (æ–°) */
      .user-bind-section {
        margin-top: 20px;
        border: 2px dashed var(--text-sub);
        border-radius: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.3);
      }
      .user-bind-title {
        font-size: 0.9rem;
        font-weight: bold;
        color: var(--text-sub);
        margin-bottom: 10px;
        text-align: center;
        border-bottom: 1px dotted var(--text-sub);
        padding-bottom: 5px;
      }

      /* éšè—çš„æ–‡ä»¶è¾“å…¥ */
      #file_import,
      #avatar_upload {
        display: none;
      }

      @keyframes floatIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* === å¼¹çª—æ ·å¼ === */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--modal-overlay);
        backdrop-filter: blur(2px);
        z-index: 999;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
      }
      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      .modal-box {
        background: var(--panel-bg);
        border: 3px solid var(--border-color);
        border-radius: 15px;
        padding: 20px;
        width: 85%;
        max-width: 320px;
        box-shadow: 0 8px 0 var(--shadow-color);
        transform: scale(0.9);
        transition: transform 0.3s;
        text-align: center;
      }
      .modal-overlay.show .modal-box {
        transform: scale(1);
      }
      .modal-title {
        font-size: 1.1rem;
        margin-bottom: 10px;
        color: var(--text-main);
        border-bottom: 2px dashed var(--border-color);
        padding-bottom: 5px;
      }
      .modal-content {
        font-size: 0.95rem;
        color: var(--text-sub);
        margin-bottom: 20px;
        line-height: 1.5;
      }
      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      /* å¼¹çª—å†…çš„ Textarea ä¿®æ­£ */
      #prompt-textarea {
        width: 100%;
        padding: 8px 10px;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-main);
        font-family: var(--font-pixel);
        font-size: 0.9rem;
        box-sizing: border-box;
        min-height: 490px;
        resize: vertical;
        display: none; /* é»˜è®¤éšè—ï¼Œç”±JSåˆ‡æ¢ */
        text-align: left;
      }
      .footer-sign {
        width: 100%;
        text-align: center;
        color: var(--text-sub);
        font-size: 0.8rem;
        letter-spacing: 2px;
        opacity: 0.8;
        margin: 4px 0;
        text-shadow: 1px 1px 0 #fff;
      }
      .footer-sign {
        margin-top: 20px;
        padding-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div class="header-sign">âœ¦ CHARACTER_Cards by æœˆè¦‹tsukimi âœ¦</div>

    <div class="top-bar">
      <div class="app-title">
        <h1>Roleplay Cards <span>â™¡</span></h1>
      </div>
      <button class="theme-toggle-btn" onclick="toggleTheme()">ğŸ¨ THEME</button>
    </div>

    <div class="main-container">
      <!-- åˆ—è¡¨è§†å›¾ -->
      <div id="view-list">
        <div style="display: flex; gap: 10px">
          <button class="pixel-btn btn-new" onclick="createNewChar()" style="flex: 1">â• æ–°å»ºè§’è‰²</button>
          <button class="pixel-btn btn-import" onclick="triggerImport()" style="flex: 1">ğŸ“‚ å¯¼å…¥ (PNG/JSON)</button>
        </div>

        <div id="char-list-container" class="char-grid"></div>
      </div>

      <!-- ç¼–è¾‘è§†å›¾ -->
      <div id="view-edit">
        <div class="edit-panel">
          <div class="edit-header">
            <button class="pixel-btn btn-back" onclick="handleBack()">â—€ è¿”å›</button>
            <span style="font-weight: bold; color: var(--text-main)">ğŸ“ ç¼–è¾‘æ¡£æ¡ˆ</span>
          </div>

          <input type="hidden" id="edit_id" />

          <!-- å¤´åƒ -->
          <div class="avatar-upload-area" onclick="document.getElementById('avatar_upload').click()">
            <img
              id="edit_avatar_preview"
              class="avatar-preview-big"
              src=""
              onerror="this.src='https://i.postimg.cc/J04FJMsS/1768119599448.png'"
            />
            <div style="font-size: 0.8rem; color: var(--text-sub)">ç‚¹å‡»æ›´æ¢å¤´åƒ</div>
            <input type="file" id="avatar_upload" accept="image/*" onchange="handleAvatarUpload(this)" />
          </div>

          <!-- åŸºç¡€ä¿¡æ¯ -->
          <div class="pixel-form-group">
            <label class="pixel-label">ğŸ‘¤ è§’è‰²æ˜µç§° (Name)</label>
            <input type="text" id="edit_name" class="pixel-input" placeholder="è¾“å…¥è§’è‰²å..." />
          </div>

          <div class="pixel-form-group">
            <label class="pixel-label">ğŸ“œ äººè®¾è¯¦æƒ… (Description)</label>
            <textarea id="edit_description" class="pixel-textarea" placeholder="äººè®¾ã€æ€§æ ¼ã€èƒŒæ™¯..."></textarea>
          </div>

          <!-- ç”¨æˆ·ç»‘å®šæ¨¡å— (æ–°) -->
          <div class="user-bind-section">
            <div class="user-bind-title">ğŸ”— ç»‘å®šç”¨æˆ· (User Binding)</div>
            <div class="pixel-form-group">
              <label class="pixel-label">ğŸ™‚ ç”¨æˆ·åç§° (User Name)</label>
              <input type="text" id="edit_user_name" class="pixel-input" placeholder="ä¾‹å¦‚: æŸæŸæŸ" />
            </div>
            <div class="pixel-form-group">
              <label class="pixel-label">ğŸ­ ç”¨æˆ·äººè®¾ (User Persona)</label>
              <textarea
                id="edit_user_persona"
                class="pixel-textarea"
                style="min-height: 60px"
                placeholder="ç”¨æˆ·åœ¨è¿™ä¸ªä¸–ç•Œä¸­çš„è®¾å®š..."
              ></textarea>
            </div>
          </div>

          <!-- ä¸–ç•Œä¹¦ (Before) -->
          <div class="wb-section">
            <div class="wb-header">
              <span>ğŸŒ å‰ç½®ä¸–ç•Œä¹¦ (Before Char)</span>
              <button class="pixel-btn btn-new btn-mini" onclick="addWBEntry('before', -1)">+ é¡¶éƒ¨æ–°å¢</button>
            </div>
            <ul id="wb_list_before" class="wb-list"></ul>
          </div>

          <!-- ä¸–ç•Œä¹¦ (After) -->
          <div class="wb-section">
            <div class="wb-header">
              <span>ğŸŒŒ åç½®ä¸–ç•Œä¹¦ (After Char)</span>
              <button class="pixel-btn btn-new btn-mini" onclick="addWBEntry('after', -1)">+ é¡¶éƒ¨æ–°å¢</button>
            </div>
            <ul id="wb_list_after" class="wb-list"></ul>
          </div>

          <!-- åº•éƒ¨æŒ‰é’® -->
          <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px">
            <div style="display: flex; gap: 10px">
              <button class="pixel-btn btn-import" onclick="exportCharacter()" style="flex: 1">
                ğŸ“¤ å¯¼å‡º (PNG/JSON)
              </button>
              <button class="pixel-btn btn-new" onclick="duplicateCharacter()" style="flex: 1">ğŸ“‘ å¤åˆ¶è§’è‰²</button>
            </div>
            <div style="display: flex; gap: 10px">
              <button class="pixel-btn btn-del" onclick="deleteCharacter()" style="flex: 1">ğŸ—‘ åˆ é™¤</button>
              <button class="pixel-btn btn-save" onclick="saveCurrentChar()" style="flex: 2">ğŸ’¾ ä¿å­˜æ›´æ”¹</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- éšè—ç»„ä»¶ -->
    <input type="file" id="file_import" accept=".json,.png" onchange="handleFileImport(this)" />

    <div id="pixel-modal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-title" id="modal-title">Alert</div>
        <div class="modal-content" id="modal-message">Content</div>
        <div class="modal-actions">
          <button class="pixel-btn btn-new" id="modal-no">å–æ¶ˆ</button>
          <button class="pixel-btn btn-save" id="modal-yes">ç¡®å®š</button>
        </div>
      </div>
    </div>

    <div id="pixel-prompt" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-title" id="prompt-title">Input</div>
        <div class="modal-content">
          <p id="prompt-message" style="margin: 0 0 10px 0">è¯·è¾“å…¥:</p>
          <!-- å•è¡Œè¾“å…¥ -->
          <input type="text" id="prompt-input" class="pixel-input" style="text-align: center" />
          <!-- å¤šè¡Œè¾“å…¥ (æ–°å¢) -->
          <textarea id="prompt-textarea"></textarea>
        </div>
        <div class="modal-actions">
          <button class="pixel-btn btn-new" id="prompt-cancel">å–æ¶ˆ</button>
          <button class="pixel-btn btn-save" id="prompt-confirm">ç¡®å®š</button>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨ç½²å (å¯ä¿®æ”¹æ–‡æ¡ˆ) -->
    <div class="footer-sign">Â© DESIGN BY æœˆè¦‹tsukimi 2025</div>

    <script>
      // ================= æ•°æ®åº“åˆå§‹åŒ– =================
      const db = new Dexie('PixelChatDB');

      // å£°æ˜ç‰ˆæœ¬å’Œè¡¨ç»“æ„ï¼ˆå¿…é¡»ä¸ Chat.4.html ä¿æŒä¸€è‡´ï¼‰
      db.version(2).stores({
        history: '++id, charId, role, content, type, timestamp',
        images: '++id, blob',
        stickers: '++id, blob, timestamp',
        characters: 'id, name, avatar, user_avatar', // è§’è‰²è¡¨
      });
      // ================= å…¨å±€çŠ¶æ€ =================
      let characters = [];
      let currentEditId = null;
      let originalCharData = null; // ç”¨äºæ£€æµ‹ä¿®æ”¹

      // ================= åˆå§‹åŒ– =================
      window.onload = function () {
        // åªéœ€è¦è°ƒç”¨è¯»å–ï¼Œè¯»å–æˆåŠŸåå®ƒä¼šè‡ªåŠ¨è°ƒç”¨ renderList()
        // showList() ä¹Ÿå¯ä»¥ç•™ç€ç”¨äºåˆå§‹åŒ–ä¸€äº› UI çŠ¶æ€ï¼Œä½†ä¸è¦æŒ‡æœ›å®ƒèƒ½æ¸²æŸ“å‡ºæ•°æ®
        showList();
        loadFromDB();
      };

      // ================= ğŸ¨ å…¨å±€ä¸»é¢˜ç®¡ç† (è¯·å¤åˆ¶åˆ°æ‰€æœ‰ 4 ä¸ªæ–‡ä»¶çš„ script ä¸­) =================

      // 1. åˆå§‹åŒ–ä¸»é¢˜ (æ‰“å¼€é¡µé¢æ—¶ç«‹å³æ‰§è¡Œ)
      function initTheme() {
        // å°è¯•è¯»å–æœ¬åœ°å­˜å‚¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º 'pink'
        const savedTheme = localStorage.getItem('momo_theme') || 'pink';
        document.documentElement.setAttribute('data-theme', savedTheme);
      }

      // 2. åˆ‡æ¢ä¸»é¢˜ (ç‚¹å‡»æŒ‰é’®æ—¶æ‰§è¡Œ)
      function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute('data-theme');
        // å¦‚æœæ˜¯ pink å°±åˆ‡ blueï¼Œå¦åˆ™åˆ‡ pink
        const next = current === 'pink' ? 'blue' : 'pink';

        // åº”ç”¨å¹¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        html.setAttribute('data-theme', next);
        localStorage.setItem('momo_theme', next);

        // â˜… ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ä¸»é¡µ(index.html)ï¼Œè¿˜éœ€è¦æ›´æ–°æ¬¢è¿è¯­
        if (typeof updateWelcomeText === 'function') {
          updateWelcomeText(next);
        }
      }

      // â˜… 3. ç«‹å³è¿è¡Œåˆå§‹åŒ–
      initTheme();

      // ================= æ•°æ®å±‚ =================
      // function loadCharacters() {
      //   const stored = localStorage.getItem('my_characters');
      //   if (stored) {
      //     try {
      //       characters = JSON.parse(stored);
      //     } catch (e) {
      //       characters = [];
      //     }
      //   }
      //   renderList();
      // }
      // === ä¿®æ”¹åçš„è¯»å–é€»è¾‘ ===
      async function loadFromDB() {
        try {
          // ä»æ•°æ®åº“è·å–æ‰€æœ‰è§’è‰²
          const savedChars = await db.characters.toArray();

          if (savedChars && savedChars.length > 0) {
            characters = savedChars;
          } else {
            // â˜… å…¼å®¹æ€§è¿ç§»ï¼šå¦‚æœæ•°æ®åº“æ˜¯ç©ºçš„ï¼Œå°è¯•ä»æ—§çš„ localStorage æ¢å¤ä¸€æ¬¡
            const localData = localStorage.getItem('my_characters');
            if (localData) {
              try {
                characters = JSON.parse(localData);
                // è¿ç§»åç«‹å³å­˜å…¥æ•°æ®åº“
                await db.characters.bulkPut(characters);
                // console.log('å·²ä» localStorage è¿ç§»æ•°æ®åˆ° IndexedDB');
                // è¿ç§»æˆåŠŸåï¼Œå¯ä»¥è€ƒè™‘æ¸…ç©º localStorage é‡Šæ”¾ç©ºé—´
                // localStorage.removeItem('my_characters');
              } catch (e) {
                console.error('æ—§æ•°æ®è§£æå¤±è´¥', e);
              }
            }
          }

          // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â˜…â˜…â˜…
          // ä¹‹å‰è¿™é‡Œè¢«æ³¨é‡Šæ‰äº†ï¼Œè€Œä¸”åå­—å†™çš„æ˜¯ renderCharacterList (è¿™æ˜¯é”™çš„)
          // å¿…é¡»åœ¨è¿™é‡Œè°ƒç”¨ renderList()ï¼Œç¡®ä¿æ•°æ®æ‹¿åˆ°åç«‹å³åˆ·æ–°ç•Œé¢
          renderList();
        } catch (err) {
          console.error('è¯»å–æ•°æ®åº“å¤±è´¥:', err);
        }
      }

      // === ä¿®æ”¹åçš„ä¿å­˜å‡½æ•° ===
      async function saveToLocal() {
        try {
          // 1. ä½¿ç”¨ bulkPut æ‰¹é‡ä¿å­˜/æ›´æ–°è§’è‰²æ•°æ®åˆ° IndexedDB
          // (bulkPut ä¼šè‡ªåŠ¨æ ¹æ® id å»é‡æˆ–æ›´æ–°ï¼Œéå¸¸æ–¹ä¾¿)
          await db.characters.bulkPut(characters);

          // console.log('æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°æ•°æ®åº“');

          // å¯é€‰ï¼šä¸ºäº†å…¼å®¹æ€§ï¼Œä¹Ÿå¯ä»¥åœ¨ localStorage å­˜ä¸€ä¸ªç®€å•çš„æ ‡è®°æˆ–ç‰ˆæœ¬å·ï¼Œä½†ä¸è¦å­˜å¤§å›¾
          localStorage.setItem('data_version', Date.now());
        } catch (err) {
          console.error('ä¿å­˜å¤±è´¥:', err);
          alert('ä¿å­˜å¤±è´¥: ' + err.message);
        }
      }

      // ================= è§†å›¾åˆ‡æ¢ =================
      function showList() {
        document.getElementById('view-list').style.display = 'block';
        document.getElementById('view-edit').style.display = 'none';
        originalCharData = null; // æ¸…é™¤å¿«ç…§
        renderList();
      }

      function showEdit(id) {
        document.getElementById('view-list').style.display = 'none';
        document.getElementById('view-edit').style.display = 'block';
        loadCharToEdit(id);
      }

      // ================= è¿”å›æ£€æµ‹é€»è¾‘ (æ–°) =================
      async function handleBack() {
        if (!currentEditId || !originalCharData) {
          showList();
          return;
        }

        // è·å–å½“å‰æ•°æ®çŠ¶æ€è¿›è¡Œæ¯”å¯¹
        const currentChar = characters.find(c => c.id === currentEditId);
        // è¿™é‡Œéœ€è¦æ„å»ºä¸€ä¸ªä¸´æ—¶çš„å¯¹è±¡æ¥æ¯”å¯¹ï¼Œå› ä¸º edit è§†å›¾æ˜¯å®æ—¶ä¿®æ”¹ characters æ•°ç»„ä¸­çš„ WB å¼•ç”¨ï¼Ÿ
        // ä¸ï¼Œä¹‹å‰çš„é€»è¾‘é‡Œï¼Œdelete/add WB æ˜¯ç›´æ¥ä¿®æ”¹ characters æ•°ç»„çš„ã€‚
        // è€Œ name/desc æ˜¯ save æ—¶æ‰å†™å…¥ã€‚
        // ä¸ºäº†å‡†ç¡®ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ add/delete WB æ—¶ä¸ç›´æ¥ saveToLocalï¼Œä½†å†…å­˜é‡Œçš„ char å·²ç»å˜äº†ã€‚
        // è€Œ edit_name input é‡Œçš„å€¼è¿˜æ²¡å†™å› charã€‚

        // ç®€æ˜“ç­–ç•¥ï¼šæ¯”å¯¹ input çš„å€¼ä¸ originalï¼Œä»¥åŠ WB æ•°ç»„ä¸ originalã€‚
        // ä½†å› ä¸º WB æ“ä½œæ˜¯å®æ—¶ä¿®æ”¹äº†å†…å­˜å¯¹è±¡ characters[i]ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·±æ‹·è´ originalã€‚
        // è·å–å½“å‰ç•Œé¢ä¸Šçš„å€¼
        const nameVal = document.getElementById('edit_name').value;
        const descVal = document.getElementById('edit_description').value;
        const uNameVal = document.getElementById('edit_user_name').value;
        const uPersonaVal = document.getElementById('edit_user_persona').value;

        // ğŸ› ï¸ è¾…åŠ©å·¥å…·ï¼šæ ‡å‡†åŒ–æ•°æ®ï¼Œé˜²æ­¢ undefined !== "" å¯¼è‡´çš„è¯¯æŠ¥
        const str = v => (v === undefined || v === null ? '' : String(v));
        const arr = v => (v === undefined || v === null ? [] : v);

        // æ£€æŸ¥åŸºæœ¬å­—æ®µ
        let isDirty =
          nameVal !== str(originalCharData.name) ||
          descVal !== str(originalCharData.description) ||
          uNameVal !== str(originalCharData.user_name) ||
          uPersonaVal !== str(originalCharData.user_persona) ||
          // æ£€æŸ¥å¤´åƒ (å†…å­˜å¯¹è±¡ä¸­çš„ avatar åœ¨ upload æ—¶å·²æ›´æ–°)
          str(currentChar.avatar) !== str(originalCharData.avatar) ||
          // æ£€æŸ¥ä¸–ç•Œä¹¦ (å†…å­˜å¯¹è±¡ä¸­çš„ WB åœ¨ add/del æ—¶å·²æ›´æ–°)
          JSON.stringify(arr(currentChar.world_info_before)) !==
            JSON.stringify(arr(originalCharData.world_info_before)) ||
          JSON.stringify(arr(currentChar.world_info_after)) !== JSON.stringify(arr(originalCharData.world_info_after));

        if (isDirty) {
          // ç¬¬ä¸€å±‚ï¼šç¡®è®¤è¿”å›
          const confirmReturn = await showPixelConfirm(
            'æ£€æµ‹åˆ°æœªä¿å­˜çš„ä¿®æ”¹\nç¡®å®šè¦è¿”å›å—ï¼Ÿ\n(ç¡®å®š=è¿›å…¥ä¿å­˜é€‰æ‹©ï¼Œå–æ¶ˆ=ç»§ç»­ç¼–è¾‘)',
            'æœªä¿å­˜æé†’',
          );

          if (confirmReturn) {
            // ç¬¬äºŒå±‚ï¼šç¡®è®¤ä¿å­˜
            const confirmSave = await showPixelConfirm(
              'è¦ä¿å­˜æ›´æ”¹åé€€å‡ºå—ï¼Ÿ\n(ç¡®å®š=ä¿å­˜å¹¶é€€å‡ºï¼Œå–æ¶ˆ=ä¸ä¿å­˜å¹¶è¿”å›)',
              'ä¿å­˜ç¡®è®¤',
            );

            if (confirmSave) {
              await saveCurrentChar();
              showList();
            } else {
              // ä¸ä¿å­˜ï¼šé‡ç½®æ•°æ®
              loadFromDB();
              showList();
            }
          }
        } else {
          showList();
        }
      }

      // ================= åˆ—è¡¨æ¸²æŸ“ =================
      function renderList() {
        const container = document.getElementById('char-list-container');
        container.innerHTML = '';
        if (characters.length === 0) {
          container.innerHTML =
            '<div style="grid-column: 1/-1; text-align:center; color:var(--text-sub); margin-top:20px;">æš‚æ— è§’è‰²ï¼Œè¯·æ–°å»ºæˆ–å¯¼å…¥</div>';
          return;
        }
        characters.forEach(char => {
          const div = document.createElement('div');
          div.className = 'char-card-item';
          div.onclick = () => showEdit(char.id);
          let avatarSrc = char.avatar || '';
          if (avatarSrc && !avatarSrc.startsWith('http') && !avatarSrc.startsWith('data:')) {
            avatarSrc = 'data:image/png;base64,' + avatarSrc;
          }
          // ä¿®æ”¹ä¸‹æ–¹ img æ ‡ç­¾çš„ onerror å±æ€§
          div.innerHTML = `
                <img class="char-avatar-small" src="${avatarSrc}" onerror="this.src='https://i.postimg.cc/J04FJMsS/1768119599448.png'">
                <div class="char-name">${char.name || 'Unnamed'}</div>
            `;
          container.appendChild(div);
        });
      }

      // ================= ç¼–è¾‘é€»è¾‘ =================
      function createNewChar() {
        const newChar = {
          id: Date.now().toString(),
          name: 'æ–°è§’è‰²',
          // ä¿®æ”¹ç‚¹ 1ï¼šè®¾ç½®è§’è‰²é»˜è®¤å¤´åƒ
          avatar: 'https://i.postimg.cc/J04FJMsS/1768119599448.png',
          description: '',
          user_name: '',
          // ä¿®æ”¹ç‚¹ 2ï¼šæ·»åŠ ç”¨æˆ·é»˜è®¤å¤´åƒå­—æ®µ
          user_avatar: 'https://i.postimg.cc/vH2JrgLf/1768119594937.png',
          user_persona: '',
          world_info_before: [],
          world_info_after: [],
        };
        characters.push(newChar);
        saveToLocal();
        showEdit(newChar.id);
      }

      function loadCharToEdit(id) {
        const char = characters.find(c => c.id === id);
        if (!char) return showList();

        // å¤‡ä»½åŸå§‹æ•°æ®ï¼Œç”¨äºæ£€æµ‹ä¿®æ”¹ (Deep Copy)
        originalCharData = JSON.parse(JSON.stringify(char));

        currentEditId = id;
        document.getElementById('edit_name').value = char.name || '';
        document.getElementById('edit_description').value = char.description || '';
        document.getElementById('edit_user_name').value = char.user_name || '';
        document.getElementById('edit_user_persona').value = char.user_persona || '';

        let avatarSrc = char.avatar || '';
        if (avatarSrc && !avatarSrc.startsWith('http') && !avatarSrc.startsWith('data:')) {
          avatarSrc = 'data:image/png;base64,' + avatarSrc;
        }
        document.getElementById('edit_avatar_preview').src = avatarSrc;

        renderWBList('before', char.world_info_before || []);
        renderWBList('after', char.world_info_after || []);
      }

      async function saveCurrentChar() {
        const charIndex = characters.findIndex(c => c.id === currentEditId);
        if (charIndex === -1) return;

        characters[charIndex].name = document.getElementById('edit_name').value;
        characters[charIndex].description = document.getElementById('edit_description').value;
        characters[charIndex].user_name = document.getElementById('edit_user_name').value;
        characters[charIndex].user_persona = document.getElementById('edit_user_persona').value;

        if (await showPixelConfirm('ç¡®å®šä¿å­˜æ›´æ”¹å—ï¼Ÿ', 'ä¿å­˜')) {
          saveToLocal();
          // æ›´æ–°å¤‡ä»½ï¼Œé¿å…ä¿å­˜åç‚¹è¿”å›è¿˜æç¤º
          originalCharData = JSON.parse(JSON.stringify(characters[charIndex]));
        }
      }

      // async function deleteCurrentChar() {
      //   if (await showPixelConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§’è‰²å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤', 'åˆ é™¤è­¦å‘Š')) {
      //     characters = characters.filter(c => c.id !== currentEditId);
      //     saveToLocal();
      //     showList();
      //   }
      // }
      // === ä¿®å¤åçš„åˆ é™¤å‡½æ•° ===
      async function deleteCharacter(id) {
        // 1. ç¡®å®šç›®æ ‡ ID
        // å¦‚æœå‡½æ•°è°ƒç”¨æ—¶ä¼ äº† id (åˆ—è¡¨é¡µåˆ é™¤)ï¼Œå°±ç”¨ä¼ è¿›æ¥çš„
        // å¦‚æœæ²¡ä¼  id (ç¼–è¾‘é¡µæŒ‰é’®)ï¼Œå°±ç”¨å…¨å±€å˜é‡ currentEditId
        const targetId = id || currentEditId;

        if (!targetId) {
          console.error('åˆ é™¤å¤±è´¥ï¼šæ‰¾ä¸åˆ° ID');
          return;
        }

        // 2. å¼¹å‡ºç¡®è®¤æ¡† (é˜²æ­¢æ‰‹æ»‘)
        if (await showPixelConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§’è‰²å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤', 'åˆ é™¤è­¦å‘Š')) {
          try {
            // 3. ä»å†…å­˜æ•°ç»„åˆ é™¤
            const index = characters.findIndex(c => c.id === targetId);
            if (index > -1) {
              characters.splice(index, 1);
            }

            // 4. ä»æ•°æ®åº“ç‰©ç†åˆ é™¤
            await db.characters.delete(targetId);

            // 5. æç¤ºå¹¶è¿”å›åˆ—è¡¨
            // await showPixelConfirm('è§’è‰²å·²åˆ é™¤', 'æç¤º'); // å¯é€‰

            // å¦‚æœæ˜¯åœ¨ç¼–è¾‘é¡µåˆ é™¤çš„ï¼Œåˆ å®Œè¦è¿”å›åˆ—è¡¨
            if (targetId === currentEditId) {
              showList();
            } else {
              // å¦‚æœæ˜¯åœ¨åˆ—è¡¨é¡µåˆ çš„ï¼Œåªéœ€è¦åˆ·æ–°åˆ—è¡¨
              renderList();
            }
          } catch (err) {
            console.error(err);
            showPixelConfirm('åˆ é™¤å‡ºé”™: ' + err.message, 'é”™è¯¯');
          }
        }
      }
      // ================= [æ–°å¢/ä¿®å¤] ä¸–ç•Œä¹¦æ¸²æŸ“å‡½æ•° =================
      function renderWBList(type, list) {
        const ul = document.getElementById(`wb_list_${type}`);
        if (!ul) return;
        ul.innerHTML = ''; // æ¸…ç©ºå½“å‰åˆ—è¡¨

        if (!list || list.length === 0) {
          ul.innerHTML =
            '<div style="color:var(--text-sub);font-size:0.8rem;text-align:center;padding:5px;">(æš‚æ— å†…å®¹)</div>';
          return;
        }

        list.forEach((entry, index) => {
          const li = document.createElement('li');
          li.className = 'wb-item';
          if (entry.enabled === false) {
            li.style.opacity = '0.6'; // ç¦ç”¨çš„æ¡ç›®å˜ç°
            li.style.filter = 'grayscale(1)';
          }

          // æˆªå–å†…å®¹é¢„è§ˆ
          const contentPreview =
            entry.content && entry.content.length > 50
              ? entry.content.substring(0, 50) + '...'
              : entry.content || '(æ— å†…å®¹)';

          // å…³é”®å­—æ˜¾ç¤º
          const keysDisplay = entry.keys ? `[${entry.keys}]` : 'æ— ';

          // ä¼˜å…ˆçº§æ˜¾ç¤º
          const prio = entry.insertion_order !== undefined ? entry.insertion_order : 100;

          li.innerHTML = `
      <div class="wb-row-main">
        <div style="flex:1; overflow:hidden;">
           <div style="font-weight:bold; color:var(--text-main); font-size:0.8rem;">
             ${keysDisplay}
           </div>
           <div style="color:var(--text-sub); font-size:0.75rem; margin-top:2px;">
             ${contentPreview}
           </div>
        </div>
        <div class="wb-prio-badge" onclick="editWBPriority('${type}', ${index})" title="ç‚¹å‡»ä¿®æ”¹ä¼˜å…ˆçº§">
           ${prio}
        </div>
      </div>

      <div class="wb-row-tools">
        <button class="pixel-btn btn-mini ${entry.enabled === false ? 'btn-new' : 'btn-save'}" 
          onclick="toggleWBEntry('${type}', ${index})">
          ${entry.enabled === false ? 'åœç”¨ä¸­' : 'å¯ç”¨ä¸­'}
        </button>
        <button class="pixel-btn btn-mini btn-back" onclick="moveWBEntry('${type}', ${index}, -1)">â–²</button>
        <button class="pixel-btn btn-mini btn-back" onclick="moveWBEntry('${type}', ${index}, 1)">â–¼</button>
        <button class="pixel-btn btn-mini btn-import" onclick="editWBEntry('${type}', ${index})">âœ</button>
        <button class="pixel-btn btn-mini btn-del" onclick="removeWBEntry('${type}', ${index})">âœ•</button>
      </div>
    `;
          ul.appendChild(li);
        });
      }

      function handleAvatarUpload(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const base64 = e.target.result;
            document.getElementById('edit_avatar_preview').src = base64;
            const char = characters.find(c => c.id === currentEditId);
            if (char) char.avatar = base64;
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // [æ–°å¢] åˆ‡æ¢ä¸–ç•Œä¹¦æ¡ç›®å¼€å…³
      function toggleWBEntry(type, index) {
        const char = characters.find(c => c.id === currentEditId);
        if (!char) return;

        const entry = char[`world_info_${type}`][index];
        // åˆ‡æ¢çŠ¶æ€
        entry.enabled = entry.enabled === undefined ? false : !entry.enabled;

        // é‡æ–°æ¸²æŸ“
        renderWBList(type, char[`world_info_${type}`]);
      }

      async function addWBEntry(type, index) {
        const keys = await showPixelPrompt('è¯·è¾“å…¥è§¦å‘å…³é”®å­— (é€—å·åˆ†éš”):');
        if (keys === null) return;

        // ä½¿ç”¨å¤šè¡Œè¾“å…¥
        const content = await showPixelPrompt('è¯·è¾“å…¥æ¡ç›®å†…å®¹:', '', true);
        if (content === null) return;

        const prioStr = await showPixelPrompt('è¯·è¾“å…¥ä¼˜å…ˆçº§ (æ•°å­—, é»˜è®¤100):', '100');
        const insertion_order = parseInt(prioStr) || 100;

        const char = characters.find(c => c.id === currentEditId);
        if (!char[`world_info_${type}`]) char[`world_info_${type}`] = [];

        const newEntry = { keys, content, insertion_order };

        if (index === -1) {
          char[`world_info_${type}`].unshift(newEntry);
        } else {
          char[`world_info_${type}`].splice(index + 1, 0, newEntry);
        }

        renderWBList(type, char[`world_info_${type}`]);
      }

      async function removeWBEntry(type, index) {
        // â‘  åˆ é™¤ç¡®è®¤
        if (await showPixelConfirm('ç¡®å®šåˆ é™¤è¯¥ä¸–ç•Œä¹¦æ¡ç›®å—ï¼Ÿ', 'åˆ é™¤ç¡®è®¤')) {
          const char = characters.find(c => c.id === currentEditId);
          char[`world_info_${type}`].splice(index, 1);
          renderWBList(type, char[`world_info_${type}`]);
        }
      }

      // â‘¢ ä¸Šç§»/ä¸‹ç§»é€»è¾‘
      function moveWBEntry(type, index, direction) {
        const char = characters.find(c => c.id === currentEditId);
        const list = char[`world_info_${type}`];

        const targetIndex = index + direction;

        // è¾¹ç•Œæ£€æŸ¥
        if (targetIndex < 0 || targetIndex >= list.length) return;

        // äº¤æ¢
        const temp = list[index];
        list[index] = list[targetIndex];
        list[targetIndex] = temp;

        renderWBList(type, list);
      }

      async function editWBEntry(type, index) {
        const char = characters.find(c => c.id === currentEditId);
        const entry = char[`world_info_${type}`][index];

        const newKeys = await showPixelPrompt('ä¿®æ”¹å…³é”®å­—:', entry.keys);
        if (newKeys !== null) {
          // â‘¡ ç¼–è¾‘ä¹Ÿä½¿ç”¨å¤šè¡Œè¾“å…¥
          const newContent = await showPixelPrompt('ä¿®æ”¹å†…å®¹:', entry.content, true);
          if (newContent !== null) {
            entry.keys = newKeys;
            entry.content = newContent;
            renderWBList(type, char[`world_info_${type}`]);
          }
        }
      }

      async function editWBPriority(type, index) {
        const char = characters.find(c => c.id === currentEditId);
        const entry = char[`world_info_${type}`][index];
        const currentPrio = entry.insertion_order !== undefined ? entry.insertion_order : 100;

        const newPrioStr = await showPixelPrompt('ä¿®æ”¹ä¼˜å…ˆçº§:', currentPrio);
        if (newPrioStr !== null) {
          entry.insertion_order = parseInt(newPrioStr) || 0;
          renderWBList(type, char[`world_info_${type}`]);
        }
      }

      // ================= å¯¼å…¥é€»è¾‘ (JSON + PNG) =================
      function triggerImport() {
        document.getElementById('file_import').click();
      }

      function handleFileImport(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        if (file.type === 'application/json') readJSON(file);
        else if (file.type.startsWith('image/png')) readPNG(file);
        else showPixelConfirm('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼', 'é”™è¯¯');
        input.value = '';
      }

      function readJSON(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const json = JSON.parse(e.target.result);
            const cardData = json.data || json;
            importCardData(cardData, null);
          } catch (err) {
            showPixelConfirm('JSON è§£æå¤±è´¥', 'é”™è¯¯');
          }
        };
        reader.readAsText(file);
      }

      function readPNG(file) {
        const urlReader = new FileReader();
        urlReader.onload = function (e) {
          const base64Avatar = e.target.result;
          const arrayReader = new FileReader();
          arrayReader.onload = function (evt) {
            const buffer = evt.target.result;
            const textData = extractPngText(buffer);
            if (textData) {
              try {
                const json = JSON.parse(decodeBase64(textData));
                const cardData = json.data || json;
                importCardData(cardData, base64Avatar);
              } catch (err) {
                try {
                  const json = JSON.parse(textData);
                  importCardData(json.data || json, base64Avatar);
                } catch (err2) {
                  showPixelConfirm('æ— æ³•è§£æ PNG æ•°æ®', 'é”™è¯¯');
                }
              }
            } else {
              showPixelConfirm('å›¾ç‰‡ä¸­æ— è§’è‰²æ•°æ®', 'é”™è¯¯');
            }
          };
          arrayReader.readAsArrayBuffer(file);
        };
        urlReader.readAsDataURL(file);
      }

      function extractPngText(buffer) {
        const view = new DataView(buffer);
        let offset = 8;
        const decoder = new TextDecoder('utf-8');
        while (offset < buffer.byteLength) {
          const length = view.getUint32(offset);
          const type = decoder.decode(buffer.slice(offset + 4, offset + 8));
          if (type === 'tEXt' || type === 'iTXt') {
            const chunkData = new Uint8Array(buffer.slice(offset + 8, offset + 8 + length));
            let nullIndex = -1;
            for (let i = 0; i < chunkData.length; i++) {
              if (chunkData[i] === 0) {
                nullIndex = i;
                break;
              }
            }
            if (nullIndex > -1) {
              const keyword = decoder.decode(chunkData.slice(0, nullIndex));
              if (keyword === 'chara') return decoder.decode(chunkData.slice(nullIndex + 1));
            }
          }
          offset += 12 + length;
        }
        return null;
      }

      function decodeBase64(str) {
        return decodeURIComponent(
          atob(str)
            .split('')
            .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
            .join(''),
        );
      }

      async function importCardData(data, avatarBase64) {
        const newChar = {
          id: Date.now().toString(),
          name: data.name || 'å¯¼å…¥è§’è‰²',
          avatar: avatarBase64 || '',
          description: data.description || data.persona || '',
          user_name: '',
          user_persona: '',
          world_info_before: [],
          world_info_after: [],
        };

        // å¤„ç† V3 è§„èŒƒçš„ Character Book
        if (data.character_book && data.character_book.entries) {
          data.character_book.entries.forEach(entry => {
            // 1. å®‰å…¨å¤„ç† keysï¼šä¸è®ºæ˜¯æ•°ç»„è¿˜æ˜¯å­—ç¬¦ä¸²éƒ½è½¬ä¸ºå­—ç¬¦ä¸²
            let keysStr = '';
            if (Array.isArray(entry.keys)) {
              keysStr = entry.keys.join(',');
            } else if (typeof entry.keys === 'string') {
              keysStr = entry.keys;
            }

            const item = {
              keys: keysStr,
              content: entry.content || '',
              // å¯¼å…¥æ—¶ä¿ç•™åŸæœ‰çš„ enabled çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ true
              enabled: entry.enabled !== false,
              insertion_order: entry.insertion_order !== undefined ? entry.insertion_order : 100,
            };

            // 2. è¯†åˆ«ä½ç½® (Before/After)
            // V3 è§„èŒƒé€šå¸¸ç”¨ "before_char" æˆ– "after_char"ï¼Œæœ‰æ—¶æ˜¯æ•°å­—ç´¢å¼•
            // è¿™é‡Œçš„é€»è¾‘ï¼šæ˜ç¡®æ ‡è®°ä¸º before æˆ–è€… ç´¢å¼•ä¸º 0 çš„æ”¾å‰é¢ï¼Œå…¶ä»–é»˜è®¤æ”¾åé¢
            const isBefore = entry.position === 'before_char' || entry.position === 0;

            if (isBefore) {
              newChar.world_info_before.push(item);
            } else {
              newChar.world_info_after.push(item);
            }
          });
        }

        // å…¼å®¹ï¼šå¦‚æœåœ¨ scenario å­—æ®µé‡Œæœ‰å†…å®¹ï¼Œè¿½åŠ åˆ°æè¿°é‡Œï¼ˆè¿™ä¹Ÿæ˜¯å¸¸è§åšæ³•ï¼‰
        if (data.scenario) {
          newChar.description += '\n\n[Scenario]\n' + data.scenario;
        }

        if (data.first_mes) {
          // å¦‚æœä½ æƒ³ä¿å­˜å¼€åœºç™½ï¼Œå¯ä»¥è€ƒè™‘åŠ ä¸ªå­—æ®µï¼Œæˆ–è€…æš‚å­˜åˆ°æè¿°é‡Œ
          // newChar.first_mes = data.first_mes;
        }

        characters.push(newChar);
        await saveToLocal(); // ä¿å­˜åˆ°æ•°æ®åº“
        await showPixelConfirm(`æˆåŠŸå¯¼å…¥: ${newChar.name}`, 'å®Œæˆ');
        showList(); // åˆ·æ–°åˆ—è¡¨
      }

      // ================= å¼¹çª—é€»è¾‘ =================
      function showPixelConfirm(message, title = 'æç¤º') {
        return new Promise(resolve => {
          const modal = document.getElementById('pixel-modal');
          document.getElementById('modal-title').innerText = title;
          document.getElementById('modal-message').innerText = message;
          modal.classList.add('show');
          const cleanup = () => {
            modal.classList.remove('show');
            yesBtn.onclick = null;
            noBtn.onclick = null;
          };
          const yesBtn = document.getElementById('modal-yes');
          const noBtn = document.getElementById('modal-no');
          yesBtn.onclick = () => {
            cleanup();
            resolve(true);
          };
          noBtn.onclick = () => {
            cleanup();
            resolve(false);
          };
        });
      }

      // ä¿®æ”¹ç‰ˆ Prompt: æ”¯æŒå¤šè¡Œæ–‡æœ¬
      function showPixelPrompt(message, defaultVal = '', isMultiline = false) {
        return new Promise(resolve => {
          const modal = document.getElementById('pixel-prompt');
          document.getElementById('prompt-message').innerText = message;

          const input = document.getElementById('prompt-input');
          const textarea = document.getElementById('prompt-textarea');

          // åˆ‡æ¢æ˜¾ç¤º input è¿˜æ˜¯ textarea
          if (isMultiline) {
            input.style.display = 'none';
            textarea.style.display = 'block';
            textarea.value = defaultVal;
            setTimeout(() => textarea.focus(), 100);
          } else {
            textarea.style.display = 'none';
            input.style.display = 'block';
            input.value = defaultVal;
            setTimeout(() => input.focus(), 100);
          }

          modal.classList.add('show');

          const cleanup = () => {
            modal.classList.remove('show');
            okBtn.onclick = null;
            cancelBtn.onclick = null;
          };
          const okBtn = document.getElementById('prompt-confirm');
          const cancelBtn = document.getElementById('prompt-cancel');

          okBtn.onclick = () => {
            cleanup();
            resolve(isMultiline ? textarea.value : input.value);
          };
          cancelBtn.onclick = () => {
            cleanup();
            resolve(null);
          };
        });
      }
      // ================= [æ–°å¢] è§’è‰²å¤åˆ¶é€»è¾‘ =================
      async function duplicateCharacter() {
        if (!currentEditId) return;
        const originalChar = characters.find(c => c.id === currentEditId);
        if (!originalChar) return;

        // 1. è¯¢é—®æ˜¯å¦å¤åˆ¶èŠå¤©è®°å½•
        // è¿™é‡Œçš„ showPixelConfirm æˆ‘ä»¬ç¨å¾®æ”¹ä¸€ä¸‹ç”¨æ³•ï¼šç¡®å®š=å¤åˆ¶è®°å½•ï¼Œå–æ¶ˆ=ä¸å¤åˆ¶è®°å½•
        const copyHistory = await showPixelConfirm(
          'æ˜¯å¦è¿å¸¦å¤åˆ¶è¯¥è§’è‰²çš„èŠå¤©è®°å½•ï¼Ÿ\n(ç¡®å®š=å¤åˆ¶è®°å½•ï¼Œå–æ¶ˆ=ä»…å¤åˆ¶è®¾å®š)',
          'å¤åˆ¶é€‰é¡¹',
        );

        try {
          // 2. åˆ›å»ºæ–°è§’è‰²å¯¹è±¡ (æ·±æ‹·è´)
          const newId = Date.now().toString();
          const newChar = JSON.parse(JSON.stringify(originalChar));
          newChar.id = newId;
          newChar.name = newChar.name + ' (å‰¯æœ¬)';

          // 3. å¦‚æœéœ€è¦ï¼Œå¤åˆ¶ IndexedDB ä¸­çš„èŠå¤©è®°å½•
          if (copyHistory) {
            const history = await db.history.where('charId').equals(originalChar.id).toArray();
            if (history.length > 0) {
              const newHistory = history.map(h => {
                // ç§»é™¤æ—§çš„è‡ªå¢ä¸»é”® idï¼Œå¹¶æ›¿æ¢ charId
                const { id, ...rest } = h;
                return { ...rest, charId: newId };
              });
              await db.history.bulkAdd(newHistory);
              // alert(`å·²å¤åˆ¶ ${newHistory.length} æ¡èŠå¤©è®°å½•`);
            }
          }

          // 4. ä¿å­˜å¹¶åˆ·æ–°
          characters.push(newChar);
          await saveToLocal();
          await showPixelConfirm(`è§’è‰²ã€${newChar.name}ã€‘å¤åˆ¶æˆåŠŸï¼`, 'æˆåŠŸ');
          showList();
        } catch (e) {
          console.error(e);
          await showPixelConfirm('å¤åˆ¶å¤±è´¥: ' + e.message, 'é”™è¯¯');
        }
      }

      // ================= [æ–°å¢] è§’è‰²å¯¼å‡ºé€»è¾‘ (PNG/JSON) =================
      async function exportCharacter() {
        if (!currentEditId) return;
        const char = characters.find(c => c.id === currentEditId);
        if (!char) return;

        // 1. è¯¢é—®å¯¼å‡ºæ ¼å¼
        // ç¡®å®š = PNG, å–æ¶ˆ = JSON
        const isPng = await showPixelConfirm(
          'è¯·é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼š\n(ç¡®å®š = å¯¼å‡ºåŒ…å«æ•°æ®çš„ PNG å›¾ç‰‡)\n(å–æ¶ˆ = å¯¼å‡º JSON æ–‡ä»¶)',
          'å¯¼å‡ºæ ¼å¼é€‰æ‹©',
        );

        // 2. æ„å»ºæ ‡å‡† TavernAI æ ¼å¼æ•°æ®ç»“æ„
        // ä¸ºäº†å…¼å®¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ world_info_before/after åˆå¹¶è¿› character_book
        const exportData = {
          name: char.name,
          description: char.description,
          personality: char.description, // å…¼å®¹å­—æ®µ
          scenario: '', // å¦‚æœä½ æœ‰å­˜åœºæ™¯ï¼ŒåŠ åœ¨è¿™é‡Œ
          first_mes: '', // å¦‚æœä½ æœ‰å­˜å¼€åœºç™½ï¼ŒåŠ åœ¨è¿™é‡Œ
          mes_example: '',
          metadata: {
            user_name: char.user_name,
            user_persona: char.user_persona,
            // è‡ªå®šä¹‰å­—æ®µ
            world_info_before: char.world_info_before,
            world_info_after: char.world_info_after,
          },
          // æ„å»ºæ ‡å‡†çš„ character_book
          character_book: {
            entries: [],
          },
        };

        // åˆå¹¶ä¸–ç•Œä¹¦æ¡ç›®åˆ° character_book
        const processWB = (list, position) => {
          if (!list) return;
          list.forEach(item => {
            exportData.character_book.entries.push({
              keys: item.keys.split(','),
              content: item.content,
              enabled: item.enabled !== false,
              insertion_order: item.insertion_order,
              position: position, // è®°å½•æ˜¯ before è¿˜æ˜¯ after
            });
          });
        };
        processWB(char.world_info_before, 'before_char');
        processWB(char.world_info_after, 'after_char');

        const fileName = char.name.replace(/[\\/:*?"<>|]/g, '_');

        if (isPng) {
          // === å¯¼å‡º PNG ===
          if (!char.avatar) {
            await showPixelConfirm('è¯¥è§’è‰²æ²¡æœ‰å¤´åƒï¼Œæ— æ³•ç”Ÿæˆè§’è‰²å¡ PNGï¼Œå°†è‡ªåŠ¨è½¬ä¸º JSON å¯¼å‡ºã€‚', 'æç¤º');
            downloadJSON(exportData, fileName);
            return;
          }
          await downloadPNGCard(char.avatar, exportData, fileName);
        } else {
          // === å¯¼å‡º JSON ===
          downloadJSON(exportData, fileName);
        }
      }

      // è¾…åŠ©ï¼šä¸‹è½½ JSON
      // [ä¿®æ”¹] è¾…åŠ©ï¼šä¸‹è½½ JSON -> æ”¹ç”¨ smartSave
      function downloadJSON(data, fileName) {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        // è°ƒç”¨æ™ºèƒ½ä¿å­˜
        smartSave(blob, `${fileName}.json`);
      }

      // è¾…åŠ©ï¼šä¸‹è½½ PNG (å¸¦ tEXt å—æ³¨å…¥)
      // [ä¿®æ”¹] è¾…åŠ©ï¼šä¸‹è½½ PNG -> æ”¹ç”¨ smartSave
      async function downloadPNGCard(base64Avatar, dataObj, fileName) {
        const img = new Image();
        // å¤„ç† base64 å‰ç¼€
        const src = base64Avatar.startsWith('data:') ? base64Avatar : 'data:image/png;base64,' + base64Avatar;
        img.src = src;

        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);

          canvas.toBlob(async blob => {
            // è½¬ä¸º ArrayBuffer ä»¥ä¾¿æ³¨å…¥æ•°æ®
            const buffer = await blob.arrayBuffer();

            // å‡†å¤‡åµŒå…¥çš„æ•°æ®
            const jsonStr = JSON.stringify(dataObj);
            const base64Data = btoa(unescape(encodeURIComponent(jsonStr)));

            // æ³¨å…¥ tEXt chunk
            const keyword = 'chara';
            const textContent = base64Data;
            const newBuffer = writePngTextChunk(buffer, keyword, textContent);

            // ç”Ÿæˆæœ€ç»ˆ Blob
            const finalBlob = new Blob([newBuffer], { type: 'image/png' });

            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šè°ƒç”¨æ™ºèƒ½ä¿å­˜ â˜…â˜…â˜…
            smartSave(finalBlob, `${fileName}.png`);
          }, 'image/png'); // æ˜ç¡®æŒ‡å®š mime type
        };
      }

      // æ ¸å¿ƒï¼šå†™å…¥ PNG tEXt å— (äºŒè¿›åˆ¶æ“ä½œ)
      function writePngTextChunk(arrayBuffer, keyword, text) {
        const encoder = new TextEncoder();
        const keywordBytes = encoder.encode(keyword);
        const textBytes = encoder.encode(text);

        // tEXt chunk æ•°æ®éƒ¨åˆ† = keyword + null separator + text
        const chunkDataLen = keywordBytes.length + 1 + textBytes.length;
        const totalChunkLen = 4 + 4 + chunkDataLen + 4; // Len + Type + Data + CRC

        const outputBuffer = new Uint8Array(arrayBuffer.byteLength + totalChunkLen);
        const view = new DataView(outputBuffer.buffer);
        const inputView = new DataView(arrayBuffer);

        // PNG ç­¾åæ˜¯å‰ 8 å­—èŠ‚
        outputBuffer.set(new Uint8Array(arrayBuffer.slice(0, 8)), 0);

        let offset = 8;
        let inputOffset = 8;

        // å¯»æ‰¾ IEND å—ï¼Œæ’å…¥åœ¨ IEND ä¹‹å‰
        while (inputOffset < arrayBuffer.byteLength) {
          const len = inputView.getUint32(inputOffset);
          const type = inputView.getUint32(inputOffset + 4); // è¿™é‡Œè¯»å‡ºæ¥æ˜¯æ•°å­—ï¼Œéœ€è¦è½¬å­—ç¬¦åˆ¤æ–­

          // IEND çš„ ASCII ç : 0x49454E44
          if (type === 0x49454e44) {
            break; // æ‰¾åˆ°äº† IENDï¼Œåœæ­¢å¤åˆ¶ï¼Œå…ˆæ’å…¥æˆ‘ä»¬çš„å—
          }

          // å¤åˆ¶å½“å‰å—åˆ°è¾“å‡º
          outputBuffer.set(new Uint8Array(arrayBuffer.slice(inputOffset, inputOffset + 12 + len)), offset);
          offset += 12 + len;
          inputOffset += 12 + len;
        }

        // === æ’å…¥ tEXt å— ===
        // 1. Length
        view.setUint32(offset, chunkDataLen);
        offset += 4;

        // 2. Type (tEXt = 0x74455874)
        view.setUint32(offset, 0x74455874);
        offset += 4;

        // 3. Data (Keyword + 0 + Text)
        outputBuffer.set(keywordBytes, offset);
        offset += keywordBytes.length;
        outputBuffer[offset] = 0; // Null separator
        offset += 1;
        outputBuffer.set(textBytes, offset);
        offset += textBytes.length;

        // 4. CRC (è®¡ç®— Type + Data)
        // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸è®¡ç®—çœŸå®çš„ CRCï¼ŒæŸäº›ä¸¥æ ¼çš„é˜…è¯»å™¨å¯èƒ½ä¼šæŠ¥é”™ï¼Œ
        // ä½†å¤§å¤šæ•° Web åº”ç”¨å¿½ç•¥ CRC æ ¡éªŒã€‚å¦‚æœéœ€è¦ä¸¥æ ¼ CRCï¼Œéœ€è¦å¼•å…¥ CRC32 ç®—æ³•è¡¨ã€‚
        // æ—¢ç„¶ç¯å¢ƒå—é™ï¼Œè¿™é‡Œå¡« 0 æˆ–è€…å°è¯•è®¡ç®—ç®€å•çš„ã€‚
        // ä¸ºäº†ä¿è¯å¯ç”¨æ€§ï¼Œå¯ä»¥å°è¯•å¤åˆ¶ä¸€ä¸ªé€šç”¨çš„ CRC32 å‡½æ•°ï¼Œæˆ–è€…ç›´æ¥ç”±æµè§ˆå™¨å®¹é”™ã€‚
        // è¿™é‡Œæˆ‘ä»¬åŠ ä¸Šä¸€ä¸ªç®€æ˜“ CRC32 å®ç°ä»¥é˜²ä¸‡ä¸€ã€‚
        const crcStart = offset - chunkDataLen - 4;
        const crcData = outputBuffer.slice(crcStart, offset);
        const crc = crc32(crcData);
        view.setUint32(offset, crc);
        offset += 4;

        // === å¤åˆ¶å‰©ä½™çš„ IEND å— ===
        outputBuffer.set(new Uint8Array(arrayBuffer.slice(inputOffset)), offset);

        return outputBuffer.buffer;
      }

      // ç®€æ˜“ CRC32 è¡¨ç”Ÿæˆä¸è®¡ç®—
      let crcTable = [];
      for (let n = 0; n < 256; n++) {
        let c = n;
        for (let k = 0; k < 8; k++) {
          if (c & 1) c = 0xedb88320 ^ (c >>> 1);
          else c = c >>> 1;
        }
        crcTable[n] = c;
      }

      function crc32(buf) {
        let crc = 0xffffffff;
        for (let i = 0; i < buf.length; i++) {
          crc = crcTable[(crc ^ buf[i]) & 0xff] ^ (crc >>> 8);
        }
        return crc ^ 0xffffffff;
      }

      // ================= [ä¿®å¤ç‰ˆ] æ™ºèƒ½ä¿å­˜é€»è¾‘ (æºè‡ª index.9.html) =================

      /**
       * æ™ºèƒ½ä¿å­˜å…¥å£ï¼šè‡ªåŠ¨åˆ¤æ–­ç¯å¢ƒ
       */
      function smartSave(blob, filename) {
        // 1. å¦‚æœæ˜¯ Cordova APP ç¯å¢ƒ (ä¸”æœ‰æ–‡ä»¶æ’ä»¶)
        if (window.cordova && cordova.file) {
          saveToMobile(blob, filename);
        }
        // 2. å¦‚æœæ˜¯æ™®é€šæµè§ˆå™¨ç¯å¢ƒ
        else {
          // æ–¹æ¡ˆ A: å°è¯•ä½¿ç”¨ FileSaver.js (å¦‚æœæœ‰çš„è¯)
          if (typeof saveAs === 'function') {
            saveAs(blob, filename);
          }
          // æ–¹æ¡ˆ B: å¦‚æœæ²¡æœ‰ FileSaverï¼Œå›é€€åˆ°åŸç”Ÿ <a> æ ‡ç­¾ä¸‹è½½
          else {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
          }
        }
      }

      /**
       * æ‰‹æœºç«¯ä¸“ç”¨ï¼šæ›´å¼ºå£®çš„å†™å…¥é€»è¾‘ (ä¿®å¤æ— ååº”é—®é¢˜)
       */
      function saveToMobile(blob, filename) {
        // 1. å…ˆæç¤ºç”¨æˆ·æ­£åœ¨å¤„ç† (é€‚é… Cards çš„å¼¹çª—é£æ ¼)
        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åªæ˜¾ç¤ºæç¤ºï¼Œä¸ç­‰å¾…ç”¨æˆ·ç‚¹å‡»ï¼Œç›´æ¥å¼€å§‹åå°å¤„ç†
        const modal = document.getElementById('pixel-modal');
        document.getElementById('modal-title').innerText = 'ä¿å­˜ä¸­';
        document.getElementById('modal-message').innerText = 'æ­£åœ¨å†™å…¥æ‰‹æœº Download ç›®å½•...\nè¯·å‹¿å…³é—­åº”ç”¨(â—â€²Ë˜â€µâ—)';
        modal.classList.add('show');
        // éšè—æŒ‰é’®ï¼Œé˜²æ­¢ç”¨æˆ·åœ¨å†™å…¥æ—¶ä¹±ç‚¹ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
        document.getElementById('modal-yes').style.display = 'none';
        document.getElementById('modal-no').style.display = 'none';

        const storageLocation = cordova.file.externalRootDirectory || cordova.file.externalDataDirectory;

        window.resolveLocalFileSystemURL(
          storageLocation,
          function (dirEntry) {
            dirEntry.getDirectory(
              'Download',
              { create: true, exclusive: false },
              function (downDir) {
                downDir.getFile(
                  filename,
                  { create: true, exclusive: false },
                  function (fileEntry) {
                    fileEntry.createWriter(function (fileWriter) {
                      // === æ ¸å¿ƒä¿®å¤ï¼šåˆ†å—å†™å…¥é€»è¾‘ (å‚è€ƒ index.9) ===
                      const CHUNK_SIZE = 1024 * 1024; // 1MB
                      let offset = 0;

                      // å®šä¹‰å†™å…¥å®Œæˆåçš„å›è°ƒ
                      fileWriter.onwriteend = function () {
                        offset += CHUNK_SIZE;

                        if (offset < blob.size) {
                          // å¦‚æœè¿˜æ²¡å†™å®Œï¼Œç§»åŠ¨æŒ‡é’ˆç»§ç»­å†™ä¸‹ä¸€å—
                          fileWriter.seek(fileWriter.length);
                          writeNextChunk();
                        } else {
                          // å…¨éƒ¨å†™å®Œï¼Œæ¢å¤æŒ‰é’®å¹¶æ˜¾ç¤ºæˆåŠŸ
                          document.getElementById('modal-title').innerText = 'å¯¼å‡ºå®Œæˆ';
                          document.getElementById(
                            'modal-message',
                          ).innerText = `âœ… ä¿å­˜æˆåŠŸï¼\næ–‡ä»¶å·²å­˜å…¥ï¼šDownload/${filename}`;
                          document.getElementById('modal-yes').style.display = 'inline-block';
                          document.getElementById('modal-yes').innerText = 'å¥½è€¶';

                          // é‡æ–°ç»‘å®šå…³é—­äº‹ä»¶
                          document.getElementById('modal-yes').onclick = function () {
                            modal.classList.remove('show');
                          };
                        }
                      };

                      // å®šä¹‰é”™è¯¯å›è°ƒ
                      fileWriter.onerror = function (e) {
                        document.getElementById('modal-title').innerText = 'é”™è¯¯';
                        document.getElementById('modal-message').innerText = 'å†™å…¥å¤±è´¥ï¼š' + e.toString();
                        document.getElementById('modal-yes').style.display = 'inline-block';
                        document.getElementById('modal-yes').innerText = 'å…³é—­';
                        document.getElementById('modal-yes').onclick = function () {
                          modal.classList.remove('show');
                        };
                      };

                      // å®šä¹‰åˆ†å—å†™å…¥å‡½æ•°
                      function writeNextChunk() {
                        const slice = blob.slice(offset, offset + CHUNK_SIZE);
                        fileWriter.write(slice);
                      }

                      // === å…³é”®æ­¥éª¤ï¼šå…ˆæ¸…ç©ºæ–‡ä»¶ ===
                      // å¾ˆå¤šå®‰å“æœºå¦‚æœç›´æ¥è¦†ç›–å†™å…¥ä¼šå¤±è´¥ï¼Œå¿…é¡»å…ˆ truncate(0)
                      // truncate ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œåˆ©ç”¨å®ƒçš„å›è°ƒæ¥è§¦å‘ç¬¬ä¸€æ¬¡å†™å…¥
                      const originalOnWriteEnd = fileWriter.onwriteend; // å¤‡ä»½ä¸Šé¢çš„é€»è¾‘

                      // ä¸´æ—¶è¦†ç›–å›è°ƒï¼Œç”¨äºå¤„ç† Truncate å®Œæˆ
                      fileWriter.onwriteend = function () {
                        // æ¢å¤æ­£å¸¸å†™å…¥é€»è¾‘
                        fileWriter.onwriteend = originalOnWriteEnd;
                        // å¼€å§‹å†™ç¬¬ä¸€å—
                        writeNextChunk();
                      };

                      // æ‰§è¡Œæ¸…ç©º
                      fileWriter.truncate(0);
                    });
                  },
                  function (err) {
                    alert('åˆ›å»ºæ–‡ä»¶å¤±è´¥: ' + JSON.stringify(err));
                    modal.classList.remove('show');
                  },
                );
              },
              function (err) {
                alert('æ‰¾ä¸åˆ° Download ç›®å½•: ' + JSON.stringify(err));
                modal.classList.remove('show');
              },
            );
          },
          function (err) {
            alert('æ— æ³•è®¿é—®å­˜å‚¨æƒé™: ' + JSON.stringify(err));
            modal.classList.remove('show');
          },
        );
      }

      // ==========================================
      // ğŸ  é¡¶éƒ¨å¯¼èˆªæ ç‚¹å‡» -> è¿”å›ä¸»é¡µ (index.html)
      // ==========================================
      (function initTopBarNav() {
        const topBar = document.querySelector('.top-bar');
        if (!topBar) return;

        // 1. é¼ æ ‡æ”¾ä¸Šå»å˜æˆå°æ‰‹ï¼Œæç¤ºå¯ç‚¹å‡»
        topBar.style.cursor = 'pointer';

        // 2. ç»‘å®šç‚¹å‡»äº‹ä»¶
        topBar.addEventListener('click', function (e) {
          // â˜… é˜²æ­¢è¯¯è§¦ï¼šå¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®(button)æˆ–æŒ‰é’®é‡Œçš„å›¾æ ‡ï¼Œå°±ä¸è·³è½¬
          if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
            return;
          }

          // è·³è½¬å›åŒç›®å½•ä¸‹çš„ index.html
          window.location.href = 'index.html';
        });
      })();
    </script>
  </body>
</html>
