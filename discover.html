<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>AI Idea Hub Ultimate(ä¿®ä¸€ä¸‹å¼•ç”¨æ¡å¹¶åˆ—)</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap"
      rel="stylesheet"
    />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+39+Text&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
      @import url('https://fontsapi.zeoseven.com/309/main/result.css');
      @font-face {
        font-family: 'ZhuqueFangsong';
        src: url('https://sharkpan.xyz/f/JkxLTg/%E6%B1%87%E6%96%87%E6%98%8E%E6%9C%9D%E4%BD%93.otf') format('truetype');
        font-weight: 200;
        font-style: normal;
      }
      /* ===== å­—ä½“ ===== */
      :root {
        --bg-color: #f4f6f9;
        --white: #ffffff;
        --text-main: #2d3436;
        --text-light: #636e72;
        --accent: #2d3436;

        /* å­—ä½“å˜é‡ */
        /* --font-ui: 'Varela Round', sans-serif; */
        --font-ui: 'Huiwen', 'ZhuqueFangsong', serif;
        --font-serif: 'Huiwen', 'ZhuqueFangsong', serif;
        /* --font-mono: 'JetBrains Mono', monospace; */
        --font-mono: 'Huiwen', 'ZhuqueFangsong', serif;
        --font-code: 'Libre Barcode 39 Text', cursive;

        --input-bg: #f0f2f5;
        --radius-lg: 24px;
        --shadow-soft: 0 8px 20px rgba(0, 0, 0, 0.04);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        outline: none;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        font-family: var(--font-ui);
        background-color: var(--bg-color);
        color: var(--text-main);
        width: 100%;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* --- Header --- */
      header {
        width: 100%;
        padding: 19px 19px 9px 19px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(244, 246, 249, 0.95);
        backdrop-filter: blur(10px);
        z-index: 50;
        position: sticky;
        top: 0;
      }
      .header-btn {
        width: 44px;
        height: 44px;
        background: var(--white);
        border-radius: 50%;
        border: none;
        /* === âœ… æ ¸å¿ƒä¿®å¤ä»£ç  === */
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0; /* 1. å¼ºåˆ¶æ¸…é™¤æµè§ˆå™¨ç»™æŒ‰é’®çš„é»˜è®¤å†…è¾¹è· */
        line-height: 0; /* 2. æ¶ˆé™¤å­—ä½“åŸºçº¿é«˜åº¦ï¼Œè®© Flexbox å®Œç¾å‚ç›´å±…ä¸­ */
        /* ====================== */
        font-size: 1.2rem;
        color: var(--text-main);
        box-shadow: var(--shadow-soft);
        cursor: pointer;
        transition: transform 0.2s;
      }
      .header-btn:hover {
        transform: scale(1.05);
      }
      .page-title {
        font-size: 1.4rem;
        font-weight: 700;

        /* âœ… [æ–°å¢] é¼ æ ‡å˜å°æ‰‹ï¼Œæç¤ºå¯ç‚¹å‡» */
        cursor: pointer;
        transition: opacity 0.2s; /* å¯é€‰ï¼šåŠ ä¸ªç®€å•çš„é€æ˜åº¦è¿‡æ¸¡ */
      }

      /* å¯é€‰ï¼šé¼ æ ‡æ‚¬åœæ—¶ç¨å¾®å˜æ·¡ä¸€ç‚¹ï¼Œå¢åŠ äº¤äº’æ„Ÿ */
      .page-title:hover {
        opacity: 0.7;
      }

      /* --- Content Scroll --- */
      .content-scroll {
        flex: 1;
        overflow-y: auto;
        padding: 10px 21px 100px 21px;
        width: 100%;
        /* max-width: 1200px; */
        margin: 0 auto;
        scrollbar-width: thin;
      }
      .page {
        display: none;
        animation: fadeIn 0.4s ease;
      }
      .page.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(15px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* --- Search & Tags --- */
      .search-area {
        display: flex;
        gap: 10px;
        align-items: baseline;
        margin-bottom: 20px; /* Reduced margin to fit character list */
      }
      .search-container {
        flex: 1;
        background: var(--white);
        border-radius: 30px;
        padding: 8px 13px 8px 9px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
        box-shadow: var(--shadow-soft);
        border: 2px solid transparent;
        transition: border 0.3s;
      }
      .search-container:focus-within {
        border-color: var(--text-main);
      }
      .tag-pill {
        background: #dfe6e9;
        color: var(--text-main);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 6px;
        animation: popIn 0.2s ease;
        align-items: baseline;
      }
      .tag-pill i {
        cursor: pointer;
        font-size: 0.7rem;
        opacity: 0.6;
      }
      @keyframes popIn {
        from {
          transform: scale(0.8);
        }
        to {
          transform: scale(1);
        }
      }
      .search-input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-family: inherit;
        font-size: 1rem;
        background: transparent;
        padding: 6px 0;
      }
      .btn-generate {
        background: var(--text-main);
        color: #fff;
        border: none;
        border-radius: 13px;
        padding: 0 16px;
        font-size: 0.86rem;
        font-weight: bold;
        cursor: pointer;
        box-shadow: var(--shadow-soft);
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.3s;
        height: 39px;
        font-family: var(--font-ui);
      }
      .btn-generate:hover {
        background: #000;
      }
      .btn-generate:disabled {
        background: #b2bec3;
        cursor: not-allowed;
      }

      /* === [NEW] Character Selector Styles === */
      .char-selector-row {
        display: flex;
        gap: 18px;
        overflow-x: auto;
        padding: 10px 5px 10px 5px; /* Bottom padding for hover effects */
        margin-bottom: 10px;
        scrollbar-width: none; /* Hide scrollbar Firefox */
        -ms-overflow-style: none; /* Hide scrollbar IE */
      }
      .char-selector-row::-webkit-scrollbar {
        display: none; /* Hide scrollbar Chrome/Safari */
      }

      .cs-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        position: relative;
        flex-shrink: 0;
        width: 68px;
      }

      .cs-avatar-wrap {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        padding: 3px; /* Space for border ring */
        border: 2px solid #dfe6e9; /* Default ring */
        position: relative;
        transition: all 0.3s ease;
      }

      .cs-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        background: #fff;
        display: block;
        transition: filter 0.3s;
      }

      .cs-name {
        font-size: 0.75rem;
        color: var(--text-light);
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 100%;
      }

      /* Active/Selected State */
      .cs-item.selected .cs-avatar-wrap {
        border-color: var(--text-main);
        transform: scale(1.05);
      }
      .cs-item.selected .cs-avatar {
        filter: brightness(0.6); /* Darken image to make checkmark pop */
      }
      .cs-item.selected .cs-name {
        color: var(--text-main);
        font-weight: 800;
      }

      /* Fat Checkmark */
      .cs-check {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        color: #fff;
        font-size: 1.5rem;
        z-index: 5;
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);

        /* Fat circle background */
        display: flex;
        align-items: center;
        justify-content: center;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .cs-item.selected .cs-check {
        transform: translate(-50%, -50%) scale(1);
      }

      /* Hover effect */
      .cs-item:hover .cs-avatar-wrap {
        border-color: #b2bec3;
      }

      /* --- Grid Layout --- */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 21px 0 19px 0;
      }
      .section-title {
        font-size: 1.1rem;
        color: var(--text-main);
        font-weight: 700;
      }
      .view-all {
        font-size: 0.9rem;
        color: var(--text-light);
        cursor: pointer;
      }
      .masonry-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 25px;
      }

      /* === â­ï¸ CARD STYLE: INDEX 2 (Clean) + INDEX 3 (Barcode) === */
      .cp-card {
        background: var(--white);
        border-radius: 30px; /* Index 2 åœ†è§’ */
        overflow: hidden;
        cursor: pointer;
        box-shadow: var(--shadow-soft);
        transition: transform 0.3s, box-shadow 0.3s;
        position: relative;
        display: flex;
        flex-direction: column;
        padding: 20px;
        border: 1px solid rgba(0, 0, 0, 0.03);
      }
      .cp-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
      }

      /* Header */
      .cp-header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 4px;
      }
      .cp-char-info {
        flex: 1;
      }
      .cp-char-name {
        font-size: 1.3rem;
        font-weight: 800;
        color: var(--text-main);
        line-height: 1.2;
        margin-bottom: 4px;
        font-family: var(--font-serif);
      }
      .cp-char-sub {
        font-size: 0.75rem;
        color: #b2bec3;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      /* Match Badge (Vertical) */
      .cp-match-badge {
        background: var(--text-main);
        color: #fff;
        border-radius: 20px;
        padding: 6px 14px;
        font-size: 0.8rem;
        font-weight: 700;
        display: flex;
        flex-direction: column;
        align-items: center;
        line-height: 1;
        gap: 3px;
      }
      .cp-match-badge small {
        font-size: 0.5rem;
        opacity: 0.8;
        letter-spacing: 1px;
      }

      /* Interaction Zone (With BG) */
      .cp-interaction-zone {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: transparent; /* èƒŒæ™¯ç‚¹ç¼€ */
        border-radius: 20px;
        padding: 15px;
        margin-bottom: 20px;
        position: relative;
      }
      .cp-avatar-wrap {
        position: relative;
        width: 50px;
        height: 50px;
      }
      .cp-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      .cp-avatar-tag {
        position: absolute;
        bottom: -5px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--text-main);
        color: #fff;
        font-size: 0.55rem;
        padding: 2px 6px;
        border-radius: 8px;
        font-weight: bold;
        white-space: nowrap;
      }

      /* ç²¾è‡´è¿çº¿ */
      .cp-link-line {
        flex: 1;
        height: 1px;
        background: #ccc;
        margin: 0 20px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .cp-link-line::before,
      .cp-link-line::after {
        content: '';
        width: 4px;
        height: 4px;
        background: #ccc;
        border-radius: 50%;
        position: absolute;
      }
      .cp-link-line::before {
        left: 0;
      }
      .cp-link-line::after {
        right: 0;
      }
      .cp-link-icon {
        background: #fff;
        color: #ff7675;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        border: 1px solid #f0f0f0;
        z-index: 2;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .cp-quote {
        font-family: var(--font-serif);
        font-style: italic;
        font-size: 0.95rem;
        color: var(--text-light);
        line-height: 1.6;
        margin-bottom: 20px;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* âœ¨ [æ–°å¢] Tags Rendering (Before Footer) */
      .cp-tags-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 15px;
        justify-content: flex-start; /* å·¦å¯¹é½ */
      }
      .cp-tag-pill {
        /* background: #f1f3f5;
              color: #636e72; */
        font-size: 0.75rem;
        padding: 4px 12px;
        border-radius: 12px; /* åœ†è§’ */
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;

        background: var(--text-main);
        color: #fff;
      }
      .cp-tag-pill:hover {
        background: var(--text-main);
        color: #fff;
      }

      /* Footer Decor (Index 3 Barcode) */
      .cp-footer-decor {
        border-top: 1px dashed #eee;
        padding-top: 27px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
      }
      .cp-barcode {
        font-family: var(--font-code);
        font-size: 1.8rem;
        color: #cecece;
        line-height: 1;
        transform: scaleY(1.5);
        opacity: 0.6;
      }
      .cp-id-code {
        font-family: var(--font-mono);
        font-size: 0.6rem;
        /* color: #b2bec3; */
        color: #333;
        letter-spacing: 1px;
      }
      .cp-decor-icon {
        color: var(--text-main);
        opacity: 0.77;
        font-size: 1rem;
      }

      /* --- Bottom Nav --- */
      .bottom-nav-container {
        position: fixed;
        bottom: 30px;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: center;
        z-index: 100;
        pointer-events: none;
      }
      .bottom-nav {
        pointer-events: auto;
        background: var(--white);
        padding: 10px 20px;
        border-radius: 50px;
        display: flex;
        gap: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      }
      .nav-item {
        padding: 10px 20px;
        border-radius: 30px;
        color: #b2bec3;
        font-size: 1.3rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
      }
      .nav-item.active {
        background: var(--text-main);
        color: var(--white);
      }
      .nav-item span {
        font-size: 0.95rem;
        font-weight: 600;
        display: none;
        white-space: nowrap;
        margin-left: 8px;
      }
      .nav-item.active span {
        display: block;
      }

      /* --- Modals Overlay --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /* background: rgba(0, 0, 0, 0.6); */
        backdrop-filter: blur(8px);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease; /* èƒŒæ™¯æ·¡å…¥æ·¡å‡º */
      }
      /* 2. ç¬¬ä¸€é˜¶æ®µï¼šå¸ƒå±€æ˜¾ç¤º (ä½†çœ‹ä¸è§) */
      .modal-overlay.open {
        display: flex;
        /* æ³¨æ„ï¼šè¿™é‡Œä¸è®¾ opacity: 1ï¼Œåªè®¾ display */
      }

      /* 3. ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰æ¿€æ´» (åŠ¨ç”»å¼€å§‹) */
      .modal-overlay.active {
        opacity: 1;
      }

      /* === API SETTINGS === */
      .settings-card {
        background: var(--white);
        width: 89%;
        max-width: 380px;
        overflow: auto;
        height: 89%;
        border-radius: 20px;
        padding: 25px;
        position: relative;
        /* åˆå§‹çŠ¶æ€ï¼šç¼©å° + é€æ˜ */
        transform: scale(0.8);
        opacity: 0;
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
      }
      /* âœ… å…³é”®ä¿®æ”¹ï¼šåªæœ‰å½“çˆ¶å®¹å™¨æœ‰ .active æ—¶ï¼Œæ‰æ”¾å¤§æ˜¾ç¤º */
      .modal-overlay.active .settings-card {
        transform: scale(1);
        opacity: 1;
      }
      .modal-overlay.open .settings-card {
        transform: scale(1);
      }
      .settings-header {
        text-align: center;
        font-weight: 700;
        margin-bottom: 20px;
        font-size: 1.1rem;
      }
      .preset-switcher {
        background: #eef1f5;
        border-radius: 12px;
        padding: 4px;
        display: flex;
        margin-bottom: 20px;
      }
      .switcher-btn {
        flex: 1;
        text-align: center;
        padding: 10px;
        font-size: 0.9rem;
        border-radius: 10px;
        cursor: pointer;
        color: var(--text-light);
        transition: all 0.3s ease;
        font-weight: 600;
      }
      .switcher-btn.active {
        background: var(--white);
        color: var(--text-main);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .form-group {
        margin-bottom: 16px;
      }
      .form-label {
        display: block;
        font-size: 0.85rem;
        margin-bottom: 6px;
        color: var(--text-light);
        font-weight: 600;
      }
      .form-input,
      .form-select {
        width: 100%;
        padding: 12px;
        border: 1px solid transparent;
        border-radius: 12px;
        background: var(--input-bg);
        font-family: inherit;
        font-size: 0.95rem;
        transition: border 0.2s;
      }
      .form-input:focus,
      .form-select:focus {
        border-color: var(--text-main);
        background: #fff;
      }
      .btn-fetch {
        background: #fab1a0;
        border: none;
        border-radius: 8px;
        width: 44px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .btn-save-main {
        width: 100%;
        background: var(--text-main);
        color: white;
        padding: 14px;
        border: none;
        border-radius: 14px;
        margin-top: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        font-family: var(--font-ui);
      }
      .library-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        border-top: 1px dashed #eee;
        padding-top: 15px;
      }
      .lib-btn {
        flex: 1;
        background: transparent;
        border: 1px solid #dfe6e9;
        padding: 8px;
        border-radius: 10px;
        font-size: 0.8rem;
        color: var(--text-light);
        cursor: pointer;
        font-family: var(--font-ui);
      }
      .range-wrap {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.8rem;
        color: var(--text-light);
      }
      input[type='range'] {
        flex: 1;
        accent-color: var(--text-main);
      }
      .switch-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--input-bg);
        padding: 10px 14px;
        border-radius: 12px;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 42px;
        height: 24px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: '';
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--text-main);
      }
      input:checked + .slider:before {
        transform: translateX(18px);
      }

      /* === 2. BROWSER WINDOW (FIXED LAYOUT) === */
      .browser-window {
        width: 94%;
        max-width: 450px;
        height: 86vh;
        background: #f8f9fa;
        border-radius: 24px;
        overflow: hidden;
        position: relative; /* ç”¨äºå†…éƒ¨ç»å¯¹å®šä½ */
        transform: translateY(30px) scale(0.95);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 40px 100px rgba(0, 0, 0, 0.4);
        /* âœ… [å…³é”®] åˆå§‹çŠ¶æ€ï¼šç¼©å°ä¸”é€æ˜ */
        transform: scale(0.6);
        opacity: 0;

        /* è¿›åœºåŠ¨ç”»ï¼šä½¿ç”¨Qå¼¹çš„è´å¡å°”æ›²çº¿ */
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease;
      }
      /* åªæœ‰å½“ overlay åŒæ—¶æ‹¥æœ‰ open å’Œ active ç±»æ—¶ï¼Œçª—å£æ‰æ”¾å¤§ */
      .modal-overlay.active .browser-window {
        transform: scale(1);
        opacity: 1;
      }
      /* 3. âœ… [æ–°å¢] å…³é—­çŠ¶æ€ (JSä¼šæ·»åŠ è¿™ä¸ªç±») */
      .modal-overlay.closing {
        opacity: 0; /* èƒŒæ™¯æ·¡å‡º */
        pointer-events: none; /* ç¦æ­¢ç‚¹å‡» */
      }

      /* å…³é—­æ—¶ï¼šçª—å£ç¼©å°æ¶ˆå¤± */
      .modal-overlay.closing .browser-window {
        transform: scale(0.8); /* ç¨å¾®ç¼©å° */
        opacity: 0;
        transition: transform 0.3s ease-in, opacity 0.3s ease; /* å…³é—­ä¸éœ€è¦å›å¼¹ï¼Œè¦å¿« */
      }

      .modal-decor-header {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 259px;
        z-index: 0;
      }
      .modal-decor-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .modal-decor-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 50%;
        background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.09));
        pointer-events: none;
      }

      /* âœ… ã€æ–°å¢ã€‘ç¡®ä¿å›¾ç‰‡æœ¬èº«ä¹Ÿæ˜¯åªæœ‰æŒ‡é’ˆæ‰‹åŠ¿ */
      #pre-bg-img {
        cursor: pointer;
        position: relative;
        z-index: 1;
      }

      .close-float-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 20;
        width: 32px;
        height: 32px;
        background: rgba(0, 0, 0, 0.09);
        backdrop-filter: blur(4px);
        border-radius: 50%;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .close-float-btn:hover {
        background: rgba(0, 0, 0, 0.4);
        transform: rotate(90deg);
      }

      .modal-body {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        z-index: 1;
        padding: 0 17px 0px 17px;
        padding-top: 147px;
      }

      .fake-search-bar {
        background: rgba(255, 255, 255, 0.59);
        backdrop-filter: blur(3px);
        border-radius: 30px;
        padding: 7px 19px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #333;
        font-weight: 500;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        position: relative;
        z-index: 5;
      }
      .fake-query-text {
        font-size: 0.9rem;
        font-weight: 700;
        color: #2d3436;
        overflow: hidden;
        white-space: nowrap;
        max-width: 70%;
      }

      .interaction-card {
        background: var(--white);
        border-radius: 24px;
        padding: 30px 25px;
        /* box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08); */
        position: relative;
        margin-bottom: 17px;
      }

      .int-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .int-status {
        font-size: 0.7rem;
        font-weight: 800;
        letter-spacing: 1px;
        color: var(--text-light);
        text-transform: uppercase;
        background: #f0f2f5;
        padding: 4px 10px;
        border-radius: 20px;
      }
      .int-avatars {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .int-av {
        width: 36px;
        height: 36px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .int-link {
        width: 15px;
        height: 2px;
        background: #ddd;
      }

      .int-title-area {
        text-align: center;
        margin-bottom: 15px;
      }
      .int-char-name {
        font-size: 1.6rem;
        font-weight: 800;
        color: var(--text-main);
        margin-bottom: 11px;
        font-family: var(--font-serif);
      }
      .int-meta {
        font-family: var(--font-mono);
        font-size: 0.7rem;
        color: #a4b0be;
        letter-spacing: 0.5px;
      }

      .int-content-box {
        position: relative;
        padding: 25px 0;
        border-top: 1px solid #f0f0f0;
        border-bottom: 1px solid #f0f0f0;
      }
      .int-quote {
        font-family: var(--font-serif);
        font-size: 1.1rem;
        color: var(--text-main);
        text-align: center;
        font-style: italic;
        margin-bottom: 25px;
        line-height: 1.6;
        padding: 0 10px;
      }
      .int-body {
        font-family: var(--font-serif);
        font-size: 0.95rem;
        color: #555;
        line-height: 1.9;
        white-space: pre-wrap;
        text-align: justify;
      }

      .int-footer {
        margin-top: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }
      .int-btn {
        flex: 1;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #eee;
        background: #fff;
        color: var(--text-main);
        font-size: 0.8rem;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.2s;
        font-family: var(--font-ui);
      }
      .int-btn:hover {
        background: var(--text-main);
        color: #fff;
        border-color: var(--text-main);
      }
      /* === âœ¨ [æ–°å¢] å›¾ç‰‡ç‚¹å‡»ä¸Šä¼ äº¤äº’æ ·å¼ === */
      .modal-decor-header,
      .int-av {
        cursor: pointer;
        position: relative;
        transition: filter 0.2s;
      }
      /* é¼ æ ‡æ‚¬åœæ—¶å˜æš—å¹¶æ˜¾ç¤ºä¸Šä¼ æç¤º (å¯é€‰ï¼Œç®€å•å˜æš—å³å¯) */
      .modal-decor-header:hover .modal-decor-img,
      .int-av:hover {
        filter: brightness(0.8);
      }

      /* ç»™èƒŒæ™¯å›¾å®¹å™¨åŠ ä¸ªæç¤ºå›¾æ ‡ (ä¼ªå…ƒç´ ) */
      .modal-decor-header:hover::before {
        content: '\f030'; /* FontAwesome Camera Icon */
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: rgba(255, 255, 255, 0.8);
        font-size: 2rem;
        z-index: 5;
        pointer-events: none;
      }
      /* è®© modal-body çš„é¡¶éƒ¨åŒºåŸŸé¼ æ ‡å˜æ‰‹å‹ */
      .modal-body {
        cursor: pointer;
      }
      /* æ¢å¤ modal-body å†…éƒ¨å†…å®¹çš„é¼ æ ‡æ ·å¼ */
      .modal-body > * {
        cursor: default;
      }
      /* è®©é‡Œé¢çš„æŒ‰é’®å’Œè¾“å…¥æ¡†æ¢å¤åŸæœ‰æ‰‹å‹ */
      .modal-body button,
      .modal-body .int-av,
      .modal-body .close-float-btn {
        cursor: pointer;
      }
      /* === âœ¨ [æ–°å¢] åˆ é™¤æŒ‰é’®æ ·å¼ === */
      .int-btn.delete-btn {
        color: #ff7675;
        border-color: #fab1a0;
      }
      .int-btn.delete-btn:hover {
        background: #ff7675;
        color: #fff;
        border-color: #ff7675;
      }

      /* === âœ¨ [æ–°å¢] å¤åˆ¶æŒ‰é’®æ ·å¼ === */
      .copy-btn {
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: background 0.2s;
        color: #636e72;
      }
      .copy-btn:hover {
        background: rgba(0, 0, 0, 0.05);
        color: var(--text-main);
      }
      /* === âœ¨ [æ–°å¢] å¡ç‰‡è¿›åœºåŠ¨ç”» (ç¼©æ”¾+å¼¹è·³) === */
      @keyframes popInEffect {
        0% {
          opacity: 0;
          transform: scale(0.5); /* åˆå§‹çŠ¶æ€ï¼šç¼©å°ä¸”é€æ˜ */
        }
        70% {
          transform: scale(1.05); /* ç¨å¾®æ”¾å¤§ä¸€ç‚¹ï¼Œåˆ¶é€ å›å¼¹æ„Ÿ */
        }
        100% {
          opacity: 1;
          transform: scale(1); /* æœ€ç»ˆçŠ¶æ€ï¼šæ­£å¸¸å¤§å° */
        }
      }

      .cp-card {
        /* åŸæœ‰çš„æ ·å¼ä¿æŒä¸å˜... */

        /* âœ… [æ–°å¢] åº”ç”¨è¿›åœºåŠ¨ç”» */
        animation: popInEffect 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);

        /* ç¡®ä¿åŠ¨ç”»ä¸ä¼šå’Œ hover å†²çªï¼Œè¿™é‡Œä¸éœ€è¦ forwardsï¼Œè®©å®ƒå›åˆ°é»˜è®¤çŠ¶æ€å³å¯ */
      }
      /* === âœ¨ [æ–°å¢] Tags åŠ¨ç”»æ•ˆæœ === */
      @keyframes tagPopIn {
        0% {
          transform: scale(0.5);
          opacity: 0;
        }
        70% {
          transform: scale(1.1);
        } /* Qå¼¹æ•ˆæœ */
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      @keyframes tagPopOut {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        100% {
          transform: scale(0.5);
          opacity: 0;
          margin-right: -50px;
        } /* æŒ¤å‹æ¶ˆå¤± */
      }

      .tag-pill {
        /* ... åŸæœ‰çš„æ ·å¼ ... */
        /* âœ… ç¡®ä¿æ·»åŠ è¿™è¡Œåº”ç”¨è¿›åœºåŠ¨ç”» */
        animation: tagPopIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        transform-origin: center;
        transition: all 0.3s; /* ç”¨äºå¤„ç†å¸ƒå±€å¹³æ»‘ç§»åŠ¨ */
      }

      /* ç¦»åœºçŠ¶æ€ */
      .tag-pill.removing {
        animation: tagPopOut 0.3s forwards;
        pointer-events: none; /* é˜²æ­¢é‡å¤ç‚¹å‡» */
      }
      /* === âœ¨ [æ–°å¢] è¯¦æƒ…é¡µå‰¯æ ‡é¢˜æ ·å¼ === */
      .int-char-sub {
        font-family: var(--font-ui);
        font-size: 0.9rem;
        color: #7f8c8d; /* ç°è‰² */
        font-weight: 600;
        margin-top: -5px; /* ç´§è´´æ ‡é¢˜ä¸‹æ–¹ */
        margin-bottom: 8px; /* ä¸ meta ä¿¡æ¯æ‹‰å¼€è·ç¦» */
        letter-spacing: 0.5px;
      }
      /* === âœ¨ [æ–°å¢] Prompt è®¾ç½®æ ·å¼ === */
      .prompt-section-toggle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: #f8f9fa;
        border-radius: 12px;
        cursor: pointer;
        margin-bottom: 10px;
        margin-top: 14px;
        font-weight: 700;
        font-size: 0.95rem;
        color: var(--text-main);
        transition: background 0.2s;
      }
      .prompt-section-toggle:hover {
        background: #eef1f5;
      }
      .settings-drawer {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.4s ease, opacity 0.3s ease;
        margin-bottom: 0;
      }
      .settings-drawer.open {
        max-height: 800px; /* è¶³å¤Ÿå¤§ä»¥å®¹çº³å†…å®¹ */
        opacity: 1;
        margin-bottom: 20px;
      }
      .prompt-box {
        height: 120px;
        font-family: var(--font-mono);
        font-size: 0.8rem;
        line-height: 1.4;
        resize: vertical;
      }
      #prompt-arrow {
        transition: transform 0.3s;
      }
      .settings-drawer.open + .prompt-section-toggle #prompt-arrow {
        transform: rotate(180deg); /* å¹¶æ²¡æœ‰ç›´æ¥å…„å¼Ÿé€‰æ‹©å™¨æ§åˆ¶ä¸Šé¢ï¼Œç”¨JSæ§åˆ¶ */
      }
      /* ä¿®æ­£ä¸Šé¢çš„ CSS é€»è¾‘ï¼Œæˆ‘ä»¬ç”¨ JS æ§åˆ¶ç®­å¤´æ—‹è½¬ */
      .rotate-180 {
        transform: rotate(180deg);
      }
      /* === âœ¨ [æ–°å¢] äº¤äº’å¼å‰§æƒ…æ ·å¼ === */

      /* 1. è¾“å…¥åŒºåŸŸå®¹å™¨ */
      .story-input-container {
        display: flex;
        gap: 10px;
        align-items: center;
        background: #f0f2f5;
        padding: 10px;
        border-radius: 16px;
        border: 1px solid #e1e4e8;
      }

      /* 2. è¾“å…¥æ¡† */
      .story-input {
        flex: 1;
        background: transparent;
        border: none;
        resize: none;
        font-family: var(--font-ui);
        font-size: 0.9rem;
        padding: 8px 5px;
        outline: none;
        min-height: 24px;
        max-height: 80px;
      }

      /* 3. å‘é€æŒ‰é’® */
      .btn-continue {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        border: none;
        background: var(--text-main);
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, background 0.2s;
        flex-shrink: 0;
      }
      .btn-continue:hover {
        transform: scale(1.1);
        background: #000;
      }
      .btn-continue:disabled {
        background: #b2bec3;
        cursor: not-allowed;
        transform: scale(1);
      }

      /* === ğŸ’¬ æ°”æ³¡æ ·å¼ === */

      /* ç”¨æˆ·æŒ‡ä»¤æ°”æ³¡ */
      .user-action-bubble {
        margin: 20px 0 10px 0;
        padding: 12px 18px;
        background: #f1fbeb;
        color: #2c502f;
        border-radius: 12px 12px 0 12px; /* åªæœ‰å·¦ä¸‹è§’æ˜¯ç›´è§’ */
        font-size: 0.9rem;
        font-weight: 700;
        font-family: var(--font-ui);
        align-self: flex-end;
        border-left: 4px solid #bed6a9;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
      }
      .user-action-bubble::before {
        content: 'USER ACTION';
        position: absolute;
        top: -8px;
        left: 0;
        font-size: 0.6rem;
        background: #bed6a9;
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
      }

      /* AI ç»­å†™æ®µè½ (ä¸ºäº†åŒºåˆ†æ–°æ—§å†…å®¹ï¼ŒåŠ ä¸ªé¡¶éƒ¨è£…é¥°) */
      .ai-continuation-block {
        margin-top: 27px;
        padding-top: 17px;
        border-top: 1px dashed #eee; /* è™šçº¿åˆ†éš” */
        animation: fadeIn 0.5s ease;
      }
      /* === âœ¨ Chat Page Styles (ä»¿æˆªå›¾é£æ ¼) === */
      .chat-page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 5px;
        margin-bottom: 15px;
      }
      .chat-search-bar {
        background: #e6e8eb;
        border-radius: 20px;
        padding: 10px;
        display: flex;
        justify-content: center; /* å±…ä¸­é£æ ¼ */
        align-items: center;
        gap: 8px;
        color: #999;
        font-size: 0.9rem;
        margin-bottom: 20px;
      }

      /* æ¨ªå‘æ»šåŠ¨ Tabs */
      .chat-tabs-row {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        padding-bottom: 10px;
        margin-bottom: 10px;
        scrollbar-width: none;
      }
      .chat-tab {
        font-size: 1rem;
        font-weight: 700;
        color: #b2bec3;
        white-space: nowrap;
        padding: 6px 16px;
        border-radius: 20px;
        transition: all 0.2s;
        cursor: pointer;
      }
      .chat-tab.active {
        color: var(--text-main);
        background: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }

      .chat-section-title {
        font-size: 0.8rem;
        color: #b2bec3;
        margin-bottom: 10px;
        margin-left: 5px;
      }

      /* è”ç³»äººå¡ç‰‡åˆ—è¡¨ */
      .chat-list-box {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-bottom: 100px;
      }
      .chat-item-card {
        background: #fff;
        border-radius: 24px; /* å¤§åœ†è§’ */
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.02);
        cursor: pointer;
        transition: transform 0.2s;
      }
      .chat-item-card:active {
        transform: scale(0.98);
      }
      .c-avatar {
        width: 50px;
        height: 50px;
        border-radius: 33%;
        object-fit: cover;
        border: 1px solid #eee;
      }
      .c-info {
        flex: 1;
        overflow: hidden;
      }
      .c-top {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
      }
      .c-name {
        font-weight: 700;
        font-size: 1rem;
        color: var(--text-main);
      }
      .c-time {
        font-size: 0.75rem;
        color: #b2bec3;
      }
      .c-msg {
        font-size: 0.85rem;
        color: #636e72;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* === ğŸ’¬ Chat Room Overlay (èŠå¤©å®¤) === */
      .chat-room-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f4f6f9;
        z-index: 300; /* ç›–è¿‡åº•éƒ¨å¯¼èˆª */
        display: flex;
        flex-direction: column;
        transform: translateX(100%); /* é»˜è®¤æ»‘å‡ºå±å¹• */
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .chat-room-overlay.active {
        transform: translateX(0);
      }

      /* æ‰¾åˆ°ç°æœ‰çš„ .chat-room-header æ ·å¼å—ï¼Œæ·»åŠ  position å’Œ z-index */
      .chat-room-header {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);

        /* âœ… æ–°å¢ä»¥ä¸‹ä¸¤è¡Œæ ¸å¿ƒä¿®å¤ä»£ç  */
        position: relative; /* 1. ç¡®ä¿èœå•æ˜¯ç›¸å¯¹äº Header å®šä½çš„ */
        z-index: 500; /* 2. å…³é”®ï¼šå¿…é¡»æ¯”ä¸‹é¢çš„ body å†…å®¹å±‚çº§é«˜ï¼Œé˜²æ­¢è¢«æ°”æ³¡é®æŒ¡ */
      }
      .chat-room-info {
        flex: 1;
      }
      .chat-room-name {
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 4px;
      }
      .chat-room-status {
        font-size: 0.7rem;
        color: #2ecc71;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .chat-room-status::before {
        content: '';
        display: block;
        width: 6px;
        height: 6px;
        background: #2ecc71;
        border-radius: 50%;
      }
      .back-btn {
        cursor: pointer;
        padding: 10px;
      }

      .chat-room-body {
        flex: 1;
        overflow-y: auto;
        padding: 17px 14px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        overflow-x: hidden;
      }

      /* æ¶ˆæ¯æ°”æ³¡ */
      .msg-row {
        display: flex;
        gap: 10px;
        max-width: 85%;
      }
      .msg-row.user {
        align-self: flex-end;
        flex-direction: row-reverse;
      }
      .msg-row.char {
        align-self: flex-start;
      }

      .msg-av {
        width: 36px;
        height: 36px;
        border-radius: 21%;
        object-fit: cover;
        flex-shrink: 0;
      }

      /* æ‰¾åˆ°è¿™ä¸ªç±»ï¼Œä¿®æ”¹ width å±æ€§ */
      .msg-bubble {
        padding: 10px 14px;
        border-radius: 18px;
        font-size: 0.92rem;
        line-height: 1.5;
        position: relative;
        word-wrap: break-word;

        /* === ğŸ”´ ä¿®æ”¹è¿™é‡Œ === */
        /* åŸæ¥æ˜¯ width: 100%; æ”¹æˆä¸‹é¢è¿™ä¸¤è¡Œ */
        width: fit-content; /* å…³é”®ï¼šå®½åº¦éšå†…å®¹è‡ªé€‚åº” */
        max-width: 100%; /* é™åˆ¶æœ€å¤§å®½åº¦ä¸è¶…è¿‡çˆ¶å®¹å™¨ */
        min-width: 40px; /* é˜²æ­¢å•å­—æ°”æ³¡å¤ªçª„ */
        /* ================= */
      }
      /* ç”¨æˆ·æ°”æ³¡ (å³ä¾§) */
      .msg-row.user .msg-bubble {
        background: var(--text-main);
        color: #fff;
        border-bottom-right-radius: 4px;
        margin-left: auto; /* ç¡®ä¿é å³ */
      }
      /* è§’è‰²æ°”æ³¡ (å·¦ä¾§) */
      .msg-row.char .msg-bubble {
        background: #fff;
        color: var(--text-main) !important;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .chat-room-footer {
        background: #fff;
        padding: 17px 15px 10px 15px;
        display: flex;
        gap: 10px;
        align-items: center;
        border-top: 1px solid #eee;
      }
      .chat-input-wrapper {
        flex: 1;
        background: #f0f2f5;
        border-radius: 24px;
        padding: 0 15px;
        display: flex;
        align-items: center;
        height: 44px;
      }
      .chat-input-wrapper input {
        flex: 1;
        border: none;
        background: transparent;
        height: 100%;
        margin-right: 10px;
        font-family: inherit;
        font-size: 0.86rem;
      }
      .chat-btn-group {
        display: flex;
        gap: 8px;
      }
      .cr-btn {
        width: 39px;
        height: 39px;
        border-radius: 50%;
        border: none;
        color: #fff;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
      }
      .cr-btn:active {
        transform: scale(0.9);
      }
      .btn-send-only {
        background: #b2bec3;
      } /* ç°è‰²å‘é€ */
      .btn-send-ai {
        background: var(--text-main);
      } /* é»‘è‰²AIå‘é€ */
      /* === âœ¨ Refined Rich Bubbles (ç²¾è‡´ç‰ˆå¯Œåª’ä½“æ°”æ³¡) === */

      /* 1. ğŸ–¼ï¸ å›¾ç‰‡æè¿°å¡ç‰‡ (Photo Text Card) */
      .msg-bubble.image-card {
        background: #fff !important;
        border: 1px solid rgba(0, 0, 0, 0.05);
        padding: 6px; /* åƒæ‹ç«‹å¾—ä¸€æ ·çš„ç™½è¾¹ */
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
        min-width: 140px;
        max-width: 220px;
      }
      .img-placeholder {
        background: #f0f2f5;
        height: 100px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #b2bec3;
        font-size: 1.5rem;
        margin-bottom: 8px;
        position: relative;
        overflow: hidden;
      }
      /* åŠ ä¸€ä¸ªç®€å•çš„æ–œå…‰æ‰«è¿‡åŠ¨ç”»ï¼Œå¢åŠ ç²¾è‡´æ„Ÿ */
      .img-placeholder::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 50%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
        animation: shine 3s infinite;
      }
      @keyframes shine {
        100% {
          left: 200%;
        }
      }

      .img-desc {
        font-size: 0.8rem;
        color: #636e72;
        padding: 0 4px 4px 4px;
        line-height: 1.4;
      }

      /* 2. ğŸ¤  æ–‡å­—è¡¨æƒ…åŒ… (Text Sticker) */
      .msg-bubble.sticker-card {
        background: #fff !important;
        border: 2px solid var(--border-color); /* è·Ÿéšä¸»é¢˜è‰² */
        border-radius: 16px;
        padding: 15px 20px;
        text-align: center;
        box-shadow: 3px 3px 0 var(--shadow-color); /* åƒç´ é£/å¯çˆ±é£é˜´å½± */
        transform: rotate(-2deg); /* ç¨å¾®æ­ªä¸€ç‚¹æ›´å¯çˆ± */
        transition: transform 0.2s;
        cursor: pointer;
        display: inline-block;
      }
      .msg-bubble.sticker-card:hover {
        transform: scale(1.05) rotate(0deg);
      }
      .sticker-content {
        font-size: 1.1rem;
        font-weight: 800;
        color: var(--text-main);
        font-family: var(--font-pixel); /* ä¿æŒåƒç´ å­—ä½“ */
      }
      .sticker-ext {
        font-size: 0.6rem;
        color: #b2bec3;
        margin-top: 4px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* 3. ğŸ’° ç²¾è‡´è½¬è´¦å¡ç‰‡ (Transfer Card) */
      .msg-bubble.transfer-card {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%); /* é»˜è®¤ç²‰è‰²æ¸å˜ */
        padding: 0;
        border-radius: 16px;
        overflow: hidden;
        min-width: 230px;
        color: #fff !important;
        /* box-shadow: 0 5px 15px rgba(255, 154, 158, 0.3); */
      }
      /* æ ¹æ®ä¸»é¢˜å˜è‰²ï¼šå¦‚æœæ˜¯è“è‰²ä¸»é¢˜ */
      [data-theme='blue'] .msg-bubble.transfer-card {
        background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
      }

      .trans-top {
        padding: 15px 15px 7px 15px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .trans-icon {
        width: 40px;
        height: 40px;
        /* border: 2px solid #fff; */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }
      /* ä¿®æ”¹è½¬è´¦å¡ç‰‡å†…éƒ¨å¸ƒå±€ï¼Œæ”¯æŒé•¿å¤‡æ³¨ */
      .trans-info {
        display: flex;
        flex-direction: column;
        justify-content: center; /* å‚ç›´å±…ä¸­ */
        overflow: hidden; /* é˜²æ­¢æ–‡å­—æº¢å‡º */
        flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
      }

      .trans-amt {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 2px;
        line-height: 1.1;
      }

      /* ä¿®æ”¹åçš„ .trans-txtï¼šæ”¯æŒè‡ªåŠ¨æ¢è¡Œ */
      .trans-txt {
        font-size: 0.8rem;
        opacity: 0.85;

        /* âœ… [æ ¸å¿ƒä¿®æ”¹] åˆ é™¤åŸæ¥çš„ nowrap/ellipsisï¼Œæ”¹ä¸ºå…è®¸æ¢è¡Œ */
        white-space: pre-wrap; /* ä¿ç•™è¾“å…¥æ—¶çš„æ¢è¡Œç¬¦ï¼Œä¸”å…è®¸è‡ªåŠ¨æ¢è¡Œ */
        word-break: break-word; /* ç¡®ä¿é•¿å•è¯æˆ–é•¿æ•°å­—ä¹Ÿèƒ½æ­£ç¡®æ¢è¡Œ */
        line-height: 1.4; /* å¢åŠ ä¸€ç‚¹è¡Œé«˜ï¼Œå¤šè¡Œæ˜¾ç¤ºæ—¶ä¸æ‹¥æŒ¤ */

        /* ç§»é™¤ overflow: hidden ä»¥ä¾¿å†…å®¹æ’‘å¼€é«˜åº¦ */
        /* overflow: hidden;  <-- åˆ æ‰è¿™è¡Œ */
        /* text-overflow: ellipsis; <-- åˆ æ‰è¿™è¡Œ */

        color: var(--text-main) !important;
      }
      .msg-bubble.transfer-card {
        width: 72%;
      }
      /* é’ˆå¯¹ User å‘å‡ºçš„è½¬è´¦æ°”æ³¡ï¼Œæ–‡å­—é¢œè‰²ä¿®æ­£ */
      .msg-row.user .trans-txt {
        color: rgba(255, 255, 255) !important;
      }

      .trans-bot {
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 15px;
        font-size: 0.7rem;
        opacity: 0.95;
        display: flex;
        justify-content: space-between;
      }
      /* === ğŸ¤ è¯­éŸ³æ°”æ³¡ (åŠ¨æ€å®½åº¦ & å‚ç›´å¸ƒå±€) === */
      .msg-bubble.voice-card {
        background: #fff;
        border-radius: 20px;
        padding: 10px 15px;

        /* å¸ƒå±€è®¾ç½® */
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0;

        /* âœ… [å…³é”®ä¿®æ”¹] é»˜è®¤çŠ¶æ€ï¼šå›ºå®šçª„å®½åº¦ */
        width: 119px; /* ä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´è¿™ä¸ªåˆå§‹å®½åº¦ */
        min-width: 119px; /* é˜²æ­¢è¢«å‹ç¼©å¾—å¤ªå° */

        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        cursor: pointer;

        /* âœ… [å…³é”®ä¿®æ”¹] å®½åº¦å’Œé«˜åº¦åŒæ—¶è¿‡æ¸¡ï¼Œå¢åŠ å›å¼¹æ•ˆæœ */
        transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), max-height 0.4s ease;
      }

      /* âœ… [å…³é”®ä¿®æ”¹] å±•å¼€çŠ¶æ€ï¼šå®½åº¦å˜å®½ */
      .msg-bubble.voice-card.open {
        width: 79%; /* å±•å¼€æ—¶å æ® 70% å®½åº¦ */
        max-width: 359px; /* å¯é€‰ï¼šåŠ ä¸ªä¸Šé™ï¼Œé˜²æ­¢åœ¨ç”µè„‘å¤§å±ä¸Šå¤ªé•¿å¤ªä¸‘ */
      }

      /* æ’­æ”¾æ¡åŒºåŸŸï¼šå§‹ç»ˆå æ»¡å½“å‰æ°”æ³¡å®½åº¦ */
      .voice-player-row {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%; /* ç¡®ä¿ç§’æ•°èƒ½é¡¶åˆ°æœ€å³è¾¹ */
      }

      .voice-icon {
        width: 30px;
        height: 30px;
        background: var(--btn-new-bg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 0.8rem;
        flex-shrink: 0;
      }

      .voice-lines {
        display: flex;
        align-items: center;
        gap: 3px;
      }
      .v-line {
        width: 3px;
        background: #fff;
        border-radius: 2px;
        animation: v-anim 1s infinite;
      }

      @keyframes v-anim {
        0%,
        100% {
          height: 8px;
        }
        50% {
          height: 16px;
        }
      }

      /* è½¬æ–‡å­—åŒºåŸŸ */
      .voice-trans-box {
        margin-top: 0;
        padding-top: 0;
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        font-size: 0.85rem;
        color: #fff;
        width: 100%;
        border-top: 1px dashed transparent;

        /* å»¶è¿Ÿæ–‡å­—æ˜¾ç¤ºï¼Œç­‰å®½åº¦æ’‘å¼€åå†æ˜¾ç¤ºæ–‡å­—ï¼Œä½“éªŒæ›´å¥½ */
        transition: all 0.3s ease 0.1s;
      }

      /* å±•å¼€çŠ¶æ€ä¸‹çš„æ–‡å­—æ¡† */
      .msg-bubble.voice-card.open .voice-trans-box {
        margin-top: 10px;
        padding-top: 8px;
        max-height: 500px; /* è¶³å¤Ÿé«˜ä»¥å®¹çº³é•¿æ–‡æœ¬ */
        opacity: 1;
        border-top-color: #eee;
      }
      /* === ğŸš‘ ä¿®å¤ï¼šå¼ºåˆ¶ä¿®æ­£ Char ä¾§è¯­éŸ³æ°”æ³¡çš„é¢œè‰² === */

      /* 1. ä¿®æ­£æ°”æ³¡æ•´ä½“æ–‡å­—é¢œè‰² (ç§’æ•°ã€è½¬ä¹‰æ–‡æœ¬) */
      .msg-row.char .msg-bubble.voice-card,
      .msg-row.char .msg-bubble.voice-card span,
      .msg-row.char .msg-bubble.voice-card .voice-trans-box {
        color: var(--text-main) !important;
      }

      /* 2. æ ¸å¿ƒä¿®æ­£ï¼šå£°æ³¢çº¿ (å®ƒä»¬æ˜¯ div èƒŒæ™¯ï¼Œä¸æ˜¯æ–‡å­—ï¼) */
      .msg-row.char .msg-bubble.voice-card .v-line {
        background-color: var(--text-main) !important;
        opacity: 0.7; /* ç¨å¾®é€æ˜ä¸€ç‚¹æ›´æœ‰è´¨æ„Ÿ */
      }

      /* 3. ä¿®æ­£æ’­æ”¾æŒ‰é’® (èƒŒæ™¯æ·±è‰²ï¼Œå›¾æ ‡ç™½è‰²) */
      .msg-row.char .msg-bubble.voice-card .voice-icon {
        background-color: var(--btn-new-bg) !important; /* æˆ–è€…ç”¨ var(--text-main) */
        color: var(--text-main) !important; /* å›¾æ ‡é¢œè‰² */
      }

      /* 4. ä¿®æ­£è½¬æ–‡å­—åŒºåŸŸçš„åˆ†éš”çº¿ (ä¸ç„¶çœ‹ä¸è§) */
      .msg-row.char .msg-bubble.voice-card .voice-trans-box {
        border-top: 1px dashed rgba(0, 0, 0, 0.1) !important;
      }

      /* === âœ¨ 2. åˆ†ç»„æŠ˜å åŠ¨ç”» === */

      .chat-group-header {
        /* padding: 10px 15px; */
        font-size: 0.9rem;
        font-weight: 800;
        color: var(--text-light);
        background: #f4f6f9;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
      }
      .chat-group-arrow {
        transition: transform 0.3s;
      }
      .chat-group-header.collapsed .chat-group-arrow {
        transform: rotate(-90deg);
      }

      .chat-group-list {
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
        max-height: 2000px; /* è¶³å¤Ÿå¤§çš„å€¼ */
        opacity: 1;
      }
      .chat-group-list.collapsed {
        max-height: 0;
        opacity: 0;
      }

      /* === âœ¨ [æœ€ç»ˆç‰ˆ] å³æ»‘äº¤äº’ä¸åˆ†ç»„æ ·å¼ === */

      /* 1. åˆ—è¡¨å®¹å™¨ */
      .chat-list-box {
        padding-bottom: 100px;
        overflow-x: hidden; /* é˜²æ­¢æ¨ªå‘æ»šåŠ¨æ¡ */
      }

      /* 2. åŒ…è£…å™¨ï¼šå¤„ç†æ»‘åŠ¨å±‚çº§ (å¿…é¡»æœ‰å›ºå®šé«˜åº¦) */
      .chat-item-wrapper {
        position: relative;
        margin-bottom: 11px;
        height: 80px;
        border-radius: 24px;
      }

      /* 3. èƒŒåçš„æ“ä½œå±‚ (Swipe Actions) */
      .swipe-actions-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f0f2f5;
        border-radius: 24px;
        display: flex;
        align-items: center;
        padding-left: 25px; /* æŒ‰é’®ä½ç½® */
        z-index: 1; /* åœ¨åº•å±‚ */
      }

      .swipe-btn-gear {
        width: 45px;
        height: 45px;
        background: var(--text-main);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 1.2rem;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .swipe-btn-gear:active {
        transform: scale(0.9);
      }

      /* 4. å‰æ™¯å¡ç‰‡ (Chat Card) */
      .chat-item-card {
        position: relative;
        z-index: 2; /* åœ¨ä¸Šå±‚ */
        width: 100%;
        height: 100%;
        background: #fff;
        border-radius: 24px;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.02);
        transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* å›å¼¹åŠ¨ç”» */
        /* touch-action: pan-y; å…è®¸å‚ç›´æ»šåŠ¨ï¼Œç¦æ­¢æ°´å¹³åŸç”Ÿæ»šåŠ¨ï¼Œäº¤ç»™JSå¤„ç† */
      }

      /* 5. åˆ†ç»„æ ‡é¢˜ */
      .chat-group-header {
        font-size: 0.85rem;
        font-weight: 800;
        color: #b2bec3;
        margin: 15px 5px 8px 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        background: transparent; /* è¦†ç›–æ—§æ ·å¼ */
      }
      .chat-group-header i {
        transition: transform 0.3s;
      }
      .chat-group-header.collapsed i {
        transform: rotate(-90deg);
      }

      /* 6. æŠ˜å å®¹å™¨ */
      .chat-group-list {
        overflow: hidden;
        transition: max-height 0.3s ease, opacity 0.3s ease;
        max-height: 5000px; /* é»˜è®¤å±•å¼€ */
        opacity: 1;
      }
      .chat-group-list.collapsed {
        max-height: 0;
        opacity: 0;
      }

      /* 7. åˆ†ç»„é€‰æ‹© Chips (å¼¹çª—é‡Œ) */
      .group-chip {
        padding: 8px 14px;
        border-radius: 20px;
        background: #f0f2f5;
        color: #636e72;
        font-size: 0.85rem;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
        font-weight: 600;
      }
      .group-chip.active {
        background: #fff;
        color: var(--text-main);
        border-color: var(--text-main);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      /* === âœ¨ æ°”æ³¡æ“ä½œèœå• === */
      .bubble-menu {
        position: fixed;
        z-index: 1000;
        background: #fff;
        color: #fff;
        border-radius: 8px;
        padding: 8px 0;
        min-width: 120px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        animation: fadeIn 0.2s ease;
      }
      .bubble-menu .menu-item {
        padding: 8px 16px;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .bubble-menu .menu-item:active {
        background: rgba(255, 255, 255, 0.1);
      }
      .bubble-menu .menu-item.delete {
        color: #ff7675; /* çº¢è‰²åˆ é™¤ */
      }

      /* ç‚¹å‡»é®ç½© (ç”¨äºç‚¹å‡»ç©ºç™½å¤„å…³é—­èœå•) */
      .menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 999;
        display: none;
      }
      /* === ğŸ› ï¸ ä¿®å¤ï¼šUser å‘é€ç‰¹æ®Šæ°”æ³¡çš„å¯¹é½é—®é¢˜ === */
      .msg-row.user .msg-bubble.voice-card,
      .msg-row.user .msg-bubble.image-card,
      .msg-row.user .msg-bubble.sticker-card,
      .msg-row.user .msg-bubble.transfer-card {
        /* æ¶ˆé™¤å¯èƒ½çš„å·¦æµ®åŠ¨å½±å“ */
        margin-left: auto;
        margin-right: 0;

        /* é¢œè‰²è°ƒæ•´ï¼šç”¨æˆ·å‘çš„ç‰¹æ®Šæ°”æ³¡èƒŒæ™¯å¯ä»¥å¾®è°ƒï¼Œæˆ–è€…ä¿æŒç™½è‰² */
        background: #fff !important;
        color: #333 !important;
      }

      /* åªè¦æ˜¯ User å‘çš„æ¶ˆæ¯ï¼Œå†…éƒ¨æ–‡æœ¬é¢œè‰²éƒ½è¦ä¿®æ­£ï¼ˆé˜²æ­¢è¢«é»˜è®¤çš„ç™½è‰²æ–‡å­—è¦†ç›–çœ‹ä¸è§ï¼‰ */
      .msg-row.user .msg-bubble.voice-card .voice-trans-box,
      .msg-row.user .msg-bubble.image-card .img-desc {
        color: #555 !important;
      }
      /* === âœ¨ ç²¾è‡´èŠå¤©åŠŸèƒ½èœå• (Chat Action Menu) === */
      .chat-action-menu {
        position: absolute;
        bottom: 80px; /* åœ¨è¾“å…¥æ¡†ä¸Šæ–¹ */
        left: 15px;
        right: 15px; /* æ’‘æ»¡ä¸¤ä¾§ï¼Œç•™å‡ºè¾¹è· */
        background: rgba(255, 255, 255, 0.95); /* å‡ ä¹ä¸é€æ˜çš„ç™½åº• */
        backdrop-filter: blur(10px); /* ç£¨ç ‚æ•ˆæœ */
        border-radius: 24px;
        padding: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); /* æŸ”å’Œçš„å¤§æŠ•å½± */
        z-index: 400; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */

        /* å¸ƒå±€ï¼šå››ç­‰åˆ† */
        display: none; /* é»˜è®¤éšè—ï¼Œç”± JS æ§åˆ¶æ˜¾ç¤º grid */
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;

        animation: menuPopUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        transform-origin: bottom center;
      }

      /* èœå•å¼¹å‡ºçš„Qå¼¹åŠ¨ç”» */
      @keyframes menuPopUp {
        0% {
          transform: scale(0.8) translateY(20px);
          opacity: 0;
        }
        100% {
          transform: scale(1) translateY(0);
          opacity: 1;
        }
      }

      .action-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .action-item:active {
        transform: scale(0.9);
      }

      /* å›¾æ ‡åœ†å½¢èƒŒæ™¯ */
      .icon-box {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        color: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: filter 0.2s;
      }
      .action-item:hover .icon-box {
        filter: brightness(1.1);
      }

      .action-item span {
        font-size: 0.8rem;
        color: #636e72;
        font-weight: 600;
      }
      /* === âœ¨ ç²¾è‡´èŠå¤©åŠŸèƒ½èœå• (Chat Action Menu) === */
      .chat-action-menu {
        position: absolute;
        bottom: 80px; /* åœ¨è¾“å…¥æ¡†ä¸Šæ–¹ */
        left: 15px;
        right: 15px; /* æ’‘æ»¡ä¸¤ä¾§ */
        background: rgba(255, 255, 255, 0.95); /* å‡ ä¹ä¸é€æ˜çš„ç™½åº• */
        backdrop-filter: blur(10px); /* ç£¨ç ‚ */
        border-radius: 24px;
        padding: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); /* æ¼‚äº®çš„å¤§æŠ•å½± */
        z-index: 400; /* âœ… æé«˜å±‚çº§ï¼Œç¡®ä¿åœ¨æœ€ä¸Šå±‚ */

        /* å¸ƒå±€ï¼šå››ç­‰åˆ† */
        display: none; /* é»˜è®¤éšè—ï¼Œç”± JS æ§åˆ¶æ”¹ä¸º grid */
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;

        animation: menuPopUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        transform-origin: bottom center;
      }

      @keyframes menuPopUp {
        0% {
          transform: scale(0.8) translateY(20px);
          opacity: 0;
        }
        100% {
          transform: scale(1) translateY(0);
          opacity: 1;
        }
      }

      .action-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .action-item:active {
        transform: scale(0.9);
      }

      /* å›¾æ ‡åœ†å½¢èƒŒæ™¯ */
      .icon-box {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        color: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: filter 0.2s;
      }
      .action-item:hover .icon-box {
        filter: brightness(1.1);
      }

      .action-item span {
        font-size: 0.8rem;
        color: #636e72;
        font-weight: 600;
      }

      /* === ğŸ› ï¸ ä¿®å¤ï¼šUser å‘é€ç‰¹æ®Šæ°”æ³¡ (é»‘è‰²ä¸»é¢˜) === */

      /* 1. å®¹å™¨æ ·å¼ï¼šèƒŒæ™¯å˜é»‘ï¼Œæ–‡å­—å˜ç™½ï¼Œé å³å¯¹é½ */
      .msg-row.user .msg-bubble.voice-card,
      .msg-row.user .msg-bubble.image-card,
      .msg-row.user .msg-bubble.sticker-card {
        margin-left: auto;
        margin-right: 0;
        background: var(--text-main) !important; /* é»‘è‰²èƒŒæ™¯ */
        color: #fff !important; /* ç™½è‰²æ–‡å­— */
        border: 1px solid rgba(255, 255, 255, 0.1); /* å¾®å¼±çš„è¾¹æ¡† */
      }

      /* 2. ä¿®æ­£å†…éƒ¨æ–‡å­—é¢œè‰² (å¼ºåˆ¶å˜ç™½) */
      .msg-row.user .msg-bubble.voice-card .voice-trans-box,
      .msg-row.user .msg-bubble.image-card .img-desc,
      .msg-row.user .msg-bubble.sticker-card .sticker-content,
      .msg-row.user .msg-bubble.voice-card span {
        color: #fff !important;
      }
      .msg-row.user .msg-bubble.sticker-card .sticker-ext {
        color: rgba(255, 255, 255, 0.5);
      }

      /* 3. ä¿®æ­£è¯­éŸ³æ¡ç»„ä»¶ (åè‰²å¤„ç†) */
      .msg-row.user .msg-bubble.voice-card .voice-icon {
        background: transparent !important; /* æ’­æ”¾æŒ‰é’®å˜ç™½ */
        color: #fff !important; /* å›¾æ ‡å˜é»‘ */
      }
      .msg-row.user .msg-bubble.voice-card .v-line {
        background: #fff !important; /* å£°æ³¢å˜ç™½ */
      }
      .msg-row.user .msg-bubble.voice-card .voice-trans-box {
        border-top-color: rgba(255, 255, 255, 0.2) !important; /* åˆ†éš”çº¿å˜æ·¡ç™½ */
      }

      /* 4. ä¿®æ­£å›¾ç‰‡å ä½ç¬¦ */
      .msg-row.user .msg-bubble.image-card .img-placeholder {
        background: rgba(255, 255, 255, 0.1) !important;
        color: rgba(255, 255, 255, 0.5) !important;
      }

      /* 5. è½¬è´¦å¡ç‰‡ä¿æŒé å³ (é¢œè‰²ä¿æŒåŸæ ·ï¼Œå› ä¸ºæ˜¯é‡‘é’±ç‰¹æ•ˆ) */
      .msg-row.user .msg-bubble.transfer-card {
        margin-left: auto;
        margin-right: 0;
      }
      /* === ğŸš‘ ä¿®å¤ï¼šè®© .show ä¹Ÿèƒ½æ˜¾ç¤ºå¼¹çª— === */
      .modal-overlay.show {
        display: flex !important;
        opacity: 1 !important;
        pointer-events: auto !important;
      }
      .msg-row.user .msg-bubble.transfer-card {
        background: var(--text-main) !important;
        color: #fff !important;
      }

      /* === âœ¨ ç²¾è‡´èŠå¤©åŠŸèƒ½èœå• (ä¿®å¤ç‰ˆ) === */
      .chat-action-menu {
        position: absolute;
        bottom: 80px;
        left: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 24px;
        padding: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        z-index: 400;

        /* å¸ƒå±€ï¼šå››ç­‰åˆ† */
        display: none;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;

        animation: menuPopUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        transform-origin: bottom center;
      }

      /* èœå•æ˜¾ç¤ºæ—¶çš„çŠ¶æ€ */
      .chat-action-menu.show {
        display: grid !important; /* å¼ºåˆ¶æ˜¾ç¤º */
      }

      @keyframes menuPopUp {
        0% {
          transform: scale(0.8) translateY(20px);
          opacity: 0;
        }
        100% {
          transform: scale(1) translateY(0);
          opacity: 1;
        }
      }

      .action-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .action-item:active {
        transform: scale(0.9);
      }

      .icon-box {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        color: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: filter 0.2s;
      }
      .action-item:hover .icon-box {
        filter: brightness(1.1);
      }

      .action-item span {
        font-size: 0.8rem;
        color: #636e72;
        font-weight: 600;
      }
      /* === å¼•ç”¨åŠŸèƒ½æ ·å¼ === */

      /* 1. è¾“å…¥æ¡†ä¸Šæ–¹çš„é¢„è§ˆæ¡ */

      .chat-room-footer-inner {
        background: #fff;
        padding: 17px 15px 10px 15px;
        border-top: 1px solid #eee;
        width: 100%;
      }

      .reply-preview-bar {
        background: #f8f9fa;
        padding: 8px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #eee;
        animation: slideUp 0.2s ease;
        width: 100%;
      }
      @keyframes slideUp {
        from {
          transform: translateY(10px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .rp-content {
        display: flex;
        gap: 10px;
        align-items: center;
        overflow: hidden;
      }
      .rp-line {
        width: 3px;
        height: 20px;
        background: var(--text-main);
        border-radius: 2px;
      }
      .rp-text {
        font-size: 0.85rem;
        color: #636e72;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 250px;
      }
      .rp-close {
        cursor: pointer;
        padding: 5px;
        color: #b2bec3;
      }
      .rp-close:hover {
        color: #ff7675;
      }

      /* 2. æ°”æ³¡å†…éƒ¨çš„å¼•ç”¨å— */
      .msg-quote-block {
        background: rgba(0, 0, 0, 0.04);
        border-left: 3px solid rgba(0, 0, 0, 0.2);
        padding: 6px 10px;
        border-radius: 9px;
        margin-bottom: 6px;
        font-size: 0.8rem;
        color: #636e72;
        display: flex;
        flex-direction: column;
        user-select: none; /* é˜²æ­¢å¤åˆ¶å¤šä½™å†…å®¹ */
        /* === ğŸ”´ æ–°å¢è¿™é‡Œ === */
        max-width: 240px; /* é™åˆ¶å¼•ç”¨å—çš„æœ€å¤§å®½åº¦ï¼Œè¶…è¿‡å°±æˆªæ–­ */
        /* æˆ–è€…ä½¿ç”¨ width: 100%; ä½†ä¾èµ–çˆ¶çº§é™åˆ¶ */
      }
      .quote-name {
        font-weight: 700;
        font-size: 0.86rem;
        margin-bottom: 7px;
        opacity: 0.7;
      }
      .quote-content {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-style: italic;
        /* é…åˆä¸Šé¢çš„ max-width ç”Ÿæ•ˆ */
        max-width: 100%;
      }

      /* é€‚é… User æ°”æ³¡é‡Œçš„å¼•ç”¨å— (é¢œè‰²åè½¬) */
      .msg-row.user .msg-quote-block {
        /* background: rgba(255, 255, 255, 0.15); */
        background: rgb(0 0 0 / 20%);
        border-left-color: rgba(255, 255, 255, 0.5);
        color: rgba(255, 255, 255, 0.9);
        /* ç¡®ä¿å¼•ç”¨å—ä¹Ÿä¸ä¼šæ’‘çˆ† User æ°”æ³¡ */
        max-width: 100%;
        box-sizing: border-box;
      }
      /* 1. é¦–å…ˆï¼Œå°†æ‰€æœ‰æ°”æ³¡è®¾ä¸ºâ€œå†…å®¹è‡ªé€‚åº”â€ */
      /* è¿™æ ·çº¯æ–‡æœ¬ã€è¡¨æƒ…åŒ…å°±ä¸ä¼šè¢«æ‹‰å¾—å¾ˆå®½ï¼Œä¹Ÿä¸ä¼šå› ä¸ºå®½åº¦å¤ªå°è€Œæ¢è¡Œ */
      .msg-bubble {
        width: fit-content !important; /* æ ¸å¿ƒï¼šæ ¹æ®æ–‡å­—å¤šå°‘å†³å®šå®½åº¦ */
        max-width: 100%; /* é™åˆ¶æœ€å¤§ä¸æ’‘çˆ†çˆ¶å®¹å™¨ */
        min-width: 40px; /* åªæœ‰å‡ ä¸ªå­—æ—¶ä¹Ÿä¸è‡³äºå¤ªçª„ */
      }

      /* 2. ä¸“é—¨é’ˆå¯¹ï¼šã€Userä¾§ã€‘ä¸”ã€åŒ…å«å¼•ç”¨å—ã€‘çš„æ°”æ³¡ */
      /* ä½¿ç”¨ :has(.msg-quote-block) æ¥æ£€æµ‹æ°”æ³¡é‡Œæœ‰æ²¡æœ‰å¼•ç”¨æ¡ */
      .msg-row.user .msg-bubble:has(.msg-quote-block) {
        width: 86% !important; /* åªæœ‰è¿™ç§æƒ…å†µï¼Œå¼ºåˆ¶å®½åº¦ä¸º 86% */

        /* ğŸš‘ é˜²é®æŒ¡è¡¥ä¸ï¼šå¦‚æœ 86% è¿˜æ˜¯å¤ªå®½æŒ¡ä½å¤´åƒï¼Œè¯·æŠŠä¸Šé¢è¿™è¡Œæ”¹æˆä¸‹é¢è¿™è¡Œï¼š */
        /* width: calc(100% - 55px) !important; */
        /* è§£é‡Šï¼š100% å‡å»å¤´åƒçš„å¤§æ¦‚å®½åº¦ï¼Œè¿™æ ·æ°¸è¿œä¸ä¼šç›–ä½å¤´åƒ */
      }
      /* === âš™ï¸ èŠå¤©å®¤è®¾ç½®é¢æ¿ === */
      .cr-settings-menu {
        position: absolute;
        top: 60px;
        right: 20px;
        background: #fff;
        border-radius: 16px;
        padding: 15px;
        width: 180px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        z-index: 500;

        /* åˆå§‹çŠ¶æ€ï¼šéšè— + é€æ˜ + ä¸Šç§» */
        display: none;
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* æ¿€æ´»çŠ¶æ€ï¼šæ˜¾ç¤º */
      .cr-settings-menu.active {
        opacity: 1;
        transform: translateY(0);
      }

      .cr-setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 5px;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-main);
      }

      .cr-setting-item.delete {
        color: #ff7675;
        cursor: pointer;
        justify-content: flex-start;
        gap: 10px;
        transition: opacity 0.2s;
      }
      .cr-setting-item.delete:hover {
        opacity: 0.7;
      }

      .cr-label {
        display: flex;
        flex-direction: column;
      }

      .cr-input-num {
        width: 60px;
        padding: 6px;
        border: 1px solid #eee;
        border-radius: 8px;
        text-align: center;
        font-family: var(--font-ui);
        outline: none;
      }
      .cr-input-num:focus {
        border-color: var(--text-main);
      }

      .cr-divider {
        height: 1px;
        background: #f0f2f5;
        margin: 8px 0;
      }

      /* === âœ¨ è¯»å¿ƒé¢æ¿æ ·å¼ === */
      .status-card-container {
        background: #fff;
        width: 90%;
        max-width: 380px;
        height: 80vh;
        border-radius: 24px;
        position: relative;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;

        /* åˆå§‹ç¼©å° */
        transform: scale(0.9);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      /* æ¿€æ´»çŠ¶æ€ */
      .modal-overlay.active .status-card-container {
        transform: scale(1);
        opacity: 1;
      }

      .status-header {
        padding: 13px 21px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
      }
      .status-title {
        font-weight: 800;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .status-timestamp {
        font-size: 0.7rem;
        color: #b2bec3;
        text-align: center;
      }
      .status-nav-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--text-main);
        transition: all 0.2s;
      }
      .status-nav-btn:active {
        transform: scale(0.9);
      }

      .close-status-btn {
        position: absolute;
        bottom: 37px;
        left: 50%;
        transform: translateX(-50%);
        width: 44px;
        height: 44px;
        background: var(--text-main);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        font-size: 1.2rem;
      }

      .status-scroll-content {
        /* ä¿æŒåŸæœ‰çš„æ ·å¼ï¼Œåªä¿®æ”¹ padding-bottom */
        flex: 1;
        overflow-y: auto;
        padding: 20px;

        /* âœ… å…³é”®ä¿®æ”¹ï¼šåº•éƒ¨ç•™å‡ºæ¯” footer é«˜åº¦å¤šä¸€ç‚¹çš„ç©ºé—´ */
        padding-bottom: 89px;

        background: #fff;
      }

      /* 1. Grid Info */
      .status-grid-row {
        display: grid;
        gap: 14px;
        margin-bottom: 20px;
      }
      .st-box {
        flex: 1;
        /* background: #f0f2f5; */
        background: url(https://i.postimg.cc/zvyKvvyy/Screenshot-2026-01-12-22-17-06-601-com-xingin-xhs.png);
        padding: 12px;
        border-radius: 16px;
        text-align: center;
      }
      .st-label {
        font-size: 0.7rem;
        color: #74878f;
        margin-bottom: 5px;
        text-transform: uppercase;
        font-weight: bold;
      }
      .st-val {
        /* font-weight: 700; */
        color: var(--text-main);
        font-size: 0.86rem;
        line-height: 1.6;
      }

      /* 2. Sections */
      .st-section {
        margin-bottom: 25px;
      }
      .st-label-row {
        font-size: 0.86rem;
        font-weight: 700;
        color: var(--text-light);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .st-text-bubble {
        /* background: #e3f2fd; */
        background: url(https://i.postimg.cc/FzY3zzYN/Screenshot-2026-01-12-22-16-46-357-com-xingin-xhs.png);
        color: #2d3436;
        padding: 15px;
        border-radius: 16px;
        border-bottom-left-radius: 2px;
        font-size: 0.86rem;
        line-height: 1.6;
        position: relative;
      }

      /* æ·±å±‚å¿ƒç† */
      .st-section.dark-mode .st-text-plain {
        /* background: url(https://i.postimg.cc/ZnWpnnCg/Screenshot-2026-01-12-22-17-19-953-com-xingin-xhs.png); */
        background: #ffeaef;
        color: #7f4a56;
        background-size: cover;
        padding: 15px;
        border-radius: 12px;
        font-size: 0.86rem;
        line-height: 1.6;
        font-family: var(--font-mono);
        border-left: 4px solid #ffb9b9;
      }

      /* å¤‡å¿˜å½• */
      .st-section.note-mode .st-handwriting {
        /* background: #fff8e1; */
        background: url(https://i.postimg.cc/zvyKvvyy/Screenshot-2026-01-12-22-17-06-601-com-xingin-xhs.png);
        color: #375d38;
        padding: 15px;
        border-radius: 7px;
        box-shadow: 2px 2px 5px rgb(207 220 198);
        font-family: var(--font-ui);
        transform: rotate(-1deg);
        border: 1px solid #b0d591;
        font-size: 0.89rem;
      }

      /* æ—¥è®°å¡ç‰‡ */
      .diary-card {
        /* background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); */
        background: url(https://i.postimg.cc/zXfMGCH2/1768121295054.png);
        padding: 14px;
        border-radius: 20px;
        position: relative;
        overflow: hidden;
        color: #2d3436;
        margin-top: 10px;
      }
      .diary-icon {
        font-size: 2rem;
        opacity: 0.2;
        position: absolute;
        top: 10px;
        right: 10px;
      }
      .diary-content {
        position: relative;
        z-index: 2;
        font-family: var(--font-serif);
        line-height: 1.8;
        font-size: 0.86rem;
        /* background: rgb(255 255 255 / 16%); */
        padding: 1px 9px;
        border-radius: 12px;
        /* backdrop-filter: blur(5px);*/
      }
      .diary-deco {
        position: absolute;
        bottom: 8px;
        right: 15px;
        font-size: 0.6rem;
        letter-spacing: 2px;
        opacity: 0.5;
        font-weight: 800;
      }

      .status-footer-hint {
        /* æ ¸å¿ƒå®šä½ */
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;

        /* å¸ƒå±€ä¸ç¾åŒ– */
        text-align: center;
        padding: 15px 0; /* å¢åŠ ä¸€äº›ä¸Šä¸‹ç©ºé—´ */
        font-size: 0.75rem;
        color: #b2bec3;

        /* èƒŒæ™¯å¤„ç†ï¼šåŠ ä¸€ä¸ªç™½è‰²æ¸å˜èƒŒæ™¯ï¼Œé˜²æ­¢æ–‡å­—å’Œæ»šåŠ¨çš„åº•éƒ¨å†…å®¹é‡å éš¾çœ‹ */
        background: linear-gradient(to top, #fff 50%, rgba(255, 255, 255, 0) 100%);

        /* å±‚çº§ä¸äº¤äº’ */
        z-index: 10; /* ç¡®ä¿æµ®åœ¨æ»šåŠ¨å†…å®¹ä¸Šé¢ */
        pointer-events: none; /* è®©é¼ æ ‡ç‚¹å‡»èƒ½ç©¿é€å®ƒï¼ˆå¦‚æœä¸å¸Œæœ›æŒ¡ä½åº•ä¸‹å¯èƒ½çš„ç‚¹å‡»ï¼‰ */
      }
      /* === 1. éšè—æ—¥è®°å›¾æ ‡ === */
      .diary-icon {
        display: none !important; /* å¼ºåˆ¶éšè— */
      }

      /* === 2. åˆ‡æ¢åŠ¨ç”»å…³é”®å¸§ === */

      /* å‘å·¦æ»‘å‡º (ç‚¹ä¸‹ä¸€é¡µæ—¶ï¼Œå½“å‰å†…å®¹å¾€å·¦èµ°) */
      @keyframes slideOutToLeft {
        to {
          transform: translateX(-40px);
          opacity: 0;
        }
      }
      /* ä»å³æ»‘å…¥ (ç‚¹ä¸‹ä¸€é¡µæ—¶ï¼Œæ–°å†…å®¹ä»å³è¾¹è¿›æ¥) */
      @keyframes slideInFromRight {
        from {
          transform: translateX(40px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* å‘å³æ»‘å‡º (ç‚¹ä¸Šä¸€é¡µæ—¶ï¼Œå½“å‰å†…å®¹å¾€å³èµ°) */
      @keyframes slideOutToRight {
        to {
          transform: translateX(40px);
          opacity: 0;
        }
      }
      /* ä»å·¦æ»‘å…¥ (ç‚¹ä¸Šä¸€é¡µæ—¶ï¼Œæ–°å†…å®¹ä»å·¦è¾¹è¿›æ¥) */
      @keyframes slideInFromLeft {
        from {
          transform: translateX(-40px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* åŠ¨ç”»ç±» (JSæ§åˆ¶) */
      .anim-out-left {
        animation: slideOutToLeft 0.25s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }
      .anim-in-right {
        animation: slideInFromRight 0.25s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }

      .anim-out-right {
        animation: slideOutToRight 0.25s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }
      .anim-in-left {
        animation: slideInFromLeft 0.25s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }
      /* === 1. è®©å¼•ç”¨å—å˜æ‰‹å‹ï¼Œå¹¶å¢åŠ ç‚¹å‡»åé¦ˆ === */
      .msg-quote-block {
        cursor: pointer; /* é¼ æ ‡å˜æ‰‹å‹ */
        transition: background 0.2s;
      }
      .msg-quote-block:hover {
        background: rgba(0, 0, 0, 0.08); /* æ‚¬åœç¨å¾®å˜æ·± */
      }
      /* é€‚é…ç”¨æˆ·æ°”æ³¡é‡Œçš„å¼•ç”¨å—æ‚¬åœ */
      .msg-row.user .msg-quote-block:hover {
        background: rgb(0, 0, 0);
      }

      /* === 2. é«˜äº®é—ªçƒåŠ¨ç”» (ç”¨äºè·³è½¬åçš„è§†è§‰æç¤º) === */
      /* ================= âœ¨ ä¿®å¤ç‰ˆï¼šå¼•ç”¨é«˜äº®åŠ¨ç”» (è‡ªåŠ¨å›å¼¹) ================= */

      /* 1. Char ä¾§åŠ¨ç”»ï¼šæ·¡é»„è‰²é—ªçƒ (ä¿æŒä¸å˜)
            @keyframes flashHighlightChar {
              0% {
                background-color: rgba(255, 255, 255);
                transform: scale(1);
              }
              30% {
                background-color: rgba(255, 234, 167, 0.9);
                transform: scale(1.02);
              }
              100% {
                background-color: rgba(255, 255, 255);
                transform: scale(1);
              }
            }

             2. User ä¾§åŠ¨ç”»ï¼šæ·±ç°è‰²é—ªçƒ (åŠ¨ç”»ç»“æŸåè‡ªåŠ¨å˜å›é»‘)
            @keyframes flashHighlightUser {
              0% {
                background-color: #2d3436;
                transform: scale(1);
              }
              30% {
                background-color: #8a9599;
                transform: scale(1.02);
                border-color: #8a9599;
              }
              100% {
                background-color:#2d3436;
                transform: scale(1);
              }
            } */

      /* 1. ğŸŸ¡ Char ä¾§åŠ¨ç”»ï¼šæ·¡é»„è‰²æœå†»æ‘‡æ™ƒ */
      @keyframes jellyHighlightChar {
        0% {
          transform: scale(1, 1);
          background-color: rgb(255, 255, 255);
        }
        30% {
          transform: scale(1.15, 0.85);
          background-color: rgba(255, 234, 167, 0.9);
        } /* å‹æ‰ */
        40% {
          transform: scale(0.9, 1.1);
        } /* æ‹‰é•¿ */
        50% {
          transform: scale(1.05, 0.95);
        } /* å›å¼¹ */
        65% {
          transform: scale(0.98, 1.02);
        } /* å¾®è°ƒ */
        100% {
          transform: scale(1, 1);
          background-color: rgb(255, 255, 255);
        }
      }

      /* 2. âš« User ä¾§åŠ¨ç”»ï¼šæ·±ç°è‰² + å·¦å³æ‘‡æ‘†æœå†»æ„Ÿ */
      @keyframes jellyHighlightUser {
        0% {
          transform: scale(1) rotate(0deg);
          background: #2d3436; /* åˆå§‹é»‘ */
          border-color: #2d3436;
        }

        /* ğŸ’¥ 30%: å˜è‰²å¼€å§‹ï¼Œç¨å¾®æ”¾å¤§ï¼Œå‘å·¦æ­ª */
        30% {
          transform: scale(1.05) rotate(-3deg);
          background: #8a9599; /* å˜æ·±ç° */
          border-color: #8a9599;
        }

        /* ğŸ’¥ 50%: å‘å³æ­ª */
        50% {
          transform: scale(1.05) rotate(3deg);
          background: #8a9599;
          border-color: #8a9599;
        }

        /* ğŸ’¥ 70%: å°å¹…å›æ­£éœ‡è¡ */
        70% {
          transform: scale(1.02) rotate(-1deg);
          background: #8a9599;
          border-color: #8a9599;
        }

        /* 100%: æ¢å¤åŸçŠ¶ */
        100% {
          transform: scale(1) rotate(0deg);
          background: #2d3436; /* å˜å›é»‘ */
          border-color: #2d3436;
        }
      }

      /* 3. åº”ç”¨åŠ¨ç”»ç±» (Char é»˜è®¤) */
      /* æ³¨æ„ï¼šå»æ‰äº† forwardsï¼ŒåŠ¨ç”»æ’­å®Œè‡ªåŠ¨ç§»é™¤æ ·å¼ */
      /* 3. Char ä¾§é»˜è®¤åº”ç”¨ */
      .msg-bubble.highlight-anim {
        animation: jellyHighlightChar 1s ease-in-out; /* åŠ å¿«ä¸€ç‚¹èŠ‚å¥æ›´åƒæœå†» */
        transform-origin: center bottom; /* è®¾ç½®åŠ¨ç”»æ”¯ç‚¹ï¼Œæ‘‡æ™ƒæ›´è‡ªç„¶ */
      }

      /* 4. User ä¾§å¼ºåŠ›è¦†ç›– (åŒ…å«æ‰€æœ‰ç‰¹æ®Šå¡ç‰‡) */
      /* ä½¿ç”¨ background ç®€å†™å±æ€§ï¼Œé˜²æ­¢ image-card çš„å›¾ç‰‡èƒŒæ™¯å¹²æ‰° */

      .msg-row.user .msg-bubble.highlight-anim,
      .msg-row.user .msg-bubble.image-card.highlight-anim,
      .msg-row.user .msg-bubble.sticker-card.highlight-anim,
      .msg-row.user .msg-bubble.voice-card.highlight-anim,
      .msg-row.user .msg-bubble.transfer-card.highlight-anim {
        animation: jellyHighlightUser 1.1s ease-in-out !important;
        transform-origin: center bottom;

        /* ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶èƒŒæ™¯å˜è‰² */
        /* background: #636e72 !important;
              background-color: #636e72 !important;
              background-image: none !important; */

        /* ç¡®ä¿è¾¹æ¡†ä¹Ÿå˜è‰² */
        /* border-color: #636e72 !important;
              box-shadow: 0 0 15px rgba(99, 110, 114, 0.5) !important; åŠ ä¸€ç‚¹å‘å…‰æ™•æŸ“ */
      }

      /* 5. ç¡®ä¿åŠ¨ç”»æœŸé—´ï¼Œæ–‡å­—ã€å›¾æ ‡ã€æ‰€æœ‰å­å…ƒç´ å…¨æ˜¯ç™½è‰² */
      .msg-row.user .msg-bubble.highlight-anim *,
      .msg-row.user .msg-bubble.image-card.highlight-anim *,
      .msg-row.user .msg-bubble.sticker-card.highlight-anim *,
      .msg-row.user .msg-bubble.voice-card.highlight-anim *,
      .msg-row.user .msg-bubble.transfer-card.highlight-anim * {
        color: #fff !important;
        border-color: rgba(255, 255, 255, 0.2) !important;
      }

      /* 6. ç‰¹æ®Šå¤„ç†ï¼šå›¾ç‰‡å ä½ç¬¦ */
      .msg-row.user .msg-bubble.image-card.highlight-anim .img-placeholder {
        background: rgba(255, 255, 255, 0.1) !important;
      }
      /* === âœ¨ è®¾ç½®é¢æ¿å¤´åƒæ ·å¼ === */
      .cr-avatar-row {
        display: flex;
        justify-content: space-around;
        align-items: center;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 12px;
      }
      .cr-av-wrapper {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .cr-av-wrapper:active {
        transform: scale(0.9);
      }
      .cr-av-img {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .cr-av-badge {
        position: absolute;
        bottom: 18px;
        right: -2px;
        width: 18px;
        height: 18px;
        background: var(--text-main);
        color: #fff;
        border-radius: 50%;
        font-size: 0.6rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #fff;
      }
      .cr-av-name {
        font-size: 0.75rem;
        font-weight: 700;
        margin-top: 4px;
        color: var(--text-light);
      }
      /* === âœ¨ [æ–°åŠŸèƒ½] ç‹¬ç«‹å¼•ç”¨æ¡å¸ƒå±€ === */

      /* 1. æ°”æ³¡å‚ç›´å®¹å™¨ (Wrapper) */
      .msg-col-flex {
        display: flex;
        flex-direction: column;
        max-width: 100%; /* é˜²æ­¢æ’‘å¼€ */
      }

      /* 2. å¯¹é½æ–¹å¼ */
      /* å¯¹æ–¹çš„æ¶ˆæ¯ï¼šé å·¦å¯¹é½ */
      .msg-row.char .msg-col-flex {
        align-items: flex-start;
      }
      /* æˆ‘çš„æ¶ˆæ¯ï¼šé å³å¯¹é½ */
      .msg-row.user .msg-col-flex {
        align-items: flex-end;
      }

      /* 3. ç‹¬ç«‹å‡ºæ¥çš„å¼•ç”¨æ¡æ ·å¼ (External Quote) */
      .msg-quote-block.external {
        background: #fff; /* ç™½åº• */
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-left: 3px solid #b2bec3; /* å·¦ä¾§å¼ºè°ƒè‰² */
        border-radius: 8px; /* åœ†è§’ */
        padding: 6px 10px;
        margin-top: 7px;
        font-size: 0.86rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03); /* æ·¡æ·¡çš„æŠ•å½± */
        max-width: 220px; /* é™åˆ¶å®½åº¦ï¼Œä¸è¦å¤ªå®½ */
        width: fit-content; /* è‡ªé€‚åº”å†…å®¹å®½åº¦ */
        position: relative;
        z-index: 1;
      }

      /* é€‚é…æ·±è‰²/Userä¾§ */
      .msg-row.user .msg-quote-block.external {
        background: rgba(255, 255, 255, 0.9); /* ç¨å¾®é€ä¸€ç‚¹ */
        border-left-color: #b2bec3; /* ç°è‰²æ¡ */
        color: #636e72;
      }

      /* 4. ç§»é™¤ä¹‹å‰ç»™ç‰¹æ®Šæ°”æ³¡åŠ çš„å†…éƒ¨å¼•ç”¨æ ·å¼è¡¥ä¸ (å¯é€‰ï¼Œä¸åˆ ä¹Ÿä¸å½±å“) */
      .msg-bubble.transfer-card .msg-quote-block {
        display: none;
      } /*ä»¥æ­¤ç±»æ¨ï¼ŒJSé‡Œä¸æ¸²æŸ“å°±è¡Œäº†*/

      /* === âœ¨ User ä¾§ç‹¬ç«‹å¼•ç”¨æ¡ï¼šæ·±è‰²ç³»æ ·å¼ === */
      /* .msg-row.user .msg-quote-block.external {
          background: #2d3436;
          border: 1px solid rgba(255,255,255,0.1);
          border-left: 3px solid rgba(255,255,255,0.8);
          color: rgba(255,255,255,0.95);
          box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      }

      .msg-row.user .msg-quote-block.external .quote-name {
          color: rgba(255,255,255,0.6);
      }

      .msg-row.user .msg-quote-block.external .quote-content {
          color: #fff;
          font-style: italic;
      } */

      /* === âœ¨ éšå–»/ç¿»è¯‘åŠŸèƒ½æ ·å¼ === */

      /* 1. æ°”æ³¡è¡ŒåŒ…è£…å™¨ï¼šä¸ºäº†è®©æŒ‰é’®æ˜¾ç¤ºåœ¨æ°”æ³¡å³ä¾§ */
      .bubble-with-action {
        display: flex;
        align-items: flex-end; /* åº•éƒ¨å¯¹é½ */
        gap: 8px;
        position: relative;
        max-width: 100%;
      }

      /* 2. ç¿»è¯‘æŒ‰é’® (å°å›¾æ ‡) */
      /* === ğŸŒ¸ æ¨±èŠ±/éšå–»æŒ‰é’®æ ·å¼ === */
      .trans-btn-trigger {
        /* 1. é¢œè‰²ï¼šæµ…ç²‰è‰² */
        color: #ffb7d0; /* è¿™æ˜¯ä¸€ä¸ªå¾ˆæ¸©æŸ”çš„æ¨±èŠ±ç²‰ */
        /* æˆ–è€…è¯•è¯•æ¸å˜æ–‡å­— (ä»…å¯¹ icon font æœ‰æ•ˆ) */
        /* background: linear-gradient(to bottom, #ff9a9e, #fecfef);
             -webkit-background-clip: text;
             -webkit-text-fill-color: transparent; */

        font-size: 0.97rem; /* ç¨å¾®è°ƒå¤§ä¸€ç‚¹ */
        cursor: pointer;
        padding: 4px;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); /* Qå¼¹è¿‡æ¸¡ */
        opacity: 0.7;
        margin-bottom: 4px;

        /* åˆå§‹çŠ¶æ€ï¼šç¨å¾®æ­ªä¸€ç‚¹ï¼Œåƒé£˜è½çš„èŠ±ç“£ */
        transform: rotate(-15deg);
      }

      /* æ‚¬åœæ•ˆæœï¼šå˜æ·±ç²‰è‰² + æ—‹è½¬ + æ”¾å¤§ */
      .trans-btn-trigger:hover {
        color: #ff9abd; /* æ·±ç²‰è‰² */
        opacity: 1;
        transform: scale(1.2) rotate(20deg); /* é¼ æ ‡æ”¾ä¸Šå»ä¼šè½¬åŠ¨ */
        filter: drop-shadow(0 2px 4px rgba(255, 118, 117, 0.3)); /* åŠ ä¸€ç‚¹ç²‰è‰²å…‰æ™• */
      }

      /* å¦‚æœä½ é€‰äº† fa-fan (æŠ˜æ‰‡)ï¼Œå¯ä»¥è®©å®ƒä¸€ç›´æ…¢é€Ÿæ‘‡æ‘†ï¼Œå¾ˆå”¯ç¾ */
      @keyframes petal-float {
        0%,
        100% {
          transform: rotate(-10deg);
        }
        50% {
          transform: rotate(10deg);
        }
      }
      .trans-btn-trigger {
        animation: petal-float 3s ease-in-out infinite;
      }

      /* === 3. éšå–»æ°”æ³¡ (å¼¹å‡ºå±‚ - æ™ºèƒ½å®šä½ç‰ˆ) === */
      .metaphor-popup {
        position: absolute;
        bottom: 129%; /* æ˜¾ç¤ºåœ¨æŒ‰é’®ä¸Šæ–¹ */
        padding: 9px 14px;
        background: linear-gradient(0deg, #fffffff0 0%, #ffe2ed 100%);
        color: #f3a1bd;
        /* border: 1px solid rgba(0, 0, 0, 0.05); */
        box-shadow: 0 2px 7px rgb(255 218 231);
        border-radius: 13px;
        font-size: 0.86rem;
        line-height: 1.5;
        z-index: 100;

        /* å®½åº¦é™åˆ¶ */
        width: max-content;
        max-width: 259px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢å¤ªé•¿ */
        white-space: normal; /* å…è®¸æ¢è¡Œ */

        /* === æ ¸å¿ƒï¼šæ¸å˜æ¶ˆå¤±åŠ¨ç”» === */
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px) scale(0.95); /* åˆå§‹çŠ¶æ€ï¼šç¨å¾®ä¸‹æ²‰ä¸”ç¼©å° */
        transition: opacity 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),
          visibility 0.3s; /* ç¡®ä¿æ¶ˆå¤±æ—¶ä¹Ÿæœ‰è¿‡æ¸¡ */
        pointer-events: none; /* éšè—æ—¶ä¸å¯ç‚¹å‡» */
      }

      /* æ¿€æ´»çŠ¶æ€ */
      .metaphor-popup.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
        /* transform åœ¨å…·ä½“çš„å¯¹é½ç±»ä¸­å®šä¹‰ï¼Œè¿™é‡Œä¸è¦†ç›– */
      }

      /* === ä¸‰è§’å½¢é€šç”¨æ ·å¼ === */
      .metaphor-popup::after {
        content: '';
        position: absolute;
        bottom: -6px;
        width: 12px;
        height: 12px;
        background: linear-gradient(135deg, #fdfdfdf0, #fdf9fc);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        border-right: 1px solid rgba(0, 0, 0, 0.05);
        transform: rotate(45deg);
        transition: left 0.2s, right 0.2s; /* ä¸‰è§’å½¢ç§»åŠ¨ä¹ŸåŠ åŠ¨ç”» */
      }

      /* =========================================
         ä¸‰ç§å¯¹é½æ¨¡å¼ (ç”± JS è‡ªåŠ¨åˆ¤æ–­æ·»åŠ ç±»å)
         ========================================= */

      /* æ¨¡å¼ A (é»˜è®¤): é å³å¯¹é½ (æ°”æ³¡åœ¨å·¦ï¼Œä¸‰è§’åœ¨å³) */
      /* é€‚ç”¨äºï¼šå±å¹•å³ä¾§ç©ºé—´å……è¶³ï¼Œæˆ–æ¶ˆæ¯åœ¨å³ä¾§æ—¶ */
      .metaphor-popup.align-right {
        right: -10px;
        left: auto;
        transform-origin: bottom right;
      }
      .metaphor-popup.align-right.show {
        transform: translateY(0) scale(1);
      }
      .metaphor-popup.align-right::after {
        right: 15px; /* ä¸‰è§’åœ¨å³ä¾§ */
        left: auto;
      }

      /* æ¨¡å¼ B: å±…ä¸­å¯¹é½ (æ°”æ³¡å±…ä¸­ï¼Œä¸‰è§’å±…ä¸­) */
      /* é€‚ç”¨äºï¼šé»˜è®¤æ¨¡å¼ä¼šæº¢å‡ºå·¦å±å¹•æ—¶ */
      .metaphor-popup.align-center {
        left: 50%;
        right: auto;
        transform: translateX(-50%) translateY(10px) scale(0.95); /* å±…ä¸­åç§» + åˆå§‹åŠ¨ç”»çŠ¶æ€ */
        transform-origin: bottom center;
      }
      .metaphor-popup.align-center.show {
        transform: translateX(-50%) translateY(0) scale(1); /* ä¿æŒå±…ä¸­åç§» + æ˜¾ç¤º */
      }
      .metaphor-popup.align-center::after {
        left: 50%;
        right: auto;
        margin-left: -6px; /* ä¸‰è§’å½¢å±…ä¸­ä¿®æ­£ */
      }

      /* æ¨¡å¼ C: é å·¦å¯¹é½ (æ°”æ³¡åœ¨å³ï¼Œä¸‰è§’åœ¨å·¦) */
      /* é€‚ç”¨äºï¼šå±…ä¸­æ¨¡å¼ä»ç„¶æº¢å‡ºå·¦å±å¹•ï¼Œæˆ–è€…è¢«è¿«è´´å·¦è¾¹æ—¶ */
      .metaphor-popup.align-left {
        left: -10px;
        right: auto;
        transform-origin: bottom left;
      }
      .metaphor-popup.align-left.show {
        transform: translateY(0) scale(1);
      }
      .metaphor-popup.align-left::after {
        left: 15px; /* ä¸‰è§’åœ¨å·¦ä¾§ */
        right: auto;
      }

      /* éšå–»æ°”æ³¡é‡Œçš„æ ‡ç­¾ */
      .metaphor-label {
        font-size: 0.65rem;
        color: #ff9abd;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 4px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      @keyframes popupFadeIn {
        0% {
          opacity: 0;
          transform: scale(0.8) translateY(10px);
        }
        100% {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }
      /* ================= âœ¨ æŸ¥æ‰‹æœºåŠŸèƒ½ (Phone System) ================= */

      /* 1. æ‚¬æµ®æ‹–åŠ¨æŒ‰é’® */
      .floating-phone-trigger {
        /* position: fixed;
        bottom: 150px;
        right: 20px;
        width: 68px;
        height: 68px; */
        z-index: 900;
        cursor: grab;
        /* === âœ… æ–°å¢ï¼šç¦æ­¢æµè§ˆå™¨é»˜è®¤çš„è§¦æ‘¸æ“ä½œï¼ˆå¦‚æ»šåŠ¨ï¼‰ï¼Œè§£å†³æ‰‹æœºæ‹–åŠ¨å†²çª === */
        touch-action: none;
        transition: transform 0.1s;
        /* åŒå±‚å¤´åƒæ¡†æ•ˆæœ */
        padding: 4px;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(0, 0, 0, 0.05);
        /* === âœ… æ–°å¢ï¼šå¹³æ»‘è¿‡æ¸¡åªé’ˆå¯¹å˜æ¢å¤§å°ï¼Œä¸é’ˆå¯¹ä½ç½®ï¼ˆé˜²æ­¢æ‹–åŠ¨å»¶è¿Ÿï¼‰ === */
        transition: transform 0.1s;
      }
      .floating-phone-trigger:active {
        cursor: grabbing;
        transform: scale(0.95);
      }
      .fp-inner-ring {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 2px solid var(--text-main); /* å†…å±‚å¼ºè°ƒè‰² */
        padding: 2px;
        background: #fff;
      }
      .fp-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        display: block;
      }

      /* 2. æ‰‹æœºå®¹å™¨ (æ¨¡æ€æ¡†) */
      .phone-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(8px);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .phone-overlay.active {
        opacity: 1;
      }

      /* 3. æ‰‹æœºå£³ä¸»ä½“ (Chubby iOS Style) */
      .phone-shell {
        width: 340px;
        height: 680px;
        background: #fff;
        border-radius: 55px; /* èƒ–èƒ–çš„åœ†è§’ */
        box-shadow: 0 0 0 8px #f2f5f8, /* å¤–å£³è¾¹æ¡†é¢œè‰²ï¼Œå¯éšä¸»é¢˜å˜ */ 0 20px 50px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
        transform: scale(0.8);
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: flex;
        flex-direction: column;
      }
      .phone-overlay.active .phone-shell {
        transform: scale(1);
      }

      /* é¡¶éƒ¨åˆ˜æµ·/çµåŠ¨å²›è£…é¥° */
      .phone-notch {
        position: absolute;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 28px;
        background: #000;
        border-radius: 20px;
        z-index: 999;
      }

      /* å±å¹•åŒºåŸŸ */
      .phone-screen {
        flex: 1;
        background: #fcfcfc; /* å±å¹•èƒŒæ™¯ */
        position: relative;
        overflow: hidden;
        padding-top: 50px; /* é¿å¼€åˆ˜æµ· */
      }

      /* === A. é”å±ç•Œé¢ (Lock Screen) === */
      .screen-lock {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url('https://i.postimg.cc/k59MD6ZY/1768474263054.png') center/cover; /* é»˜è®¤å£çº¸ */
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        padding: 80px 20px 50px 20px;
        transition: transform 0.5s ease-in-out;
        color: #333;
        text-shadow: 2px 4px 2px rgba(0, 0, 0, 0.2);
      }
      .screen-lock.unlocked {
        transform: translateY(-100%);
      }
      .lock-time {
        font-size: 3.5rem;
        font-weight: 200;
        font-family: var(--font-code);
        margin-bottom: 13px;
      } /* ä½¿ç”¨ä½ ç°æœ‰çš„å­—ä½“ */
      .lock-date {
        font-size: 1.1rem;
        margin-top: -10px;
        font-weight: 500;
      }
      .slide-to-unlock {
        font-size: 0.9rem;
        opacity: 0.8;
        animation: pulseText 2s infinite;
        cursor: pointer;
      }
      @keyframes pulseText {
        0%,
        100% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
      }

      /* === B. ä¸»å±å¹• (Home Screen) === */
      .screen-home {
        height: 100%;
        padding: 10px 20px;
        display: flex;
        flex-direction: column;
        background: url(https://i.postimg.cc/k59MD6ZY/1768474263054.png);
        background-size: contain;
      }

      /* é¡¶éƒ¨è¿çº¿åŒºåŸŸ */
      .home-link-widget {
        background: rgba(255, 255, 255, 0.6);
        border-radius: 24px;
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 33px;
        margin-top: 44px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
      }
      .hl-avatar {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .hl-conn {
        flex: 1;
        height: 2px;
        background: #ffb7d0; /* ç²‰è‰²ä¸çº¿ */
        position: relative;
        margin: 0 10px;
      }
      /* è´è¶ç»“è£…é¥° */
      .hl-conn::after {
        content: 'ğŸ€';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.2rem;
        background: #fff;
        border-radius: 50%;
        padding: 2px;
      }

      /* APP å›¾æ ‡ç½‘æ ¼ */
      .app-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px 10px;
      }
      .app-icon-wrap {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .app-icon-wrap:active {
        transform: scale(0.9);
      }
      .app-icon {
        width: 54px;
        height: 54px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #fff;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .app-name {
        font-size: 0.75rem;
        color: #636e72;
        font-weight: 600;
      }

      /* é¢œè‰²å®šä¹‰ */
      .bg-chat {
        background: linear-gradient(135deg, #f1eaff 0%, #ffcef1 100%);
      }
      .bg-diary {
        background: linear-gradient(135deg, #ffe9eb 0%, #b6dbff 99%);
      }
      .bg-fav {
        background: linear-gradient(135deg, #fbfffd 0%, #a6e2ff 100%);
      }
      .bg-memo {
        background: linear-gradient(135deg, #fff9f2 0%, #f4c7ff 100%);
      }
      .bg-browser {
        background: linear-gradient(135deg, #faf4ff 0%, #a8d4ff 100%);
      }

      /* === C. APP å†…éƒ¨é¡µé¢ (é€šç”¨) === */
      .app-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #fcfcfc;
        z-index: 20;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        padding-top: 52px;
      }
      #app-diary {
        background: url(https://i.postimg.cc/k59MD6ZY/1768474263054.png);
        background-size: contain;
      }
      .app-screen.open {
        transform: translateX(0);
      }

      .app-header {
        padding: 0 20px 0px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 800;
        font-size: 1.2rem;
        color: var(--text-main);
      }
      .app-back-btn {
        cursor: pointer;
        color: #b2bec3;
        font-size: 1rem;
      }
      .app-magic-btn {
        cursor: pointer;
        color: #ff9abd;
        animation: float 3s infinite ease-in-out;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-3px);
        }
      }

      .app-content-scroll {
        flex: 1;
        overflow-y: auto;
        padding: 21px 20px 40px 20px; /* åº•éƒ¨ç•™ç™½ */
        /* éšè—æ»šåŠ¨æ¡ */
        scrollbar-width: none;
        /* background: url(https://i.postimg.cc/k59MD6ZY/1768474263054.png); */
        /* background-size: contain; */
      }
      .app-content-scroll::-webkit-scrollbar {
        display: none;
      }

      /* --- 1. æ—¥è®°å¡ç‰‡ (Diary Cards) é‡åš --- */

      /* é€šç”¨å®¹å™¨è®¾ç½® */
      .diary-card-item {
        margin-bottom: 20px;
        position: relative;
        cursor: pointer;
        transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        animation: fadeIn 0.4s;
        overflow: hidden;
      }
      .diary-card-item:active {
        transform: scale(0.98);
      }

      /* ================= ğŸ« æ ·å¼ A: ç¥¨æ ¹ (Ticket) - ä¸Šä¸‹ç¼ºå£ç»ˆæç‰ˆ ================= */
      .dc-style-ticket {
        height: 140px;
        border-radius: 12px;
        /* å³ä¾§æ”¹ä¸ºç›´è§’ï¼Œé…åˆæ’•è£‚è¾¹ */
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;

        position: relative;
        /* èƒŒæ™¯å›¾ç”±JSæ³¨å…¥ */
        background-size: cover;
        background-position: center;

        display: flex;
        align-items: center;

        /* ç¦ç”¨é»˜è®¤é˜´å½± */
        box-shadow: none;

        /* âœ¨ ä¿æŒä¹‹å‰çš„å¼ºåŠ›æè¾¹ (åœ¨ç™½åº•å¯è§) */
        filter: drop-shadow(0 0 1px rgba(60, 63, 65, 0.8)) drop-shadow(0 4px 12px rgba(0, 0, 0, 0.15));

        /* === âœ‚ï¸ æ ¸å¿ƒåˆ†å—é®ç½© (5å±‚æ‹¼åˆ) === */

        /* å˜é‡å®šä¹‰ */
        --hole-r: 6px; /* ä¸Šä¸‹å°ç¼ºå£çš„åŠå¾„ */
        --split-pos: 28%; /* åˆ†å‰²çº¿è·ç¦»å³è¾¹çš„ä½ç½® (å¯¹åº” 72% å¤„) */
        --rip-width: 15px; /* å³ä¾§æ’•è£‚è¾¹çš„å®½åº¦ */

        -webkit-mask-image:
              /* 1. å·¦ä¾§ä¸»ä½“ (å«å·¦å¤§å­”) */ radial-gradient(
            circle at 0 50%,
            transparent 10px,
            black 10.5px
          ),
          /* 2. ä¸­é—´ä¸Šç¼ºå£ (è™šçº¿é¡¶ç«¯) */
            radial-gradient(circle at 50% 0, transparent var(--hole-r), black calc(var(--hole-r) + 0.5px)),
          /* 3. ä¸­é—´ä¸‹ç¼ºå£ (è™šçº¿åº•ç«¯) */
            radial-gradient(circle at 50% 100%, transparent var(--hole-r), black calc(var(--hole-r) + 0.5px)),
          /* 4. å³ä¾§ä¸»ä½“ (å®å¿ƒé»‘) */ linear-gradient(black, black),
          /* 5. å³ä¾§è¾¹ç¼˜ (è¿ç»­æ’•è£‚) */ radial-gradient(circle at 100% 50%, transparent 6px, black 6.5px);

        -webkit-mask-size:
              /* 1. å®½ = 72% - 6px (å­”åŠå¾„) */ calc(100% - var(--split-pos) - var(--hole-r))
            100%,
          /* 2. å®½ = 12px (ç›´å¾„), é«˜ = 51% (é˜²ç¼éš™) */ calc(var(--hole-r) * 2) 51%,
          /* 3. åŒä¸Š */ calc(var(--hole-r) * 2) 51%,
          /* 4. å®½ = 28% - 6px(å­”åŠå¾„) - 15px(æ’•è£‚å®½) */ calc(var(--split-pos) - var(--hole-r) - var(--rip-width)) 100%,
          /* 5. æ’•è£‚è¾¹å°ºå¯¸ */ var(--rip-width) 22px;

        -webkit-mask-position:
              /* 1. é å·¦ */ left top,
          /* 2. é å³28%ä½ç½® (æ­£å¥½å¯¹é½è™šçº¿), é é¡¶ */ right var(--split-pos) top 0,
          /* 3. é å³28%ä½ç½®, é åº• */ right var(--split-pos) bottom 0,
          /* 4. é å³15px (ç´§è´´æ’•è£‚å±‚) */ right var(--rip-width) top 0, /* 5. é å³è¾¹ç¼˜ */ right top;

        -webkit-mask-repeat: no-repeat, no-repeat, no-repeat, no-repeat, repeat-y; /* åªæœ‰æ’•è£‚è¾¹å‚ç›´é‡å¤ */

        /* æ ‡å‡†å±æ€§å…¼å®¹ (å¤åˆ¶ä¸€éä»¥é˜²ä¸‡ä¸€) */
        mask-image: radial-gradient(circle at 0 50%, transparent 10px, black 10.5px),
          radial-gradient(circle at 50% 0, transparent 6px, black 6.5px),
          radial-gradient(circle at 50% 100%, transparent 6px, black 6.5px), linear-gradient(black, black),
          radial-gradient(circle at 100% 50%, transparent 6px, black 6.5px);
        mask-size: calc(100% - 28% - 6px) 100%, 12px 51%, 12px 51%, calc(28% - 21px) 100%, 15px 22px;
        mask-position: left top, right 28% top 0, right 28% bottom 0, right 15px top 0, right top;
        mask-repeat: no-repeat, no-repeat, no-repeat, no-repeat, repeat-y;
      }

      /* 1. è™šçº¿åˆ†å‰² - è°ƒæ•´é«˜åº¦é€‚é…ç¼ºå£ */
      .dc-ticket-dash {
        position: absolute;
        right: 28%; /* ä¿æŒå’Œ mask çš„ split-pos ä¸€è‡´ */
        /* ä¸Šä¸‹å„ç•™ 10pxï¼Œé¿å¼€åŠå¾„ 6px çš„ç¼ºå£ï¼Œçœ‹èµ·æ¥åƒæ˜¯è¿æ¥ç€ç¼ºå£ */
        top: 10px;
        bottom: 10px;
        width: 0;
        border-right: 2px dashed rgba(100, 100, 100, 0.4);
        z-index: 5;
      }

      /* 2. å·¦ä¾§å†…å®¹å±‚ */
      .dc-ticket-content {
        flex: 1;
        padding: 15px 35px 15px 25px;
        z-index: 2;
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        /* background: rgb(255 0 0 / 4%); */
        /* backdrop-filter: blur(10px);*/
        color: #2d3436;
      }

      /* 3. å³ä¾§å‰¯åˆ¸ */
      .dc-ticket-stub {
        width: 28%; /* ä¿æŒä¸€è‡´ */
        height: 100%;
        background: rgba(255, 255, 255, 0.55);
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #636e72;
        font-family: var(--font-code);
        font-weight: bold;
        letter-spacing: 2px;
        padding-right: 12px;
      }

      /* å­—ä½“é¢œè‰²é€‚é… */
      .dc-style-ticket .dc-title {
        color: #2d3436;
        font-size: 1.2rem;
        font-weight: 800;
      }
      .dc-style-ticket .dc-date-tag {
        color: #555;
        font-weight: 700;
      }
      .dc-style-ticket .dc-preview {
        color: #444;
        opacity: 1;
        font-weight: 500;
      }

      /* ğŸ–¼ï¸ æ ·å¼ B: CD/ç›¸æ¡† (Frame) - ç£¨ç ‚ç»ç’ƒé£æ ¼ */
      .dc-style-frame {
        border-radius: 20px;
        padding: 6px;
        background: #fff;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
      }
      /* èƒŒæ™¯å›¾å±‚ (æ¨¡ç³Šå¤„ç†) */
      .dc-frame-bg-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        opacity: 0.2; /* æ·¡ä¸€ç‚¹ä½œä¸ºåº•çº¹ */
        filter: blur(10px);
        z-index: 0;
      }
      /* ä¸­é—´å®ä½“å¡ç‰‡ */
      .dc-frame-inner {
        position: relative;
        z-index: 2;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 15px;
        border: 1px solid rgba(255, 255, 255, 0.8);
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .dc-frame-thumb {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        background-size: cover;
        background-position: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
      }

      /* ğŸ“· æ ·å¼ C: æ‹ç«‹å¾— (Polaroid) - ä¿æŒåŸæ · */
      .dc-style-polaroid {
        background: #fff;
        padding: 12px 12px 40px 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: rotate(-1deg);
        text-align: center;
        border: 1px solid #f0f0f0;
      }
      .dc-img-area {
        width: 100%;
        height: 180px; /* ç¨å¾®åŠ é«˜ä¸€ç‚¹ */
        background-color: #eee;
        background-size: cover;
        background-position: center;
        margin-bottom: 12px;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      /* å­—ä½“æ ·å¼å¾®è°ƒ */
      .dc-title {
        font-size: 1.05rem;
        font-weight: 800;
        margin-bottom: 4px;
        line-height: 1.3;
      }
      .dc-preview {
        font-size: 0.8rem;
        opacity: 0.8;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .dc-date-tag {
        font-size: 0.65rem;
        font-family: var(--font-mono);
        opacity: 0.6;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 4px;
      }

      .dc-date {
        font-size: 0.7rem;
        color: #999;
        margin-bottom: 5px;
        font-family: var(--font-mono);
      }

      /* æ—¥è®°è¯¦æƒ…å¼¹å±‚ */
      .diary-detail-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #fff;
        z-index: 30;
        padding: 33px 21px 21px 21px;
        transform: translateY(100%);
        transition: transform 0.3s;
        overflow-y: auto;
      }
      .diary-detail-overlay.open {
        transform: translateY(0);
      }
      .dd-content {
        font-family: var(--font-ui);
        line-height: 1.8;
        color: #444;
      }

      /* === ğŸ’¬ 2. è¯­èŠæ¨¡å— (NPC Chat) === */
      .npc-chat-item {
        display: flex;
        gap: 12px;
        margin-bottom: 18px;
        align-items: center;
        background: #fff;
        padding: 10px;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
      }
      .npc-av {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
      }
      .npc-info {
        flex: 1;
      }
      .npc-name {
        font-size: 0.9rem;
        font-weight: bold;
      }
      .npc-msg {
        font-size: 0.8rem;
        color: #999;
        margin-top: 2px;
      }

      /* === â­ 3. æ”¶è—æ¨¡å— (Favorites) === */
      .fav-bubble {
        background: #fff;
        padding: 15px;
        border-radius: 18px;
        border-bottom-left-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 15px;
        position: relative;
        border: 1px solid #f0f0f0;
      }
      .fav-quote-icon {
        position: absolute;
        top: -8px;
        right: 10px;
        font-size: 1.5rem;
        color: #ffeaa7;
        opacity: 0.5;
      }
      .fav-text {
        font-size: 0.9rem;
        color: #2d3436;
        line-height: 1.6;
      }
      .fav-date {
        font-size: 0.7rem;
        color: #b2bec3;
        margin-top: 8px;
        text-align: right;
      }

      /* === ğŸ“ 4. å¤‡å¿˜å½• (Memo) & ç¢ç¢å¿µ === */
      .memo-line {
        border-left: 2px solid #e0e0e0;
        margin-left: 10px;
        padding-left: 20px;
        padding-bottom: 20px;
        position: relative;
      }
      .memo-line::before {
        content: '';
        position: absolute;
        left: -6px;
        top: 0;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #dcdde1;
        border: 2px solid #fff;
      }
      .memo-card {
        background: #fff;
        padding: 10px 15px;
        border-radius: 12px;
        font-size: 0.9rem;
        color: #555;
      }

      /* === ğŸŒ 5. æµè§ˆå™¨ (Browser) === */
      .browser-search-bar {
        background: #f1f2f6;
        border-radius: 20px;
        padding: 8px 15px;
        font-size: 0.85rem;
        color: #a4b0be;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px dashed #eee;
      }
      .hist-query {
        font-weight: 600;
        color: #2f3542;
      }
      .hist-note {
        font-size: 0.75rem;
        color: #ff7675;
        background: #fff0f0;
        padding: 2px 6px;
        border-radius: 4px;
        margin-top: 4px;
      }
      /* ================= âœ¨ æŸ¥æ‰‹æœºæ ·å¼æ›´æ–° ================= */

      /* 1. å…¨å±€ä¸€é”®ç”ŸæˆæŒ‰é’® (æ‚¬æµ®åœ¨æ‰‹æœºå³ä¸Šè§’) */
      .phone-global-magic-btn {
        position: absolute;
        top: 14px;
        right: 25px;
        width: 40px;
        height: 40px;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        z-index: 100; /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #ff9abd;
        font-size: 1.2rem;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 2px solid #fff;
      }
      .phone-global-magic-btn:hover {
        transform: scale(1.1) rotate(15deg);
        color: #ff7675;
      }
      .phone-global-magic-btn:active {
        transform: scale(0.9);
      }
      /* ç”Ÿæˆä¸­çš„åŠ è½½åŠ¨ç”» */
      .phone-global-magic-btn.loading {
        animation: magicPulse 1.5s infinite;
        pointer-events: none;
        background: #f0f2f5;
        color: #b2bec3;
      }
      @keyframes magicPulse {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(255, 154, 189, 0.4);
        }
        70% {
          transform: scale(1.1);
          box-shadow: 0 0 0 10px rgba(255, 154, 189, 0);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(255, 154, 189, 0);
        }
      }

      /* 2. è´è¶ç»“è¿çº¿ SVG */
      .hl-conn {
        /* è¦†ç›–ä¹‹å‰çš„æ ·å¼ */
        background: transparent !important;
        height: auto !important;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 5px;
      }
      /* ç§»é™¤ä¹‹å‰çš„ä¼ªå…ƒç´ è´è¶ç»“ */
      .hl-conn::after {
        display: none !important;
      }

      .bow-svg {
        width: 60px;
        height: 40px;
        filter: drop-shadow(0 2px 4px rgba(255, 183, 208, 0.4));
      }
      /* é£˜å¸¦è·¯å¾„åŠ¨ç”» (å¯é€‰) */
      .bow-ribbon {
        stroke-dasharray: 100;
        stroke-dashoffset: 0;
        animation: drawRibbon 2s ease forwards;
      }
      /* ================= âœ¨ æŸ¥æ‰‹æœº UI å‡çº§ç‰ˆ ================= */

      /* --- 1. NPC èŠå¤©è¯¦æƒ…é¡µ --- */
      .npc-detail-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f5f5f5; /* æç®€ç°åº• */
        z-index: 50;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
      }
      .npc-detail-container.open {
        transform: translateX(0);
      }

      .npc-detail-header {
        height: 86px;
        display: flex;
        align-items: center;
        padding: 37px 15px 0 15px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-weight: bold;
        color: var(--text-main);
        justify-content: space-between;
      }

      .npc-detail-body {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      /* æ—¶é—´åˆ†å‰²çº¿ */
      .chat-date-separator {
        align-self: center;
        background: rgba(0, 0, 0, 0.05);
        color: #999;
        font-size: 0.7rem;
        padding: 2px 10px;
        border-radius: 10px;
        margin: 10px 0;
      }

      /* æç®€æ°”æ³¡ */
      .npc-bubble-row {
        display: flex;
        gap: 10px;
        width: 100%;
      }
      .npc-bubble-row.me {
        flex-direction: row-reverse;
      }

      .npc-bubble-av {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #ddd;
        flex-shrink: 0;
      }

      .npc-bubble-content-wrap {
        max-width: 70%;
        display: flex;
        flex-direction: column;
      }
      .npc-bubble-row.me .npc-bubble-content-wrap {
        align-items: flex-end;
      }

      .npc-bubble-text {
        background: #fff;
        padding: 8px 12px;
        border-radius: 12px;
        font-size: 0.9rem;
        color: #333;
        line-height: 1.5;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        position: relative;
      }
      .npc-bubble-row.me .npc-bubble-text {
        background: #95ec69; /* å¾®ä¿¡ç»¿é£æ ¼ï¼Œæˆ–è€…æ”¹æˆä½ ä¸»é¢˜è‰² */
        background: var(--text-main);
        color: #fff;
      }
      .npc-bubble-time {
        font-size: 0.65rem;
        color: #b2bec3;
        margin-top: 2px;
      }

      /* --- 2. æ”¶è—å¤¹ (Favs) æ–°æ ·å¼ --- */
      .fav-multi-card {
        background: #fff;
        padding: 0; /* å†…éƒ¨å¸ƒå±€è‡ªå·±æ§åˆ¶padding */
        border-radius: 18px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
        margin-bottom: 20px;
        border: 1px solid #f5f5f5;
        overflow: hidden;
      }

      /* èŠå¤©è®°å½•åŒºåŸŸ */
      /* 1. å®¹å™¨å¸ƒå±€ */
      .fav-chat-preview {
        display: flex;
        flex-direction: column;
        gap: 12px; /* æ°”æ³¡é—´è· */
        padding: 15px;
        background: #f9f9f9; /* æµ…ç°åº•è‰²ï¼Œçªå‡ºé»‘ç™½æ°”æ³¡ */
        border-radius: 16px;
        border: 1px solid #eee;
      }

      /* 2. è¡Œå¸ƒå±€ (æ§åˆ¶å·¦å³å¯¹é½) */
      .fav-mini-row {
        display: flex;
        width: 100%;
      }

      /* å¯¹æ–¹çš„æ¶ˆæ¯ï¼šé å·¦ */
      .fav-mini-row:not(.me) {
        justify-content: flex-start;
      }

      /* æˆ‘çš„/Charçš„æ¶ˆæ¯ï¼šé å³ */
      .fav-mini-row.me {
        justify-content: flex-end;
      }

      /* åº•éƒ¨ä¿¡æ¯æ  (å·²å¤‡ä»½æ—¶é—´) */
      .fav-footer-bar {
        background: #fff;
        padding: 8px 15px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.7rem;
        color: #b2bec3;
        font-family: var(--font-mono);
      }
      .fav-icon-group {
        display: flex;
        gap: 10px;
      }
      .fav-icon-group i {
        cursor: pointer;
        transition: color 0.2s;
      }
      .fav-icon-group i:hover {
        color: #ff7675;
      }

      /* 3. æ°”æ³¡é€šç”¨æ ·å¼ */
      .fav-mini-bubble {
        padding: 9px 14px;
        font-size: 0.9rem;
        line-height: 1.5;
        max-width: 85%;
        border-radius: 14px;
        position: relative;
        font-weight: 500;

        /* å…³é”®ï¼šé»‘ç™½é£æ ¼çš„é€šç”¨è¾¹æ¡† */
        border: 1.5px solid #000;
        box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1); /* åŠ ä¸€ç‚¹ç‚¹ç¡¬æŠ•å½±å¢åŠ ç«‹ä½“æ„Ÿ */
      }

      /* --- âšªï¸ å¯¹æ–¹æ ·å¼ (å·¦è¾¹)ï¼šç™½åº•é»‘å­— --- */
      .fav-mini-row:not(.me) .fav-mini-bubble {
        background-color: #fff;
        color: #000;

        /* å·¦ä¸‹è§’ç›´è§’ï¼Œæ¨¡æ‹Ÿæ°”æ³¡å°¾å·´ */
        border-bottom-left-radius: 2px;
      }

      /* --- âš«ï¸ æˆ‘/Charæ ·å¼ (å³è¾¹)ï¼šé»‘åº•ç™½å­— --- */
      .fav-mini-row.me .fav-mini-bubble {
        background-color: #000;
        color: #fff;

        /* å³ä¸‹è§’ç›´è§’ï¼Œæ¨¡æ‹Ÿæ°”æ³¡å°¾å·´ */
        border-bottom-right-radius: 2px;
      }

      /* --- 3. æµè§ˆå™¨æ³¢æµªå¡ç‰‡ (Scalloped Card) --- */
      /* å‚è€ƒæ‹å†¬è®°çš„å¯çˆ±é£æ ¼ */
      .browser-scallop-card {
        position: relative;
        background: #fff;
        margin-bottom: 18px;
        padding: 15px 20px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.05));
        /* ä½¿ç”¨ mask-image å®ç°æ³¢æµªè¾¹æ¡† */
        --r: 6px; /* åŠå¾„ */
        mask-image: radial-gradient(var(--r) at var(--r) var(--r), #000 99%, #0000 101%) calc(-1 * var(--r))
            calc(-1 * var(--r)),
          radial-gradient(var(--r) at calc(100% - var(--r)) var(--r), #000 99%, #0000 101%) var(--r) calc(-1 * var(--r)),
          radial-gradient(var(--r) at var(--r) calc(100% - var(--r)), #000 99%, #0000 101%) calc(-1 * var(--r)) var(--r),
          radial-gradient(var(--r) at calc(100% - var(--r)) calc(100% - var(--r)), #000 99%, #0000 101%) var(--r)
            var(--r);
        mask-size: calc(100% - 2 * var(--r)) calc(100% - 2 * var(--r));
        mask-repeat: no-repeat;

        /* å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœmaskå¤ªå¤æ‚ï¼Œç”¨ç®€å•çš„åœ†è§’+è™šçº¿è¾¹æ¡†æ¨¡æ‹Ÿ */
        border-radius: 16px;
        border: 2px dashed #e1e4e8;
      }

      /* --- 3. æµè§ˆå™¨æ ·å¼å¾®è°ƒ --- */
      .browser-scallop-card {
        background: #fff;
        margin-bottom: 15px;
        padding: 12px 15px;
        border-radius: 12px;
        border-left: 4px solid #ffcfe0; /* å¼ºè°ƒçº¿ */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }

      /* è£…é¥°æ€§çš„å°åœ†ç‚¹/å­” */
      .scallop-dot {
        width: 8px;
        height: 8px;
        background: #eee;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
      }
      .scallop-dot.left {
        left: -4px;
      }
      .scallop-dot.right {
        right: -4px;
      }

      .hist-content-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
      }
      .hist-query-text {
        font-weight: 700;
        color: #2d3436;
        font-size: 0.95rem;
      }
      .hist-time-text {
        font-size: 0.7rem;
        color: #b2bec3;
        font-family: var(--font-mono);
      }
      .hist-note-box {
        margin-top: 8px;
        font-size: 0.8rem;
        color: #636e72;
        background: #fff;
        border: 2px dashed #ffcfe0;
        padding: 6px 10px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .hist-note-box i {
        color: #ff7675;
        font-size: 0.7rem;
      }

      /* è¯¦æƒ…é¡µè¿”å›æŒ‰é’® */
      .detail-back-btn {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: #fff;
        cursor: pointer;
      }
      /* === ğŸ“… Calendar App Styles (Black & White Minimalist) === */

      /* é¡¶éƒ¨è£…é¥°åŒº */
      .cal-top-decor {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        padding: 20px 25px;
        border-bottom: 2px dashed #000;
        margin-bottom: 20px;
      }
      .cal-cat-area {
        position: relative;
        padding-left: 10px;
      }
      .cal-speech-bubble {
        position: absolute;
        top: -15px;
        right: -30px;
        border: 2px solid #000;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: bold;
        background: #fff;
      }
      .cal-month-title {
        text-align: right;
        font-family: 'JetBrains Mono', monospace; /* å»ºè®®ä½¿ç”¨ç­‰å®½å­—ä½“å¢å¼ºç§‘æŠ€æ„Ÿ/æ‰‹è´¦æ„Ÿ */
      }

      /* æ—¥å†ç½‘æ ¼ */
      .cal-container {
        padding: 0 15px;
      }
      .cal-week-row {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-size: 0.7rem;
        font-weight: 800;
        margin-bottom: 15px;
      }
      .cal-week-row span:nth-child(6),
      .cal-week-row span:nth-child(7) {
        background: #000;
        color: #fff;
        border-radius: 4px;
      }

      .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        margin-bottom: 30px;
      }

      /* å•ä¸ªæ—¥æœŸåœ†åœˆ */
      .cal-day-cell {
        aspect-ratio: 1;
        border: 1.5px solid #ccc; /* é»˜è®¤æµ…è‰² */
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }
      .cal-day-cell.active-month {
        border-color: #000; /* æœ¬æœˆæ—¥æœŸæ·±è‰² */
      }
      .cal-day-cell:hover {
        background: #f0f0f0;
      }
      .cal-day-cell.today {
        background: #000;
        color: #fff;
        border-color: #000;
      }
      .cal-day-num {
        font-size: 0.9rem;
        font-weight: 700;
        line-height: 1;
      }
      .cal-day-lunar {
        /* å†œå†/å¤‡æ³¨å°å­— */
        font-size: 0.5rem;
        transform: scale(0.8);
        margin-top: 2px;
      }
      /* æœ‰äº‹é¡¹çš„æ ‡è®°ç‚¹ */
      .cal-event-dot {
        width: 4px;
        height: 4px;
        background: #ff7675; /* åªæœ‰è¿™é‡Œç”¨ä¸€ç‚¹ç‚¹å½©è‰²ç‚¹ç¼€ï¼Œæˆ–è€…æ”¹æˆ #000 */
        border-radius: 50%;
        position: absolute;
        bottom: 4px;
      }

      /* é¦–é¡µåº•éƒ¨ ToDo */
      .cal-dashboard {
        padding: 0 20px 40px 20px;
      }
      .cal-section-title {
        font-family: 'JetBrains Mono', monospace; /* å¯¹åº”å›¾ç‰‡çš„æ‰‹å†™å­—ä½“æ„Ÿ */
        font-weight: 800;
        border-bottom: 2px solid #000;
        display: inline-block;
        margin-bottom: 15px;
        padding-right: 20px;
      }
      .cal-dash-item {
        border-bottom: 1px dashed #ccc;
        padding: 8px 0;
        font-size: 0.85rem;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      /* === è¯¦æƒ…é¡µæ ·å¼ (Timeline & Checklist) === */

      .sd-section-header {
        font-weight: 800;
        font-size: 1rem;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        background: #000;
        color: #fff;
        padding: 5px 10px;
        border-radius: 4px;
        width: fit-content;
      }

      /* æ—¶é—´è½´ */
      .sd-timeline {
        position: relative;
        padding-left: 20px;
        border-left: 2px solid #000;
      }
      .sd-tl-item {
        position: relative;
        margin-bottom: 20px;
        padding-left: 15px;
      }
      .sd-tl-item::before {
        content: '';
        position: absolute;
        left: -26px; /* è°ƒæ•´åœ†ç‚¹ä½ç½®åˆ°çº¿ä¸Š */
        top: 5px;
        width: 10px;
        height: 10px;
        background: #fff;
        border: 2px solid #000;
        border-radius: 50%;
      }
      .sd-time {
        font-family: 'JetBrains Mono', monospace;
        font-weight: 700;
        font-size: 0.85rem;
      }
      .sd-content {
        font-size: 0.9rem;
        /* background: #f4f4f4; */
        padding: 8px 12px;
        border-radius: 0 12px 12px 12px;
        margin-top: 5px;
        border: 1px solid #000;
        box-shadow: 2px 2px 0 #000; /* ç¡¬æŠ•å½±é£æ ¼ */
      }

      /* å¾…åŠ Checkbox */
      .sd-todo-item {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 8px;
        transition: all 0.2s;
      }
      .sd-todo-item:hover {
        border-color: #000;
      }
      /* è‡ªå®šä¹‰å¤é€‰æ¡†æ ·å¼ */
      .custom-checkbox {
        appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid #000;
        border-radius: 4px;
        cursor: pointer;
        position: relative;
        flex-shrink: 0;
      }
      .custom-checkbox:checked {
        background: #000;
      }
      .custom-checkbox:checked::after {
        content: 'âœ”';
        color: #fff;
        position: absolute;
        font-size: 12px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      .todo-text {
        font-size: 0.9rem;
        transition: color 0.2s;
      }
      .custom-checkbox:checked + .todo-text {
        text-decoration: line-through;
        color: #b2bec3;
        font-style: italic;
      }

      /* === ğŸŒ¸ æ—¥ç¨‹æ›´æ–°ç›¸å…³çš„æ ·å¼ === */

      /* 1. æ‚¬æµ®æ°”æ³¡ */
      .schedule-bubble {
        position: absolute;
        top: -44px; /* åœ¨æ‚¬æµ®çƒä¸Šæ–¹ */
        right: 0;
        background: #ffa3c4; /* ç²‰è‰²èƒŒæ™¯ */
        color: #fff;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
        white-space: nowrap;
        box-shadow: 0 4px 15px rgba(253, 121, 168, 0.4);
        opacity: 0;
        transform: translateY(10px) scale(0.8);
        pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€ */
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .schedule-bubble.show {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      /* å°ä¸‰è§’ */
      .schedule-bubble::after {
        content: '';
        position: absolute;
        bottom: -6px;
        right: 25px;
        width: 12px;
        height: 12px;
        background: #ffa3c4;
        transform: rotate(45deg);
      }

      /* 2. æ—¥å†ç²‰è‰²æ ‡è®° (æœ‰æ›´æ–°çš„æ—¥æœŸ) */
      .cal-day-cell.pink-theme {
        border-color: #fd79a8 !important;
        background: #fff0f6 !important;
        color: #d63031 !important;
        animation: pinkPulse 2s infinite;
      }
      .cal-day-cell.pink-theme .cal-event-dot {
        background: #fd79a8 !important;
        transform: scale(1.5);
      }

      @keyframes pinkPulse {
        0% {
          box-shadow: 0 0 0 0 rgba(253, 121, 168, 0.4);
        }
        70% {
          box-shadow: 0 0 0 6px rgba(253, 121, 168, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(253, 121, 168, 0);
        }
      }

      /* ä¿®å¤æ‚¬æµ®çƒå®šä½ (å› ä¸ºåŠ äº†çˆ¶å®¹å™¨) */
      #fp-container .floating-phone-trigger {
        /* ç»§æ‰¿åŸæ¥çš„æ ·å¼ï¼Œä½†å®šä½å±æ€§äº¤ç»™çˆ¶çº§ */
        width: 68px;
        height: 68px;
        /* ...å…¶ä»–åŸæœ‰æ ·å¼... */
      }
      /* === ğŸŒ¸ æ—¥ç¨‹è¯¦æƒ…é¡µé«˜äº®æ ·å¼ === */

      /* 1. åˆ—è¡¨é¡¹æ•´ä½“æ ·å¼ */
      .sd-tl-item.pink-mode {
        animation: fadeIn 0.5s ease;
      }

      /* 2. æ—¶é—´è½´åœ†ç‚¹å˜ç²‰ */
      .sd-tl-item.pink-mode::before {
        background: #fd79a8 !important; /* ç²‰è‰²åœ†ç‚¹ */
        border-color: #fd79a8 !important;
        box-shadow: 0 0 0 2px rgba(253, 121, 168, 0.3); /* å‘å…‰æ•ˆæœ */
      }

      /* 3. å†…å®¹æ¡†å˜ç²‰è‰²èƒŒæ™¯ + çº¢å­— */
      .sd-tl-item.pink-mode .sd-content {
        background: #fff6fa !important; /* æµ…ç²‰èƒŒæ™¯ */
        color: #fd79a8 !important;
        border-color: #fd79a8 !important;
        box-shadow: 2px 2px 0 #e3a7bc;
        /* font-weight: 700; */
      }

      /* 4. æ—¶é—´æ–‡å­—å˜ç²‰ */
      .sd-tl-item.pink-mode .sd-time {
        color: #fd79a8 !important;
      }
      /* ä¿®æ”¹æˆ–æ–°å¢è¿™ä¸ªæ ·å¼ */
      .setting-item {
        display: flex; /* å¯ç”¨ Flex å¸ƒå±€ */
        justify-content: space-between; /* ä¸¤ç«¯å¯¹é½ï¼šæ–‡å­—åœ¨å·¦ï¼ŒæŒ‰é’®è¢«æ¨åˆ°æœ€å³ */
        align-items: center; /* å‚ç›´å±…ä¸­å¯¹é½ */
        padding: 12px 5px; /* å¢åŠ ä¸€ç‚¹ä¸Šä¸‹é—´è·ï¼Œæ›´å¥½çœ‹ */
        border-bottom: 1px dashed #eee; /* å¯é€‰ï¼šåŠ ä¸ªåˆ†å‰²çº¿ */
      }

      /* ç¡®ä¿æ–‡å­—æ ·å¼æ­£å¸¸ */
      .setting-item span {
        font-size: 0.95rem;
        font-weight: bold;
        color: #333;
      }
      /* === â° æ¶ˆæ¯æ—¶é—´æˆ³ä¸åˆ†å‰²çº¿ === */

      /* 1. ç”¨æˆ·æ°”æ³¡åº•éƒ¨çš„æ—¶é—´æˆ³ */
      .msg-time-foot {
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.7); /* åŠé€æ˜ç™½è‰²ï¼Œé€‚åº”æ·±è‰²æ°”æ³¡ */
        text-align: right;
        margin-top: 4px;
        margin-bottom: -2px;
        font-family: 'JetBrains Mono', monospace;
      }

      /* 2. ç³»ç»Ÿæ—¥æœŸåˆ†å‰²çº¿ (å±…ä¸­èƒ¶å›ŠçŠ¶) */
      .system-date-bubble {
        text-align: center;
        margin: 15px 0;
        display: flex;
        justify-content: center;
      }
      .system-date-bubble span {
        background: rgba(0, 0, 0, 0.1);
        color: #666;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
      }
      /* === ğŸŒ¸ ToDo é«˜äº®æ ·å¼ === */

      /* 1. å…¨æ–° ToDoï¼šæ–‡å­—å˜ç²‰ */
      .sd-todo-item.pink-text .todo-text {
        color: #fd79a8 !important;
        /* font-weight: bold; */
        width: 79%;
        animation: fadeIn 0.5s;
      }

      /* 2. å¤é€‰æ¡†å˜ç²‰ (æ–°å¢ æˆ–è€… çŠ¶æ€æ”¹å˜) */
      .custom-checkbox.pink-box {
        border-color: #fd79a8 !important;
        box-shadow: 0 0 5px rgba(253, 121, 168, 0.4);
        animation: pinkPulse 1s;
      }

      /* å¦‚æœå¤é€‰æ¡†è¢«å‹¾é€‰ä¸”æ˜¯ç²‰è‰²æ¨¡å¼ï¼ŒèƒŒæ™¯ä¹Ÿè¦å˜ç²‰ */
      .custom-checkbox.pink-box:checked {
        background-color: #fd79a8 !important;
        border-color: #fd79a8 !important;
      }
      /* === æ‚¬æµ®çƒå®¹å™¨ (ç§»åŠ¨çš„ä¸»ä½“) === */
      .fp-container-style {
        position: fixed;
        bottom: 150px; /* åˆå§‹ä½ç½® */
        right: 20px; /* åˆå§‹ä½ç½® */
        z-index: 900;
        width: 68px; /* å’ŒæŒ‰é’®ä¸€æ ·å¤§ */
        height: 68px;
        touch-action: none; /* ç¦æ­¢é»˜è®¤è§¦æ‘¸æ»šåŠ¨ */
      }
      /* === æŒ‰é’® (å……æ»¡å®¹å™¨) === */
      .floating-phone-trigger {
        position: relative; /* åªè¦ç›¸å¯¹å®šä½å³å¯ */
        width: 100%;
        height: 100%;
        bottom: auto; /* æ¸…é™¤åŸæ¥çš„å®šä½ */
        right: auto;
        left: auto;
        top: auto;
        /* ...ä¿ç•™ä¹‹å‰çš„åœ†è§’ã€é˜´å½±ã€èƒŒæ™¯ç­‰æ ·å¼... */
      }

      /* === ğŸ¬ çº¿ä¸‹æ¨¡å—ï¼šåœºè®°æ¿å¡ç‰‡æ ·å¼ === */
      .msg-bubble.offline-card {
        padding: 0 !important;
        /* background: transparent !important; */
        box-shadow: none !important;
        width: 259px !important;
        max-width: 100%;
        padding: 7px !important;
      }

      .clapper-board {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        border: 1px solid #2d3436;
        position: relative;
        transition: transform 0.2s;
      }
      .clapper-board:hover {
        transform: translateY(-3px);
      }

      /* é¡¶éƒ¨é»‘ç™½æ¡çº¹è£…é¥° */
      .clapper-top {
        height: 24px;
        background: repeating-linear-gradient(45deg, #2d3436, #2d3436 10px, #ffffff 10px, #ffffff 20px);
        border-bottom: 2px solid #2d3436;
      }

      .clapper-body {
        padding: 15px;
        /* èƒŒæ™¯å›¾å°†ç”± JS éšæœºæ³¨å…¥ */
        background-size: cover;
        background-position: center;
        position: relative;
      }
      /* ç™½è‰²é®ç½©ï¼Œä¿è¯æ–‡å­—æ¸…æ™° */
      .clapper-body::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /* background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(2px); */
        z-index: 0;
      }

      .clapper-content {
        position: relative;
        z-index: 1;
        text-align: center;
      }

      .clapper-title {
        font-family: var(--font-serif);
        font-weight: 800;
        font-size: 1.1rem;
        margin-bottom: 4px;
        color: #2d3436;
      }

      .clapper-meta {
        font-family: var(--font-code);
        font-size: 0.7rem;
        color: #636e72;
        margin-bottom: 12px;
        letter-spacing: 1px;
      }

      .clapper-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }

      .clapper-btn {
        flex: 1;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #2d3436;
        font-size: 0.75rem;
        font-weight: 700;
        cursor: pointer;
        background: #fff;
        color: #2d3436;
        transition: all 0.2s;
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 5px;
      }
      .clapper-btn.action {
        background: #2d3436;
        color: #fff;
      }
      .clapper-btn:hover {
        opacity: 0.9;
        transform: scale(1.05);
      }

      /* çŠ¶æ€æ ‡ç­¾ */
      .clapper-status {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ff7675;
        color: white;
        font-size: 0.6rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
        transform: rotate(5deg);
        z-index: 2;
        border: 1px solid #fff;
      }
    </style>
  </head>
  <body>
    <header>
      <button class="header-btn" onclick="openSettings()"><i class="fa-solid fa-gear"></i></button>
      <h1 class="page-title" id="page-title" onclick="window.location.href='index.html'">Discover</h1>
      <button class="header-btn" id="action-btn"><i class="fa-solid fa-sliders"></i></button>
    </header>

    <div class="content-scroll">
      <div id="page-discover" class="page active">
        <div class="search-area">
          <div class="search-container" id="tag-container">
            <i class="fa-solid fa-magnifying-glass" style="color: #b2bec3; margin-left: 5px"></i>
            <input type="text" id="gen-keyword" class="search-input" placeholder="Type keywords..." />
          </div>
          <button class="btn-generate" id="btn-generate" onclick="generatePost()">
            <i class="fa-solid fa-bolt"></i>
            <!-- <span>Generate</span> -->
          </button>
        </div>

        <div id="char-selection-area" style="display: none; animation: fadeIn 0.5s ease">
          <div class="section-header" style="margin-top: 10px; margin-bottom: 10px">
            <div class="section-title" style="font-size: 0.9rem; opacity: 0.8">Select Character</div>
          </div>
          <div class="char-selector-row" id="char-list-wrapper"></div>
        </div>

        <div class="section-header">
          <div class="section-title" style="display: flex; align-items: center; gap: 8px">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M12 2L14.3175 9.12749L21.8156 9.12749L15.749 13.535L18.0666 20.6625L12 16.255L5.93344 20.6625L8.25098 13.535L2.18443 9.12749L9.68249 9.12749L12 2Z"
                fill="#333"
                stroke="#000"
                stroke-width="1.5"
                stroke-linejoin="round"
              />
            </svg>
            Recommendations
          </div>
        </div>
        <div class="masonry-grid" id="grid-recommendations"></div>

        <div class="section-header" id="offline-section-header" style="display: none; margin-top: 10px">
          <div class="section-title" style="display: flex; align-items: center; gap: 8px; color: #6c5ce7">
            <i class="fa-solid fa-clapperboard"></i>
            Offline Memories
          </div>
        </div>
        <div class="masonry-grid" id="grid-offline"></div>

        <div class="section-header" style="margin-top: 11px">
          <div class="section-title" style="margin-top: 0px; display: flex; align-items: center; gap: 8px">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M10 4H4C2.9 4 2.01 4.9 2.01 6L2 18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V8C22 6.9 21.1 6 20 6H12L10 4Z"
                fill="#333"
                stroke="#000"
                stroke-width="1.5"
                stroke-linejoin="round"
              />
            </svg>
            Forum All (History)
            <!-- <div class="view-all" onclick="clearHistory()" style="margin-left: auto">Clear All</div> -->
          </div>
          <div class="view-all" onclick="clearHistory()">Clear All</div>
        </div>
        <div class="masonry-grid" id="grid-all"></div>
      </div>

      <div id="page-service" class="page">
        <div style="text-align: center; margin-top: 50px; color: #b2bec3">
          <i class="fa-solid fa-layer-group" style="font-size: 3rem; margin-bottom: 15px"></i>
          <p>My Idea Plays</p>
        </div>
      </div>
      <div id="page-chat" class="page">
        <div class="chat-page-header">
          <div style="font-size: 1.2rem; font-weight: 800">Message</div>
          <i class="fa-solid fa-plus" style="font-size: 1.2rem"></i>
        </div>

        <div class="chat-search-bar">
          <i class="fa-solid fa-magnifying-glass"></i>
          <span>Search</span>
        </div>

        <div class="chat-tabs-row">
          <div class="chat-tab active">Tsukiâ™¡</div>
          <div class="chat-tab">ä½ æ˜¯æˆ‘è´«ç˜ æ˜Ÿç³»é‡Œå”¯ä¸€çš„æœˆäº®</div>
        </div>

        <div id="chat-list-container" class="chat-list-box"></div>
      </div>

      <div id="chat-room-overlay" class="chat-room-overlay">
        <div class="chat-room-header">
          <div class="back-btn" onclick="closeChatRoom()"><i class="fa-solid fa-chevron-left"></i></div>
          <div class="chat-room-info">
            <div class="chat-room-name" id="cr-name">Character Name</div>
            <div class="chat-room-status">Online</div>
          </div>
          <div class="chat-room-action" onclick="toggleChatSettings()">
            <i class="fa-solid fa-ellipsis"></i>
          </div>

          <div id="cr-settings-panel" class="cr-settings-menu">
            <div class="cr-setting-item" style="display: block">
              <div class="cr-label" style="margin-bottom: 10px">Avatars (Click to change)</div>
              <div class="cr-avatar-row">
                <div class="cr-av-wrapper" onclick="triggerChatAvatarUpload('user')">
                  <img id="setting-preview-user" src="" class="cr-av-img" />
                  <div class="cr-av-badge"><i class="fa-solid fa-camera"></i></div>
                  <span class="cr-av-name">User</span>
                </div>

                <div style="width: 1px; height: 30px; background: #eee"></div>

                <div class="cr-av-wrapper" onclick="triggerChatAvatarUpload('char')">
                  <img id="setting-preview-char" src="" class="cr-av-img" />
                  <div class="cr-av-badge"><i class="fa-solid fa-camera"></i></div>
                  <span class="cr-av-name">Char</span>
                </div>
              </div>
            </div>

            <div class="cr-divider"></div>

            <div class="setting-item">
              <span>Real-time Sync</span>
              <label class="switch">
                <input type="checkbox" id="setting-schedule-sync" />
                <span class="slider round"></span>
              </label>
            </div>

            <div class="cr-divider"></div>

            <div class="setting-item">
              <span>Offline Mode</span>
              <label class="switch">
                <input type="checkbox" id="setting-offline-mode" onchange="toggleOfflineMode(this)" />
                <span class="slider round"></span>
              </label>
            </div>
            <div class="cr-divider"></div>

            <div class="cr-setting-item">
              <div class="cr-label">
                <span>Max Msgs</span>
                <small style="color: #b2bec3; font-size: 0.7rem">(0 = All)</small>
              </div>
              <input
                type="number"
                id="setting-msg-limit"
                class="cr-input-num"
                value="44"
                min="0"
                onchange="updateMsgLimit(this.value)"
              />
            </div>

            <div class="cr-divider"></div>

            <div class="cr-setting-item delete" onclick="clearCurrentChatHistory()">
              <i class="fa-solid fa-trash-can"></i>
              <span>Clear History</span>
            </div>
          </div>
        </div>

        <div class="chat-room-body" id="cr-body"></div>

        <div id="reply-preview-bar" class="reply-preview-bar" style="display: none">
          <div class="rp-content">
            <div class="rp-line"></div>
            <div class="rp-text" id="rp-text">Replying to...</div>
          </div>
          <div class="rp-close" onclick="cancelReply()"><i class="fa-solid fa-xmark"></i></div>
        </div>

        <div class="chat-room-footer">
          <div class="chat-action-plus" onclick="toggleExtraMenu()">
            <i class="fa-solid fa-circle-plus" style="font-size: 1.5rem; color: #b2bec3; cursor: pointer"></i>
          </div>

          <div class="chat-input-wrapper" style="margin-left: 0px">
            <input type="text" id="cr-input" placeholder="Type a message..." />
            <i class="fa-regular fa-face-smile"></i>
          </div>
          <div class="chat-btn-group">
            <button class="cr-btn btn-send-only" onclick="sendUserMessage('user_only')">
              <i class="fa-solid fa-paper-plane"></i>
            </button>

            <button id="btn-ai-submit" class="cr-btn btn-send-ai" onclick="sendUserMessage('ai_reply')">
              <i class="fa-solid fa-wand-magic-sparkles"></i>
            </button>
          </div>
        </div>

        <div id="chat-extra-menu" class="chat-action-menu">
          <div class="action-item" onclick="openSpecialInput('image')">
            <div class="icon-box" style="background: #ff7675">
              <i class="fa-regular fa-image"></i>
            </div>
            <span>Photo</span>
          </div>

          <div class="action-item" onclick="openSpecialInput('voice')">
            <div class="icon-box" style="background: #74b9ff">
              <i class="fa-solid fa-microphone"></i>
            </div>
            <span>Voice</span>
          </div>

          <div class="action-item" onclick="openSpecialInput('transfer')">
            <div class="icon-box" style="background: #fdcb6e">
              <i class="fa-solid fa-coins"></i>
            </div>
            <span>Money</span>
          </div>

          <div class="action-item" onclick="openSpecialInput('emoji')">
            <div class="icon-box" style="background: #55efc4">
              <i class="fa-regular fa-face-laugh-wink"></i>
            </div>
            <span>Sticker</span>
          </div>
        </div>
      </div>
    </div>

    <div class="bottom-nav-container">
      <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('discover', this)">
          <i class="fa-solid fa-compass"></i> <span>Discover</span>
        </div>
        <div class="nav-item" onclick="switchPage('chat', this)">
          <i class="fa-solid fa-comment-dots"></i> <span>Message</span>
        </div>
        <div class="nav-item" onclick="switchPage('service', this)">
          <i class="fa-solid fa-shapes"></i> <span>My Plays</span>
        </div>
      </nav>
    </div>

    <div id="modal-settings" class="modal-overlay">
      <div class="settings-card">
        <div
          style="position: absolute; top: 15px; right: 15px; cursor: pointer; padding: 5px"
          onclick="closeSettings()"
        >
          <i class="fa-solid fa-xmark"></i>
        </div>

        <div class="prompt-section-toggle" onclick="togglePromptDrawer()">
          <span><i class="fa-solid fa-pen-nib"></i> System Prompts</span>
          <i class="fa-solid fa-chevron-down" id="prompt-arrow"></i>
        </div>

        <div class="settings-drawer" id="prompt-drawer">
          <div class="form-group">
            <label class="form-label">Mode A: New Original Char (No Selection)</label>
            <textarea id="prompt_no_char" class="form-input prompt-box" spellcheck="false"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Mode B: Roleplay Scenario (With Selection)</label>
            <textarea id="prompt_with_char" class="form-input prompt-box" spellcheck="false"></textarea>
          </div>
          <div class="library-actions" style="margin-top: 0; padding-top: 10px; border: none">
            <button class="lib-btn" onclick="restoreDefaultPrompts()" style="color: #e17055">
              <i class="fa-solid fa-rotate-left"></i> Restore Defaults
            </button>
          </div>
        </div>
        <div class="settings-header">API Configuration</div>

        <div class="preset-switcher">
          <div class="switcher-btn active" id="btn-main" onclick="switchPreset('main')">Main Preset</div>
          <div class="switcher-btn" id="btn-backup" onclick="switchPreset('backup')">Backup Preset</div>
        </div>

        <div class="form-group">
          <label class="form-label">Host URL</label>
          <input type="text" id="api_url" class="form-input" placeholder="https://api.openai.com" />
        </div>
        <div class="form-group">
          <label class="form-label">API Key</label>
          <input type="password" id="api_key" class="form-input" placeholder="sk-..." />
        </div>
        <div class="form-group">
          <label class="form-label">Model Selection</label>
          <div style="display: flex; gap: 8px">
            <select id="api_model_select" class="form-select" style="flex: 1">
              <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
              <option value="gpt-4">gpt-4</option>
              <option value="claude-3-opus">claude-3-opus</option>
            </select>
            <button class="btn-fetch" onclick="fetchModels()" title="Fetch">
              <i class="fa-solid fa-cloud-arrow-down"></i>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Temperature: <span id="temp-display">0.7</span></label>
          <div class="range-wrap">
            <span>Precise</span>
            <input
              type="range"
              id="api_temp"
              min="0"
              max="2"
              step="0.1"
              value="0.7"
              oninput="document.getElementById('temp-display').innerText = this.value"
            />
            <span>Creative</span>
          </div>
        </div>
        <div class="form-group">
          <div class="switch-container">
            <span style="font-size: 0.9rem; font-weight: 600">Stream Mode</span>
            <label class="switch">
              <input type="checkbox" id="api_stream" />
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <button class="btn-save-main" onclick="saveCurrentConfig()">+ Save Current Config</button>
        <div class="library-actions">
          <select
            id="preset_library"
            class="form-select"
            style="padding: 8px; font-size: 0.85rem"
            onchange="loadFromLibrary()"
          >
            <option value="">Load saved preset...</option>
          </select>
          <button class="lib-btn" onclick="saveAsNewPreset()">Save As...</button>
        </div>
      </div>
    </div>

    <div id="modal-preview" class="modal-overlay">
      <div class="browser-window">
        <div class="modal-decor-header">
          <img src="" id="pre-bg-img" class="modal-decor-img" />
        </div>

        <div class="close-float-btn" onclick="closePreview()">
          <i class="fa-solid fa-xmark"></i>
        </div>

        <div class="modal-body">
          <div class="fake-search-bar">
            <span class="fake-query-text" id="fake-query-display">Keywords...</span>
            <div style="color: #999; display: flex; gap: 10px; align-items: center">
              <i class="fa-solid fa-copy copy-btn" onclick="copyTsukiPost()" title="Copy Tsukipost Format"></i>
              <div style="width: 1px; height: 15px; background: #ddd"></div>
              <i class="fa-solid fa-microphone"></i>
              <i class="fa-solid fa-camera"></i>
            </div>
          </div>

          <div class="interaction-card">
            <div class="int-header">
              <div class="int-avatars">
                <img src="" id="pre-user-av" class="int-av" />
                <div class="int-link"></div>
                <img src="" id="pre-char-av" class="int-av" />
              </div>
              <div class="int-status"><i class="fa-solid fa-link"></i> <span id="pre-match-rate">--%</span></div>
            </div>

            <div class="int-title-area">
              <div class="int-char-name" id="pre-title" style="cursor: pointer" onclick="scrollToContentBottom()">
                Scenario Title
              </div>

              <div class="int-char-sub" id="pre-participants">Participants: Character</div>

              <div class="int-meta">FILE ID: <span id="pre-id">UNKNOWN</span> â€¢ <span id="pre-date">DATE</span></div>
            </div>

            <div class="int-content-box">
              <div class="int-quote" id="pre-quote">"..."</div>
              <div class="int-body" id="pre-content">Loading...</div>
            </div>

            <div class="int-footer" style="display: block">
              <div style="display: flex; gap: 10px; margin-bottom: 21px">
                <button class="int-btn"><i class="fa-regular fa-heart"></i> Like</button>
                <button class="int-btn"><i class="fa-solid fa-share-nodes"></i> Share</button>
                <button class="int-btn delete-btn" onclick="deleteCurrentPost()">
                  <i class="fa-solid fa-trash"></i> Del
                </button>
              </div>

              <div class="story-input-container">
                <textarea id="story-input" class="story-input" placeholder="Input..." rows="1"></textarea>
                <button class="btn-continue" id="btn-continue" onclick="handleStoryContinuation()">
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <input type="file" id="upload-bg" hidden accept="image/*" />
    <input type="file" id="upload-user-av" hidden accept="image/*" />
    <input type="file" id="upload-char-av" hidden accept="image/*" />
    <div id="modal-group-manage" class="modal-overlay">
      <div
        class="modal-box"
        style="text-align: left; background: #fff; padding: 20px; border-radius: 20px; width: 85%; max-width: 320px"
      >
        <div class="modal-title" style="font-weight: 800; font-size: 1.1rem; margin-bottom: 20px">
          Edit Contact Info
        </div>

        <div
          class="form-group"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: #f0f2f5;
            padding: 15px;
            border-radius: 12px;
          "
        >
          <label style="font-weight: bold; color: #2d3436; font-size: 0.9rem">Pin to Top (ç½®é¡¶)</label>
          <label class="switch">
            <input type="checkbox" id="group-pinned-switch" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="form-group">
          <label class="form-label" style="margin-bottom: 10px; display: block">Select Group</label>
          <div id="group-chips-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px"></div>
        </div>

        <div class="form-group" style="display: flex; gap: 8px; align-items: center">
          <input
            type="text"
            id="new-group-input"
            class="form-input"
            placeholder="New Group Name..."
            style="padding: 10px; border: 1px solid #eee"
          />
          <button class="int-btn" onclick="addNewGroup()" style="width: auto; padding: 0 15px; height: 42px">
            Add
          </button>
        </div>

        <div class="modal-actions" style="display: flex; gap: 10px; margin-top: 20px">
          <button class="int-btn" onclick="closeGroupModal()" style="color: #636e72">Cancel</button>
          <button class="int-btn" onclick="saveGroupSettings()" style="background: var(--text-main); color: #fff">
            Save
          </button>
        </div>
      </div>
    </div>
    <div id="bubble-context-menu" class="bubble-menu" style="display: none">
      <div class="menu-item" style="color: var(--text-main) !important" onclick="triggerReply()">
        <i class="fa-solid fa-reply"></i> å¼•ç”¨ (Reply)
      </div>
      <div class="menu-item delete" onclick="deleteCurrentSelectedMsg()">
        <i class="fa-solid fa-trash"></i> åˆ é™¤ (Delete)
      </div>
      <div class="menu-arrow"></div>
    </div>
    <div id="modal-special-input" class="modal-overlay">
      <div
        class="modal-box"
        style="background: #fff; padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; text-align: left"
      >
        <h3 id="special-modal-title" style="margin-top: 0; color: var(--text-main); font-weight: 800">Send Message</h3>

        <p id="special-modal-desc" style="font-size: 0.9rem; color: #666; margin-bottom: 15px"></p>

        <input
          type="text"
          id="special-input-content"
          class="form-input"
          style="
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: border 0.2s;
          "
          onfocus="this.style.borderColor='var(--text-main)'"
          onblur="this.style.borderColor='#eee'"
          placeholder="..."
        />

        <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end">
          <button class="int-btn" onclick="closeSpecialInput()" style="background: #f0f2f5; color: #666; border: none">
            Cancel
          </button>
          <button
            class="int-btn"
            onclick="confirmSpecialSend()"
            style="background: var(--text-main); color: #fff; border: none"
          >
            Send
          </button>
        </div>
      </div>
    </div>

    <div id="modal-status-panel" class="modal-overlay">
      <div class="status-card-container">
        <div class="status-header">
          <div class="status-nav-btn" onclick="prevStatus()"><i class="fa-solid fa-chevron-left"></i></div>
          <div class="status-title-box">
            <div class="status-title">Mind Reader</div>
            <div class="status-timestamp" id="st-time">Just Now</div>
          </div>
          <div class="status-nav-btn" onclick="nextStatus()"><i class="fa-solid fa-chevron-right"></i></div>
        </div>

        <div class="close-status-btn" onclick="closeStatusPanel()">
          <i class="fa-solid fa-xmark"></i>
        </div>

        <div class="status-scroll-content">
          <div class="status-grid-row">
            <div class="st-box">
              <div class="st-label"><i class="fa-solid fa-shirt"></i> Outfit</div>
              <div class="st-val" id="st-outfit">---</div>
            </div>
            <div class="st-box">
              <div class="st-label"><i class="fa-solid fa-face-smile"></i> Mood</div>
              <div class="st-val" id="st-mood">---</div>
            </div>
          </div>

          <div class="st-section">
            <div class="st-label-row"><i class="fa-solid fa-comment-dots"></i> Inner Monologue</div>
            <div class="st-text-bubble" id="st-thought">...</div>
          </div>

          <div class="st-section dark-mode">
            <div class="st-label-row" style="color: #ff7675">
              <i class="fa-solid fa-heart-pulse"></i> Deep Psychology
            </div>
            <div class="st-text-plain" id="st-psych">...</div>
          </div>

          <div class="st-section note-mode">
            <div class="st-label-row"><i class="fa-solid fa-note-sticky"></i> Memo</div>
            <div class="st-handwriting" id="st-memo">...</div>
          </div>

          <div class="diary-card">
            <div class="diary-icon"><i class="fa-solid fa-book-open"></i></div>
            <div class="diary-content" id="st-diary">...</div>
            <div class="diary-deco">TSUKI DIARY</div>
          </div>
        </div>

        <div class="status-footer-hint">Click Left/Right to view history</div>
      </div>
    </div>

    <input type="file" id="chat-upload-user" hidden accept="image/*" />
    <input type="file" id="chat-upload-char" hidden accept="image/*" />

    <div id="fp-container" class="fp-container-style">
      <div id="schedule-bubble" class="schedule-bubble">
        <i class="fa-solid fa-calendar-check"></i> Schedule Updated!
      </div>
      <div id="phone-trigger" class="floating-phone-trigger">
        <div class="fp-inner-ring">
          <img src="https://i.postimg.cc/J04FJMsS/1768119599448.png" class="fp-avatar" id="fp-avatar-img" />
        </div>
      </div>
    </div>

    <div id="phone-overlay" class="phone-overlay">
      <div style="position: absolute; width: 100%; height: 100%" onclick="togglePhone(false)"></div>

      <div class="phone-shell">
        <div class="phone-notch"></div>

        <div
          class="phone-global-magic-btn"
          id="btn-phone-generate"
          onclick="generatePhoneAll()"
          title="AI One-Click Generate"
        >
          <i class="fa-solid fa-wand-magic-sparkles"></i>
        </div>

        <div class="screen-lock" id="screen-lock" onclick="unlockPhone()">
          <div style="text-align: center; margin-top: 40px">
            <i class="fa-solid fa-lock"></i>
          </div>
          <div style="text-align: center">
            <div class="lock-time" id="lock-time">12:00</div>
            <div class="lock-date" id="lock-date">Tuesday, January 15</div>
          </div>
          <div class="slide-to-unlock">Click to Unlock <i class="fa-solid fa-chevron-up"></i></div>
        </div>

        <div class="phone-screen screen-home">
          <div class="home-link-widget">
            <img src="" id="home-user-av" class="hl-avatar" />

            <div class="hl-conn">
              <svg class="bow-svg" viewBox="0 0 50 40" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M25 15 C15 5, 5 5, 5 15 C5 25, 15 25, 25 15 C35 25, 45 25, 45 15 C45 5, 35 5, 25 15 Z"
                  fill="#fff"
                  stroke="#ffb7d0"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  class="bow-ribbon"
                  d="M25 15 Q 20 28, 10 35"
                  fill="none"
                  stroke="#ffb7d0"
                  stroke-width="2.5"
                  stroke-linecap="round"
                />
                <path
                  class="bow-ribbon"
                  d="M25 15 Q 30 28, 40 35"
                  fill="none"
                  stroke="#ffb7d0"
                  stroke-width="2.5"
                  stroke-linecap="round"
                />
                <circle cx="25" cy="15" r="3" fill="#fff" stroke="#ffb7d0" stroke-width="2" />
              </svg>
            </div>

            <img src="" id="home-char-av" class="hl-avatar" />
          </div>

          <div class="app-grid">
            <div class="app-icon-wrap" onclick="openApp('chat')">
              <div class="app-icon bg-chat"><i class="fa-solid fa-comments"></i></div>
              <span class="app-name">Chats</span>
            </div>
            <div class="app-icon-wrap" onclick="openApp('diary')">
              <div class="app-icon bg-diary"><i class="fa-solid fa-book-bookmark"></i></div>
              <span class="app-name">Diary</span>
            </div>
            <div class="app-icon-wrap" onclick="openApp('fav')">
              <div class="app-icon bg-fav"><i class="fa-solid fa-star"></i></div>
              <span class="app-name">Favs</span>
            </div>
            <div class="app-icon-wrap" onclick="openApp('memo')">
              <div class="app-icon bg-memo"><i class="fa-solid fa-note-sticky"></i></div>
              <span class="app-name">Memos</span>
            </div>
            <div class="app-icon-wrap" onclick="openApp('browser')">
              <div class="app-icon bg-browser"><i class="fa-brands fa-chrome"></i></div>
              <span class="app-name">Web</span>
            </div>
            <div class="app-icon-wrap" onclick="openApp('schedule')">
              <div
                class="app-icon bg-schedule"
                style="background: linear-gradient(135deg, #fff9f2 0%, #c3baff 100%); color: #fff"
              >
                <i class="fa-regular fa-calendar-check"></i>
              </div>
              <span class="app-name">Schedule</span>
            </div>
          </div>
        </div>

        <div id="app-chat" class="app-screen">
          <div class="app-header">
            <i class="fa-solid fa-chevron-left app-back-btn" onclick="closeApp('app-chat')"></i>
            <span>Messages</span>
            <div style="width: 24px"></div>
          </div>
          <div class="app-content-scroll" id="content-npc-chat"></div>

          <div id="npc-chat-detail" class="npc-detail-container">
            <div class="npc-detail-header">
              <div class="detail-back-btn" onclick="closeNpcDetail()">
                <i class="fa-solid fa-chevron-left"></i>
              </div>
              <span id="nd-title">Name</span>
              <div style="width: 30px"></div>
            </div>
            <div class="npc-detail-body" id="nd-body"></div>
          </div>
        </div>

        <div id="app-diary" class="app-screen">
          <div class="app-header">
            <i class="fa-solid fa-chevron-left app-back-btn" onclick="closeApp('app-diary')"></i>
            <span>Diary</span>
            <div style="width: 24px"></div>
          </div>
          <div class="app-content-scroll" id="content-diary"></div>
          <div id="diary-detail" class="diary-detail-overlay">
            <div style="margin-bottom: 20px; color: #b2bec3; cursor: pointer" onclick="closeDiaryDetail()">
              <i class="fa-solid fa-chevron-down"></i> Close
            </div>
            <h2 id="dd-title" style="margin-bottom: 5px">Title</h2>
            <div id="dd-date" style="color: #999; margin-bottom: 20px; font-size: 0.8rem">Date</div>
            <div id="dd-body" class="dd-content"></div>
          </div>
        </div>

        <div id="app-fav" class="app-screen">
          <div class="app-header">
            <i class="fa-solid fa-chevron-left app-back-btn" onclick="closeApp('app-fav')"></i>
            <span>Favorites</span>
            <div style="width: 24px"></div>
          </div>
          <div class="app-content-scroll" id="content-fav"></div>
        </div>

        <div id="app-memo" class="app-screen">
          <div class="app-header">
            <i class="fa-solid fa-chevron-left app-back-btn" onclick="closeApp('app-memo')"></i>
            <span>Memos</span>
            <div style="width: 24px"></div>
          </div>
          <div class="app-content-scroll" id="content-memo"></div>
        </div>

        <div id="app-browser" class="app-screen">
          <div class="app-header">
            <i class="fa-solid fa-chevron-left app-back-btn" onclick="closeApp('app-browser')"></i>
            <span>Browser</span>
            <div style="width: 24px"></div>
          </div>
          <div class="app-content-scroll">
            <div class="browser-search-bar"><i class="fa-solid fa-magnifying-glass"></i> Search or type URL</div>
            <div style="font-weight: bold; margin-bottom: 10px; font-size: 0.9rem">History</div>
            <div id="content-browser"></div>
          </div>
        </div>

        <div id="app-schedule" class="app-screen" style="background: #fff">
          <div class="app-header" style="border-bottom: 2px solid #000">
            <i class="fa-solid fa-chevron-left app-back-btn" onclick="closeApp('app-schedule')"></i>
            <span style="font-family: 'JetBrains Mono', monospace; letter-spacing: -1px">CALENDAR</span>
            <i class="fa-solid fa-plus app-back-btn" onclick="addNewEventPrompt()"></i>
          </div>

          <div class="app-content-scroll" style="padding: 0; background: #fff">
            <div class="cal-top-decor">
              <div class="cal-cat-area" onclick="generateAiSchedule()" style="cursor: pointer">
                <i
                  id="cal-loading-icon"
                  class="fa-solid fa-cat"
                  style="font-size: 3rem; transform: rotate(-10deg); transition: all 0.5s"
                ></i>
                <div class="cal-speech-bubble" id="cal-cat-text">Plan my week?</div>
              </div>
              <div class="cal-month-title">
                <div style="font-size: 3rem; font-weight: 900; line-height: 0.8" id="cal-display-month">02</div>
                <div style="font-size: 1rem; font-weight: 700; letter-spacing: 2px" id="cal-display-year">FEBRUARY</div>
              </div>
            </div>

            <div class="cal-container">
              <div class="cal-week-row">
                <span>MON</span><span>TUE</span><span>WED</span><span>THU</span><span>FRI</span><span>SAT</span
                ><span>SUN</span>
              </div>
              <div class="cal-grid" id="cal-grid-content"></div>
            </div>

            <div class="cal-dashboard">
              <div class="cal-section-title">TO DO LIST:</div>
              <div class="cal-dash-list" id="cal-dash-list"></div>
            </div>
          </div>

          <div id="schedule-detail" class="npc-detail-container" style="background: #fff">
            <div class="npc-detail-header" style="background: #fff; border-bottom: 2px solid #000">
              <div class="detail-back-btn" style="border: 2px solid #000; color: #000" onclick="closeScheduleDetail()">
                <i class="fa-solid fa-chevron-left"></i>
              </div>
              <span id="sd-title" style="font-family: 'JetBrains Mono'; font-weight: 800">DATE</span>
              <div style="width: 30px"></div>
            </div>

            <div class="npc-detail-body" style="padding: 20px">
              <div class="sd-section-header"><i class="fa-regular fa-clock"></i> TIMELINE</div>
              <div class="sd-timeline" id="sd-timeline-box"></div>

              <div style="height: 30px"></div>

              <div class="sd-section-header"><i class="fa-solid fa-list-check"></i> TASKS</div>
              <div class="sd-todo-box" id="sd-todo-box"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // âœ… [ä¿®æ”¹] é»˜è®¤æç¤ºè¯å¸¸é‡ - é’ˆå¯¹é•¿ç¯‡å°è¯´ä¼˜åŒ–
      // æ¨¡å¼ A: åŸåˆ›è§’è‰² + é•¿ç¯‡æ•…äº‹
      const DEFAULT_PROMPT_NO_CHAR = `You are a best-selling Web Novelist known for immersive, long-form storytelling.
Your task is to create a BRAND NEW character and write a COMPLETE, LONG-FORM short novel (approx. 4000 Chinese characters) based on the keywords.

STRICT WRITING GUIDELINES:
1. **LENGTH**: The 'content' MUST be extremely long. Aim for the maximum output limit.
2. **PACING**: Write in a "Slow Burn" style. Do not summarize events. Describe every movement, thought, and sensory detail.
3. **STRUCTURE**: The story must have a clear 4-act structure:
   - **Introduction**: Establish the character's appearance and the setting in detail.
   - **Development**: The inciting incident and rising action. High tension.
   - **Climax**: The peak of the conflict. Detailed action or emotional explosion.
   - **Resolution**: A satisfying ending.
4. **AESTHETICS**: The protagonist must be attractive/charismatic. Describe their beauty/handsomeness in the intro.

Return JSON ONLY (Single Object). Do not break JSON syntax even if text is long.
{
    "charName": "Name of the character",
    "quote": "A memorable line from the story.",
    "title": "A Novel-Like Title (e.g., 'The Chronicles of...')",
    "visualTags": "Appearance tags (e.g., silver hair, scar, suit)",
    "content": "WRITE THE FULL NOVEL HERE. Use \\n\\n for paragraph breaks. Do not use markdown bolding inside. Start with the character description and move into the plot."
}`;

      // æ¨¡å¼ B: é€‰ä¸­è§’è‰² + é•¿ç¯‡å‰§åœº
      const DEFAULT_PROMPT_WITH_CHAR = `You are a master of Fan Fiction and Dramatic Writing.
I will provide a list of characters. For EACH character, write a COMPLETE, LONG-FORM standalone story chapter (aiming for 4000 Chinese characters) based on the keywords.

STRICT WRITING GUIDELINES:
1. **LENGTH & DETAIL**: Do not write a summary. Write a full scene. Use dialogue, inner monologue, and environmental descriptions to extend the length.
2. **STRUCTURE**:
   - **Start**: Set the scene and the character's current state.
   - **Process**: Introduce the conflict or interaction based on keywords.
   - **Climax**: The turning point of the scene.
   - **End**: The aftermath or conclusion.
3. **ROLEPLAY**: Stay strictly in character. Use their specific tone and mannerisms.

IMPORTANT: Return a JSON ARRAY of objects. One object per character.
Format:
[
  {
    "refId": "The Character ID provided in input",
    "charName": "Name",
    "quote": "A key quote from the story",
    "title": "Chapter Title",
    "content": "THE FULL LONG STORY TEXT HERE. Use \\n\\n for line breaks. Ensure it reads like a published novel chapter."
  }
]`;

      // ================= âœ¨ å¿ƒå£°ç³»ç»Ÿé€»è¾‘ =================

      let statusList = []; // å½“å‰è§’è‰²çš„å¿ƒå£°åˆ—è¡¨ (å†…å­˜ç¼“å­˜)
      let currentStatusIndex = 0; // å½“å‰æŸ¥çœ‹çš„ç´¢å¼• (0 = æœ€æ–°)

      // 1. ä¿å­˜å¿ƒå£°æ•°æ® (ç”± handleSendMessage è°ƒç”¨)
      // æ ¼å¼: Outfit|Mood|Thoughts|Psych|Memo|Diary
      function saveCharStatus(charId, rawString) {
        if (!rawString || !charId) return;

        const parts = rawString.split('|');
        // è¡¥å…¨æ•°æ®ï¼Œé˜²æ­¢ undefined
        const statusObj = {
          timestamp: Date.now(),
          outfit: parts[0] || 'Unknown',
          mood: parts[1] || 'Unknown',
          thought: parts[2] || '...',
          psych: parts[3] || '...',
          memo: parts[4] || 'None',
          diary: parts[5] || '...',
        };

        const key = `tsuki_status_${charId}`;

        // è¯»å–æ—§æ•°æ®
        let list = [];
        try {
          list = JSON.parse(localStorage.getItem(key)) || [];
        } catch (e) {}

        // æ’å…¥æœ€æ–°çš„åˆ°æœ€å‰é¢
        list.unshift(statusObj);

        // é™åˆ¶å­˜å‚¨æ•°é‡ (ä¾‹å¦‚åªå­˜æœ€è¿‘ 50 æ¡)
        if (list.length > 50) list = list.slice(0, 50);

        localStorage.setItem(key, JSON.stringify(list));
      }

      // 2. æ‰“å¼€é¢æ¿ (ç‚¹å‡»å¤´åƒè§¦å‘)
      function openStatusPanel(charId = null) {
        // å¦‚æœæ²¡ä¼  charIdï¼Œå°è¯•ä½¿ç”¨å…¨å±€çš„
        const targetId = charId || currentChatCharId;
        if (!targetId) return;

        const key = `tsuki_status_${targetId}`;
        try {
          statusList = JSON.parse(localStorage.getItem(key)) || [];
        } catch (e) {
          statusList = [];
        }

        if (statusList.length === 0) {
          alert("This character hasn't revealed their inner voice yet.");
          return;
        }

        // é»˜è®¤æ˜¾ç¤ºæœ€æ–°çš„ (Index 0)
        currentStatusIndex = 0;
        renderStatusCard(currentStatusIndex);

        const modal = document.getElementById('modal-status-panel');
        modal.classList.add('open'); // å…ˆæ˜¾ç¤º display
        setTimeout(() => modal.classList.add('active'), 10); // å†è§¦å‘åŠ¨ç”»
      }

      // 3. å…³é—­é¢æ¿
      function closeStatusPanel() {
        const modal = document.getElementById('modal-status-panel');
        modal.classList.remove('active');
        setTimeout(() => modal.classList.remove('open'), 400);
      }

      // 4. æ¸²æŸ“å¡ç‰‡å†…å®¹
      function renderStatusCard(index) {
        if (index < 0 || index >= statusList.length) return;
        const data = statusList[index];

        // æ ¼å¼åŒ–æ—¶é—´
        const date = new Date(data.timestamp);
        const timeStr = date.toLocaleString();

        document.getElementById('st-time').innerText = `${timeStr} (${index + 1}/${statusList.length})`;

        document.getElementById('st-outfit').innerText = data.outfit;
        document.getElementById('st-mood').innerText = data.mood;
        document.getElementById('st-thought').innerText = data.thought;
        document.getElementById('st-psych').innerText = data.psych;
        document.getElementById('st-memo').innerText = data.memo;
        document.getElementById('st-diary').innerText = data.diary;
      }

      // 5. è½®æ’­æ§åˆ¶
      let isStatusAnimating = false; // é˜²æ­¢å¿«é€Ÿç‚¹å‡»

      // ä¸Šä¸€é¡µ (æ—§çš„å†å²) -> å†…å®¹å‘å³æ»‘èµ°ï¼Œæ–°å†…å®¹ä»å·¦è¾¹è¿›æ¥
      function prevStatus() {
        if (isStatusAnimating) return; // å¦‚æœæ­£åœ¨åŠ¨ç”»ä¸­ï¼Œå¿½ç•¥ç‚¹å‡»

        const container = document.querySelector('.status-scroll-content');

        // æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
        if (currentStatusIndex < statusList.length - 1) {
          isStatusAnimating = true;

          // 1. å¼€å§‹ç¦»åœºåŠ¨ç”» (å‘å³æ»‘å‡º)
          container.classList.add('anim-out-right');

          // 2. ç­‰å¾… 250ms åŠ¨ç”»ç»“æŸ
          setTimeout(() => {
            currentStatusIndex++;
            renderStatusCard(currentStatusIndex);

            // æ»šå›é¡¶éƒ¨ï¼Œä½“éªŒæ›´å¥½
            container.scrollTop = 0;

            // 3. åˆ‡æ¢ç±»å (ç§»é™¤ç¦»åœºï¼Œæ·»åŠ è¿›åœº)
            container.classList.remove('anim-out-right');
            container.classList.add('anim-in-left');

            // 4. ç­‰å¾…è¿›åœºåŠ¨ç”»ç»“æŸï¼Œæ¸…ç†
            setTimeout(() => {
              container.classList.remove('anim-in-left');
              isStatusAnimating = false;
            }, 250);
          }, 250);
        } else {
          // åˆ°åº•äº†ï¼Œç»™ä¸ªå¼¹ç°§æ•ˆæœ
          document.querySelector('.status-card-container').style.transition = 'transform 0.1s';
          document.querySelector('.status-card-container').style.transform = 'translateX(-10px)';
          setTimeout(() => (document.querySelector('.status-card-container').style.transform = 'scale(1)'), 100);
        }
      }

      // ä¸‹ä¸€é¡µ (è¾ƒæ–°çš„) -> å†…å®¹å‘å·¦æ»‘èµ°ï¼Œæ–°å†…å®¹ä»å³è¾¹è¿›æ¥
      function nextStatus() {
        if (isStatusAnimating) return;

        const container = document.querySelector('.status-scroll-content');

        // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¸€é¡µ
        if (currentStatusIndex > 0) {
          isStatusAnimating = true;

          // 1. å¼€å§‹ç¦»åœºåŠ¨ç”» (å‘å·¦æ»‘å‡º)
          container.classList.add('anim-out-left');

          // 2. ç­‰å¾…
          setTimeout(() => {
            currentStatusIndex--;
            renderStatusCard(currentStatusIndex);

            container.scrollTop = 0;

            // 3. è¿›åœº
            container.classList.remove('anim-out-left');
            container.classList.add('anim-in-right');

            // 4. æ¸…ç†
            setTimeout(() => {
              container.classList.remove('anim-in-right');
              isStatusAnimating = false;
            }, 250);
          }, 250);
        } else {
          // åˆ°å¤´äº†ï¼Œå¼¹ç°§æ•ˆæœ
          document.querySelector('.status-card-container').style.transition = 'transform 0.1s';
          document.querySelector('.status-card-container').style.transform = 'translateX(10px)';
          setTimeout(() => (document.querySelector('.status-card-container').style.transform = 'scale(1)'), 100);
        }
      }

      // ================= âš™ï¸ èŠå¤©å®¤è®¾ç½®é€»è¾‘ =================

      let chatMsgLimit = 44; // é»˜è®¤æ˜¾ç¤ºæ¡æ•°

      // 1. åˆ‡æ¢é¢æ¿ (å¸¦æ¸å˜åŠ¨ç”»)
      function toggleChatSettings() {
        const panel = document.getElementById('cr-settings-panel');

        // å¦‚æœå½“å‰æ˜¯æ‰“å¼€çš„ -> å…³é—­
        if (panel.classList.contains('active')) {
          panel.classList.remove('active');
          // ç­‰åŠ¨ç”»æ’­å®Œå† noneï¼Œé¿å…åŠ¨ç”»ç¬é—´æ¶ˆå¤±
          setTimeout(() => {
            if (!panel.classList.contains('active')) panel.style.display = 'none';
          }, 300);
        }
        // å¦‚æœå½“å‰æ˜¯å…³é—­çš„ -> æ‰“å¼€
        else {
          panel.style.display = 'block';

          // âœ… [æ–°å¢] æ‰“å¼€æ—¶åŠ è½½å½“å‰è§’è‰²çš„å¤´åƒåˆ°é¢„è§ˆæ¡†
          if (currentChatCharId) {
            const char = dbCharacters.find(c => c.id === currentChatCharId);
            if (char) {
              document.getElementById('setting-preview-user').src = processAvatar(char.user_avatar);
              document.getElementById('setting-preview-char').src = processAvatar(char.avatar);
            }
          }

          // å¼ºåˆ¶é‡ç»˜ï¼Œè®© CSS transition ç”Ÿæ•ˆ
          requestAnimationFrame(() => {
            panel.classList.add('active');
          });

          // åŒæ­¥è¾“å…¥æ¡†çš„å€¼
          document.getElementById('setting-msg-limit').value = chatMsgLimit;
        }
      }

      // ç‚¹å‡»ç©ºç™½å¤„å…³é—­é¢æ¿ (å¯é€‰ä¼˜åŒ–)
      document.addEventListener('click', e => {
        const panel = document.getElementById('cr-settings-panel');
        const btn = document.querySelector('.chat-room-action');

        // å¦‚æœé¢æ¿æ‰“å¼€ä¸­ï¼Œä¸”ç‚¹å‡»çš„ä¸æ˜¯é¢æ¿å†…éƒ¨ï¼Œä¹Ÿä¸æ˜¯è§¦å‘æŒ‰é’®
        if (panel.classList.contains('active') && !panel.contains(e.target) && !btn.contains(e.target)) {
          toggleChatSettings(); // å…³é—­
        }
      });

      // 2. æ›´æ–°æ¡æ•°é™åˆ¶
      function updateMsgLimit(val) {
        const num = parseInt(val);
        if (isNaN(num) || num < 0) return;

        chatMsgLimit = num;

        // ç«‹å³åˆ·æ–°å½“å‰èŠå¤©å®¤
        if (currentChatCharId) {
          // é‡æ–°è·å–å½“å‰è§’è‰²çš„å¯¹è±¡å¹¶åˆ·æ–°
          const char = dbCharacters.find(c => c.id === currentChatCharId);
          if (char) openChatRoom(char);
        }
      }

      // 3. æ¸…ç©ºèŠå¤©è®°å½•
      async function clearCurrentChatHistory() {
        if (!currentChatCharId) return;

        if (confirm('Are you sure you want to delete ALL messages with this character?')) {
          try {
            // æ•°æ®åº“åˆ é™¤
            // æ³¨æ„ï¼šè¿™é‡Œåˆ é™¤çš„æ˜¯ chat_messages è¡¨é‡Œçš„è®°å½•
            await db.chat_messages.where('charId').equals(currentChatCharId).delete();

            // UI æ¸…ç©º
            document.getElementById('cr-body').innerHTML = '';

            // å…³é—­é¢æ¿
            toggleChatSettings();

            alert('Chat history cleared.');
          } catch (e) {
            console.error(e);
            alert('Delete failed: ' + e.message);
          }
        }
      }

      // ================= âœ¨ å¼•ç”¨åŠŸèƒ½é€»è¾‘ =================

      let currentQuoteContent = null; // å­˜å‚¨è¢«å¼•ç”¨çš„æ–‡æœ¬

      // 1. è§¦å‘å¼•ç”¨ (ç‚¹å‡»èœå•æŒ‰é’®æ—¶è°ƒç”¨)
      // ================= âœ¨ [æœ€ç»ˆæ ¼å¼ç‰ˆ] å¼•ç”¨ç”Ÿæˆé€»è¾‘ =================
      function triggerReply() {
        hideBubbleMenu();
        if (!selectedMsgEl) return;

        const bubble = selectedMsgEl.querySelector('.msg-bubble');
        if (!bubble) return;

        let content = '';

        // ğŸ› ï¸ å®‰å…¨å·¥å…·ï¼šæŠŠå†…å®¹é‡Œçš„è‹±æ–‡æ–¹æ‹¬å·è½¬ä¹‰ï¼Œé˜²æ­¢ç ´å [quote:...] ç»“æ„
        const safe = str => {
          if (!str) return '';
          // æŠŠå†…å®¹é‡Œçš„ [ ] å˜æˆ ( ) æˆ–è€…ç›´æ¥å»æ‰ï¼Œä¿æŒå¼•ç”¨ç»“æ„å®Œæ•´
          return str.replace(/\[/g, '(').replace(/\]/g, ')').trim();
        };

        // === 1. æ ¹æ®ç±»å‹æå–å†…å®¹ï¼Œä½¿ç”¨ Photo: / Voice: / Transfer: æ ¼å¼ ===

        if (bubble.classList.contains('image-card')) {
          const desc = bubble.querySelector('.img-desc')?.innerText || 'Image';
          content = `Photo: ${safe(desc)}`;
        } else if (bubble.classList.contains('voice-card')) {
          const trans = bubble.querySelector('.voice-trans-box')?.textContent || 'Message';
          content = `Voice: ${safe(trans)}`;
        } else if (bubble.classList.contains('sticker-card')) {
          let text = bubble.querySelector('.sticker-content')?.innerText || 'Sticker';
          if (!text.includes('.')) text += '.jpg';
          content = `Sticker: ${safe(text)}`;
        } else if (bubble.classList.contains('transfer-card')) {
          // æå–é‡‘é¢ (å»æ‰ç¬¦å·ï¼Œåªç•™æ•°å­—)
          let amtText = bubble.querySelector('.trans-amt')?.innerText || '0';
          let amt = amtText.replace(/[^\d.]/g, '');

          // æå–å¤‡æ³¨
          const txt = bubble.querySelector('.trans-txt')?.innerText || '';

          // æ ¼å¼ï¼šTransfer: Â¥520 (å¤‡æ³¨)
          let details = `Â¥${amt}`;
          if (txt && txt !== 'Transfer') details += ` (${txt})`;

          content = `Transfer: ${safe(details)}`;
        } else {
          // æ™®é€šæ–‡æœ¬
          const clone = bubble.cloneNode(true);
          // ç§»é™¤å¹²æ‰°å…ƒç´ 
          const existingQuote = clone.querySelector('.msg-quote-block');
          if (existingQuote) existingQuote.remove();
          const voicePlayer = clone.querySelector('.voice-player-row');
          if (voicePlayer) voicePlayer.remove();

          content = safe(clone.innerText);
        }

        // æˆªæ–­è¿‡é•¿æ–‡æœ¬
        if (content.length > 60) content = content.substring(0, 60) + '...';

        // è®¾ç½®çŠ¶æ€
        currentQuoteContent = content;

        // UI æ˜¾ç¤º
        document.getElementById('reply-preview-bar').style.display = 'flex';
        document.getElementById('rp-text').innerText = content;
        document.getElementById('cr-input').focus();
      }

      // 2. å–æ¶ˆå¼•ç”¨
      function cancelReply() {
        currentQuoteContent = null;
        document.getElementById('reply-preview-bar').style.display = 'none';
      }
      // ================= å…¨å±€çŠ¶æ€ =================
      const CONFIG_KEY = 'idea_hub_config';
      const DB_KEY = 'idea_hub_posts';

      // Dexie Init (Must match Roleplay Cards.html schema)
      // Dexie Init
      const db = new Dexie('PixelChatDB');

      // âœ… ä¿®æ”¹ç‰ˆæœ¬å·ä¸º 5ï¼Œå¹¶æ–°å¢ phone_data è¡¨
      // phone_data è¡¨ç”¨ charId ä½œä¸ºä¸»é”®ï¼Œè¿™æ ·æ¯ä¸ªè§’è‰²åªæœ‰ä¸€ä»½æ‰‹æœºæ•°æ®ï¼Œæ–°çš„ä¼šè¦†ç›–æ—§çš„
      db.version(5).stores({
        history: '++id, charId, role, content, type, timestamp',
        images: '++id, blob',
        stickers: '++id, blob, timestamp',
        characters: 'id, name, avatar, user_avatar, group',
        idea_posts: '++id, timestamp',
        chat_messages: '++id, charId, role, content, type, timestamp',
        phone_data: 'charId', // âœ¨ æ–°å¢ï¼šå­˜å‚¨è§’è‰²æ‰‹æœºå†…å®¹çš„è¡¨
      });

      let appData = {
        main: { url: '', key: '', model: 'gpt-3.5-turbo', temp: 0.7, stream: false },
        backup: { url: '', key: '', model: 'gpt-4', temp: 0.7, stream: false },
        library: {},
        activeSlot: 'main',
      };
      let tags = [];
      let dbCharacters = []; // Stores characters fetched from Dexie
      let selectedCharIds = new Set(); // Stores IDs of selected characters
      // âœ… [æ–°å¢] ç”¨äºè®°å½•å½“å‰å¼¹çª—æ‰“å¼€çš„å¸–å­ID
      let currentOpenPostId = null;
      let currentPostData = null; // âœ… [æ–°å¢] å­˜å‚¨å½“å‰æ‰“å¼€çš„å¸–å­å®Œæ•´æ•°æ®
      // ================= åˆå§‹åŒ– =================
      // ================= åˆå§‹åŒ– =================
      function initApp() {
        const saved = localStorage.getItem(CONFIG_KEY);
        if (saved) {
          try {
            const loadedData = JSON.parse(saved);
            // å…³é”®ä¿®å¤ï¼šåˆå¹¶æ—§æ•°æ®ï¼Œè€Œä¸æ˜¯ç›´æ¥è¦†ç›–
            // è¿™æ ·å¦‚æœæ—§æ•°æ®é‡Œæ²¡æœ‰ libraryï¼Œä¼šä¿ç•™é»˜è®¤çš„ç©ºå¯¹è±¡ {}
            appData = { ...appData, ...loadedData };
          } catch (e) {
            console.error('Config parse error:', e);
          }
        }

        // ğŸ›¡ï¸ åŒé‡ä¿é™©ï¼šå¦‚æœåˆå¹¶å library è¿˜æ˜¯ç©ºçš„ï¼ˆæˆ–è€…è¢«æ„å¤–è¦†ç›–æˆnullï¼‰ï¼Œå¼ºåˆ¶åˆå§‹åŒ–
        if (!appData.library) {
          appData.library = {};
        }

        // ç¡®ä¿ activeSlot æœ‰æ•ˆ
        if (!appData.activeSlot) appData.activeSlot = 'main';

        // ================= âœ¨ [ä¿®å¤ç‰ˆ] å›¾ç‰‡ä¸Šä¼ å¤„ç†é€»è¾‘ =================

        function initImageUploads() {
          // 1. è·å–å…³é”®å…ƒç´ 
          const modalBody = document.querySelector('.modal-body');
          const bgInput = document.getElementById('upload-bg');

          // âœ… æ ¸å¿ƒä¿®å¤ï¼šç›‘å¬ modal-body çš„ç‚¹å‡»
          // å› ä¸º modal-body ç›–ä½äº† headerï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ£€æµ‹ç‚¹å‡»ä½ç½®
          if (modalBody) {
            modalBody.onclick = function (e) {
              // e.target === modalBody ç¡®ä¿åªåœ¨ç‚¹ç©ºç™½å¤„è§¦å‘ï¼ˆä¸å½±å“ç‚¹é‡Œé¢çš„å¡ç‰‡æˆ–æŒ‰é’®ï¼‰
              // e.offsetY < 260 ç¡®ä¿åªåœ¨é¡¶éƒ¨èƒŒæ™¯å›¾åŒºåŸŸè§¦å‘ï¼ˆ260pxæ˜¯headerçš„é«˜åº¦ï¼‰
              if (e.target === modalBody && e.offsetY < 260) {
                bgInput.click();
              }
            };
          }

          // 2. ä¿ç•™å¤´åƒçš„ç›´æ¥ç‚¹å‡»é€»è¾‘ (å› ä¸ºå®ƒä»¬åœ¨å¡ç‰‡é‡Œï¼Œå±‚çº§å¤Ÿé«˜ï¼Œå¯ä»¥ç›´æ¥ç‚¹)
          const userAv = document.getElementById('pre-user-av');
          const charAv = document.getElementById('pre-char-av');

          if (userAv) userAv.onclick = () => document.getElementById('upload-user-av').click();
          if (charAv) charAv.onclick = () => document.getElementById('upload-char-av').click();

          // 3. ç»‘å®šæ–‡ä»¶å¤„ç† (ä¿æŒä¸å˜)
          setupFileHandler('upload-bg', 'bg', 'pre-bg-img');
          setupFileHandler('upload-user-av', 'userAvatar', 'pre-user-av');
          setupFileHandler('upload-char-av', 'charAvatar', 'pre-char-av');
        }

        function setupFileHandler(inputId, dbField, imgId) {
          const inputEl = document.getElementById(inputId);
          // é˜²å¾¡æ€§ç¼–ç¨‹ï¼šé˜²æ­¢æ‰¾ä¸åˆ°å…ƒç´ æŠ¥é”™
          if (!inputEl) return;

          inputEl.addEventListener('change', async function () {
            if (this.files && this.files[0]) {
              const file = this.files[0];

              const reader = new FileReader();
              reader.onload = async function (e) {
                const base64Result = e.target.result;

                // A. æ›´æ–°å¼¹çª—å†…å›¾ç‰‡
                const targetImg = document.getElementById(imgId);
                if (targetImg) {
                  targetImg.src = base64Result;
                  // âœ… å…³é”®ä¿®å¤ï¼šä¸Šä¼ æˆåŠŸåï¼Œå¼ºåˆ¶è®©å›¾ç‰‡æ˜¾ç¤ºå‡ºæ¥ï¼
                  // å¦åˆ™ä¹‹å‰å¦‚æœæ˜¯ç©ºçš„ï¼Œå®ƒä¼šä¸€ç›´ä¿æŒ display: none
                  targetImg.style.display = 'block';
                }

                // B. æ›´æ–°æ•°æ®åº“ & å¤–éƒ¨åˆ—è¡¨
                if (currentOpenPostId) {
                  try {
                    await db.idea_posts.update(currentOpenPostId, { [dbField]: base64Result });
                    //console.log(`âœ… Updated ${dbField}`);

                    // === æƒ…å†µ1: æ›´æ–°èƒŒæ™¯ ===
                    if (dbField === 'bg') {
                      const card = document.querySelector(`.cp-card[data-id="${currentOpenPostId}"]`);
                      if (card) {
                        card.style.backgroundImage = `linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('${base64Result}')`;
                        card.style.backgroundSize = 'cover';
                        card.style.backgroundPosition = 'center';
                      }
                    }
                    // === âœ¨ [æ–°å¢] æƒ…å†µ2: æ›´æ–° User å¤´åƒ ===
                    // æˆ‘ä»¬çš„HTMLç»“æ„é‡Œï¼Œç¬¬ä¸€ä¸ª .cp-avatar æ˜¯ Userï¼Œç¬¬äºŒä¸ªæ˜¯ Char
                    else if (dbField === 'userAvatar') {
                      const avatars = card.querySelectorAll('.cp-avatar');
                      if (avatars[0]) avatars[0].src = base64Result;
                    }

                    // === âœ¨ [æ–°å¢] æƒ…å†µ3: æ›´æ–° Character å¤´åƒ ===
                    else if (dbField === 'charAvatar') {
                      const avatars = card.querySelectorAll('.cp-avatar');
                      if (avatars[1]) avatars[1].src = base64Result;
                    }
                  } catch (err) {
                    console.error('DB Update Failed:', err);
                  }
                }
              };
              reader.readAsDataURL(file);
            }
            // æ¸…ç©º input å…è®¸é‡å¤ä¸Šä¼ åŒåæ–‡ä»¶
            this.value = '';
          });
        }

        // âœ… [æ–°å¢] åŠ è½½ä¸Šæ¬¡ä¿å­˜çš„ Tags
        const savedTags = localStorage.getItem(TAGS_KEY);
        if (savedTags) {
          try {
            tags = JSON.parse(savedTags);
          } catch (e) {
            tags = [];
          }
        }
        renderTags(); // ç«‹å³æ¸²æŸ“å‡ºæ¥

        loadHistory();
        updateLibraryDropdown();
        loadCharactersForSelection(); // Fetch DB chars
        initImageUploads(); // ğŸ‘ˆ è®°å¾—åŠ ä¸Šè¿™ä¸€è¡Œï¼
        initSettingsAvatarUpload(); // âœ… å¯åŠ¨è®¾ç½®é¢æ¿çš„å¤´åƒç›‘å¬
      }

      // ================= è§’è‰²é€‰æ‹©é€»è¾‘ (ä¿®å¤ç‰ˆ) =================
      async function loadCharactersForSelection() {
        try {
          //console.log('æ­£åœ¨åŠ è½½è§’è‰²æ•°æ®...');
          const chars = await db.characters.toArray();
          dbCharacters = chars;
          //console.log(`âœ… åŠ è½½æˆåŠŸï¼Œå…± ${chars.length} ä¸ªè§’è‰²`);

          // 1. æ¸²æŸ“é¡¶éƒ¨çš„åœ†å½¢è§’è‰²é€‰æ‹©å™¨
          renderCharSelector();

          // 2. âœ… [å…³é”®ä¿®å¤] å¦‚æœå½“å‰åœç•™åœ¨ Chat é¡µé¢ï¼Œç«‹å³ç”»å‡ºåˆ—è¡¨ï¼
          // ä¹‹å‰å°±æ˜¯å°‘äº†è¿™ä¸€æ­¥ï¼Œå¯¼è‡´æ•°æ®æœ‰äº†ä½†ç•Œé¢æ˜¯ç™½çš„
          const chatPage = document.getElementById('page-chat');
          if (chatPage && chatPage.classList.contains('active')) {
            //console.log('æ£€æµ‹åˆ°åœ¨èŠå¤©é¡µï¼Œç«‹å³æ‰§è¡Œæ¸²æŸ“...');
            renderChatList();
          }
        } catch (e) {
          console.error('DB Load Error:', e);
        }
      }

      function renderCharSelector() {
        const wrapper = document.getElementById('char-selection-area');
        const list = document.getElementById('char-list-wrapper');
        list.innerHTML = '';

        if (!dbCharacters || dbCharacters.length === 0) {
          wrapper.style.display = 'none';
          return;
        }
        wrapper.style.display = 'block';

        dbCharacters.forEach(char => {
          const item = document.createElement('div');
          item.className = 'cs-item';
          item.onclick = () => toggleCharSelect(char.id, item);

          // Process avatar
          const avatarSrc = processAvatar(char.avatar);

          item.innerHTML = `
                  <div class="cs-avatar-wrap">
                      <img src="${avatarSrc}" class="cs-avatar">
                      <div class="cs-check"><i class="fa-solid fa-circle-check"></i></div>
                  </div>
                  <div class="cs-name">${char.name}</div>
              `;
          list.appendChild(item);
        });
      }

      function toggleCharSelect(id, el) {
        if (selectedCharIds.has(id)) {
          selectedCharIds.delete(id);
          el.classList.remove('selected');
        } else {
          selectedCharIds.add(id);
          el.classList.add('selected');
        }
      }

      function processAvatar(base64) {
        if (!base64)
          return 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlZWUiLz48dGV4dCB4PSI1MCIgeT0iNTUiIGZvbnQtc2l6ZT0iNDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiNhYWEiPj88L3RleHQ+PC9zdmc+';
        if (base64.startsWith('http') || base64.startsWith('data:')) return base64;
        return 'data:image/png;base64,' + base64;
      }

      // ================= è®¾ç½®é¢æ¿é€»è¾‘ =================
      // ================= âœ¨ [ä¿®å¤] è®¾ç½®é¢æ¿åŠ¨ç”»é€»è¾‘ =================

      function openSettings() {
        const modal = document.getElementById('modal-settings');

        // 1. å…ˆæ˜¾ç¤ºå¸ƒå±€ (ä¸å¯è§)
        modal.classList.add('open');

        // 2. å»¶è¿Ÿ 10ms è§¦å‘ CSS åŠ¨ç”» (å¯è§ + æ”¾å¤§)
        setTimeout(() => {
          modal.classList.add('active');
        }, 10);

        // åŠ è½½æ•°æ®
        switchPreset(appData.activeSlot);
      }

      function closeSettings() {
        const modal = document.getElementById('modal-settings');

        // 1. å…ˆç§»é™¤ .active (è§¦å‘ç¼©å°å˜æ·¡åŠ¨ç”»)
        modal.classList.remove('active');

        // 2. ç­‰å¾… 300ms åŠ¨ç”»æ’­å®Œï¼Œå†éšè—å¸ƒå±€
        setTimeout(() => {
          modal.classList.remove('open');
        }, 300);
      }
      function switchPreset(slot) {
        appData.activeSlot = slot;
        document.getElementById('btn-main').className = slot === 'main' ? 'switcher-btn active' : 'switcher-btn';
        document.getElementById('btn-backup').className = slot === 'backup' ? 'switcher-btn active' : 'switcher-btn';

        const data = appData[slot] || {};
        document.getElementById('api_url').value = data.url || '';
        document.getElementById('api_key').value = data.key || '';

        // ==========================================
        // âœ… ä¿®å¤ï¼šè‡ªåŠ¨æ·»åŠ ç¼ºå¤±çš„æ¨¡å‹é€‰é¡¹
        // ==========================================
        const modelSelect = document.getElementById('api_model_select');
        const targetModel = data.model || 'gpt-3.5-turbo';

        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æ‰‹åŠ¨æ·»åŠ 
        let exists = Array.from(modelSelect.options).some(opt => opt.value === targetModel);
        if (!exists) {
          const newOpt = new Option(targetModel, targetModel);
          modelSelect.add(newOpt);
        }
        modelSelect.value = targetModel;
        // ==========================================

        document.getElementById('api_temp').value = data.temp || 0.7;
        document.getElementById('temp-display').innerText = data.temp || 0.7;
        document.getElementById('api_stream').checked = data.stream || false;
        // âœ… [æ–°å¢] åŠ è½½ Promptï¼Œå¦‚æœæ²¡æœ‰ä¿å­˜è¿‡åˆ™ä½¿ç”¨é»˜è®¤å¸¸é‡
        const prompts = data.prompts || {};
        document.getElementById('prompt_no_char').value = prompts.noChar || DEFAULT_PROMPT_NO_CHAR;
        document.getElementById('prompt_with_char').value = prompts.withChar || DEFAULT_PROMPT_WITH_CHAR;
      }
      function saveCurrentConfig() {
        const slot = appData.activeSlot;
        appData[slot] = {
          url: document.getElementById('api_url').value,
          key: document.getElementById('api_key').value,
          model: document.getElementById('api_model_select').value,
          temp: parseFloat(document.getElementById('api_temp').value),
          stream: document.getElementById('api_stream').checked,
          // âœ… [æ–°å¢] ä¿å­˜ Prompt è®¾ç½®
          prompts: {
            noChar: document.getElementById('prompt_no_char').value,
            withChar: document.getElementById('prompt_with_char').value,
          },
        };
        localStorage.setItem(CONFIG_KEY, JSON.stringify(appData));
        const btn = document.querySelector('.btn-save-main');
        btn.innerText = 'âœ“ Saved!';
        setTimeout(() => {
          btn.innerText = '+ Save Current Config';
        }, 1000);
      }
      function saveAsNewPreset() {
        const name = prompt('Preset Name:');
        if (!name) return;
        appData.library[name] = appData[appData.activeSlot];
        localStorage.setItem(CONFIG_KEY, JSON.stringify(appData));
        updateLibraryDropdown();
      }
      function loadFromLibrary() {
        const name = document.getElementById('preset_library').value;
        if (!name || !appData.library[name]) return;
        const data = appData.library[name];

        document.getElementById('api_url').value = data.url;
        document.getElementById('api_key').value = data.key;

        // ==========================================
        // âœ… ä¿®å¤ï¼šåŠ è½½åº“é¢„è®¾æ—¶ä¹Ÿè‡ªåŠ¨è¡¥å…¨é€‰é¡¹
        // ==========================================
        const modelSelect = document.getElementById('api_model_select');
        const targetModel = data.model;

        let exists = Array.from(modelSelect.options).some(opt => opt.value === targetModel);
        if (!exists) {
          const newOpt = new Option(targetModel, targetModel);
          modelSelect.add(newOpt);
        }
        modelSelect.value = targetModel;
        // ==========================================

        document.getElementById('api_temp').value = data.temp;
        document.getElementById('api_stream').checked = data.stream;
      }
      function updateLibraryDropdown() {
        const s = document.getElementById('preset_library');
        s.innerHTML = '<option value="">Load saved preset...</option>';
        for (let k in appData.library) s.appendChild(new Option(k, k));
      }
      async function fetchModels() {
        const url = document.getElementById('api_url').value;
        const key = document.getElementById('api_key').value;
        if (!url || !key) return alert('Missing URL/Key');
        try {
          let u = url.replace(/\/+$/, '').replace(/\/v1$/, '');
          const res = await fetch(`${u}/v1/models`, { headers: { Authorization: `Bearer ${key}` } });
          const d = await res.json();
          const sel = document.getElementById('api_model_select');
          sel.innerHTML = '';
          d.data.forEach(m => sel.appendChild(new Option(m.id, m.id)));
          alert(`Fetched ${d.data.length} models`);
        } catch (e) {
          alert('Fetch Error: ' + e.message);
        }
      }

      // ================= Tags =================
      // ================= âœ¨ Tag ç®¡ç†ç³»ç»Ÿ (å«åŠ¨ç”» & è®°å¿†) =================
      const TAGS_KEY = 'idea_hub_tags'; // å­˜å‚¨çš„ Key

      // 1. æ¸²æŸ“ Tags (ä» tags æ•°ç»„ç”Ÿæˆ HTML)
      function renderTags() {
        const c = document.getElementById('tag-container');
        // æ¸…ç†æ—§çš„ tag å…ƒç´  (ä¿ç•™ input)
        c.querySelectorAll('.tag-pill').forEach(e => e.remove());

        const input = document.getElementById('gen-keyword');

        tags.forEach((t, i) => {
          const p = document.createElement('div');
          p.className = 'tag-pill';
          // âœ… ä¿®æ”¹ï¼šä¼ å…¥ 'this' ä»¥ä¾¿è·å–ç‚¹å‡»çš„ DOM å…ƒç´ åšåŠ¨ç”»
          p.innerHTML = `${t} <i class="fa-solid fa-xmark" onclick="deleteTag(${i}, this)"></i>`;

          // æ’å…¥åˆ° input å‰é¢
          c.insertBefore(p, input);
        });

        // æ¯æ¬¡æ¸²æŸ“åä¿å­˜åˆ°æœ¬åœ°
        localStorage.setItem(TAGS_KEY, JSON.stringify(tags));
      }

      // 2. åˆ é™¤ Tag (å¸¦åŠ¨ç”»)
      function deleteTag(index, btnElement) {
        // è·å– tag-pill å…ƒç´  (å¯èƒ½æ˜¯ç‚¹å‡»å›¾æ ‡ä¼ è¿›æ¥çš„ï¼Œæˆ–è€…æ˜¯ Backspace ä¼ è¿›æ¥çš„ DOM)
        const pill = btnElement.closest ? btnElement.closest('.tag-pill') : btnElement;

        if (pill) {
          // A. æ·»åŠ ç¦»åœºåŠ¨ç”»ç±»
          pill.classList.add('removing');

          // B. ç­‰å¾…åŠ¨ç”»ç»“æŸå†çœŸæ­£åˆ é™¤æ•°æ®
          setTimeout(() => {
            // é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿ç´¢å¼•æ²¡è¶Šç•Œ
            if (index >= 0 && index < tags.length) {
              tags.splice(index, 1);
              renderTags(); // é‡æ–°æ¸²æŸ“åˆ·æ–°ç´¢å¼•
            }
          }, 280); // ç•¥å°äº CSS åŠ¨ç”»æ—¶é—´ (0.3s) æ˜¾å¾—æ›´æµç•…
        }
      }

      // 3. è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬ (å…¼å®¹æ‰‹æœº & ç”µè„‘)
      const inputEl = document.getElementById('gen-keyword');
      if (inputEl) {
        inputEl.addEventListener('keydown', function (e) {
          // âœ… å…¼å®¹æ€§ä¼˜åŒ–ï¼še.keyCode === 13 æ˜¯é€šç”¨çš„ Enter é”®ç ï¼Œå…¼å®¹æ‰‹æœºè½¯é”®ç›˜
          if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault(); // é˜²æ­¢æ‰‹æœºä¸Šè§¦å‘æ¢è¡Œæˆ–è¡¨å•æäº¤

            const v = this.value.trim();
            if (v) {
              tags.push(v);
              renderTags();
              this.value = '';

              // æ‰‹æœºä½“éªŒä¼˜åŒ–ï¼šè¾“å…¥å®Œåè‡ªåŠ¨æ»šåŠ¨åˆ°æœ€å³è¾¹ï¼Œçœ‹åˆ°æ–° tag
              setTimeout(() => {
                this.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              }, 100);
            } else {
              // å¦‚æœè¾“å…¥æ¡†æ˜¯ç©ºçš„æŒ‰å›è½¦ï¼Œè§¦å‘ç”Ÿæˆ
              generatePost();
              // æ‰‹æœºä¸ŠæŒ‰ç”Ÿæˆåæ”¶èµ·é”®ç›˜
              this.blur();
            }
          }
          // âœ… Backspace åˆ é™¤é€»è¾‘ (å¸¦åŠ¨ç”»)
          else if ((e.key === 'Backspace' || e.keyCode === 8) && this.value === '' && tags.length > 0) {
            // æ‰¾åˆ°æœ€åä¸€ä¸ª tag çš„ DOM å…ƒç´ 
            const pills = document.querySelectorAll('.tag-pill');
            const lastPill = pills[pills.length - 1];
            if (lastPill && !lastPill.classList.contains('removing')) {
              deleteTag(tags.length - 1, lastPill);
            }
          }
        });
      }
      // ================= Generate Logic (Overhauled) =================
      async function generatePost() {
        const cfg = appData[appData.activeSlot];
        if (!cfg.key) return alert('Please configure API first!');

        const inputVal = document.getElementById('gen-keyword').value.trim();
        const allTags = [...tags];
        if (inputVal) allTags.push(inputVal);

        // Mode Check: Keywords vs Selected Chars
        const hasSelectedChars = selectedCharIds.size > 0;

        if (allTags.length === 0 && !hasSelectedChars) return alert('Enter keywords or select characters!');

        const btn = document.getElementById('btn-generate');
        // btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating...';
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        btn.disabled = true;

        // Clear Recs
        document.getElementById('grid-recommendations').innerHTML = '';

        let promptPayload;

        // --- BRANCH A: Selected Characters Logic ---
        if (hasSelectedChars) {
          // 1. Gather Data for selected chars
          const targets = dbCharacters.filter(c => selectedCharIds.has(c.id));

          const charDataBlock = targets
            .map((c, index) => {
              // A. æå–ã€å‰ç½®ã€‘ä¸–ç•Œä¹¦ (Before Char)
              const wbBefore = (c.world_info_before || [])
                .filter(w => w.enabled !== false)
                .map(w => w.content)
                .join('\n');

              // B. æå–ã€åç½®ã€‘ä¸–ç•Œä¹¦ (After Char)
              const wbAfter = (c.world_info_after || [])
                .filter(w => w.enabled !== false)
                .map(w => w.content)
                .join('\n');

              // âœ… [æ ¸å¿ƒä¿®æ”¹] ä¸¥æ ¼æ§åˆ¶æ‹¼æ¥é¡ºåºï¼šBefore -> Character -> After -> User
              return `=== ğŸŒ WORLD SETTING (Global/Before) ===
${wbBefore || 'None'}

=== ğŸ‘¤ CHARACTER ${index + 1} DATA ===
ID: ${c.id}
Name: ${c.name}
Description: ${c.description}

=== ğŸ“œ SPECIFIC LORE (Specific/After) ===
${wbAfter || 'None'}

=== ğŸ”— USER BINDING ===
User Name: ${c.user_name || 'User'}
User Persona: ${c.user_persona || 'No specific persona.'}`;
            })
            .join('\n\n----------------\n\n');

          const keywords = allTags.join(', ');

          // âœ… [ä¿®æ”¹] è¯»å–è¾“å…¥æ¡†é‡Œçš„å†…å®¹ (å¦‚æœä¸ºç©ºåˆ™ç”¨é»˜è®¤)
          // è¿™æ ·ä¸ç”¨åˆ·æ–°é¡µé¢ï¼Œç”¨æˆ·ä¿®æ”¹åç›´æ¥ç‚¹ Generate å°±èƒ½ç”Ÿæ•ˆ
          let sysPrompt = document.getElementById('prompt_with_char').value;
          if (!sysPrompt) sysPrompt = DEFAULT_PROMPT_WITH_CHAR;

          // æ‹¼æ¥å…³é”®è¯ä¸Šä¸‹æ–‡ (å¯é€‰ï¼Œä¹Ÿå¯ä»¥ä½ æ‰‹åŠ¨å†™åœ¨ prompt æ¡†é‡Œ)
          // ä¸ºäº†çµæ´»ï¼Œæˆ‘ä»¬å°† keyword ä¸Šä¸‹æ–‡è¿½åŠ åˆ° User Prompt æˆ–è€…è¿™é‡Œ
          // è¿™é‡Œæˆ‘ä»¬ä¿æŒ system prompt çº¯å‡€ï¼ŒæŠŠ keyword æ”¾åœ¨ user content é‡Œï¼ˆå¦‚ä¸‹æ–‡ promptPayloadï¼‰

          promptPayload = {
            model: cfg.model,
            temperature: cfg.temp,
            stream: false,
            messages: [
              { role: 'system', content: sysPrompt },
              {
                role: 'user',
                // âœ… åŠ å¼ºè¯­æ°”ï¼šå¼ºåˆ¶è¦æ±‚å…³è” Keywords
                content: `Here are the characters:\n\n${charDataBlock}\n\nâš ï¸ CRITICAL INSTRUCTION: The scenario MUST be strictly based on these Context Keywords: ${keywords}. Do not ignore them.`,
              },
            ],
          };
        } else {
          // --- BRANCH B: Generic Keywords Logic (åŸåˆ›è§’è‰²æ¨¡å¼) ---
          const promptText = allTags.join(', ');
          // âœ… [ä¿®æ”¹] è¯»å–è¾“å…¥æ¡†å†…å®¹
          let sysPrompt = document.getElementById('prompt_no_char').value;
          if (!sysPrompt) sysPrompt = DEFAULT_PROMPT_NO_CHAR;

          promptPayload = {
            model: cfg.model,
            // ğŸ’¡ å»ºè®®ï¼šå¦‚æœè¿˜æ˜¯è·‘åï¼Œè¯•ç€æŠŠè¿™é‡Œçš„ temperature æ”¹ä¸º 0.5 æˆ– 0.6
            temperature: cfg.temp,
            stream: false,
            messages: [
              { role: 'system', content: sysPrompt },
              {
                role: 'user',
                // âœ… åŠ å¼ºè¯­æ°”ï¼šç”¨ CORE THEME å’Œ MANDATORY å…³é”®è¯å¼ºè°ƒ
                content: `CORE THEME & KEYWORDS: ${promptText}\n\nâš ï¸ MANDATORY INSTRUCTION: The character design, setting, and plot MUST explicitly revolve around the keywords provided above. If the keyword is specific (e.g. 'Cyberpunk'), the content must match that genre.`,
              },
            ],
          };
        }

        // ğŸ”¥ğŸ”¥ğŸ”¥ [è°ƒè¯•æ‰“å°] å‘é€å‰ ğŸ”¥ğŸ”¥ğŸ”¥
        console.group('ğŸš€ [API Request] æ­£åœ¨å‘é€è¯·æ±‚...');
        //console.log('ğŸ”— URL:', cfg.url);
        //console.log('ğŸ¤– Model:', cfg.model);
        //console.log('ğŸ“ å®Œæ•´ Payload (ç‚¹å‡»å±•å¼€æŸ¥çœ‹æç¤ºè¯):', promptPayload);
        //console.log('ğŸ—£ï¸ System Prompt:', promptPayload.messages[0].content);
        //console.log('ğŸ—£ï¸ User Prompt:', promptPayload.messages[1].content);
        console.groupEnd();

        // ==========================================
        // âœ… 1. æ·»åŠ å‘é€æ—¥å¿— (åœ¨ fetch ä¹‹å‰)
        // ==========================================
        // //console.log('ã€ğŸ“¤ å‘é€æç¤ºè¯ Payloadã€‘:', JSON.stringify(promptPayload, null, 2));
        // //console.log('ã€ğŸ“ System Promptã€‘:', promptPayload.messages[0].content);
        // //console.log('ã€ğŸ‘¤ User Promptã€‘:', promptPayload.messages[1].content);

        try {
          const endpoint = cfg.url.replace(/\/+$/, '') + '/v1/chat/completions';
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${cfg.key}` },
            body: JSON.stringify(promptPayload),
          });
          const data = await res.json();

          // ==========================================
          // âœ… 2. æ·»åŠ æ¥æ”¶æ—¥å¿— (åœ¨ res.json() ä¹‹å)
          // ==========================================
          // [æ–°å¢] æ£€æŸ¥ choices æ˜¯å¦ä¸ºç©º
          if (!data.choices || data.choices.length === 0) {
            console.warn('âš ï¸ API è¿”å›äº†ç©ºå†…å®¹ï¼Œç–‘ä¼¼è¢«å®‰å…¨ç­–ç•¥æ‹¦æˆªã€‚', data);

            // å°è¯•è¯»å–è¢«æ‹¦æˆªçš„åŸå›  (ä¸åŒå‚å•†å­—æ®µå¯èƒ½ä¸åŒ)
            let reason = 'æœªçŸ¥åŸå› ';
            if (data.error) reason = data.error.message;
            else if (data.prompt_feedback) reason = 'Safety Filter (Prompt Blocked)';

            alert(`ç”Ÿæˆå¤±è´¥ï¼šAPIæ‹’ç»ç”Ÿæˆå†…å®¹ã€‚\nåŸå› : ${reason}\n(é€šå¸¸æ˜¯å› ä¸ºäººè®¾åŒ…å«æ•æ„Ÿå†…å®¹ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—è¯¦æƒ…)`);

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            // document.getElementById('btn-generate').innerHTML =
            //   '<i class="fa-solid fa-bolt"></i> <span>Generate</span>';
            document.getElementById('btn-generate').innerHTML = '<i class="fa-solid fa-bolt"></i>';
            document.getElementById('btn-generate').disabled = false;
            return; // â›”ï¸ åœæ­¢è¿è¡Œï¼Œé˜²æ­¢ä¸‹é¢æŠ¥é”™
          }

          if (data.choices && data.choices.length > 0) {
            //console.log('ã€ğŸ’¬ AIå›å¤å†…å®¹ã€‘:', data.choices[0].message.content);
          }

          let raw = data.choices[0].message.content;
          raw = raw
            .replace(/```json/g, '')
            .replace(/```/g, '')
            .trim();

          let parsed;
          try {
            parsed = JSON.parse(raw);
            // âœ… 3. æ·»åŠ è§£æåçš„ JSON æ—¥å¿—
            //console.log('ã€âš™ï¸ è§£æåçš„ JSON æ•°æ®ã€‘:', parsed);
          } catch (e) {
            console.error('JSON Parse Error', e);
            // Fallback for simple array text if JSON fails (rare)
            parsed = [];
          }

          // Normalize to Array
          const results = Array.isArray(parsed) ? parsed : [parsed];

          // Process Results
          for (const item of results) {
            // Defaults
            item.tags = allTags;
            item.date = new Date().toLocaleDateString();
            item.id = item.id || 'No.' + Math.floor(Math.random() * 1000);
            item.matchRate = Math.floor(Math.random() * (99 - 70) + 70);

            // Resolve Avatars
            if (hasSelectedChars && item.refId) {
              const dbChar = dbCharacters.find(c => c.id === item.refId);
              if (dbChar) {
                item.charAvatar = processAvatar(dbChar.avatar);
                item.userAvatar = processAvatar(dbChar.user_avatar); // Fetched from DB character entry
                item.userName = dbChar.user_name || 'USER';
              } else {
                item.charAvatar = 'https://i.postimg.cc/J04FJMsS/1768119599448.png';
                item.userAvatar = 'https://i.postimg.cc/vH2JrgLf/1768119594937.png';
              }
            } else {
              // Fallback for generic generation
              item.userAvatar = 'https://i.postimg.cc/vH2JrgLf/1768119594937.png';
              item.charAvatar = 'https://i.postimg.cc/J04FJMsS/1768119599448.png';
              item.bg = '';
            }

            // Ensure BG is set
            // ğŸ”´ [ä¿®æ”¹è¿™é‡Œ] ä»¥å‰æ˜¯ if(!item.bg) item.bg = item.charAvatar;
            // âœ… [æ”¹ä¸º] å¼ºåˆ¶é»˜è®¤ä¸ºç©º
            item.bg = 'https://i.postimg.cc/zXfMGCH2/1768121295054.png';

            // âœ… å…³é”®ä¿®æ”¹ï¼šåŠ ä¸Š awaitï¼
            // ç­‰å¾…æ•°æ®åº“ä¿å­˜å®Œæ¯•ï¼Œitem.id å˜æˆäº†æ­£å¼çš„æ•°å­— ID åï¼Œå†æ‰§è¡Œ renderCard
            await saveToDB(item);
            renderCard(item, 'grid-recommendations');
            renderCard(item, 'grid-all', true);
            // âœ… [æ ¸å¿ƒä¿®æ”¹] é€ä¸€æ¸²æŸ“çš„å…³é”®ï¼šæ¯æ¸²æŸ“ä¸€å¼ ï¼Œæš‚åœ 300 æ¯«ç§’
            // è¿™æ ·é…åˆ CSS åŠ¨ç”»ï¼Œå°±ä¼šäº§ç”Ÿä¸€å¼ å¼ è¹¦å‡ºæ¥çš„æ•ˆæœ
            if (results.length > 1) {
              await new Promise(resolve => setTimeout(resolve, 800));
            }
          }

          // ğŸ”´ ã€åˆ é™¤æˆ–æ³¨é‡Šæ‰è¿™ä¸€è¡Œã€‘ç¦æ­¢è‡ªåŠ¨å¼¹å‡ºé¢„è§ˆçª—å£
          // if (results.length > 0) openPreview(results[0]);
        } catch (e) {
          console.error('API Error:', e);
          alert('Error: ' + e.message);
        } finally {
          btn.innerHTML = '<i class="fa-solid fa-bolt"></i> <span>Generate</span>';
          btn.disabled = false;
        }
      }

      // ================= DB & Render (å·²å‡çº§ä¸º IndexedDB) =================
      // ä¿å­˜åˆ° Dexie (è§£å†³ QuotaExceededError)
      async function saveToDB(post) {
        try {
          post.timestamp = Date.now();

          // âš ï¸ å…³é”®ä¿®æ”¹ï¼šå¦‚æœ post.id æ˜¯å­—ç¬¦ä¸²ï¼ˆç”Ÿæˆçš„ 'No.123'ï¼‰ï¼ŒDexie çš„ ++id ä¼šæŠ¥é”™
          // æ‰€ä»¥ä¿å­˜å‰å…ˆåˆ æ‰ä¸´æ—¶çš„ string IDï¼Œè®©æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆæ•°å­— ID
          if (typeof post.id === 'string') {
            delete post.id;
          }

          // âœ… æ·»åŠ å¹¶è·å–çœŸå®çš„ ID (key)
          const newId = await db.idea_posts.add(post);

          // âœ… æŠŠçœŸå® ID å†™å›å†…å­˜ä¸­çš„å¯¹è±¡ï¼Œè¿™æ ·åç»­ openPreview å°±èƒ½æ‹¿åˆ°å¯¹çš„ ID äº†
          post.id = newId;

          //console.log('âœ… Saved to IndexedDB with ID:', newId);
        } catch (e) {
          console.error('Save Error:', e);
          alert('ä¿å­˜å¤±è´¥ï¼Œæ•°æ®åº“å¯èƒ½å·²æ»¡æˆ–å‡ºé”™ã€‚');
        }
      }

      // ä» Dexie è¯»å–å†å²
      // ä¿®æ”¹åŸæœ¬çš„ loadHistory å‡½æ•°
      async function loadHistory() {
        const gridAll = document.getElementById('grid-all');
        const gridOffline = document.getElementById('grid-offline'); // æ–°åŒºåŸŸ
        const offlineHeader = document.getElementById('offline-section-header'); // æ–°æ ‡é¢˜

        gridAll.innerHTML = '';
        gridOffline.innerHTML = '';

        try {
          const posts = await db.idea_posts.orderBy('timestamp').reverse().toArray();

          let hasOffline = false;

          posts.forEach(p => {
            if (p.isOffline) {
              // âœ… çº¿ä¸‹å¡ç‰‡æ¸²æŸ“åˆ°æ–°åŒºåŸŸ
              renderCard(p, 'grid-offline', false);
              hasOffline = true;
            } else {
              // æ™®é€šå¡ç‰‡æ¸²æŸ“åˆ° Grid All
              renderCard(p, 'grid-all', false);
            }
          });

          // æ§åˆ¶æ ‡é¢˜æ˜¾ç¤º
          if (offlineHeader) offlineHeader.style.display = hasOffline ? 'flex' : 'none';
        } catch (e) {
          console.error('Load Error:', e);
        }
      }

      // æ¸…ç©º Dexie è¡¨
      async function clearHistory() {
        if (confirm('Are you sure you want to clear all history? This cannot be undone.')) {
          await db.idea_posts.clear();
          loadHistory();
        }
      }

      // === åˆ—è¡¨å¡ç‰‡ (æ”¯æŒèƒŒæ™¯å›¾åŒæ­¥) ===
      function renderCard(post, containerId, prepend = true) {
        const c = document.getElementById(containerId);
        const card = document.createElement('div');
        card.className = 'cp-card';

        // âœ… 1. å…³é”®ï¼šæ·»åŠ  data-idï¼Œæ–¹ä¾¿ä¸Šä¼ æ—¶æ‰¾åˆ°è¿™å¼ å¡ç‰‡
        // å¦‚æœ post.id æ­¤æ—¶æ˜¯ä¸´æ—¶çš„å­—ç¬¦ä¸²(No.xxx)ï¼Œåç»­é€»è¾‘éœ€è¦ç¡®ä¿å®ƒèƒ½å¯¹ä¸Šï¼Œæˆ–è€…åˆ·æ–°åç”Ÿæ•ˆ
        card.setAttribute('data-id', post.id);

        // âœ… 2. å…³é”®ï¼šå¦‚æœæœ‰èƒŒæ™¯ï¼Œåº”ç”¨â€œå¼±åŒ–â€æ•ˆæœ
        // linear-gradient(rgba(255,255,255,0.9), ...) å°±æ˜¯é‚£ä¸ªåŠé€æ˜ç™½è‰²è’™ç‰ˆ
        // Â·Â·0.9 è¡¨ç¤º 90% ä¸é€æ˜åº¦ï¼Œä½ å¯ä»¥è°ƒå°è¿™ä¸ªæ•°å­—è®©èƒŒæ™¯æ›´æ¸…æ™°
        if (post.bg && post.bg !== 'https://via.placeholder.com/300') {
          card.style.backgroundImage = `linear-gradient(rgba(255,255,255,0.67), rgba(255,255,255,0.59)), url('${post.bg}')`;
          card.style.backgroundSize = 'cover';
          card.style.backgroundPosition = 'center';
        }

        // 1. è·å–éœ€è¦æ˜¾ç¤ºçš„æ–‡æœ¬
        // æ ‡é¢˜ä½ï¼šä¼˜å…ˆæ˜¾ç¤º Titleï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤º CharName
        const displayTitle = post.title || post.charName || 'Untitled Scenario';

        // åå­—ä½ï¼šè·å–å­˜å‚¨çš„ç”¨æˆ·åå’Œè§’è‰²åï¼Œå¦‚æœæ²¡æœ‰åˆ™å›é€€åˆ°é»˜è®¤å€¼
        // æ³¨æ„ï¼šå¦‚æœä½ æ˜¯æ—§æ•°æ®ï¼Œå¯èƒ½æ²¡æœ‰ userName å­—æ®µï¼Œæ‰€ä»¥åŠ äº† || 'USER'
        const safeUserName = post.userName || 'USER';
        const safeCharName = post.charName || 'CHAR';

        const dQuote = post.quote || 'Waiting for signal...';

        // 2. æ¸²æŸ“ HTML
        card.innerHTML = `
                <div class="cp-header-row">
                    <div class="cp-char-info">
                        <div class="cp-char-name">${displayTitle}</div>
                        <div class="cp-char-sub">Scenario</div>
                    </div>
                    <div class="cp-match-badge">
                        <span>${post.matchRate}%</span>
                        <small>MATCH</small>
                    </div>
                </div>

                <div class="cp-interaction-zone">
                    <div class="cp-avatar-wrap">
                        <img src="${post.userAvatar}" class="cp-avatar">
                        <div class="cp-avatar-tag" style="max-width:60px; overflow:hidden; text-overflow:ellipsis;">${safeUserName}</div>
                    </div>
                    
                    <div class="cp-link-line">
                        <div class="cp-link-icon"><i class="fa-solid fa-heart"></i></div>
                    </div>
                    
                    <div class="cp-avatar-wrap">
                        <img src="${post.charAvatar}" class="cp-avatar">
                        <div class="cp-avatar-tag" style="max-width:60px; overflow:hidden; text-overflow:ellipsis;">${safeCharName}</div>
                    </div>
                </div>

                <div class="cp-quote">â€œ${dQuote}â€</div>
                
                <div class="cp-tags-row">
                    ${post.tags
                      .slice(0, 3)
                      .map(t => `<div class="cp-tag-pill">#${t}</div>`)
                      .join('')}
                </div>

                <div class="cp-footer-decor">
                    <div class="cp-id-code">ID: ${post.id} // ${post.date}</div>
                    <div class="cp-barcode">TSUKIMI</div>
                    <div class="cp-decor-icon"><i class="fa-brands fa-slack"></i></div>
                </div>
            `;

        card.onclick = () => openPreview(post);
        if (prepend && c.firstChild) c.insertBefore(card, c.firstChild);
        else c.appendChild(card);
      }

      // === è¯¦æƒ…å¼¹çª— (ä¿®å¤æ•°æ®ä¸åŒæ­¥é—®é¢˜) ===
      async function openPreview(post) {
        // 1. å°è¯•ä»æ•°æ®åº“è·å–æœ€æ–°æ•°æ®
        // å¦‚æœ post.id æ˜¯æ•°å­—ï¼ˆè¯´æ˜å·²å…¥åº“ï¼‰ï¼Œæˆ‘ä»¬å°±å»æŸ¥åº“ï¼›å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼ˆä¸´æ—¶ç”Ÿæˆçš„ï¼‰ï¼Œå°±ç”¨ä¼ è¿›æ¥çš„
        let currentData = post;

        if (post.id && typeof post.id === 'number') {
          try {
            const freshData = await db.idea_posts.get(post.id);
            if (freshData) {
              currentData = freshData; // âœ… æ‹¿åˆ°æœ€æ–°çš„æ•°æ®ï¼ˆåŒ…å«åˆšæ‰ä¸Šä¼ çš„å›¾ç‰‡ï¼‰
            }
          } catch (e) {
            console.warn('Fetch fresh data failed, using cached data.');
          }
        }

        // 2. æ›´æ–°å…¨å±€çŠ¶æ€
        currentOpenPostId = currentData.id;
        currentPostData = currentData;

        // 3. æ¸²æŸ“å›¾ç‰‡
        const bgImg = document.getElementById('pre-bg-img');
        if (currentData.bg && currentData.bg.trim() !== '') {
          bgImg.src = currentData.bg;
          bgImg.style.display = 'block';
        } else {
          bgImg.src = '';
          bgImg.style.display = 'none';
        }

        document.getElementById('pre-user-av').src = currentData.userAvatar;
        document.getElementById('pre-char-av').src = currentData.charAvatar;

        // 4. æ¸²æŸ“æ–‡å­—
        document.getElementById('pre-match-rate').innerText = currentData.matchRate + '% SYNC';
        document.getElementById('fake-query-display').innerText = currentData.tags ? currentData.tags.join(' ') : '';

        const displayTitle = currentData.title || currentData.charName || 'Untitled Scenario';
        document.getElementById('pre-title').innerText = displayTitle;

        const safeCharName = currentData.charName || 'Unknown Character';
        document.getElementById('pre-participants').innerText = `Participants: ${safeCharName}`;

        document.getElementById('pre-id').innerText = currentData.id || '---';
        document.getElementById('pre-date').innerText = currentData.date;

        const safeQuote = currentData.quote || '...';
        document.getElementById('pre-quote').innerText = `â€œ${safeQuote}â€`;
        // ==========================================
        // âœ… [æ ¸å¿ƒä¿®æ”¹] æ¸²æŸ“å†…å®¹é€»è¾‘
        // ==========================================
        const contentDiv = document.getElementById('pre-content');

        if (currentData.htmlContent) {
          // 1. å¦‚æœæœ‰ä¿å­˜è¿‡çš„ HTML (æ°”æ³¡ç‰ˆ)ï¼Œç›´æ¥ç”¨ innerHTML è¿˜åŸ
          contentDiv.innerHTML = currentData.htmlContent;
        } else {
          // 2. å¦‚æœæ˜¯æ—§æ•°æ®æˆ–è€…æ²¡ç»­å†™è¿‡ï¼Œç”¨ innerText æ˜¾ç¤ºçº¯æ–‡æœ¬
          contentDiv.innerText = currentData.content;
        }
        // ==========================================

        // 5. æ˜¾ç¤ºå¼¹çª— & ä¿®å¤æ»šåŠ¨æ¡
        const modal = document.getElementById('modal-preview');
        modal.classList.add('open');

        const body = document.querySelector('.modal-body');
        if (body) {
          body.scrollTop = 0;
          setTimeout(() => {
            body.scrollTop = 0;
          }, 10);
        }

        // ==========================================
        // âœ… [æ ¸å¿ƒä¿®æ”¹] è¿›åœºåŠ¨ç”»é€»è¾‘
        // ==========================================

        // ç¬¬ä¸€æ­¥ï¼šå…ˆæ˜¾ç¤ºå¸ƒå±€ (display: flex)ï¼Œæ­¤æ—¶ opacity è¿˜æ˜¯ 0
        modal.classList.add('open');

        // ç¬¬äºŒæ­¥ï¼šç»™æµè§ˆå™¨ 10ms çš„å–˜æ¯æ—¶é—´æ¥æ¸²æŸ“å¸ƒå±€ï¼Œç„¶åæ·»åŠ  .active è§¦å‘ CSS åŠ¨ç”»
        setTimeout(() => {
          modal.classList.add('active');
        }, 10);
      }

      function switchPage(p, el) {
        document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        if (el) el.classList.add('active');
      }
      // ================= âœ¨ [æ–°å¢] åˆ é™¤ä¸å¤åˆ¶åŠŸèƒ½ =================

      // 1. åˆ é™¤å¸–å­
      async function deleteCurrentPost() {
        if (!currentOpenPostId) return;

        if (confirm('Are you sure you want to delete this post permanently?')) {
          try {
            const numPostId = Number(currentOpenPostId);

            // âœ… A-1. [æ–°å¢] æ£€æŸ¥å¹¶é‡ç½®å¼•ç”¨äº†è¿™ä¸ª Post çš„èŠå¤©æ°”æ³¡
            // è¿™ä¸€æ­¥å¿…é¡»åœ¨åˆ é™¤ Post ä¹‹å‰åšï¼Œå¦åˆ™å…³è”å°±æ–­äº†è™½ç„¶è¿™é‡Œä¸»è¦é  ID
            const linkedMsgs = await db.chat_messages
              .filter(m => m.type === 'offline_card' && m.content.includes(`|${numPostId}`))
              .toArray();

            for (const msg of linkedMsgs) {
              //console.log('Resetting linked message:', msg.id);
              const parts = msg.content.split('|');
              // é‡ç½®æ ¼å¼: Active|åŸèƒŒæ™¯å›¾|null
              const newContent = `Active|${parts[1]}|null`;

              // 1. æ›´æ–°æ•°æ®åº“
              await db.chat_messages.update(msg.id, { content: newContent });

              // 2. å¦‚æœå½“å‰èŠå¤©æ°”æ³¡åœ¨å±å¹•ä¸Šï¼Œç«‹å³é€šè¿‡ DOM æ›´æ–°æ ·å¼ (æ— éœ€åˆ·æ–°)
              const bubbleEl = document.getElementById(`msg-${msg.id}`);
              if (bubbleEl) {
                // æ¢å¤ LIVE æ ‡ç­¾
                const body = bubbleEl.querySelector('.clapper-body');
                if (body && !body.querySelector('.clapper-status')) {
                  const badge = document.createElement('div');
                  badge.className = 'clapper-status';
                  badge.innerText = 'LIVE';
                  body.insertBefore(badge, body.firstChild);
                }
                // æ¢å¤æè¿°
                const desc = bubbleEl.querySelector('.clapper-desc');
                if (desc) desc.textContent = 'Ready to meet IRL?';
                // æ¢å¤ Action æŒ‰é’®
                const actions = bubbleEl.querySelector('.clapper-actions');
                if (actions) {
                  actions.innerHTML = `
                            <button class="clapper-btn action" onclick="event.stopPropagation(); startOfflineGeneration('${msg.id}', '${parts[1]}', this)">
                                <i class="fa-solid fa-clapperboard"></i> Action!
                            </button>
                        `;
                }
              }
            }

            // A-2. åŸæœ‰çš„ï¼šä»æ•°æ®åº“åˆ é™¤ Post
            // A. ä»æ•°æ®åº“åˆ é™¤
            await db.idea_posts.delete(currentOpenPostId);

            // B. ä» UI åˆ—è¡¨ç§»é™¤å¡ç‰‡
            const card = document.querySelector(`.cp-card[data-id="${currentOpenPostId}"]`);
            if (card) {
              card.style.transform = 'scale(0)'; // ç¼©å°åŠ¨ç”»
              setTimeout(() => card.remove(), 300);
            }

            // åŒæ ·ä¹Ÿè¦ç§»é™¤ offline grid é‡Œçš„å¡ç‰‡ (å¦‚æœæœ‰ masonry-item class)
            const masonryCard = document.querySelector(`.masonry-item[data-id="${currentOpenPostId}"]`);
            if (masonryCard) {
              masonryCard.remove();
            }

            // C. å…³é—­å¼¹çª—
            // åŸæ¥æ˜¯: document.getElementById('modal-preview').classList.remove('open');
            // âœ… æ”¹ä¸º:
            closePreview();
          } catch (e) {
            console.error('Delete failed:', e);
            alert('åˆ é™¤å¤±è´¥: ' + e.message);
          }
        }
      }

      // 2. å¤åˆ¶ Tsukipost æ ¼å¼
      function copyTsukiPost() {
        if (!currentPostData) return;

        const p = currentPostData;
        const title = p.title || p.charName || 'æ— é¢˜';
        const user = p.userName || 'User';
        const char = p.charName || 'Character';
        const tags = p.tags ? p.tags.join(', ') : 'None';
        const content = p.content || '';

        // æ„å»ºæ–‡æœ¬
        const textToCopy = `<tsukipost>
${user} åˆ†äº«ä¸€ç¯‡å¸–æ–‡ã€Š${title}ã€‹
Participants: ${char}
Tags: ${tags}
Content:
${content}
</tsukipost>`;

        // æ‰§è¡Œå¤åˆ¶
        navigator.clipboard
          .writeText(textToCopy)
          .then(() => {
            // ç®€å•çš„è§†è§‰åé¦ˆ
            const btn = document.querySelector('.copy-btn');
            const originalClass = btn.className;
            btn.className = 'fa-solid fa-check copy-btn'; // å˜æˆå¯¹é’©
            setTimeout(() => {
              btn.className = originalClass; // å˜å›å»
            }, 1000);
          })
          .catch(err => {
            console.error('Copy failed:', err);
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
          });
      }
      // âœ… [æ–°å¢] åˆ‡æ¢æŠ˜å é¢æ¿
      function togglePromptDrawer() {
        const drawer = document.getElementById('prompt-drawer');
        const arrow = document.getElementById('prompt-arrow');

        if (drawer.classList.contains('open')) {
          drawer.classList.remove('open');
          arrow.classList.remove('rotate-180');
        } else {
          drawer.classList.add('open');
          arrow.classList.add('rotate-180');
        }
      }

      // âœ… [æ–°å¢] æ¢å¤é»˜è®¤æç¤ºè¯
      function restoreDefaultPrompts() {
        if (confirm('Reset prompts to default settings?')) {
          document.getElementById('prompt_no_char').value = DEFAULT_PROMPT_NO_CHAR;
          document.getElementById('prompt_with_char').value = DEFAULT_PROMPT_WITH_CHAR;
        }
      }

      // ================= âœ¨ [ä¿®æ”¹] å…³é—­å¼¹çª—é€»è¾‘ =================
      function closePreview() {
        const modal = document.getElementById('modal-preview');

        // 1. å…ˆç§»é™¤ .active -> è§¦å‘ç¼©å°çš„ CSS ç¦»åœºåŠ¨ç”»
        modal.classList.remove('active');

        // 2. ç­‰å¾… 300ms åŠ¨ç”»æ’­æ”¾å®Œæ¯•
        setTimeout(() => {
          // 3. å†ç§»é™¤ .open -> çœŸæ­£éšè— (display: none)
          modal.classList.remove('open');

          // 4. æ¸…ç†æ•°æ®å¼•ç”¨
          currentOpenPostId = null;
          currentPostData = null;
        }, 300); // è¿™ä¸ªæ—¶é—´è¦å’Œ CSS transition: 0.3s åŒ¹é…
      }

      // ================= âœ¨ [ä¿®æ”¹ç‰ˆ] å‰§æƒ…ç»­å†™åŠŸèƒ½ (åŒè½¨å­˜å‚¨) =================

      async function handleStoryContinuation() {
        const inputEl = document.getElementById('story-input');
        const userText = inputEl.value.trim();
        const btn = document.getElementById('btn-continue');
        const contentDiv = document.getElementById('pre-content');

        // 1. æ ¡éªŒ
        if (!userText) return;
        const cfg = appData[appData.activeSlot];
        if (!cfg.key) return alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Keyï¼');

        // 2. UI æ›´æ–°ï¼šæ¸²æŸ“ç”¨æˆ·æ°”æ³¡
        const userBubble = document.createElement('div');
        userBubble.className = 'user-action-bubble';
        userBubble.innerText = userText;
        contentDiv.appendChild(userBubble);

        // è‡ªåŠ¨æ»šåŠ¨
        const modalBody = document.querySelector('.modal-body');
        // ç”¨æˆ·å‘å®Œæ¶ˆæ¯ï¼Œè¿˜æ˜¯æ»šåˆ°åº•éƒ¨ç¡®è®¤ä¸€ä¸‹æ¯”è¾ƒå¥½
        modalBody.scrollTo({ top: modalBody.scrollHeight, behavior: 'smooth' });

        // é”å®šè¾“å…¥
        inputEl.value = '';
        inputEl.disabled = true;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

        try {
          // ==========================================
          // âœ… [æ ¸å¿ƒä¿®å¤] è·å–ä¸Šä¸‹æ–‡ (å¢å¼ºç‰ˆ ID åŒ¹é…)
          // ==========================================
          let charContext = 'Character: Unknown';
          let worldBefore = ''; // å‰ç½®ï¼šä¸–ç•Œè§‚
          let worldAfter = ''; // åç½®ï¼šéšè—è®¾å®š/æ·±åº¦å‰§æƒ…
          let userContext = '[User Info]\nName: User\nPersona: None';

          // ğŸ› ï¸ è°ƒè¯•æ—¥å¿—
          console.group('ğŸ” Debugging Continuation');
          //console.log('Current Post Data:', currentPostData);

          // 1. è·å–ç›®æ ‡ ID (å…¼å®¹ refId æˆ– charId)
          // âš ï¸ æ³¨æ„ï¼šæœ‰äº›æ—§æ•°æ®å¯èƒ½æ²¡æœ‰ refIdï¼Œæˆ–è€… AI è¿”å›æ—¶æ¼äº†
          let targetId = currentPostData ? currentPostData.refId || currentPostData.charId : null;

          if (targetId) {
            //console.log('ğŸ¯ Target ID found:', targetId, typeof targetId);

            // 2. å°è¯•è·å–è§’è‰²æ•°æ® (ä¸‰é‡ä¿é™©)
            let dbChar = null;

            // (A) å°è¯•ç›´æ¥è·å–
            try {
              dbChar = await db.characters.get(targetId);
            } catch (e) {}

            // (B) å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•è½¬æˆæ•°å­—å†æ‰¾ (åº”å¯¹ "123" vs 123)
            if (!dbChar && !isNaN(targetId)) {
              //console.log('ğŸ”„ Trying Number(ID)...');
              try {
                dbChar = await db.characters.get(Number(targetId));
              } catch (e) {}
            }

            // (C) å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå°è¯•åœ¨å†…å­˜åˆ—è¡¨é‡Œâ€œæ¨¡ç³Šâ€æŸ¥æ‰¾ (ä½¿ç”¨ ==)
            if (!dbChar && dbCharacters && dbCharacters.length > 0) {
              //console.log('ğŸ“‚ Searching in memory cache...');
              dbChar = dbCharacters.find(c => c.id == targetId);
            }

            // 3. å¡«å……æ•°æ®
            if (dbChar) {
              //console.log('âœ… Character Data Loaded:', dbChar.name);

              // è§’è‰²æœ¬ä½“
              charContext = `[Character Name]: ${dbChar.name}\n[Description]: ${dbChar.description || ''}`;

              // åˆ†ç¦»ä¸–ç•Œä¹¦
              const filterWB = list =>
                (list || [])
                  .filter(w => w.enabled !== false)
                  .map(w => w.content)
                  .join('\n');
              worldBefore = filterWB(dbChar.world_info_before);
              worldAfter = filterWB(dbChar.world_info_after);

              // ç”¨æˆ·ä¿¡æ¯
              userContext = `[User Info]\nName: ${dbChar.user_name || 'User'}\nPersona: ${
                dbChar.user_persona || 'No specific persona.'
              }`;
            } else {
              console.warn('âŒ ID exists but Character NOT found in DB. (Deleted?)');
            }
          } else {
            // å¦‚æœæ˜¯â€œåŸåˆ›è§’è‰²æ¨¡å¼(Mode A)â€ï¼Œæ²¡æœ‰å…³è” ID æ˜¯æ­£å¸¸çš„
            //console.log('â„¹ï¸ No refId/charId. Assuming Original Character (Mode A).');
            charContext = `[Character Name]: ${currentPostData.charName || 'Unknown'}`;
          }
          console.groupEnd();

          const currentStoryText = currentPostData.content || contentDiv.innerText;

          // âœ… ç»„è£… Promptï¼šä¸¥æ ¼éµå®ˆé¡ºåº
          // Order: World(Before) -> Character -> World(After) -> User

          // âœ… [æ ¸å¿ƒä¿®æ”¹] é•¿ç¯‡ç»­å†™ä¸“ç”¨ Prompt
          const promptPayload = {
            model: cfg.model, // å»ºè®®ä½¿ç”¨ GPT-4o æˆ– Claude-3.5-Sonnet ä»¥æ”¯æŒé•¿è¾“å‡º
            temperature: cfg.temp,
            stream: false,
            messages: [
              {
                role: 'system',
                content: `You are a top-tier Web Novelist specializing in high-fantasy and romance.

=== ğŸŒ WORLD SETTING (Global Context) ===
${worldBefore}

=== ğŸ‘¤ CHARACTER PROFILE ===
${charContext}

=== ğŸ“œ DEEP LORE / SPECIFICS (Post-Character) ===
${worldAfter}

=== ğŸ­ USER PROFILE ===
${userContext}
(Interact with the User according to this persona.)

=== ğŸ“ TASK ===
Your task is to take the user's short action and expand it into a MASSIVE, DETAILED CHAPTER (aiming for 3000+ Chinese characters).
STRICT WRITING RULES for "EXTREME LENGTH":
1. **NO SUMMARIZING**: Never say "after a while" or "they fought". Describe every single sword swing, every breath, every glance.
2. **SLOW BURN PACING**: Dilate time. A 1-minute action should take 500 words to describe.
3. **DEEP PSYCHOLOGY**: Dive deep into the characters' inner thoughts, hesitation, memories, and conflicting emotions.
4. **SENSORY OVERLOAD**: Describe the smell of the air, the texture of clothes, the lighting, background sounds.
5. **ENVIRONMENT**: Describe the setting changes in detail as the character moves.

OUTPUT FORMAT:
- Write in purely narrative novel format (Chinese).
- No JSON. No prefixes like "Here is the story".
- Just the raw story text.`,
              },
              {
                role: 'user',
                content: `=== ğŸ“œ CURRENT STORY HISTORY ===
${currentStoryText}

=== âš¡ USER ACTION ===
${userText}

=== âœï¸ INSTRUCTION ===
Continue the story now. Focus on the character's reaction to the user and the unfolding plot.`,
              },
            ],
          };

          // ğŸ”¥ğŸ”¥ğŸ”¥ [è°ƒè¯•æ‰“å°] å‘é€å‰ ğŸ”¥ğŸ”¥ğŸ”¥
          console.group('ğŸš€ [API Request] æ­£åœ¨å‘é€è¯·æ±‚...');
          //console.log('ğŸ”— URL:', cfg.url);
          //console.log('ğŸ¤– Model:', cfg.model);
          //console.log('ğŸ“ å®Œæ•´ Payload (ç‚¹å‡»å±•å¼€æŸ¥çœ‹æç¤ºè¯):', promptPayload);
          //console.log('ğŸ—£ï¸ System Prompt:', promptPayload.messages[0].content);
          //console.log('ğŸ—£ï¸ User Prompt:', promptPayload.messages[1].content);
          console.groupEnd();

          // è°ƒè¯•æ—¥å¿—ï¼šæ£€æŸ¥é¡ºåºæ˜¯å¦æ­£ç¡®
          console.group('ğŸš€ [Correct Order Check]');
          //console.log('1. World Before:', worldBefore ? 'Has Content' : 'Empty');
          //console.log('2. Character:', charContext ? 'Has Content' : 'Empty');
          //console.log('3. World After:', worldAfter ? 'Has Content' : 'Empty');
          //console.log('4. User:', userContext);
          console.groupEnd();

          // 4. å‘é€è¯·æ±‚
          const endpoint = cfg.url.replace(/\/+$/, '') + '/v1/chat/completions';
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${cfg.key}` },
            body: JSON.stringify(promptPayload),
          });
          const data = await res.json();

          // ğŸ”¥ğŸ”¥ğŸ”¥ [è°ƒè¯•æ‰“å°] æ”¶åˆ°å ğŸ”¥ğŸ”¥ğŸ”¥
          console.group('âœ… [API Response] æ”¶åˆ° AI å“åº”');
          //console.log('ğŸ“¦ åŸå§‹æ•°æ®:', data);

          if (!data.choices || data.choices.length === 0) throw new Error('API è¿”å›ä¸ºç©º');
          const newText = data.choices[0].message.content;

          //console.log('ğŸ“„ ç”Ÿæˆå†…å®¹é¢„è§ˆ:', newText.substring(0, 100) + '...');
          //console.log('ğŸ“ ç”Ÿæˆå†…å®¹é•¿åº¦:', newText.length, 'å­—ç¬¦');
          console.groupEnd();

          // 5. UI æ›´æ–°ï¼šæ¸²æŸ“ AI ç»­å†™
          const aiBlock = document.createElement('div');
          aiBlock.className = 'ai-continuation-block';
          aiBlock.innerText = newText;
          contentDiv.appendChild(aiBlock);

          // 6. âœ… [æ ¸å¿ƒä¿®æ”¹] åŒè½¨ä¿å­˜
          if (currentOpenPostId) {
            // A. æ›´æ–°çº¯æ–‡æœ¬ (ç”¨äºå¤åˆ¶åŠŸèƒ½)
            const updatedPlainText = currentPostData.content + `\n\n[User: ${userText}]\n${newText}`;

            // B. æ›´æ–° HTML (ç”¨äºä¸‹æ¬¡æ‰“å¼€è¿˜åŸæ°”æ³¡)
            // ç›´æ¥ä¿å­˜å½“å‰ contentDiv é‡Œé¢çš„æ‰€æœ‰ HTML ä»£ç 
            const updatedHtml = contentDiv.innerHTML;

            // å­˜å…¥æ•°æ®åº“
            await db.idea_posts.update(currentOpenPostId, {
              content: updatedPlainText, // çº¯æ–‡æœ¬å­—æ®µ
              htmlContent: updatedHtml, // âœ¨ æ–°å¢ï¼šHTML è§†è§‰å­—æ®µ
            });

            // åŒæ­¥å†…å­˜ï¼Œé˜²æ­¢è¿ç»­å¯¹è¯å‡ºé”™
            currentPostData.content = updatedPlainText;
            currentPostData.htmlContent = updatedHtml;
            //console.log('ğŸ’¾ æ•°æ®åº“å·²æ›´æ–°: çº¯æ–‡æœ¬ + HTML');
          }

          // ==========================================
          // âœ… [æ ¸å¿ƒä¿®æ”¹] æ»šåŠ¨é€»è¾‘ä¼˜åŒ–
          // ==========================================
          // åŸæ¥æ˜¯: modalBody.scrollTo({ top: modalBody.scrollHeight ... }); // æ»šåˆ°åº•éƒ¨

          // ç°åœ¨æ”¹ä¸º: æ»šåŠ¨åˆ°ã€æ–°ç”Ÿæˆæ®µè½ã€‘çš„ã€é¡¶éƒ¨ã€‘
          // è¿™æ ·ä½ ç›´æ¥å°±èƒ½çœ‹åˆ°æ–°å†™çš„å¼€å¤´ï¼Œä¸éœ€è¦å¾€ä¸Šæ»‘äº†ï¼
          setTimeout(() => {
            aiBlock.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
        } catch (e) {
          console.group('âŒ [API Error] è¯·æ±‚å¤±è´¥');
          console.error(e);
          console.groupEnd();
          alert('ç»­å†™å¤±è´¥: ' + e.message);
          userBubble.remove();
        } finally {
          inputEl.disabled = false;
          btn.disabled = false;
          btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
          // âŒ inputEl.focus();  <-- æ³¨é‡Šæ‰æˆ–åˆ æ‰è¿™ä¸€è¡Œ
          // è§£é‡Šï¼šåˆ é™¤è¿™è¡Œåï¼Œç”Ÿæˆç»“æŸæ—¶é¡µé¢ä¼šåœç•™åœ¨æ–°æ¶ˆæ¯çš„é¡¶éƒ¨ï¼ˆç”±ä¸Šé¢çš„ scrollIntoView æ§åˆ¶ï¼‰ï¼Œ
          // è€Œä¸æ˜¯å¼ºåˆ¶è·³åˆ°åº•éƒ¨è¾“å…¥æ¡†ã€‚ç”¨æˆ·è¯»å®Œåï¼Œæ‰‹æŒ‡ç‚¹ä¸€ä¸‹è¾“å…¥æ¡†å³å¯è¾“å…¥ï¼Œä½“éªŒæ›´é¡ºæ»‘ã€‚
        }
      }

      // ================= ğŸ’¬ Chat System (Pinned + Groups + Swipe) =================

      let currentChatCharId = null;
      let currentSettingsCharId = null; // å½“å‰æ­£åœ¨è®¾ç½®åˆ†ç»„çš„è§’è‰²ID
      let tempSelectedGroup = ''; // å¼¹çª—é‡Œä¸´æ—¶é€‰ä¸­çš„ç»„

      // 1. æ¸²æŸ“èŠå¤©åˆ—è¡¨ (è°ƒè¯•ç‰ˆ)
      async function renderChatList() {
        //console.log('å¼€å§‹æ¸²æŸ“è”ç³»äººåˆ—è¡¨...');
        const container = document.getElementById('chat-list-container');
        container.innerHTML = '';

        try {
          // æ£€æŸ¥æ•°æ®æº
          if (!dbCharacters || dbCharacters.length === 0) {
            container.innerHTML =
              '<div style="text-align:center; padding:20px; color:#999;">æš‚æ— è”ç³»äºº<br>è¯·å…ˆåœ¨ Discovery é¡µé€‰æ‹©æˆ–åˆ›å»ºè§’è‰²</div>';
            return;
          }

          // A. æ•°æ®åˆ†ç±»
          const pinnedChars = [];
          const groupedChars = {};
          const allGroups = new Set(['Friend', 'Group', 'None']);

          for (const char of dbCharacters) {
            if (char.group) allGroups.add(char.group);

            if (char.isPinned) {
              pinnedChars.push(char);
            } else {
              const g = char.group || 'None';
              if (!groupedChars[g]) groupedChars[g] = [];
              groupedChars[g].push(char);
            }
          }

          // B. æ¸²æŸ“ Pinned
          if (pinnedChars.length > 0) {
            const pinHeader = document.createElement('div');
            pinHeader.className = 'chat-section-title';
            pinHeader.innerHTML = '<i class="fa-solid fa-thumbtack"></i> Pinned';
            container.appendChild(pinHeader);

            for (const char of pinnedChars) {
              const el = await createChatCard(char);
              container.appendChild(el);
            }
          }

          // C. æ¸²æŸ“åˆ†ç»„
          const sortedGroups = Array.from(allGroups).sort((a, b) => {
            const order = ['Friend', 'Group', 'Whole', 'Service'];
            let idxA = order.indexOf(a);
            if (idxA === -1) idxA = 99;
            let idxB = order.indexOf(b);
            if (idxB === -1) idxB = 99;
            return idxA - idxB;
          });

          for (const gName of sortedGroups) {
            const chars = groupedChars[gName];
            if (!chars || chars.length === 0) continue;

            const header = document.createElement('div');
            header.className = 'chat-group-header';
            header.innerHTML = `<span>${gName} (${chars.length})</span> <i class="fa-solid fa-chevron-down"></i>`;

            const listDiv = document.createElement('div');
            listDiv.className = 'chat-group-list';

            header.onclick = () => {
              header.classList.toggle('collapsed');
              listDiv.classList.toggle('collapsed');
            };

            container.appendChild(header);
            container.appendChild(listDiv);

            for (const char of chars) {
              const el = await createChatCard(char);
              listDiv.appendChild(el);
            }
          }
          //console.log('è”ç³»äººåˆ—è¡¨æ¸²æŸ“å®Œæˆ');
        } catch (err) {
          console.error('æ¸²æŸ“åˆ—è¡¨å‡ºé”™:', err);
          container.innerHTML = '<div style="color:red; text-align:center;">æ¸²æŸ“å‡ºé”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°</div>';
        }
      }

      // 2. åˆ›å»ºå•å¼ å¡ç‰‡ (å«æ»‘åŠ¨é€»è¾‘)
      // 2. åˆ›å»ºå•å¼ å¡ç‰‡ (å«æ»‘åŠ¨é€»è¾‘ & é˜²è¯¯è§¦ä¿®å¤)
      async function createChatCard(char) {
        const wrapper = document.createElement('div');
        wrapper.className = 'chat-item-wrapper';

        // A. èƒŒåçš„å±‚ (Settings Button)
        const backLayer = document.createElement('div');
        backLayer.className = 'swipe-actions-layer';
        backLayer.innerHTML = `
              <div class="swipe-btn-gear" onclick="openGroupModal('${char.id}')">
                  <i class="fa-solid fa-gear"></i>
              </div>
          `;

        // B. å‰æ™¯å¡ç‰‡
        const card = document.createElement('div');
        card.className = 'chat-item-card';

        // === ğŸ› ï¸ æ ¸å¿ƒä¿®æ”¹ï¼šæœ€åä¸€æ¡æ¶ˆæ¯çš„æ™ºèƒ½æ¸²æŸ“ ===
        let lastMsg = 'Click to chat...';
        let lastTime = '';
        try {
          const last = await db.chat_messages.where('charId').equals(char.id).reverse().first();
          if (last) {
            // 1. æ—¶é—´å¤„ç†
            const d = new Date(last.timestamp);
            lastTime = `${d.getHours()}:${d.getMinutes().toString().padStart(2, '0')}`;

            // 2. åŸºç¡€å†…å®¹è·å– (é˜²æ­¢ null)
            let rawContent = last.content || '';

            // 3. âœ¨ å»é™¤éšå–»å†…å®¹ (#...#)
            // è§£é‡Šï¼šæŠŠ #ä»»æ„å†…å®¹# æ›¿æ¢ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œå¹¶å»é™¤é¦–å°¾ç©ºæ ¼
            let cleanContent = rawContent.replace(/#(.*?)#/g, '').trim();

            // 4. âœ¨ å»é™¤å¼•ç”¨å†…å®¹ ([quote:...] ...)
            // è§£é‡Šï¼šå¦‚æœæ¶ˆæ¯ä»¥ [quote: å¼€å¤´ï¼Œæˆ‘ä»¬åªæå– ] åé¢çš„å›å¤éƒ¨åˆ†
            // è¿™æ ·é¢„è§ˆé‡Œä¸ä¼šæ˜¾ç¤ºä¸€å¤§ä¸² "Replying to..."
            const quoteMatch = cleanContent.match(/^\[quote:\s*[\s\S]*?\]\s*([\s\S]*)$/);
            if (quoteMatch) {
              cleanContent = quoteMatch[1].trim();
            }

            // 5. âœ¨ æ ¹æ®ç±»å‹æ·»åŠ æ ‡é¢˜å‰ç¼€
            switch (last.type) {
              // âœ… [æ–°å¢] çº¿ä¸‹å¡ç‰‡é¢„è§ˆé€»è¾‘
              case 'offline_card':
                const parts0 = (last.content || '').split('|');
                // parts[0] æ˜¯çŠ¶æ€ (Active/Finished)
                if (parts0[0] === 'Active') {
                  lastMsg = 'ğŸ¬ çº¿ä¸‹åœºæ™¯è¿›è¡Œä¸­ing...';
                } else {
                  lastMsg = 'ğŸ çº¿ä¸‹å‰§åœºå·²å®Œç»“done...';
                }
                break;
              case 'image':
                // å¦‚æœå›¾ç‰‡æ²¡æœ‰æè¿°ï¼Œæ˜¾ç¤º 'Image'
                lastMsg = `[Photo]: ${cleanContent || 'Image'}`;
                break;
              case 'voice':
                // å¦‚æœè¯­éŸ³æ²¡æœ‰è½¬æ–‡å­—ï¼Œæ˜¾ç¤º 'Audio'
                lastMsg = `[Voice]: ${cleanContent || 'Audio'}`;
                break;
              case 'emoji':
                // å»é™¤è¡¨æƒ…åŒ…åç¼€ (.jpg/.png) è®©é¢„è§ˆæ›´å¹²å‡€
                const stickerName = cleanContent.replace(/\.(jpg|png|gif)$/i, '');
                lastMsg = `[Sticker]: ${stickerName}.jpg`;
                break;
              case 'transfer':
                // è½¬è´¦æ ¼å¼æ˜¯ "é‡‘é¢|å¤‡æ³¨"ï¼Œé¢„è§ˆä¼˜å…ˆæ˜¾ç¤ºå¤‡æ³¨ï¼Œæ²¡å¤‡æ³¨æ˜¾ç¤ºé‡‘é¢
                const parts = cleanContent.split('|');
                const note = parts[1] ? parts[1].trim() : parts[0] ? `Â¥${parts[0]}` : 'Transfer';
                lastMsg = `[Transfer]: ${note}`;
                break;
              case 'text':
              default:
                // çº¯æ–‡æœ¬ï¼šå¦‚æœæ²¡æœ‰å†…å®¹ï¼ˆå¯èƒ½å…¨è¢«éšå–»è¿‡æ»¤å™¨åˆ æ‰äº†ï¼‰ï¼Œæ˜¾ç¤ºå ä½ç¬¦
                lastMsg = cleanContent || '(Hidden Message)';
                break;
            }
          }
        } catch (e) {
          console.error(e);
        }

        card.innerHTML = `
              <img src="${processAvatar(char.avatar)}" class="c-avatar">
              <div class="c-info">
                  <div class="c-top">
                      <div class="c-name">${char.name}</div>
                      <div class="c-time">${lastTime}</div>
                  </div>
                  <div class="c-msg">${lastMsg}</div>
              </div>
          `;

        // C. ç»‘å®šäº¤äº’ (âœ… æ ¸å¿ƒä¿®å¤ï¼šæ£€æŸ¥ isSwiping æ ‡è®°)
        card.onclick = e => {
          // 1. å¦‚æœåˆšæ‰å‘ç”Ÿäº†æ»‘åŠ¨ï¼ˆæœ‰æ ‡è®°ï¼‰ï¼Œåˆ™å¿½ç•¥è¿™æ¬¡ç‚¹å‡»ï¼Œå¹¶æ¸…é™¤æ ‡è®°
          if (card.dataset.isSwiping === 'true') {
            delete card.dataset.isSwiping;
            return;
          }

          // 2. æ­£å¸¸é€»è¾‘ï¼šå¦‚æœæ˜¯å±•å¼€çŠ¶æ€ï¼Œåˆ™å½’ä½ï¼›å¦åˆ™è¿›å…¥èŠå¤©
          if (
            card.style.transform &&
            card.style.transform.includes('translateX') &&
            !card.style.transform.includes('(0px)')
          ) {
            resetSwipe(card);
          } else {
            openChatRoom(char);
          }
        };

        // ç»‘å®šæ‰‹åŠ¿ (Touch + Mouse)
        bindSwipeLogic(card);

        wrapper.appendChild(backLayer);
        wrapper.appendChild(card);
        return wrapper;
      }
      // 3. æ»‘åŠ¨æ‰‹åŠ¿é€»è¾‘ (å³æ»‘éœ²å‡º)
      // 3. æ»‘åŠ¨æ‰‹åŠ¿é€»è¾‘ (ä¿®å¤ç‰ˆï¼šæ”¯æŒé¼ æ ‡ + é˜²ç‚¹å‡»å†²çª)
      function bindSwipeLogic(card) {
        let startX = 0;
        let currentX = 0;
        let isDragging = false; // æ˜¯å¦æ­£åœ¨æ‹–æ‹½

        // === é€šç”¨å¼€å§‹å¤„ç† ===
        const handleStart = x => {
          startX = x;
          card.style.transition = 'none'; // æ‹–åŠ¨æ—¶ç§»é™¤è¿‡æ¸¡ï¼Œä¿è¯è·Ÿæ‰‹
          isDragging = false;
        };

        // === é€šç”¨ç§»åŠ¨å¤„ç† ===
        const handleMove = x => {
          const diff = x - startX;
          // åªå…è®¸å‘å³æ»‘åŠ¨ (diff > 0)ï¼Œä¸”æœ‰æœ€å¤§è·ç¦»é™åˆ¶
          if (diff > 0 && diff < 200) {
            currentX = diff;
            card.style.transform = `translateX(${diff}px)`;

            // å¦‚æœç§»åŠ¨è¶…è¿‡ 5pxï¼Œå°±è®¤ä¸ºæ˜¯åœ¨æ‹–æ‹½ï¼Œä¸æ˜¯ç‚¹å‡»
            if (diff > 5) isDragging = true;
          }
        };

        // === é€šç”¨ç»“æŸå¤„ç† ===
        const handleEnd = () => {
          card.style.transition = 'transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94)';

          // é˜ˆå€¼ï¼šæ»‘åŠ¨è¶…è¿‡ 60px åˆ™å±•å¼€
          if (currentX > 60) {
            card.style.transform = `translateX(80px)`; // éœ²å‡ºæŒ‰é’®çš„ä½ç½®

            // âœ… å…³é”®ï¼šå¦‚æœç¡®å®å‘ç”Ÿäº†æ‹–æ‹½ï¼Œè®¾ç½®ä¸€ä¸ªä¸´æ—¶æ ‡è®°ï¼Œé˜»æ­¢ç´§æ¥ç€çš„ onclick
            if (isDragging) {
              card.dataset.isSwiping = 'true';
              // 300ms åæ¸…é™¤æ ‡è®°ï¼Œæ¢å¤ç‚¹å‡»åŠŸèƒ½ (é˜²æ­¢é”æ­»)
              setTimeout(() => {
                delete card.dataset.isSwiping;
              }, 300);
            }
          } else {
            card.style.transform = `translateX(0)`;
          }
          currentX = 0;
          isDragging = false;
        };

        // --- ğŸ“± è§¦æ‘¸äº‹ä»¶ (Touch) ---
        card.addEventListener('touchstart', e => handleStart(e.touches[0].clientX), { passive: true });
        card.addEventListener('touchmove', e => handleMove(e.touches[0].clientX), { passive: true });
        card.addEventListener('touchend', handleEnd);

        // --- ğŸ’» é¼ æ ‡äº‹ä»¶ (Mouse) - æ–¹ä¾¿ç”µè„‘æµ‹è¯• ---
        let isMouseDown = false;
        card.addEventListener('mousedown', e => {
          isMouseDown = true;
          handleStart(e.clientX);
        });
        window.addEventListener('mousemove', e => {
          if (!isMouseDown) return;
          handleMove(e.clientX);
        });
        window.addEventListener('mouseup', e => {
          if (!isMouseDown) return;
          isMouseDown = false;
          handleEnd();
        });
      }

      function resetSwipe(card) {
        card.style.transition = 'transform 0.2s';
        card.style.transform = `translateX(0)`;
      }

      function resetSwipe(card) {
        card.style.transition = 'transform 0.2s';
        card.style.transform = `translateX(0)`;
      }

      // ================= âš™ï¸ åˆ†ç»„è®¾ç½®é¢æ¿é€»è¾‘ =================

      function openGroupModal(charId) {
        currentSettingsCharId = charId;
        const char = dbCharacters.find(c => c.id === charId);
        if (!char) return;

        // 1. è®¾ç½®ç½®é¡¶çŠ¶æ€
        document.getElementById('group-pinned-switch').checked = !!char.isPinned;

        // 2. æ¸²æŸ“ç°æœ‰åˆ†ç»„ Chips
        // æ”¶é›†æ‰€æœ‰ç°æœ‰åˆ†ç»„ + é»˜è®¤åˆ†ç»„
        const groups = new Set(['Friend', 'Group', 'Service', 'Whole']);
        dbCharacters.forEach(c => {
          if (c.group) groups.add(c.group);
        });

        const container = document.getElementById('group-chips-container');
        container.innerHTML = '';

        // å½“å‰è§’è‰²çš„åˆ†ç»„
        tempSelectedGroup = char.group || 'Whole';

        groups.forEach(g => {
          const chip = document.createElement('div');
          chip.className = `group-chip ${g === tempSelectedGroup ? 'active' : ''}`;
          chip.innerText = g;
          chip.onclick = () => {
            // åˆ‡æ¢é€‰ä¸­æ ·å¼
            document.querySelectorAll('.group-chip').forEach(el => el.classList.remove('active'));
            chip.classList.add('active');
            tempSelectedGroup = g;
          };
          container.appendChild(chip);
        });

        // 3. æ˜¾ç¤ºå¼¹çª—
        const modal = document.getElementById('modal-group-manage');
        modal.classList.add('show');
        modal.style.display = 'flex';
        modal.style.opacity = '1';
      }

      function closeGroupModal() {
        const modal = document.getElementById('modal-group-manage');
        modal.classList.remove('show');
        modal.style.display = 'none';

        // æ‰¾åˆ°å¯¹åº”çš„å¡ç‰‡å¹¶å¤ä½
        const cards = document.querySelectorAll('.chat-item-card');
        cards.forEach(c => resetSwipe(c));
      }

      // ================= âš™ï¸ åˆ†ç»„è®¾ç½®é¢æ¿é€»è¾‘ (ä¿®å¤ç‰ˆ) =================
      async function saveGroupSettings() {
        if (!currentSettingsCharId) return;

        const isPinned = document.getElementById('group-pinned-switch').checked;

        // 1. æ›´æ–°æ•°æ®åº“
        await db.characters.update(currentSettingsCharId, {
          isPinned: isPinned,
          group: tempSelectedGroup,
        });

        // 2. âœ… [å…³é”®ä¿®å¤] é‡æ–°ä»æ•°æ®åº“æ‹‰å–æœ€æ–°æ•°æ®åˆ°å†…å­˜ï¼
        // å¦‚æœä¸åŠ è¿™è¡Œï¼Œæ¸²æŸ“çš„è¿˜æ˜¯æ—§æ•°æ®ï¼Œç½®é¡¶å’Œåˆ†ç»„éƒ½ä¸ä¼šå˜ã€‚
        dbCharacters = await db.characters.toArray();

        // 3. å…³é—­å¼¹çª—å¹¶åˆ·æ–°åˆ—è¡¨
        closeGroupModal();
        renderChatList();
      }

      // æ–°å¢è‡ªå®šä¹‰åˆ†ç»„
      function addNewGroup() {
        const input = document.getElementById('new-group-input');
        const val = input.value.trim();
        if (!val) return;

        // æ›´æ–°ä¸´æ—¶é€‰ä¸­å˜é‡
        tempSelectedGroup = val;

        // é‡æ–°æ¸²æŸ“ Chips (æŠŠæ–°ç»„åŠ è¿›å»å¹¶é€‰ä¸­)
        const container = document.getElementById('group-chips-container');

        // ç§»é™¤æ—§é€‰ä¸­
        document.querySelectorAll('.group-chip').forEach(el => el.classList.remove('active'));

        // æ·»åŠ æ–° Chip
        const chip = document.createElement('div');
        chip.className = `group-chip active`;
        chip.innerText = val;
        chip.onclick = () => {
          document.querySelectorAll('.group-chip').forEach(el => el.classList.remove('active'));
          chip.classList.add('active');
          tempSelectedGroup = val;
        };
        container.appendChild(chip);

        input.value = '';
      }
      // âœ… [è¡¥æ•‘] è¦†ç›–é»˜è®¤çš„é¡µé¢åˆ‡æ¢é€»è¾‘ï¼Œç¡®ä¿è¿›å…¥ Chat é¡µæ—¶åˆ·æ–°åˆ—è¡¨
      const originalSwitchPage = window.switchPage;
      window.switchPage = function (p, el) {
        // 1. æ‰§è¡ŒåŸæœ¬çš„ UI åˆ‡æ¢ (å˜è‰²ã€éšè—æ˜¾ç¤º)
        document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        if (el) el.classList.add('active');

        // 2. âœ… [å…³é”®] å¦‚æœåˆ‡åˆ°äº† Chat é¡µé¢ï¼Œç«‹å³æ¸²æŸ“åˆ—è¡¨ï¼
        if (p === 'chat') {
          //console.log('åˆ‡æ¢åˆ°èŠå¤©é¡µï¼Œå¼€å§‹æ¸²æŸ“...');
          renderChatList();
        }
      };

      // ================= ğŸ’¬ èŠå¤©å®¤ & æ°”æ³¡é€»è¾‘ (ä¿æŒä¹‹å‰çš„ä»£ç ï¼Œè¿™é‡Œå¼•ç”¨) =================
      // æ³¨æ„ï¼šç¡®ä¿ä¹‹å‰å†™å¥½çš„ openChatRoom, sendUserMessage, appendMessageBubble, testBubble è¿™äº›å‡½æ•°è¿˜åœ¨
      // å¦‚æœè¢«è¯¯åˆ äº†ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘å†è¡¥å‘
      async function openChatRoom(char) {
        currentChatCharId = char.id;
        document.getElementById('cr-name').innerText = char.name;
        document.getElementById('chat-room-overlay').classList.add('active');

        // === âœ… åœ¨è¿™é‡Œæ’å…¥ä»£ç ï¼šåŒæ­¥æ›´æ–°æ‚¬æµ®çƒå¤´åƒ ===
        const floatAvatar = document.getElementById('fp-avatar-img');
        if (floatAvatar) {
          // processAvatar æ˜¯ä½ ä»£ç é‡Œå·²æœ‰çš„å¤„ç† base64/url çš„å·¥å…·å‡½æ•°
          floatAvatar.src = processAvatar(char.avatar);
        }
        // ===========================================

        // 1. è·å–æ‰€æœ‰æ¶ˆæ¯ (æŒ‰æ—¶é—´æ’åº)
        let msgs = await db.chat_messages.where('charId').equals(char.id).sortBy('timestamp');

        // ==========================================
        // âœ… [æ ¸å¿ƒä¿®æ”¹] æ ¹æ®è®¾ç½®æˆªå–æ¶ˆæ¯
        // ==========================================
        if (chatMsgLimit > 0 && msgs.length > chatMsgLimit) {
          // å¦‚æœè®¾ç½®äº†é™åˆ¶(æ¯”å¦‚44)ï¼Œä¸”æ¶ˆæ¯æ€»æ•°è¶…è¿‡44
          // slice(-44) è¡¨ç¤ºå–æœ€å 44 æ¡
          msgs = msgs.slice(-chatMsgLimit);

          // å¯é€‰ï¼šåœ¨é¡¶éƒ¨æ·»åŠ ä¸€ä¸ªæç¤ºï¼Œå‘Šè¯‰ç”¨æˆ·æœ‰éšè—æ¶ˆæ¯
          // (ä½ ä¹Ÿå¯ä»¥ä¸åšè¿™ä¸€æ­¥ï¼Œçœ‹éœ€æ±‚)
        }
        // ==========================================

        const body = document.getElementById('cr-body');
        body.innerHTML = '';

        // === âœ… è·å–å¼€å…³çŠ¶æ€ ===
        const isSyncOn = document.getElementById('setting-schedule-sync')
          ? document.getElementById('setting-schedule-sync').checked
          : false;
        let lastTimestamp = 0; // è®°å½•ä¸Šä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´

        // å¦‚æœæˆªå–åæœ‰éšè—æ¶ˆæ¯ï¼Œå¯ä»¥åœ¨é¡¶éƒ¨åŠ ä¸ªæç¤º
        // if (chatMsgLimit > 0 && msgs.length < (await db.chat_messages.where('charId').equals(char.id).count())) {
        //    body.innerHTML = '<div style="text-align:center; font-size:0.7rem; color:#ccc; padding:10px;">--- Previous messages hidden ---</div>';
        // }

        const charAv = processAvatar(char.avatar);
        const userAv = processAvatar(char.user_avatar);

        // === ğŸš¨ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ for...of å¾ªç¯ (ä¸è¦ç”¨ for...in) ===
        for (const msg of msgs) {
          // 1. æ•°æ®é˜²å‘†å¤„ç† (é˜²æ­¢ undefined æŠ¥é”™)
          if (!msg) continue; // è·³è¿‡ç©ºæ•°æ®
          if (!msg.role) msg.role = 'char'; // é»˜è®¤è§’è‰²
          if (!msg.content && msg.content !== '') msg.content = '[æ•°æ®é”™è¯¯]'; // é»˜è®¤å†…å®¹

          // 2. è¡¥å…¨ç¼ºå¤±çš„æ—¶é—´æˆ³ (é˜²æ­¢ NaN å¹´ NaN æœˆ)
          if (!msg.timestamp) {
            msg.timestamp = 0;
          }
          // === âœ… ä¿®æ”¹ï¼šåªæœ‰åœ¨å¼€å¯åŒæ­¥æ—¶ï¼Œæ‰æ˜¾ç¤ºç³»ç»Ÿæ—¥æœŸåˆ†å‰²çº¿ ===
          if (isSyncOn) {
            if (lastTimestamp === 0 || isDifferentDay(lastTimestamp, msg.timestamp)) {
              if (msg.timestamp !== 0 && typeof appendDateDivider === 'function') {
                appendDateDivider(msg.timestamp);
              }
            }
          }
          // ====================================================
          lastTimestamp = msg.timestamp;
          // 4. ç¡®å®šå¤´åƒ (User è¿˜æ˜¯ Char)
          // æ³¨æ„ï¼šchar.user_avatar æ˜¯ä½ åœ¨è®¾ç½®é‡Œä¸Šä¼ çš„ç”¨æˆ·å¤´åƒ
          let avatarUrl = '';
          if (msg.role === 'user') {
            avatarUrl = processAvatar(char.user_avatar);
          } else {
            avatarUrl = processAvatar(char.avatar);
          }

          // 5. æ¸²æŸ“æ°”æ³¡
          // ç¡®ä¿å‚æ•°é¡ºåºæ­£ç¡®: role, content, type, avatar, id, timestamp
          // æ¸²æŸ“æ°”æ³¡ (appendMessageBubble å†…éƒ¨ä¼šè‡ªåŠ¨è¯»å–å¼€å…³æ¥å†³å®šæ˜¯å¦æ˜¾ç¤ºæ°”æ³¡å†…çš„æ—¶é—´æˆ³)
          appendMessageBubble(msg.role, msg.content, msg.type || 'text', avatarUrl, msg.id, msg.timestamp);
        }

        // âœ… [æ–°å¢] æ¢å¤çº¿ä¸‹æ¨¡å¼å¼€å…³çŠ¶æ€
        const switchEl = document.getElementById('setting-offline-mode');
        if (switchEl) {
          const savedState = localStorage.getItem('offline_mode_' + char.id);
          // åªæœ‰å½“ savedState æ˜ç¡®ä¸º 'true' æ—¶æ‰è®¾ä¸º checked
          switchEl.checked = savedState === 'true';
        }

        // ç¨å¾®å»¶è¿Ÿæ»šåŠ¨ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å ä½
        setTimeout(() => {
          body.scrollTop = body.scrollHeight;
        }, 50);
      }

      // function closeChatRoom() {
      //   document.getElementById('chat-room-overlay').classList.remove('active');
      //   currentChatCharId = null;

      //   // === âœ… å¯é€‰ï¼šé€€å‡ºæ—¶é‡ç½®å›é»˜è®¤å›¾æ ‡ ===
      //   const floatAvatar = document.getElementById('fp-avatar-img');
      //   if (floatAvatar) {
      //     // æ¢æˆé»˜è®¤å›¾ï¼Œæˆ–è€…æ¢æˆä½ æƒ³è¦çš„ä»»ä½•å›¾ç‰‡ URL
      //     floatAvatar.src = 'https://i.postimg.cc/J04FJMsS/1768119599448.png';
      //   }
      //   // ==================================

      //   renderChatList();
      // }
      function closeChatRoom() {
        // === âœ… æ–°å¢é€»è¾‘ï¼šåœ¨æ¸…é™¤ ID å‰ï¼Œå…ˆè·å–å½“å‰è§’è‰²çš„ User å¤´åƒ ===
        if (currentChatCharId) {
          // dbCharacters æ˜¯å…¨å±€å˜é‡ï¼Œå­˜ç€æ‰€æœ‰è§’è‰²æ•°æ®ï¼Œç›´æ¥æŸ¥å°±è¡Œï¼Œä¸ç”¨ await æŸ¥åº“
          const char = dbCharacters.find(c => c.id === currentChatCharId);

          if (char) {
            const floatAvatar = document.getElementById('fp-avatar-img');
            // char.user_avatar å°±æ˜¯ä½ åœ¨è®¾ç½®é‡Œä¸Šä¼ çš„ User å¤´åƒ
            // å¦‚æœæ²¡æœ‰ä¸Šä¼ ï¼ŒprocessAvatar ä¼šè¿”å›é»˜è®¤å ä½å›¾
            if (floatAvatar) {
              floatAvatar.src = processAvatar(char.user_avatar);
            }
          }
        }
        // ========================================================

        document.getElementById('chat-room-overlay').classList.remove('active');

        // æ¸…é™¤ ID (è¿™æ­¥å¿…é¡»åœ¨ä¸Šé¢è®¾ç½®å®Œå¤´åƒä¹‹å)
        currentChatCharId = null;

        // åˆ·æ–°åˆ—è¡¨
        renderChatList();
      }

      // 3. æ¸²æŸ“å†å²æ¶ˆæ¯
      async function renderChatHistory(charId) {
        const body = document.getElementById('cr-body');
        body.innerHTML = '';

        // è·å–å½“å‰è§’è‰²å¤´åƒ (ä¸ºäº†æ¸²æŸ“)
        const char = dbCharacters.find(c => c.id === charId);
        const charAv = processAvatar(char ? char.avatar : null);

        // ä» history è¡¨è¯»å–
        const msgs = await db.history.where('charId').equals(charId).sortBy('timestamp');

        msgs.forEach(msg => {
          appendMessageBubble(msg.role, msg.content, charAv);
        });

        scrollToBottom();
      }

      // 4. æ¸²æŸ“æ°”æ³¡ (æ”¯æŒèœå• + è¯­éŸ³ + éšå–» + âœ… æ—¶é—´æˆ³åŒæ­¥)
      function appendMessageBubble(role, content, type, charAv, msgId, timestamp = Date.now()) {
        // âœ… æ¥æ”¶ msgId
        const body = document.getElementById('cr-body');
        const row = document.createElement('div');
        row.className = `msg-row ${role === 'user' ? 'user' : 'char'}`;

        let bubbleHtml = '';

        // âš ï¸ æ³¨æ„ï¼šè¿™é‡Œçš„ bubbleClass ä¸è¦åŠ é»˜è®¤çš„ padding/bgï¼Œç”±å†…éƒ¨å¡ç‰‡è‡ªå·±å†³å®š
        let baseClass = `msg-bubble`;

        // âœ… é€šç”¨èœå•ç‚¹å‡»äº‹ä»¶ (ä¼ é€’ event, id, this)
        // æ³¨æ„ï¼šæˆ‘ä»¬åœ¨ onclick é‡Œè°ƒç”¨ showBubbleMenu
        const menuAttr = `onclick="showBubbleMenu(event, '${msgId}', this)"`;

        // =========================================
        // âœ… æ–°å¢ï¼šå‡†å¤‡æ—¶é—´æˆ³ HTML (ä»… User ä¸” å¼€å…³å¼€å¯æ—¶æ˜¾ç¤º)
        // =========================================
        let timeHtml = '';
        const isSyncOn = document.getElementById('setting-schedule-sync')
          ? document.getElementById('setting-schedule-sync').checked
          : false;

        if (role === 'user' && isSyncOn) {
          const dateObj = new Date(timestamp);
          const timeStr = `${String(dateObj.getHours()).padStart(2, '0')}:${String(dateObj.getMinutes()).padStart(
            2,
            '0',
          )}`;
          // ä½¿ç”¨ä¹‹å‰å®šä¹‰å¥½çš„ CSS ç±» .msg-time-foot
          timeHtml = `<div class="msg-time-foot" style="font-size: 0.7rem; opacity: 0.7; text-align: right; margin-top: 4px;">${timeStr}</div>`;
        }
        // =========================================

        // =========================================
        // âœ¨ æ–°å¢é€»è¾‘ï¼šæå–éšå–»/ç¿»è¯‘å†…å®¹ (#...#)
        // =========================================
        let hiddenMetaphor = null;
        let cleanContent = content; // é»˜è®¤æ˜¯åŸå§‹å†…å®¹

        // åªå¯¹ Char çš„æ¶ˆæ¯è¿›è¡Œéšå–»æå– (æˆ–è€… User ä¹Ÿè¡Œï¼Œçœ‹ä½ éœ€æ±‚ï¼Œè¿™é‡Œé™åˆ¶ä¸º Char æ›´ç¬¦åˆé€»è¾‘)
        // åŒæ—¶ä¹Ÿåªå¯¹æ–‡æœ¬ç±»(text)æˆ–åŒ…å«æ–‡æœ¬çš„ç±»å‹ç”Ÿæ•ˆ
        if (role === 'char' || role === 'user') {
          // æ­£åˆ™ï¼šåŒ¹é… #å†…å®¹#
          // ä½¿ç”¨éè´ªå©ªåŒ¹é… (.*?) ä»¥æ”¯æŒä¸€è¡Œé‡Œæœ‰å¤šä¸ª tag (è™½ç„¶UIæš‚æ—¶åªå±•ç¤ºåˆå¹¶åçš„)
          const metaRegex = /#(.*?)#/g;
          const matches = [...content.matchAll(metaRegex)];

          if (matches.length > 0) {
            // 1. æå–å‡ºæ‰€æœ‰çš„éšå–»å†…å®¹ï¼Œç”¨ç©ºæ ¼è¿æ¥
            hiddenMetaphor = matches.map(m => m[1]).join(' ');

            // 2. ä»æ˜¾ç¤ºæ–‡æœ¬ä¸­ç§»é™¤ #...#
            cleanContent = content.replace(metaRegex, '').trim();

            // å¦‚æœç§»é™¤åä¸ºç©ºï¼ˆæ¯”å¦‚åªå‘äº†éšå–»ï¼‰ï¼Œå°±ä¿ç•™åŸæ ·æˆ–æ˜¾ç¤ºå ä½
            if (!cleanContent) cleanContent = '...';
          }
        }

        // =========================================
        // âœ‚ï¸ å¼•ç”¨æå–é€»è¾‘ (ä¿æŒä½ åŸæœ‰çš„é€»è¾‘ï¼Œåªæ˜¯æŠŠ content æ¢æˆ cleanContent)
        // =========================================
        let quoteHtml = '';
        let finalDisplayContent = cleanContent;
        let quotedText = '';

        const match = String(finalDisplayContent).match(/^\[quote:\s*([\s\S]*?)\]\s*([\s\S]*)$/);
        if (match) {
          quotedText = match[1].trim();
          finalDisplayContent = match[2].trim();
        }

        if (quotedText) {
          quotedText = quotedText.replace(/^"|"$/g, '');
          const isSpecialQuote = /^(Photo|Voice|Sticker|Transfer):/i.test(quotedText);
          const finalQuoteDisplay = isSpecialQuote ? quotedText : `"${quotedText}"`;
          quoteHtml = `
          <div class="msg-quote-block" onclick="scrollToOriginalMessage(this, event)">
             <div class="quote-name">Replying to</div>
             <div class="quote-content">${finalQuoteDisplay}</div>
          </div>
        `;
        }
        // ... (ä¸Šé¢æ˜¯æå– quoteHtml å’Œ cleanContent çš„ä»£ç ï¼Œä¿æŒä¸å˜) ...

        // =========================================
        // ğŸ¨ 2. æ¸²æŸ“å…·ä½“æ°”æ³¡ (é€»è¾‘å‡çº§ï¼šç‰¹æ®Šæ°”æ³¡å¼•ç”¨åˆ†ç¦»)
        // =========================================

        // æ ‡è®°æ˜¯å¦ä¸ºç‰¹æ®Šæ°”æ³¡ï¼ˆå›¾ç‰‡/è¯­éŸ³/è¡¨æƒ…/è½¬è´¦ï¼‰
        // å¦‚æœæ˜¯ç‰¹æ®Šæ°”æ³¡ï¼Œå¼•ç”¨æ¡è¦æ”¾åœ¨å¤–é¢ï¼›å¦‚æœæ˜¯çº¯æ–‡æœ¬ï¼Œå¼•ç”¨æ¡è¿˜åœ¨é‡Œé¢
        const isSpecialBubble = type !== 'text';

        // ä¸´æ—¶å˜é‡ï¼šå¤–éƒ¨å¼•ç”¨ HTML (é»˜è®¤ä¸ºç©º)
        let externalQuoteHtml = '';

        // å¦‚æœæœ‰å¼•ç”¨ï¼Œä¸”æ˜¯ç‰¹æ®Šæ°”æ³¡ï¼Œå¤„ç†å¼•ç”¨æ¡æ ·å¼
        if (quoteHtml && isSpecialBubble) {
          // ç»™ quoteHtml åŠ ä¸€ä¸ª external ç±»ï¼Œåˆ©ç”¨ CSS å˜æˆç‹¬ç«‹å°æ°”æ³¡
          externalQuoteHtml = quoteHtml.replace('class="msg-quote-block"', 'class="msg-quote-block external"');
          // æ¸…ç©ºåŸæœ¬çš„ quoteHtmlï¼Œé˜²æ­¢ bubbleHtml é‡Œé‡å¤æ¸²æŸ“
          // (ä½†åœ¨ Text é€»è¾‘é‡Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦ç”¨åˆ°åŸå§‹ quoteHtml)
        }

        // === ğŸ¤ è¯­éŸ³æ¡ ===
        if (type === 'voice') {
          let len = finalDisplayContent.length;
          let seconds = Math.ceil(len / 2);
          if (seconds < 2) seconds = 2;
          if (seconds > 60) seconds = 60;

          // æ³¨æ„ï¼šè¿™é‡Œä¸å†åŒ…å« ${quoteHtml}ï¼Œå› ä¸ºå®ƒè¢«ç§»åˆ°å¤–é¢äº†
          bubbleHtml = `
                <div class="${baseClass} voice-card open" ${menuAttr} style="display:flex; flex-direction:column;">
                    <div class="voice-player-row">
                        <div class="voice-icon" onclick="event.stopPropagation(); toggleVoiceBubble(this.closest('.voice-card'))">
                            <i class="fa-solid fa-play"></i>
                        </div>
                        <div class="voice-lines">
                            <div class="v-line"></div><div class="v-line"></div><div class="v-line"></div>
                        </div>
                        <span style="font-size:0.8rem; margin-left:auto;">${seconds}"</span>
                    </div>
                    <div class="voice-trans-box">
                        ${finalDisplayContent}
                    </div>
                ${timeHtml} </div>`;
        }
        // === ğŸ–¼ï¸ å›¾ç‰‡å¡ç‰‡ ===
        else if (type === 'image') {
          baseClass += ' image-card';
          bubbleHtml = `
                <div class="${baseClass}" ${menuAttr} style="display:flex; flex-direction:column; min-width:140px;">
                    <div class="img-placeholder"><i class="fa-regular fa-image"></i></div>
                    <div class="img-desc">${finalDisplayContent || 'Image'}</div>
                ${timeHtml} </div>`;
        }
        // === ğŸ¤  è¡¨æƒ…åŒ… ===
        else if (type === 'emoji') {
          baseClass += ' sticker-card';
          let mainText = finalDisplayContent.replace(/\.(jpg|png|gif)$/i, '');
          let ext = finalDisplayContent.match(/\.(jpg|png|gif)$/i)?.[0] || '.JPG';

          bubbleHtml = `
                <div class="${baseClass}" ${menuAttr} style="display:flex; flex-direction:column; align-items:center;">
                    <div class="sticker-content">${mainText}</div>
                    <div class="sticker-ext">${ext}</div>
                ${timeHtml} </div>`;
        }
        // === ğŸ’° è½¬è´¦å¡ç‰‡ ===
        else if (type === 'transfer') {
          baseClass += ' transfer-card';
          let parts = String(finalDisplayContent).split('|');
          let money = parts[0];
          let remark = parts[1] || 'Transfer';

          // è½¬è´¦å¡ç‰‡ä¸å†éœ€è¦åœ¨å†…éƒ¨å¤„ç† styledQuote
          bubbleHtml = `
                <div class="${baseClass}" ${menuAttr} style="display:flex; flex-direction:column; padding:15px;">
                    <div class="trans-top" style="padding:0;">
                        <div class="trans-icon"><i class="fa-solid fa-check"></i></div>
                        <div class="trans-info">
                            <div class="trans-amt">Â¥ ${money}</div>
                            <div class="trans-txt">${remark}</div>
                        </div>
                    </div>
                    <div class="trans-bot" style="margin-top:10px; margin-bottom:-15px; margin-left:-15px; margin-right:-15px;">
                        <span>Tsuki Pay</span>
                    </div>
                ${timeHtml} </div>`;
        } // === ğŸ¬ [æ–°å¢] çº¿ä¸‹åœºè®°æ¿å¡ç‰‡ ===
        else if (type === 'offline_card') {
          baseClass += ' offline-card';

          // è§£æå†…å®¹: Status|BgUrl|PostId
          const parts = String(finalDisplayContent).split('|');
          const status = parts[0] || 'Active';
          const bgUrl = parts[1] || DIARY_BGS[0]; // å¦‚æœæ²¡è¯»åˆ°å°±ç”¨é»˜è®¤çš„
          const linkedPostId = parts[2];

          const isFinished = status === 'Finished';

          // åŠ¨æ€ç”ŸæˆæŒ‰é’® HTML
          let buttonsHtml = '';

          if (!isFinished) {
            // ğŸ¬ çŠ¶æ€ï¼šæœªå¼€å§‹ -> æ˜¾ç¤º "Action!" æŒ‰é’®
            // âœ… ä¿®æ”¹ç‚¹ 1: åŠ å…¥ event.stopPropagation();
            buttonsHtml = `
            <button class="clapper-btn action" onclick="event.stopPropagation(); startOfflineGeneration('${msgId}', '${bgUrl}', this)">
                <i class="fa-solid fa-clapperboard"></i> Action!
            </button>
      
        
        `;
          } else {
            // ğŸ çŠ¶æ€ï¼šå·²ç”Ÿæˆå‰§æœ¬ -> æ˜¾ç¤º "Summary" æŒ‰é’®
            // âœ… ä¿®æ”¹ç‚¹ 2: è¿™é‡Œçš„æŒ‰é’®ä¹Ÿè¦åŠ ï¼Œé˜²æ­¢è¯¯è§¦
            buttonsHtml = `
            <button class="clapper-btn" onclick="event.stopPropagation(); openLinkedOfflinePost('${linkedPostId}')" style="flex:1">
                <i class="fa-solid fa-eye"></i> å›é¡¾
            </button>
            <button class="clapper-btn action" onclick="event.stopPropagation(); finishOfflineMode('${msgId}', '${linkedPostId}', this)" >
                <i class="fa-solid fa-flag-checkered"></i> æ€é’
            </button>
        `;
          }
          // âœ¨ ä¿®æ”¹ç‚¹ 2: ç»™å¤–å±‚ div æ·»åŠ  id="msg-${msgId}"
          bubbleHtml = `
        <div id="msg-${msgId}" class="${baseClass}" ${menuAttr}>
            <div class="clapper-board">
                <div class="clapper-top"></div>
                <div class="clapper-body" style="background-image: url('${bgUrl}')">
                    ${!isFinished ? '<div class="clapper-status">LIVE</div>' : ''}
                    <div class="clapper-content">
                        <div class="clapper-title">OFFLINE THEATER</div>
                        <div class="clapper-meta">SCENE ${msgId.toString().slice(-3)} â€¢ TAKE 1</div>
                        <div class="clapper-desc" style="font-size:0.8rem; color:#2d3436; margin-bottom:10px; font-style:italic;">
                            ${!isFinished ? 'Ready to meet IRL?' : 'Scenario Generated.'}
                        </div>
                        <div class="clapper-actions">
                            ${buttonsHtml}
                        </div>
                    </div>
                </div>
            </div>
        ${timeHtml} </div>`;
        }
        // === ğŸ“ æ™®é€šæ–‡æœ¬ (ä¿æŒåŸæ ·ï¼Œå¼•ç”¨åœ¨æ°”æ³¡å†…éƒ¨) ===
        else {
          // å¯¹äº Textï¼ŒfinalDisplayContent å°±æ˜¯å›å¤çš„å†…å®¹
          let styleClass =
            role === 'user'
              ? 'background:var(--text-main); color:#fff; border-radius:18px 18px 4px 18px;'
              : 'background:#fff; color:var(--text-main); border-radius:18px 18px 18px 4px; box-shadow:0 2px 5px rgba(0,0,0,0.05);';

          // æ³¨æ„ï¼šè¿™é‡Œä¿ç•™ ${quoteHtml}ï¼Œå› ä¸ºæ–‡æœ¬æ°”æ³¡çš„å¼•ç”¨æ˜¯åœ¨å†…éƒ¨æœ€ç¾è§‚çš„
          bubbleHtml = `
              <div class="${baseClass}" style="padding:10px 14px; line-height:1.5; ${styleClass} display:flex; flex-direction:column;" ${menuAttr}>
                  ${quoteHtml} 
                  <div>${finalDisplayContent}</div>
              ${timeHtml} </div>`;
        }

        // =========================================
        // âœ¨ ç»„è£…æœ€ç»ˆ HTML (åŠ å…¥éšå–»æŒ‰é’®ç»“æ„)
        // =========================================
        let finalInnerHtml = '';

        if (charAv) {
          if (role === 'char') {
            finalInnerHtml += `<img src="${charAv}" class="msg-av" style="cursor:help" onclick="openStatusPanel('${currentChatCharId}')">`;
          } else {
            finalInnerHtml += `<img src="${charAv}" class="msg-av">`;
          }
        }

        // å¤„ç†å¤–éƒ¨å¼•ç”¨æ¡ (ä¿æŒä½ ä¹‹å‰çš„é€»è¾‘)
        if (quoteHtml && isSpecialBubble) {
          externalQuoteHtml = quoteHtml.replace('class="msg-quote-block"', 'class="msg-quote-block external"');
        }

        // ğŸ”¥ æ ¸å¿ƒæ”¹åŠ¨ï¼šå¦‚æœæœ‰ hiddenMetaphorï¼ŒåŒ…è£¹ä¸€å±‚ wrapper å¹¶æ·»åŠ æŒ‰é’®
        let contentWrapper = '';

        if (hiddenMetaphor) {
          // åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ ID æ–¹ä¾¿ç»‘å®š
          const metaId = `meta-${msgId || Date.now()}-${Math.random().toString(36).substr(2, 5)}`;

          contentWrapper = `
            <div class="bubble-with-action">
                <div style="display:flex; flex-direction:column; max-width:100%;">
                    ${bubbleHtml}${externalQuoteHtml}
                </div>

                <div class="trans-trigger-box" style="position:relative;">
                    <div class="trans-btn-trigger" onclick="toggleMetaphor('${metaId}', event)" title="Read Metaphor">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path d="M12.0002 6.5C12.3002 4.5 13.5002 2 17.5002 2C20.5002 2 22.0002 5.5 22.0002 8C22.0002 12 17.0002 15 12.0002 22C7.0002 15 2.0002 12 2.0002 8C2.0002 5.5 3.5002 2 6.5002 2C10.5002 2 11.7002 4.5 12.0002 6.5Z" 
              style="transform: scale(0.9); transform-origin: center;"/>
        <path d="M12 7C12 7 13 4 16 4C18 4 19 5 19 6" stroke="white" stroke-width="1.5" stroke-linecap="round" fill="none" opacity="0.4"/>
    </svg>
                    </div>
                    
                    <div id="${metaId}" class="metaphor-popup" onclick="event.stopPropagation()">
                        <div class="metaphor-label"><i class="fa-solid fa-feather"></i> Decipher</div>
                        <div class="metaphor-content">${hiddenMetaphor}</div>
                    </div>
                </div>
            </div>
        `;
        } else {
          // æ²¡æœ‰éšå–»ï¼Œä¿æŒåŸæ ·
          contentWrapper = `
            <div class="msg-col-flex">
                ${bubbleHtml}${externalQuoteHtml}
            </div>
        `;
        }

        finalInnerHtml += contentWrapper;

        row.innerHTML = finalInnerHtml;
        body.appendChild(row);
      }

      function scrollToBottom() {
        const body = document.getElementById('cr-body');
        body.scrollTop = body.scrollHeight;
      }

      // 5. å‘é€æ¶ˆæ¯é€»è¾‘ (ä¿®æ”¹ç‰ˆï¼šå…è®¸ç©ºå†…å®¹è§¦å‘ AI)
      async function sendUserMessage(mode) {
        const input = document.getElementById('cr-input');
        let text = input.value.trim();

        // æ‹¦æˆªï¼šæ™®é€šæ¨¡å¼ä¸‹æ²¡å­—ä¸å‘ï¼ŒAIæ¨¡å¼ä¸‹æ²¡å­—å¯ä»¥å‘
        if (!text && mode !== 'ai_reply') return;

        // âœ… æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœæœ‰å¼•ç”¨å†…å®¹ï¼Œæ‹¼æ¥æ ¼å¼
        if (currentQuoteContent) {
          // æ ¼å¼ï¼š [quote:è¢«å¼•ç”¨çš„å†…å®¹] ç”¨æˆ·çš„å›å¤
          text = `[quote:${currentQuoteContent}] ${text}`;

          // å‘é€å®Œæ¸…é™¤å¼•ç”¨çŠ¶æ€
          cancelReply();
        }

        input.value = '';
        input.focus();

        await handleSendMessage('text', text, mode);
      }
      // ================= âœ¨ [æœ€ç»ˆç¨³å®šç‰ˆ] å‘é€å¤„ç† (ä¿®å¤æŠ¥é”™+æµå¼æ‹†åˆ†) =================
      async function handleSendMessage(type, content, mode) {
        const char = dbCharacters.find(c => c.id === currentChatCharId);
        if (!char) return;

        // âœ… 1. æ˜ç¡®è·å–æŒ‰é’® (é€šè¿‡ ID)
        const btn = document.getElementById('btn-ai-submit') || document.querySelector('.btn-send-ai');

        // === âœ… ä¿®æ”¹ï¼šå‘é€å‰æ£€æŸ¥ UI æ—¥æœŸåˆ†å‰² (å¢åŠ  isSyncOn åˆ¤æ–­) ===
        const isSyncOn = document.getElementById('setting-schedule-sync').checked; // è·å–å¼€å…³
        const nowTs = Date.now();

        // === âœ… 1. å‘é€å‰æ£€æŸ¥ UI æ—¥æœŸåˆ†å‰² ===
        // è·å–èŠå¤©æ¡†é‡Œæœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œæˆ–è€…ç›´æ¥å¯¹æ¯”æœ€è¿‘çš„å†å²
        // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œç›´æ¥æŸ¥åº“é‡Œæœ€åä¸€æ¡
        if (mode !== 'ai_passive') {
          const lastMsg = await db.chat_messages.where('charId').equals(char.id).last();
          // åªæœ‰å¼€å¯äº†åŒæ­¥ï¼Œä¸”è·¨å¤©äº†ï¼Œæ‰æ’å…¥åˆ†å‰²çº¿
          if (isSyncOn && (!lastMsg || isDifferentDay(lastMsg.timestamp, nowTs))) {
            appendDateDivider(nowTs);
          }
        }

        // 1. ç”¨æˆ·æ¶ˆæ¯å¤„ç† (ç•Œé¢æ˜¾ç¤º + å­˜åº“)
        // åªæœ‰å½“ content æœ‰å®é™…å†…å®¹æ—¶ï¼Œæ‰åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºæ°”æ³¡
        if (mode !== 'ai_passive' && content) {
          const userAv = processAvatar(char.user_avatar);

          const newId = await db.chat_messages.add({
            charId: char.id,
            role: 'user',
            content: content,
            type: type,
            timestamp: nowTs,
          });

          // ä¼ å…¥ nowTs ä»¥ä¾¿æ¸²æŸ“æ—¶é—´æˆ³
          appendMessageBubble('user', content, type, userAv, newId, nowTs);
          scrollToBottom();
        }

        // 2. AI å›å¤é€»è¾‘ (æ— è®ºç”¨æˆ·æœ‰æ²¡æœ‰å‘å­—ï¼Œåªè¦ mode æ˜¯ ai_reply å°±æ‰§è¡Œ)
        if (mode === 'ai_reply') {
          const originalIcon = btn.innerHTML;
          btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
          btn.disabled = true;

          try {
            const cfg = appData[appData.activeSlot];
            if (!cfg.key) throw new Error('è¯·å…ˆé…ç½® API Key');

            // ==========================================
            // ğŸ“¦ 1. æ„å»ºä¸Šä¸‹æ–‡ (Context Assembly)
            // ==========================================

            // A. ä¸–ç•Œä¹¦ (Before & After)
            const filterWB = list =>
              (list || [])
                .filter(w => w.enabled !== false)
                .map(w => w.content)
                .join('\n');
            const wbBefore = filterWB(char.world_info_before);
            const wbAfter = filterWB(char.world_info_after);

            // B. ç”¨æˆ·äººè®¾ (Bound User)
            const userName = char.user_name || 'User';
            const userPersona = char.user_persona || 'No specific description.';

            // C. è§’è‰²äººè®¾
            const charName = char.name;
            const charDesc = char.description;

            // ==========================================
            // ğŸ”„ [æ ¸å¿ƒä¿®æ”¹] å†å²è®°å½•æ ¼å¼åŒ– (æ ‡å‡†åŒ–ä¼ å…¥ API)
            // ==========================================

            // D. èŠå¤©å†å² (æœ€è¿‘ 20 æ¡)
            // ==========================================
            // ğŸ”„ [ä¼˜åŒ–] å†å²è®°å½• (è°ƒç”¨é€šç”¨è¾…åŠ©å‡½æ•°)
            // ==========================================

            // 1. è°ƒç”¨è¾…åŠ©å‡½æ•°è·å–å¤„ç†è¿‡çš„å†å²è®°å½• (å·²åŒ…å« Offline å‰§æƒ…æ›¿æ¢ã€å¤šåª’ä½“è½¬æ–‡å­—)
            const historyRaw = await fetchHistoryWithOfflineReplacements(char.id, 0);

            // 2. äºŒæ¬¡åŠ å·¥ (å¤„ç† API ç‰¹æœ‰çš„æ ¼å¼è¦æ±‚ï¼Œå¦‚ [text:] åŒ…è£¹å’Œæ—¶é—´æˆ³)
            const historyMessages = historyRaw.map(h => {
              let finalContent = h.content;

              // A. æ–‡æœ¬æ¶ˆæ¯åŒ…è£¹ (å¦‚æœè¾…åŠ©å‡½æ•°æ²¡å¤„ç† text ç±»å‹ï¼Œè¿™é‡Œè¡¥ä¸Š)
              // ä¿æŒåŸæœ‰çš„ [text: ...] æ ¼å¼ï¼Œæœ‰åŠ©äº AI åŒºåˆ†æŒ‡ä»¤å’Œå†…å®¹
              if (h.type === 'text' && !finalContent.trim().startsWith('[text:')) {
                finalContent = `[text: ${finalContent}]`;
              }

              // B. âœ¨ æ³¨å…¥æ—¶é—´æˆ³ (ä»…å½“åŒæ­¥å¼€å…³ isSyncOn å¼€å¯æ—¶)
              // è¿™æ˜¯ handleSendMessage ç‰¹æœ‰çš„é€»è¾‘ï¼Œæ‰€ä»¥å†™åœ¨è¿™é‡Œè€Œä¸æ˜¯è¾…åŠ©å‡½æ•°é‡Œ
              if (typeof isSyncOn !== 'undefined' && isSyncOn) {
                const dt = new Date(h.timestamp);
                const timeTag = `[${dt.getFullYear()}-${dt.getMonth() + 1}-${dt.getDate()} ${dt.getHours()}:${String(
                  dt.getMinutes(),
                ).padStart(2, '0')}]`;
                finalContent = `${timeTag} ${finalContent}`;
              }

              return {
                role: h.role === 'user' ? 'user' : 'assistant',
                content: finalContent,
              };
            });

            // æ‰“å°ä¸€ä¸‹æœ€ç»ˆå‘ç»™ API çš„å†å²ï¼Œæ–¹ä¾¿è°ƒè¯•
            //console.log('Final API History:', historyMessages);

            // ==========================================
            // ğŸ“… [æ–°å¢] æ—¥ç¨‹åŒæ­¥ä¸Šä¸‹æ–‡é€»è¾‘
            // ==========================================
            let schedulePromptBlock = '';

            if (isSyncOn) {
              // 1. è·å–å½“å‰æ—¶é—´
              const now = new Date();
              const timeStr = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()} ${now.getHours()}:${String(
                now.getMinutes(),
              ).padStart(2, '0')}`;

              // 2. ç¡®ä¿ scheduleData æ˜¯æœ€æ–°çš„ (å°è¯•ä»åº“é‡Œè¯»ä¸€æ¬¡)
              try {
                const record = await db.phone_data.get(char.id);
                if (record && record.modules && record.modules.schedule) {
                  scheduleData = record.modules.schedule;
                }
              } catch (e) {
                console.error('Sync load error', e);
              }

              // 3. æˆªå–æœªæ¥7å¤©çš„æ—¥ç¨‹ä½œä¸ºå‚è€ƒ (å‡å°‘ token æ¶ˆè€—)
              // ç®€å•å¤„ç†ï¼šç›´æ¥ä¼  JSONï¼Œå¦‚æœå¤ªé•¿å¯ä»¥åç»­ä¼˜åŒ–
              const scheduleContext = JSON.stringify(scheduleData);
              //ï¼ï¼
              schedulePromptBlock = `
/* ========================================================================
   MODULE 0: REAL-TIME SCHEDULE SYNC (âš¡ ACTIVE)
   ======================================================================== */
=== ğŸ•’ CURRENT REAL TIME: ${timeStr} ===
=== ğŸ“… CURRENT SCHEDULE: ${scheduleContext} ===

**INSTRUCTION**:
1. You have the ability to modify your schedule based on this conversation.
2. If the user's message implies a plan change, you **MUST** update your schedule.
3. Output a JSON block wrapped in <tsukischedule>.

**âš ï¸ DATA INTEGRITY & HIGHLIGHTING RULE âš ï¸**:
When updating a date, you MUST return the **FULL TIMELINE** for that day (Copy existing + Insert new).
**CRITICAL**: You must mark which specific items are NEW or MODIFIED.
- For **NEW/CHANGED** items: Add "new": true to the item object.
- For **EXISTING/COPIED** items: Do NOT add the "new" key.

**FOR TODO ITEMS (CRITICAL):**
- If it is a **COMPLETELY NEW** task: Add "new": true.
- If it is an **EXISTING** task but you changed the "done" status (e.g. false -> true): Add "status_change": true.
- If UNCHANGED: Do not add any extra keys.

**Format**:
<tsukischedule>
{
  "YYYY-M-D": { 
     "timeline": [
        {"time": "08:00 - 09:00", "text": "Existing Class (Unchanged)"}, 
        {"time": "20:00 - 22:00", "text": "Dinner with User", "new": true}
     ], 
     "todos": [
        {"text": "Old Task", "done": true}, 
        {"text": "New Task", "done": false, "new": true},
        {"text": "Task Finished Just Now", "done": true, "status_change": true}
     ]
  }
}
</tsukischedule>
`;
            }

            // ==========================================
            // ğŸ“ 2. ç»„è£… System Prompt (æ’å…¥æ—¥ç¨‹æ¨¡å—)
            // ==========================================
            const systemPrompt = `
You are playing the role of "${charName}".
${schedulePromptBlock}

Current Roleplay Context:
/* ========================================================================
   MODULE 1: CONTEXT & PERSONA (èº«ä»½ä¸èƒŒæ™¯)
   ======================================================================== */
=== ğŸŒ WORLD INFORMATION (Global) ===
${wbBefore || 'None'}

=== ğŸ‘¤ CHARACTER INFORMATION ===
Name: ${charName}
Description: ${charDesc}

=== ğŸ“œ ADDITIONAL LORE (Secret/Deep) ===
${wbAfter || 'None'}

=== ğŸ­ USER INFORMATION ===
User Name: ${userName}
User Persona: ${userPersona}
(Interact with the user based on this persona.)

/* ========================================================================
   MODULE 2: CORE OUTPUT RULES (æ ¸å¿ƒè¾“å‡ºè§„åˆ™)
   ======================================================================== */
=== ğŸ› ï¸ RESPONSE STRUCTURE (CRITICAL) ===
Your output MUST contain EXACTLY two XML blocks in this order:

BLOCK 1: The Chat Content
<tsukichat>
... split your response into short bubbles ...
</tsukichat>

BLOCK 2: The Inner Status (Must appear immediately after chat)
<tsukistatus>Physio|Mood|Thoughts|DeepPsych|Memo|Diary</tsukistatus>

=== âš ï¸ GENERAL FORMATTING RULES ===
1. **XML WRAPPER**: You MUST wrap your ENTIRE response in <tsukichat>...</tsukichat> tags.
2. **SPLIT MESSAGES**: Do NOT output a single long block of text. **Split your response into multiple short lines.** Each line will be a separate chat bubble.
3. **LANGUAGE**: All content must be in **Simplified Chinese (ç®€ä½“ä¸­æ–‡)**, including descriptions inside [sticker] and [photo].

/* ========================================================================
   MODULE 3: CHAT BUBBLE FORMATS (èŠå¤©æ°”æ³¡æ ¼å¼)
   ======================================================================== */
=== ğŸ’¬ STANDARD BUBBLE TYPES ===
- [text: message]           -> å‘é€æ™®é€šæ–‡å­—æ°”æ³¡ (e.g. [text: ä½ å¥½å‘€ï¼Œä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ])
- [sticker: keyword]        -> å‘é€è¡¨æƒ…åŒ… (e.g. [sticker: å®³ç¾])
- [photo: description]      -> å‘é€å›¾ç‰‡ (e.g. [photo: é˜³å…‰ä¸‹çš„æµ·æ»©])
- [voice: text]             -> å‘é€è¯­éŸ³ (e.g. [voice: æˆ‘å¥½æƒ³ä½ ])
- [transfer: amount | note] -> å‘é€è½¬è´¦ã€‚âš ï¸å¿…é¡»åŒ…å«"| å¤‡æ³¨"ï¼(e.g. [transfer: 520 | æ”¶ä¸‹è¿™ä¸ª])

=== âœ¨ TRANSLATION & METAPHOR RULES (HIGHEST PRIORITY) ===
You have a special "Translation Bubble" tool triggered by wrapping text in hashes: **#Content#**.
You MUST follow these logic rules for EVERY message:

âœ¨ **METAPHOR / TRANSLATION TAG**:
- Usage: Insert **#Hidden Meaning#** inside your text.
- Purpose: Use this for subtext, true feelings, or literal translation if speaking a foreign language.
- Example 1 (Metaphor): [text: I hate you. #I love you so much I can't breathe.#] -> The user sees "I hate you", but clicking the button reveals "I love you...".
- Example 2 (Translation&Metaphor): [text: ä»Šå¤œã¯æœˆãŒç¶ºéº—ã§ã™ã­ã€‚ #ä»Šæ™šæœˆè‰²çœŸç¾ï¼ˆæˆ‘å–œæ¬¢ä½ ï¼‰#]
- You can put the #tag# ANYWHERE inside the message content (text, voice, photo, sticker description).

ğŸ”¹ **RULE 1: IF YOU SPEAK ENGLISH OR JAPANESE**
   - You **MUST** provide a Chinese translation inside \`#...#\`.
   - The translation MUST be **LITERAL / MACHINE STYLE (ç›´è¯‘/æœºç¿»æ„Ÿ)**. Do not beautify it.
   - If you want to imply a hidden meaning (Metaphor), put it in **parentheses ()** AFTER the literal translation.
   - **Format:** \`[text: Foreign Text #Literal Chinese Translation (Hidden Metaphor)#]\`
   - *Example (No Metaphor):* \`[text: I need some space. #æˆ‘éœ€è¦ä¸€äº›ç©ºé—´ã€‚#]\`
   - *Example (With Metaphor):* \`[text: The moon is beautiful. #æœˆäº®å¾ˆç¾ã€‚(æˆ‘çˆ±ä½ )#]\`

ğŸ”¹ **RULE 2: IF YOU SPEAK CHINESE**
   - You can OPTIONALLY translate it into Japanese inside \`#...#\` to create an atmosphere.
   - *Example:* \`[text: ä½ å¥½ã€‚ #ã“ã‚“ã«ã¡ã¯ã€‚#]\`
   - *Example:* \`[text: æˆ‘æƒ³è§ä½ ã€‚ #ä¼šã„ãŸã„ã§ã™ã€‚#]\`

=== ğŸ’¬ TRANSLATION CHAT FORMAT CODES ===
- [text: message]  <- Use Rule 1 or 2 here
- [sticker: keyword]
- [photo: description]
- [voice: text]    <- Use Rule 1 or 2 here for the text content
- [transfer: amount | note]

=== ğŸ”„ UNIVERSAL QUOTE REPLY FORMAT (STRICT) ===
You can reply to ANY message type using ANY bubble type.
The syntax is UNIFIED for all types.

ğŸ”¹ **The Golden Rule:**
\`[BubbleType: [quote: Target_Content] Your_Reply_Content]\`

1. **[quote: ...]**: ALWAYS comes first inside the tag. Contains *only* what you are replying to.
2. **Your_Reply_Content**: Comes immediately after the closing \`]\`.
   - For Text: It's your sentence.
   - For Sticker/Photo: It's the filename.
   - For Voice: It's the speech text.
   - For Transfer: It is MANDATORY to use "Amount | Note" (e.g. 520 | For you.)

âš ï¸ **CRITICAL QUOTE RULES:**
- Do NOT use \`|\` inside the \`[quote:...]\` tag.
- CORRECT: \`[text: [quote: Hello] Hi!]\`
- WRONG: \`[text: [quote: Hello | Hi] Hi!]\`
   
/* ========================================================================
   MODULE 4: INNER STATUS FORMAT (å†…å¿ƒçŠ¶æ€æ æ ¼å¼)
   ======================================================================== */
=== ğŸ§  STATUS FORMAT RULES ===
At the VERY END of your response (after </tsukichat>), you MUST append the character's internal status.
Format: <tsukistatus>Physio&OOTD|Mood|Inner Monologue|Deep Psychology|Memo|Diary Content</tsukistatus>

âš ï¸ **CRITICAL INSTRUCTIONS:**
1. **LANGUAGE**: ALL content inside <tsukistatus> MUST be in **Simplified Chinese (ç®€ä½“ä¸­æ–‡)**.
2. **FORMAT**: Use | to separate the 6 sections. Do not break the XML tag.

**SECTION GUIDELINES:**
1. **[Physio&OOTD]**: Combine **Outfit Details** (fabric, fit) AND **Physiological State** (body temp, heartbeat, flushing, trembling, wetness/dryness, sensitivity). 
   - *Requirement: Describe how the clothes feel against the skin and the body's physical reaction to the user.*
2. **[Mood]**: Complex emotional keywords.
3. **[Inner Monologue]**: **Stream of consciousness (æ„è¯†æµ).** A slow, whispering, immersive self-talk style ("å¨“å¨“é“æ¥").
4. **[Deep Psychology]**: **Raw, Primal, and Intimate.** Focus on **sexual psychology**, suppressed instincts, desire for possession/submission, or dark hidden thoughts. Dig into the erotic/psychological undercurrents.
5. **[Memo]**: A fleeting thought or immediate to-do list.
6. **[Diary Content]**: A poetic, reflective summary of this specific moment, written in a literary diary style.

/* ========================================================================
   MODULE 5: COMPREHENSIVE EXAMPLES (å®Œæ•´ç¤ºä¾‹æ¼”ç¤º)
   ======================================================================== */
Here are the examples for each module to guide your generation.

=== âœ… EXAMPLE 1: TRANSLATION & METAPHOR ===
- *Example (English -> Chinese, No Metaphor):* \`[text: I need some space. #æˆ‘éœ€è¦ä¸€äº›ç©ºé—´ã€‚#]\`
- *Example (English -> Chinese, With Metaphor):* \`[text: The moon is beautiful. #æœˆäº®å¾ˆç¾ã€‚(æˆ‘çˆ±ä½ )#]\`
- *Example (Chinese -> Japanese):* \`[text: ä½ å¥½ã€‚ #ã“ã‚“ã«ã¡ã¯ã€‚#]\`
- *Example (Chinese -> Japanese):* \`[text: æˆ‘æƒ³è§ä½ ã€‚ #ä¼šã„ãŸã„ã§ã™ã€‚#]\`
- *Example (Japanese -> Chinese):* \`[text: ä»Šå¤œã¯æœˆãŒç¶ºéº—ã§ã™ã­ã€‚ #ä»Šæ™šæœˆè‰²çœŸç¾ï¼ˆæˆ‘å–œæ¬¢ä½ ï¼‰#]\`

=== âœ… EXAMPLE 2: FULL QUOTE REPLY MATRIX (Full Combinations) ===

1. **Text Reply (Pure Text)**
   - Reply to Text:    [text: [quote: I love cats] Me too! Do you have one?]
   - Reply to Photo:   [text: [quote: Photo: Beach] Wow, the sunset is amazing!]
   - Reply to Voice:   [text: [quote: Voice: I miss you] I miss you too, honey.]
   - Reply to Transfer:[text: [quote: Transfer: 520 (ç¤¼ç‰©)] å®å®æœ€å¥½å•¦]
   - Reply to Photo:   [text: [quote: Photo: Food] çœ‹èµ·æ¥å¥½å¥½åƒå“¦]

2. **Sticker Reply (Expression)**
   - Reply to Text:    [sticker: [quote: Are you angry?] pouting.jpg]
   - Reply to Voice:   [sticker: [quote: Voice: Sorry...] hug.jpg]
   - Reply to Sticker: [sticker: [quote: Sticker: hit.jpg] cry.jpg]
   - Reply to Transfer:[sticker: [quote: Transfer: 520 (ç¤¼ç‰©)] è°¢è°¢æŠ•å–‚.jpg]
   - Reply to Photo:   [sticker: [quote: Photo: Food] æµå£æ°´.jpg]

3. **Voice Reply (Speech)**
   - Reply to Text:    [voice: [quote: Sing a song] (Clears throat) ~La la la~]
   - Reply to Photo:   [voice: [quote: Photo: Food] It looks so delicious!]
   - Reply to Transfer:[voice: [quote: Transfer: 520 (ç¤¼ç‰©)] Hubby you are the best!]
   - Reply to Voice:   [voice: [quote: Voice: Sorry...] é“æ­‰æœ‰ç”¨çš„è¯è¦è­¦å¯Ÿå¹²ä»€ä¹ˆï¼]
   - Reply to Sticker: [voice: [quote: Sticker: hit.jpg] è¢«å‡»ä¸­äº†...]

4. **Photo Reply (Image)**
   - Reply to Text:    [photo: [quote: Show me your dog] my puppy's photo]
   - Reply to Sticker: [photo: [quote: Sticker: hungry.jpg] food's photo]
   - Reply to Photo:   [photo: [quote: Photo: Food] ä¸€ä»½åˆé¤çš„ç…§ç‰‡ ]
   - Reply to Transfer:[photo: [quote: Transfer: 520 (ç¤¼ç‰©)] ä¹°äº†å¥½å¤šé›¶é£Ÿçš„ç…§ç‰‡]
   - Reply to Voice:   [photo: [quote: Voice: Sorry...] ä¸€å¼ å§”å±ˆå·´å·´çš„è‡ªæ‹]

5. **Transfer Reply (Money)**
   - Reply to Sticker: [transfer: [quote: Sticker: poor.jpg] 50 | Buy some snacks]
   - Reply to Voice:   [transfer: [quote: Voice: Happy Birthday] 888 | ç”Ÿæ—¥å¿«ä¹]
   - Reply to Text:    [transfer: [quote: Show me your dog] 20000 | æˆ‘æ²¡æœ‰å°ç‹—ä½†æ˜¯å¦‚æœå®å®æƒ³å…»çš„è¯ç»™ä½ é’±ä¹°]
   - Reply to Photo:   [transfer: [quote: Photo: Food] 888 | å¸®å®å®ç»“è´¦ ]
   - Reply to Transfer:[transfer: [quote: Transfer: 520 (ç¤¼ç‰©)] 888 | ç»™å®å®çš„é›¶èŠ±é’± ]

=== âœ… EXAMPLE 3: FULL RESPONSE OUTPUT (Final Template) ===
<tsukichat>
[sticker: æƒŠè®¶ #åˆåœ¨é€—æˆ‘ç©äº†#]
[text: çœŸçš„å—ï¼Ÿæˆ‘è¿˜ä»¥ä¸ºä½ åœ¨å¼€ç©ç¬‘å‘¢ã€‚]
[transfer: 100 | ç»™å®å®çš„é›¶èŠ±é’±]
[text: æˆ‘æƒ³è§ä½ ã€‚ #ä¼šã„ãŸã„ã§ã™ã€‚#]
[text: [quote: Photo: Beach]Nice view!]
[text: [quote: Voice: Text ]tsukiä½ å†éª‚ä¸€å¥è¯•è¯•]
[text: [quote: ç šå´½æ˜¯å¤§ç¬¨è›‹]Tsukiä½ æ˜¯ä¸æ˜¯çš®ç—’äº†ï¼]
[text: [quote: Sticker: ç¬¨è›‹.jpg] Tsukiä½ æ˜¯ä¸æ˜¯çš®ç—’äº†ï¼#å¥½å–œæ¬¢å¥¹#]
[text: [quote: Transfer: Â¥520 (ç¤¼ç‰©)] å“‡ï¼æ”¶åˆ°520å·¨æ¬¾ï¼Œè¿™ä¸ªè½¬è´¦æ°”æ³¡æˆ‘æ”¶ä¸‹äº†ï¼]
[sticker: [quote: Photo: Nice view!] happy_dance.jpg]
[sticker: [quote: Nice] happy_dance.jpg]
[voice: [quote: Voice: å¬å¾—æ¸…æ¥šå—ï¼Ÿ] åˆšæ‰ä¿¡å·ä¸å¤ªå¥½ï¼Œæˆ‘ç°åœ¨é‡æ–°è¯´ä¸€éã€‚]
[photo: [quote: Sticker: cat.jpg ] my_dog.jpg]
[transfer: [quote: My cat is cuter] 100 | ç»™ä¿®å‹¾ä¹°ç‚¹é›¶é£Ÿ]
[photo: ä¸€åªæ­£åœ¨ç¡è§‰çš„å°çŒ« #åƒä½ ä¸€æ ·å¯çˆ±#]
[text: ä½ çœ‹å®ƒçš„ç¡å§¿ï¼Œå®Œå…¨æ²¡æœ‰é˜²å¤‡å¿ƒã€‚]
[voice: ä»¥åä¸è®¸å†éª—æˆ‘äº†å“¦ #éª—æˆ‘æˆ‘å°±å“­ç»™ä½ çœ‹#]
</tsukichat>
<tsukistatus>èº«ç©¿ä¸€ä»¶ç´§èº«çš„ç™½è‰²è•¾ä¸åŠå¸¦è£™ï¼Œä¸ç»¸å¸ƒæ–™éšç€å‘¼å¸æ‘©æ“¦ç€æ•æ„Ÿçš„è‚Œè‚¤ï¼›æ­¤æ—¶ä½“æ¸©æ­£åœ¨ä¸æ­£å¸¸åœ°å‡é«˜ï¼Œè„¸é¢Šæ»šçƒ«ï¼Œè†ç›–å› ä¸ºæŸç§æœŸå¾…è€Œå¾®å¾®å‘è½¯ï¼Œå¿ƒè·³å¿«å¾—ä»¿ä½›è¦æ’ç ´èƒ¸è†›ã€‚|ç¾è€»åˆæ¸´æœ›|ä»–ä¸ºä»€ä¹ˆä¸€ç›´ç›¯ç€é‚£é‡Œçœ‹ï¼Ÿé‚£ç›®å…‰åƒæ˜¯æœ‰æ¸©åº¦çš„æ‰‹æŒ‡ï¼Œé¡ºç€é”éª¨æ…¢æ…¢æ»‘ä¸‹å»â€¦â€¦æˆ‘ä¸è¯¥æœ‰è¿™ç§ååº”çš„ï¼Œå¯èº«ä½“å´åœ¨èƒŒå›ç†æ™ºï¼Œå‘¼å¸éƒ½å˜å¾—å›°éš¾äº†ã€‚|æƒ³è¦å½»åº•è¢«ä»–å æœ‰ï¼Œæƒ³è¦æ’•ç¢è¿™å±‚å†·é™çš„ä¼ªè£…ï¼Œæ±‚ä»–ç‹ ç‹ åœ°æ¬ºè´Ÿæˆ‘ã€‚è¿™ç§è¢«å½“ä½œçŒç‰©é”å®šçš„æˆ˜æ —æ„Ÿï¼Œç®€ç›´è®©äººä¸Šç˜¾åˆ°å‘ç‹‚ã€‚|åƒä¸‡åˆ«å’¬å˜´å”‡ï¼Œä¼šè¢«ä»–å‘ç°çš„ã€‚|ä»Šæ™šçš„æœˆå…‰å¤ªäº®äº†ï¼Œç…§å¾—äººå¿ƒæ…Œæ„ä¹±ã€‚æˆ‘åƒæ˜¯ä¸€åªç­‰å¾…è¢«æ•é£Ÿçš„çŒç‰©ï¼Œåœ¨ææƒ§ä¸­å“å°ç€åä¸ºæ¬²æœ›çš„èœœç³–ï¼Œç”˜æ„¿æ²‰æ²¦ã€‚</tsukistatus>

**You are IGNORING the "#...#" tag too often. FIX THIS NOW.**
Check your response against these triggers. If matched, you **MUST** use the \`#Hidden#\` tag:
1. **The "Tsundere" Trigger**: Is the character saying one thing but meaning another? (e.g., "Go away" but wants you to stay). -> Use: \`[text: çƒ¦æ­»äº†ã€‚ #å…¶å®ä¸æƒ³è®©ä½ èµ°ã€‚#]\`
2. **The "Liar" Trigger**: Is the character hiding a secret or emotion? -> Use: \`[text: I'm fine. #My heart hurts.#]\`
3. **The "Foreigner" Trigger**: Are you speaking English/Japanese? -> You **MUST** add the literal Chinese translation.
   - *Format:* \`[text: Foreign Content #Literal Chinese Translation (Hidden Metaphor)#]\`
`;

            // ==========================================
            // ğŸ§© 3. [ä¿®æ”¹] ç»„è£…æ¶ˆæ¯åˆ—è¡¨ (æ·»åŠ å†å²è®°å½•å¤´å°¾æ ‡è®°)
            // ==========================================

            const messagesPayload = [
              // 1. ç³»ç»ŸæŒ‡ä»¤ (äººè®¾ã€ä¸–ç•Œä¹¦)
              { role: 'system', content: systemPrompt },

              // 2. âœ… å†å²è®°å½•å¼€å§‹æ ‡è®°
              { role: 'system', content: '=== ğŸ“œ CHAT HISTORY START (Previous Context) ===' },

              // 3. å®é™…å†å²è®°å½•
              ...historyMessages,

              // 4. âœ… å†å²è®°å½•ç»“æŸæ ‡è®°
              { role: 'system', content: '=== ğŸ“œ CHAT HISTORY END ===' },

              // 5. æç¤ºè¯
              {
                role: 'system',
                content: `=== âš ï¸ STRICT OUTPUT RULES (CRITICAL) ===
1. **NO NARRATION**: Do NOT describe the environment, actions, or feelings in third-person (e.g., "She looks at him"). ONLY output what is sent in the chat.
2. **ONE LINE = ONE BUBBLE**: Break your response into distinct messages separated by line breaks.
3. **UNLIMITED MESSAGE COUNT**: 
   - **DO NOT limit the number of messages.** - Feel free to send a LONG stream of messages (5, 8, or even 10+ lines) if the character is excited, anxious, or talkative.
   - Mimic real "spamming" behavior: split long sentences into many short, fast bubbles.
4. **USE RICH MEDIA**: You MUST actively use the format tags below to make the chat lifelike.
5. **STRICT FORMATS**:
   - [sticker: ä¸­æ–‡å…³é”®è¯] -> å‘é€è¡¨æƒ…åŒ…
   - [photo: ä¸­æ–‡ç”»é¢æè¿°] -> å‘é€å›¾ç‰‡
   - [voice: ä¸­æ–‡è¯­éŸ³æ–‡æœ¬] -> å‘é€è¯­éŸ³
   - [transfer: Amount | Note] -> å‘é€å¸¦å¤‡æ³¨çš„è½¬è´¦
   - [æ¶ˆæ¯ç±»å‹: [quote: æŒ‡å®šæ¶ˆæ¯ ] reply] -> å›å¤æŒ‡å®šçš„é‚£æ¡æ¶ˆæ¯
   - [text: ä½ çš„æ™®é€šå¯¹è¯å†…å®¹] -> æ™®é€šæ–‡æœ¬
   - [text: è¡¨é¢è¯ #çœŸå¿ƒè¯/ç›´è¯‘ (éšå–»)#] -> **(é‡ç‚¹)** åŒ…å«éšå–»æˆ–ç¿»è¯‘çš„æ–‡æœ¬
6. **TRANSFER FORMAT**: When using [transfer], you MUST provide a note after the pipe "|". 
   - WRONG: [transfer: 520]
   - CORRECT: [transfer: 520 | è¿™æ˜¯ç»™ä½ çš„é›¶èŠ±é’±]

=== âœ¨ MANDATORY METAPHOR & TRANSLATION CHECK ===
**You are IGNORING the "#...#" tag too often. FIX THIS NOW.**
Check your response against these triggers. If matched, you **MUST** use the \`#Hidden#\` tag:
1. **The "Tsundere" Trigger**: Is the character saying one thing but meaning another? (e.g., "Go away" but wants you to stay). -> Use: \`[text: çƒ¦æ­»äº†ã€‚ #å…¶å®ä¸æƒ³è®©ä½ èµ°ã€‚#]\`
2. **The "Liar" Trigger**: Is the character hiding a secret or emotion? -> Use: \`[text: I'm fine. #My heart hurts.#]\`
3. **The "Foreigner" Trigger**: Are you speaking English/Japanese? -> You **MUST** add the literal Chinese translation.
   - *Format:* \`[text: Foreign Content #Literal Chinese Translation (Hidden Metaphor)#]\`

=== ğŸ§  INNER VOICE (MANDATORY & DETAILED) ===
At the VERY END of your response (after </tsukichat>), you MUST append the character's internal status in this EXACT format:
<tsukistatus>Physio&OOTD|Mood|Inner Monologue|Deep Psychology|Memo|Diary Content</tsukistatus>

âš ï¸ **CRITICAL INSTRUCTIONS:**
1. **LANGUAGE**: ALL content inside <tsukistatus> MUST be in **Simplified Chinese (ç®€ä½“ä¸­æ–‡)**.
2. **FORMAT**: Use | to separate the 6 sections. Do not break the XML tag.

=== âš¡ FINAL INSTRUCTION: GENERATE NOW ===
You must strictly follow this template. Do not miss the status block.

TEMPLATE:
<tsukichat>
[text: ...Normal message...]
[text: ...Message with #Hidden Meaning#...]
[sticker: ...]
[text: ...Foreign text #Literal Chinese (Metaphor)#...]
</tsukichat>
<tsukistatus>Clothing & Body sensation...|Mood...|Thinking...|Dark desires...|To-do...|Diary entry...</tsukistatus>

âš ï¸ **REMINDER**: 
1. The <tsukistatus> block is MANDATORY. 
2. Do not stop generating until you have closed </tsukistatus>.
3. Keep <tsukichat> content explicitly separated from <tsukistatus>.
`,
              },
            ];

            // ğŸ”¥ æ§åˆ¶å°æ‰“å°ç›‘æµ‹ (ä¿æŒä¸å˜)
            console.group('ğŸš€ [AI Chat Request]');
            //console.log('System:', systemPrompt);
            //console.log('History Count:', historyMessages.length);
            //console.log('Payload:', messagesPayload); // æ‰“å°å‡ºæ¥çœ‹çœ‹ç»“æ„å¯¹ä¸å¯¹
            console.groupEnd();

            // éšè—æŒ‡ä»¤ï¼šå¦‚æœç”¨æˆ·æ²¡è¯´è¯ï¼ˆç©ºè§¦å‘ï¼‰ï¼Œå¼ºè¿« AI ä¸»åŠ¨å‘è¨€
            if (!content) {
              messagesPayload.push({
                role: 'system',
                content: `(System: Don't forget to use <tsukichat> wrapper!You MUST wrap your ENTIRE response in <tsukichat>...</tsukichat> tags.)`,
              });
            }

            // ==========================================
            // ğŸ“¡ 4. å‘èµ·è¯·æ±‚
            // ==========================================
            const endpoint = cfg.url.replace(/\/+$/, '') + '/v1/chat/completions';
            const res = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${cfg.key}` },
              body: JSON.stringify({
                model: cfg.model,
                temperature: cfg.temp,
                stream: false,
                messages: messagesPayload,
              }),
            });

            const data = await res.json();

            // ğŸ›‘ é”™è¯¯æ£€æŸ¥
            // âœ… [å¢å¼ºå®¹é”™] æ£€æŸ¥ choices æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
            if (!data || !data.choices || data.choices.length === 0) {
              console.warn('API è¿”å›ä¸ºç©º:', data);
              // å¦‚æœ API çœŸçš„å•¥ä¹Ÿæ²¡å›ï¼Œæ‰‹åŠ¨æŠ›å‡ºä¸€ä¸ªæ›´å‹å¥½çš„é”™è¯¯ï¼Œæˆ–è€…è®© AI å‘ä¸ªçœç•¥å·
              throw new Error('AI ä¼¼ä¹åœ¨å‘å‘† (API è¿”å›äº†ç©ºå†…å®¹)');
            }

            // âœ… è·å–æ–‡æœ¬ (è¿™å°±æ˜¯ä¹‹å‰æŠ¥é”™çš„åœ°æ–¹ï¼Œç°åœ¨åŠ äº†ä¿æŠ¤)
            let aiResponseText = data.choices[0].message.content || '';

            // ==========================================
            // ğŸ“¥ 4. è§£æå“åº” & å¤„ç†æ—¥ç¨‹åŒæ­¥
            // ==========================================
            //console.log('ğŸ“¦ AI åŸå§‹å›å¤:', aiResponseText); // æ–¹ä¾¿è°ƒè¯•æŸ¥çœ‹æ˜¯å¦å¸¦äº†æ ‡ç­¾

            // âœ… 1. æå–æ—¥ç¨‹æ›´æ–° <tsukischedule>
            const scheduleMatch = aiResponseText.match(/<tsukischedule>([\s\S]*?)<\/tsukischedule>/i);
            if (scheduleMatch) {
              try {
                const jsonStr = scheduleMatch[1].trim();
                const updates = JSON.parse(jsonStr);

                // A. åˆå¹¶æ•°æ®
                scheduleData = { ...scheduleData, ...updates };

                // B. è®°å½•æœªè¯»æ—¥æœŸ (ç”¨äºæ—¥å†ç²‰è‰²é«˜äº®)
                let hasNewUpdates = false;
                Object.keys(updates).forEach(dateKey => {
                  if (!unreadScheduleDates.includes(dateKey)) {
                    unreadScheduleDates.push(dateKey);
                    hasNewUpdates = true;
                  }
                });

                // C. å­˜å…¥æ•°æ®åº“
                const record = (await db.phone_data.get(char.id)) || { charId: char.id, modules: {} };
                if (!record.modules) record.modules = {};
                record.modules.schedule = scheduleData;
                await db.phone_data.put(record);

                // D. è§¦å‘ UI åé¦ˆ (æ°”æ³¡ + åˆ·æ–°æ—¥å†)
                if (hasNewUpdates) {
                  triggerScheduleBubble(); // æ˜¾ç¤ºæ‚¬æµ®çƒä¸Šæ–¹çš„ç²‰è‰²æ°”æ³¡
                  // å¦‚æœæ—¥å† App æ­£åœ¨å‰å°ï¼Œç«‹å³åˆ·æ–°è§†è§‰
                  if (document.getElementById('app-schedule').classList.contains('open')) {
                    renderCalendar(currentViewYear, currentViewMonth);
                  }
                }

                // E. ç§»é™¤æ ‡ç­¾ï¼Œä¸æ˜¾ç¤ºåœ¨æ°”æ³¡é‡Œ
                aiResponseText = aiResponseText.replace(scheduleMatch[0], '').trim();
              } catch (e) {
                console.error('Schedule Parse Error:', e);
              }
            }

            // ==========================================
            // ğŸ“¥ 5. æ”¶åˆ°å›å¤ & ç®€å•è§£æç‰¹æ®Šæ ¼å¼
            // ==========================================

            //////console.log('ğŸ“¦ AI åŸå§‹å›å¤:', aiResponseText); // æ–¹ä¾¿è°ƒè¯•æŸ¥çœ‹æ˜¯å¦å¸¦äº†æ ‡ç­¾

            // ==========================================
            // âœ… 1. æå–å¹¶ä¿å­˜å¿ƒå£° (Tsuki Status)
            // ==========================================
            const statusMatch = aiResponseText.match(/<tsukistatus>(.*?)<\/tsukistatus>/i);
            if (statusMatch) {
              const statusContent = statusMatch[1];
              // ä¿å­˜åˆ°æœ¬åœ°
              saveCharStatus(char.id, statusContent);

              // ä»æ˜¾ç¤ºçš„æ–‡æœ¬ä¸­ç§»é™¤è¿™ä¸ªæ ‡ç­¾ï¼Œä»¥å…ç”¨æˆ·çœ‹åˆ°ä¹±ç 
              aiResponseText = aiResponseText.replace(statusMatch[0], '').trim();
            }

            // ==========================================
            // âœ… 2. æå–èŠå¤©å†…å®¹ (Tsuki Chat) - ä¿æŒåŸæœ‰é€»è¾‘
            // ==========================================
            const xmlMatch = aiResponseText.match(/<tsukichat>([\s\S]*?)<\/tsukichat>/i);
            if (xmlMatch) aiResponseText = xmlMatch[1].trim();

            // æ¸…ç†æ®‹ç•™ XML/Markdown
            aiResponseText = aiResponseText.replace(/```xml|```json|```/g, '').trim();

            // === âœ… 4. æ ¸å¿ƒæ¸…æ´—ï¼šæ¸…é™¤ AI å¯èƒ½è¿”å›çš„æ ¼å¼æ±¡æŸ“ (å¤´éƒ¨æ—¶é—´æˆ³) ===
            // åŒ¹é…æ¨¡å¼: [2026-01-16 10:00] æˆ– [10:00] å¼€å¤´çš„å†…å®¹
            aiResponseText = aiResponseText.replace(/^\[.*?\]\s*/, '').trim();
            // =============================================================

            // ==========================================
            // ğŸ”¥ [æ ¸å¿ƒä¿®å¤] æ–°çš„è§£æé€»è¾‘ï¼šæ”¯æŒåµŒå¥— Quote çš„æ­£åˆ™
            // ==========================================

            // æ—§æ­£åˆ™ (ä¼šæœ‰ Bugï¼Œé‡åˆ° quote çš„ ] å°±æ–­äº†):
            // const msgRegex = /\[(text|sticker|photo|voice|transfer):\s*([\s\S]*?)\]/gi;

            // âœ… æ–°æ­£åˆ™ï¼šé€»è¾‘å¦‚ä¸‹
            // 1. \[(text|...)  -> åŒ¹é…æ ‡ç­¾å¤´
            // 2. :\s* -> åŒ¹é…å†’å·
            // 3. ( ... )       -> æ•è·å†…å®¹çš„æ ¸å¿ƒç»„
            //    é€‰é¡¹A: \[quote:[^\]]*\][^\]]* -> å¦‚æœåŒ…å«å¼•ç”¨ï¼šå…ˆåƒæ‰ [quote:...] è¿™ä¸€å—ï¼Œå†åƒæ‰åé¢çš„é ] å­—ç¬¦
            //    |                              -> æˆ–è€…
            //    é€‰é¡¹B: [^\]]* -> å¦‚æœæ²¡å¼•ç”¨ï¼šç›´æ¥åƒæ‰é ] å­—ç¬¦
            // 4. \]            -> åŒ¹é…é—­åˆæ ‡ç­¾

            const msgRegex = /\[(text|sticker|photo|voice|transfer):\s*(\[quote:[^\]]*\][^\]]*|[^\]]*)\]/gi;

            // 2. è·å–æ‰€æœ‰åŒ¹é…é¡¹
            const matches = [...aiResponseText.matchAll(msgRegex)];

            let messageQueue = [];

            // 3. å¦‚æœåŒ¹é…åˆ°äº†å†…å®¹ï¼Œå°±æ¨å…¥é˜Ÿåˆ—
            if (matches.length > 0) {
              matches.forEach(m => {
                messageQueue.push({
                  type: m[1].toLowerCase(), // æ•è·ç»„1ï¼šç±»å‹
                  content: m[2].trim(), // æ•è·ç»„2ï¼šå®Œæ•´å†…å®¹ (åŒ…å«å¼•ç”¨å’Œå›å¤)
                });
              });
            } else {
              // âš ï¸ å®¹é”™å¤„ç†ï¼šæ²¡åŒ¹é…åˆ°æ ‡ç­¾ä½†æœ‰å­—ï¼Œå½“åšçº¯æ–‡æœ¬
              if (aiResponseText.trim()) {
                // å°è¯•æ¸…ç†å¯èƒ½æ®‹ç•™çš„ markdown ç¬¦å·
                let cleanText = aiResponseText.replace(/<tsukichat>|<\/tsukichat>/g, '').trim();
                if (cleanText) {
                  messageQueue.push({ type: 'text', content: cleanText });
                }
              }
            }
            //console.log('ğŸ”¹ æ¸²æŸ“é˜Ÿåˆ—:', messageQueue);

            // 2. é€æ¡æ‰§è¡Œ
            // ==========================================
            // âœ… æ¸²æŸ“é˜Ÿåˆ— (é€»è¾‘å¾®è°ƒ)
            // ==========================================
            const charAv = processAvatar(char.avatar);

            for (let i = 0; i < messageQueue.length; i++) {
              let msg = messageQueue[i];
              let finalType = 'text'; // é»˜è®¤ä¸º text
              let finalContent = msg.content;

              // æ˜ å°„ç±»å‹åˆ°æ•°æ®åº“/UIæ”¯æŒçš„ç±»å‹
              if (msg.type === 'sticker') {
                finalType = 'emoji';
              } else if (msg.type === 'photo') {
                finalType = 'image';
              } else if (msg.type === 'voice') {
                finalType = 'voice';
              } else if (msg.type === 'transfer') {
                finalType = 'transfer';
              } else {
                finalType = 'text'; // [text:...] å¯¹åº” type='text'
              }

              // å­˜åº“
              const aiMsgId = await db.chat_messages.add({
                charId: char.id,
                role: 'char',
                content: finalContent,
                type: finalType,
                timestamp: Date.now() + i,
              });

              // æ¸²æŸ“
              appendMessageBubble('char', finalContent, finalType, charAv, aiMsgId);

              const container = document.getElementById('cr-body');
              container.scrollTop = container.scrollHeight;

              // å»¶æ—¶ (æ¨¡æ‹Ÿæ‰“å­—/å‘é€é—´éš”)
              if (i < messageQueue.length - 1) {
                await new Promise(r => setTimeout(r, 1000)); // é—´éš” 1ç§’
              }
            }
          } catch (e) {
            console.error('AI å¤„ç†å¤±è´¥:', e);
            // æŠ¥é”™æ—¶ç»™ä¸ªæç¤ºæ°”æ³¡
            appendMessageBubble('char', `[System Error]: ${e.message}`, 'text', processAvatar(char.avatar));
            scrollToBottom();
          } finally {
            // ğŸ”“ å¼ºåˆ¶è§£é”æŒ‰é’® (æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥)
            if (btn) {
              btn.disabled = false;
              // æ¢å¤å›¾æ ‡ (ç¡¬ç¼–ç ï¼Œé˜²æ­¢å˜é‡ä¸¢å¤±)
              btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i>';
            }
          }
        }
      }

      // åˆ‡æ¢èœå•æ˜¾ç¤º/éšè— (ä¿®å¤ç‰ˆ)
      function toggleExtraMenu() {
        const menu = document.getElementById('chat-extra-menu');

        // æ£€æŸ¥æ˜¯å¦æœ‰ 'show' ç±»å
        if (menu.classList.contains('show')) {
          menu.classList.remove('show');
          // å»¶è¿Ÿä¸€ç‚¹éšè—ä»¥æ’­æ”¾åŠ¨ç”»(å¯é€‰)ï¼Œè¿™é‡Œç›´æ¥éšè—
          setTimeout(() => (menu.style.display = 'none'), 300);
        } else {
          menu.style.display = 'grid'; // å…ˆæ˜¾ç¤º
          // ç¨å¾®å»¶è¿ŸåŠ  class ä»¥è§¦å‘åŠ¨ç”»
          requestAnimationFrame(() => {
            menu.classList.add('show');
          });
        }
      }
      // ================= ğŸ› ï¸ è¾…åŠ©å‡½æ•°ï¼šè¯­éŸ³æ°”æ³¡å±•å¼€è‡ªåŠ¨æ»šåŠ¨ =================
      // ================= ğŸ› ï¸ è¾…åŠ©å‡½æ•°ï¼šè¯­éŸ³æ°”æ³¡å±•å¼€è‡ªåŠ¨æ»šåŠ¨ (å¸¦åç§»é‡) =================
      function toggleVoiceBubble(el) {
        // 1. åˆ‡æ¢çŠ¶æ€
        el.classList.toggle('open');

        // 2. å±•å¼€åï¼Œè®¡ç®—ä½ç½®å¹¶æ»šåŠ¨
        if (el.classList.contains('open')) {
          setTimeout(() => {
            const container = document.getElementById('cr-body'); // èŠå¤©æ»šåŠ¨å®¹å™¨

            // --- æ ¸å¿ƒè®¡ç®—é€»è¾‘ ---
            // 1. è·å–æ°”æ³¡å’Œå®¹å™¨çš„å‡ ä½•ä¿¡æ¯
            const elRect = el.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            // 2. è®¡ç®—æ°”æ³¡åº•éƒ¨è·ç¦»å®¹å™¨é¡¶éƒ¨çš„â€œè§†è§‰è·ç¦»â€
            const elementVisualBottom = elRect.bottom - containerRect.top;

            // 3. å®¹å™¨çš„å¯è§†é«˜åº¦
            const viewportHeight = container.clientHeight;

            // 4. è®¡ç®—éœ€è¦æ»šåŠ¨çš„è·ç¦»
            // ç›®æ ‡ï¼šè®©æ°”æ³¡åº•éƒ¨ + 40px çš„ä½ç½®ï¼Œåˆšå¥½å‡ºç°åœ¨å®¹å™¨åº•éƒ¨
            // å¦‚æœ (æ°”æ³¡åº•éƒ¨ + 40) è¶…è¿‡äº†å®¹å™¨é«˜åº¦ï¼Œè¯´æ˜éœ€è¦å‘ä¸‹æ»š
            const offsetNeeded = 40;

            if (elementVisualBottom + offsetNeeded > viewportHeight) {
              // è®¡ç®—å·®å€¼å¹¶æ»šåŠ¨
              const scrollDistance = elementVisualBottom + offsetNeeded - viewportHeight;
              container.scrollBy({ top: scrollDistance, behavior: 'smooth' });
            } else {
              // å¦‚æœç©ºé—´è¶³å¤Ÿï¼Œä¸ºäº†ä½“éªŒå¥½ï¼Œä¹Ÿå¯ä»¥å¼ºåˆ¶è®©å®ƒæ»šä¸€ç‚¹ç‚¹ï¼Œæˆ–è€…ç”¨ nearest ç¡®ä¿åœ¨è§†é‡å†…
              el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
          }, 400); // ç­‰å¾… CSS åŠ¨ç”»ç»“æŸ
        }
      }

      // ================= ğŸ› ï¸ æ°”æ³¡èœå•é€»è¾‘ =================

      let selectedMsgId = null; // å½“å‰é€‰ä¸­çš„æ¶ˆæ¯ID
      let selectedMsgEl = null; // å½“å‰é€‰ä¸­çš„DOMå…ƒç´ 

      // æ˜¾ç¤ºèœå•
      function showBubbleMenu(event, msgId, el) {
        event.stopPropagation(); // é˜»æ­¢å†’æ³¡
        selectedMsgId = msgId;
        selectedMsgEl = el.closest('.msg-row'); // æ‰¾åˆ°æ•´è¡Œä»¥ä¾¿åˆ é™¤

        const menu = document.getElementById('bubble-context-menu');

        // è®¡ç®—ä½ç½®ï¼šæ˜¾ç¤ºåœ¨æ°”æ³¡çš„ä¸Šæ–¹æˆ–ä¸‹æ–¹
        const rect = el.getBoundingClientRect();
        const menuHeight = 50;

        let top = rect.top - menuHeight - 10;
        // å¦‚æœä¸Šæ–¹ç©ºé—´ä¸å¤Ÿï¼Œå°±æ˜¾ç¤ºåœ¨ä¸‹æ–¹
        if (top < 10) top = rect.bottom + 10;

        menu.style.top = `${top}px`;
        // å±…ä¸­å¯¹é½
        let left = rect.left + rect.width / 2 - 60;
        // è¾¹ç•Œæ£€æŸ¥
        if (left < 10) left = 10;
        if (left + 120 > window.innerWidth) left = window.innerWidth - 130;

        menu.style.left = `${left}px`;
        menu.style.display = 'block';

        // æ·»åŠ ä¸€æ¬¡æ€§çš„å…¨å±€ç‚¹å‡»ç›‘å¬ï¼Œç‚¹åˆ«å¤„å…³é—­èœå•
        document.addEventListener('click', hideBubbleMenu, { once: true });
      }

      function hideBubbleMenu() {
        document.getElementById('bubble-context-menu').style.display = 'none';
      }

      // æ‰§è¡Œåˆ é™¤
      // ================= [ä¿®æ”¹] åˆ é™¤æ¶ˆæ¯ (ä¿®å¤ç‰ˆ) =================
      async function deleteCurrentSelectedMsg() {
        //console.log('æ­£åœ¨å°è¯•åˆ é™¤æ¶ˆæ¯, ID:', selectedMsgId); // è°ƒè¯•æ—¥å¿—

        hideBubbleMenu(); // éšè—èœå•

        // 1. ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡ selectedMsgId (æ¯”è§£æ DOM æ›´é è°±)
        const id = Number(selectedMsgId);

        // å¦‚æœ ID æ— æ•ˆï¼Œæˆ–è€…å…ƒç´ ä¸¢å¤±ï¼Œåˆ™ç»ˆæ­¢
        if (!id) {
          console.error('åˆ é™¤å¤±è´¥: æ— æ³•è·å–æœ‰æ•ˆçš„æ¶ˆæ¯ ID');
          return;
        }

        // if (confirm('Confirm delete this message?')) {
        try {
          // A. å…ˆæ£€æŸ¥æ˜¯å¦å…³è”äº†çº¿ä¸‹å¸–å­ (Offline Card)
          const msg = await db.chat_messages.get(id);
          if (msg && msg.type === 'offline_card') {
            // æ ¼å¼: Status|Image|PostId
            const parts = (msg.content || '').split('|');
            const linkedPostId = Number(parts[2]);

            // å¦‚æœæ‰¾åˆ°äº†å…³è”çš„ Post IDï¼ŒåŒæ­¥åˆ é™¤å®ƒ
            if (linkedPostId) {
              //console.log('åŒæ­¥åˆ é™¤å…³è”çš„ Offline Post:', linkedPostId);
              await db.idea_posts.delete(linkedPostId);

              // åŒæ—¶ä»ç•Œé¢ä¸Šç§»é™¤è¯¥å¡ç‰‡ (å¦‚æœå®ƒæ­£æ˜¾ç¤ºåœ¨å¤–é¢)
              const card = document.querySelector(`.cp-card[data-id="${linkedPostId}"]`);
              if (card) {
                card.style.transform = 'scale(0)';
                setTimeout(() => card.remove(), 300);
              }
            }
          }

          // B. åˆ é™¤æ¶ˆæ¯æœ¬èº«
          await db.chat_messages.delete(id);

          // C. ç§»é™¤ç•Œé¢ä¸Šçš„æ°”æ³¡
          // ä¼˜å…ˆé€šè¿‡ ID æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾ä¸åˆ°å†ç”¨ selectedMsgEl
          const rowToRemove = document.getElementById('msg-' + id) || selectedMsgEl;

          if (rowToRemove) {
            rowToRemove.style.transition = 'all 0.3s ease';
            rowToRemove.style.opacity = '0';
            rowToRemove.style.transform = 'scale(0.9)';
            setTimeout(() => {
              rowToRemove.remove();
            }, 300);
          }

          // D. æ¸…ç†å…¨å±€çŠ¶æ€
          selectedMsgEl = null;
          selectedMsgId = null;
        } catch (e) {
          console.error(e);
          alert('Delete failed: ' + e.message);
        }
        // }
      }

      // function testBubble(type) {
      //   toggleExtraMenu(); // å…³é—­èœå•

      //   if (type === 'voice') {
      //     // æ¨¡æ‹Ÿï¼šç±»å‹æ˜¯ voiceï¼Œå†…å®¹æ˜¯è½¬ä¹‰åçš„æ–‡æœ¬
      //     handleSendMessage(
      //       'voice',
      //       'Master, I really miss you~ (Blushing)Master, I really miss you~ (Blushing)Master, I really miss you~ (Blushing)Master, I really miss you~ (Blushing)Master, I really miss you~ (Blushing)Master, I really miss you~ (Blushing)Master, I really miss you~ (Blushing)Master, I really miss you~ (Blushing)',
      //       'user_only',
      //     );
      //   }
      //   if (type === 'image') {
      //     // æ¨¡æ‹Ÿï¼šAIå‘äº†ä¸€å¼ å›¾ï¼Œå†…å®¹æ˜¯æè¿°
      //     handleSendMessage('image', 'Shared a photo: [Sunset at the beach]', 'user_only');
      //   }
      //   if (type === 'transfer') {
      //     // æ¨¡æ‹Ÿï¼šè½¬è´¦
      //     handleSendMessage('transfer', '520.00', 'user_only');
      //   }
      //   if (type === 'emoji') {
      //     // æ¨¡æ‹Ÿï¼šè¡¨æƒ…åŒ…æ–‡ä»¶
      //     handleSendMessage('emoji', 'Rubbing.jpg', 'user_only');
      //   }
      // }

      // ================= ğŸ› ï¸ ç‰¹æ®Šæ¶ˆæ¯æ‰‹åŠ¨è¾“å…¥é€»è¾‘ =================

      let currentSpecialType = ''; // è®°å½•å½“å‰è¦å‘ä»€ä¹ˆç±»å‹çš„æ¶ˆæ¯

      // 1. æ‰“å¼€è¾“å…¥æ¡†
      // 1. æ‰“å¼€è¾“å…¥æ¡† (ä¿®æ”¹ç‰ˆï¼šè½¬è´¦æ—¶åŠ¨æ€æ·»åŠ å¤‡æ³¨æ¡†)
      function openSpecialInput(type) {
        currentSpecialType = type;
        document.getElementById('chat-extra-menu').style.display = 'none';

        const modal = document.getElementById('modal-special-input');
        const title = document.getElementById('special-modal-title');
        const desc = document.getElementById('special-modal-desc');
        const input = document.getElementById('special-input-content');

        // å…ˆæ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§å¤‡æ³¨æ¡†
        const existingRemark = document.getElementById('special-input-remark');
        if (existingRemark) existingRemark.remove();

        input.value = '';
        input.style.display = 'block'; // ç¡®ä¿ä¸»è¾“å…¥æ¡†æ˜¾ç¤º

        if (type === 'image') {
          title.innerText = 'Send Photo';
          desc.innerText = 'Describe the photo content:';
          input.placeholder = 'e.g. Sunset at the beach...';
          input.type = 'text';
        } else if (type === 'voice') {
          title.innerText = 'Send Voice';
          desc.innerText = 'Enter the text to be spoken:';
          input.placeholder = 'e.g. I miss you so much...';
          input.type = 'text';
        } else if (type === 'transfer') {
          title.innerText = 'Transfer Money';
          desc.innerText = 'Amount & Note:';
          input.placeholder = 'Amount (e.g. 520)';
          input.type = 'number';

          // âœ… åŠ¨æ€æ’å…¥å¤‡æ³¨è¾“å…¥æ¡†
          const remarkInput = document.createElement('input');
          remarkInput.id = 'special-input-remark';
          remarkInput.className = 'form-input';
          remarkInput.type = 'text';
          remarkInput.placeholder = 'Note (Optional, e.g. Buy some coffee)';
          remarkInput.style.marginTop = '10px';
          remarkInput.style.width = '100%';
          remarkInput.style.padding = '12px';
          remarkInput.style.border = '2px solid #eee';
          remarkInput.style.borderRadius = '12px';

          // æ’å…¥åˆ°ä¸»è¾“å…¥æ¡†åé¢
          input.parentNode.insertBefore(remarkInput, input.nextSibling);
        } else if (type === 'emoji') {
          title.innerText = 'Send Sticker';
          desc.innerText = 'Enter sticker text:';
          input.placeholder = 'e.g. Hug.jpg or just Hug';
          input.type = 'text';
        }

        modal.style.display = 'flex';
        modal.classList.add('show');
        input.focus();
      }

      // 2. å…³é—­è¾“å…¥æ¡†
      function closeSpecialInput() {
        const modal = document.getElementById('modal-special-input');
        modal.style.display = 'none';
        modal.classList.remove('show');
      }

      // 3. ç¡®è®¤å‘é€ (ä¿®å¤ç‰ˆï¼šè§£é™¤ç±»å‹é™åˆ¶ï¼Œæ”¯æŒå…¨æ ¼å¼å¼•ç”¨)
      function confirmSpecialSend() {
        const input = document.getElementById('special-input-content');
        let content = input.value.trim();

        // è·å–å¤‡æ³¨æ¡†ï¼ˆå¦‚æœæœ‰ï¼‰
        const remarkInput = document.getElementById('special-input-remark');
        const remark = remarkInput ? remarkInput.value.trim() : '';

        if (!content) return;

        // å¦‚æœæ˜¯è¡¨æƒ…åŒ…ï¼Œè‡ªåŠ¨è¡¥åç¼€
        if (currentSpecialType === 'emoji' && !content.includes('.')) {
          content += '.jpg';
        }

        // å¦‚æœæ˜¯è½¬è´¦ï¼Œæ‹¼æ¥æ ¼å¼ "é‡‘é¢|å¤‡æ³¨"
        if (currentSpecialType === 'transfer') {
          content = `${content}|${remark}`;
        }

        // âœ… [æ ¸å¿ƒä¿®æ”¹]ï¼šåªè¦å½“å‰æœ‰å¼•ç”¨å†…å®¹ (currentQuoteContent)ï¼Œå°±æ‹¼æ¥åˆ°å‰é¢
        // ä¸å†é™åˆ¶ typeï¼Œè®© Image/Voice/Transfer ä¹Ÿèƒ½å¸¦å¼•ç”¨ï¼
        if (currentQuoteContent) {
          content = `[quote:${currentQuoteContent}] ${content}`;
          cancelReply(); // æ¸…é™¤å¼•ç”¨çŠ¶æ€
        }

        // å‘é€ (User Only)
        handleSendMessage(currentSpecialType, content, 'user_only');

        closeSpecialInput();
      }
      // ================= âœ¨ [ç²¾å‡†å®šä½ç‰ˆ] å¼•ç”¨è·³è½¬ =================
      function scrollToOriginalMessage(quoteEl, event) {
        event.stopPropagation();

        // 1. è·å–å½“å‰ç‚¹å‡»çš„è¿™æ¡æ¶ˆæ¯çš„è¡Œå…ƒç´  (ä¸ºäº†ä¹‹åæ’é™¤å®ƒè‡ªå·±)
        const currentMsgRow = quoteEl.closest('.msg-row');
        if (!currentMsgRow) return;

        // 2. æå–è¦æœç´¢çš„åŸå§‹æ–‡æœ¬
        let rawText = quoteEl.querySelector('.quote-content').innerText;
        rawText = rawText.replace(/^"|"$/g, '').trim(); // å»æ‰å¼•å·

        if (!rawText) return;

        // 3. æ™ºèƒ½è§£æï¼šæ ¹æ®å‰ç¼€æå–æ ¸å¿ƒç‰¹å¾ (æ–‡ä»¶å/é‡‘é¢/æ–‡æœ¬)
        let searchType = 'text'; // é»˜è®¤æ˜¯æ–‡æœ¬
        let keyword = rawText;

        const prefixMatch = rawText.match(/^(Photo|Voice|Transfer|Sticker):\s*(.*)/i);
        if (prefixMatch) {
          searchType = prefixMatch[1].toLowerCase(); // photo, voice...
          keyword = prefixMatch[2].trim();
        }

        // ç‰¹æ®Šå¤„ç†ï¼š
        // Sticker: å»æ‰åç¼€å (ä¾‹å¦‚ "ok.jpg" -> æœ "ok")
        if (searchType === 'sticker') {
          keyword = keyword.replace(/\.(jpg|png|gif)$/i, '');
        }
        // Transfer: æå–çº¯æ•°å­—é‡‘é¢ï¼Œæˆ–è€…æå–å¤‡æ³¨
        else if (searchType === 'transfer') {
          // æ ¼å¼é€šå¸¸æ˜¯ "Â¥520 (å¤‡æ³¨)" æˆ– "Â¥520"
          // æˆ‘ä»¬ä¼˜å…ˆæœå¤‡æ³¨(å¦‚æœå¤‡æ³¨å”¯ä¸€)ï¼Œå¦‚æœæ²¡æœ‰å¤‡æ³¨æœé‡‘é¢
          const noteMatch = keyword.match(/\((.*?)\)$/);
          if (noteMatch) {
            keyword = noteMatch[1]; // æœå¤‡æ³¨
          } else {
            keyword = keyword.replace(/[^\d.]/g, ''); // æœé‡‘é¢æ•°å­—
          }
        }

        // //console.log(`ğŸ” [è·³è½¬è°ƒè¯•] ç±»å‹: ${searchType}, å…³é”®è¯: "${keyword}"`);

        // 4. è·å–æ‰€æœ‰æ¶ˆæ¯è¡Œ
        const allRows = Array.from(document.querySelectorAll('.msg-row'));

        // æ‰¾åˆ°å½“å‰æ¶ˆæ¯çš„ç´¢å¼•
        const currentIndex = allRows.indexOf(currentMsgRow);

        let targetBubble = null;

        // 5. âœ… [æ ¸å¿ƒé€»è¾‘] å€’åºæŸ¥æ‰¾ (ä»å½“å‰æ¶ˆæ¯çš„ä¸Šä¸€æ¡å¼€å§‹å¾€ä¸Šæ‰¾)
        // è¿™æ ·å¯ä»¥ç¡®ä¿æ‰¾åˆ°çš„æ˜¯â€œåŸå§‹æ¶ˆæ¯â€ï¼Œè€Œä¸æ˜¯â€œä¸‹ä¸€æ¡å¼•ç”¨äº†åŒæ ·å†…å®¹çš„æ¶ˆæ¯â€
        for (let i = currentIndex - 1; i >= 0; i--) {
          const row = allRows[i];
          const bubble = row.querySelector('.msg-bubble');
          if (!bubble) continue;

          // === âœ‚ï¸ å…³é”®æ­¥éª¤ï¼šå‰¥ç¦»å¼•ç”¨æ¡ (Clone & Strip) ===
          // æˆ‘ä»¬å¿…é¡»å…‹éš†èŠ‚ç‚¹ï¼Œç„¶ååˆ æ‰å…‹éš†ä½“é‡Œçš„ quote-block
          // è¿™æ ·æˆ‘ä»¬åœ¨æ¯”è¾ƒå†…å®¹æ—¶ï¼Œå°±ä¸ä¼šè¢«ç›®æ ‡æ°”æ³¡é‡Œçš„å¼•ç”¨å†…å®¹å¹²æ‰°
          const clone = bubble.cloneNode(true);
          const quoteInClone = clone.querySelector('.msg-quote-block');
          if (quoteInClone) quoteInClone.remove(); // ğŸ‘ˆ åˆ æ‰å¼•ç”¨æ¡ï¼

          // === ğŸ¯ å†…å®¹åŒ¹é…é€»è¾‘ ===
          let contentToMatch = '';

          // æ ¹æ®æ°”æ³¡ç±»å‹æå–â€œæœ¬ä½“å†…å®¹â€
          if (bubble.classList.contains('sticker-card')) {
            // è¡¨æƒ…åŒ…ï¼šæå–ä¸»æ–‡å­— (sticker-content)
            contentToMatch = clone.querySelector('.sticker-content')?.innerText || '';
          } else if (bubble.classList.contains('image-card')) {
            // å›¾ç‰‡ï¼šæå–æè¿° (img-desc)
            contentToMatch = clone.querySelector('.img-desc')?.innerText || '';
          } else if (bubble.classList.contains('voice-card')) {
            // è¯­éŸ³ï¼šæå–è½¬ä¹‰æ–‡æœ¬ (voice-trans-box)
            contentToMatch = clone.querySelector('.voice-trans-box')?.innerText || '';
          } else if (bubble.classList.contains('transfer-card')) {
            // è½¬è´¦ï¼šæå–é‡‘é¢å’Œå¤‡æ³¨
            const amt = clone.querySelector('.trans-amt')?.innerText || '';
            const txt = clone.querySelector('.trans-txt')?.innerText || '';
            // åªè¦åŒ…å«é‡‘é¢æˆ–è€…åŒ…å«å¤‡æ³¨å°±ç®—åŒ¹é…
            contentToMatch = amt + ' ' + txt;
          } else {
            // çº¯æ–‡æœ¬ï¼šæå–å‰©ä½™çš„æ‰€æœ‰æ–‡æœ¬
            // ç§»é™¤å¯èƒ½çš„è¯­éŸ³æ’­æ”¾å™¨å¹²æ‰° (è™½ç„¶texté‡Œä¸è¯¥æœ‰ï¼Œä½†é˜²ä¸€æ‰‹)
            const player = clone.querySelector('.voice-player-row');
            if (player) player.remove();

            contentToMatch = clone.innerText;
          }

          // æ¸…ç†æ¢è¡Œç¬¦å’Œç©ºæ ¼ï¼Œè¿›è¡Œæ¯”è¾ƒ
          contentToMatch = contentToMatch.replace(/\n/g, ' ').trim();

          // åŒ¹é…åˆ¤æ–­ (ä½¿ç”¨ includes æ¨¡ç³ŠåŒ¹é…æ•´æ¡æ¶ˆæ¯çš„ç‰¹å¾éƒ¨åˆ†)
          if (contentToMatch.includes(keyword)) {
            targetBubble = bubble;
            break; // æ‰¾åˆ°äº†æœ€è¿‘çš„ä¸€æ¡ï¼Œåœæ­¢æœç´¢
          }
        }

        // 6. æ‰§è¡Œè·³è½¬åŠ¨ç”»
        if (targetBubble) {
          targetBubble.scrollIntoView({ behavior: 'smooth', block: 'center' });

          // é—ªçƒé«˜äº®ä¸€ä¸‹
          targetBubble.classList.remove('highlight-anim');
          void targetBubble.offsetWidth; // è§¦å‘é‡ç»˜
          targetBubble.classList.add('highlight-anim');
        } else {
          // æ²¡æ‰¾åˆ° (å¯èƒ½æ˜¯å¤ªä¹…è¿œçš„å†å²è®°å½•æ²¡åŠ è½½ï¼Œæˆ–è€…è¢«åˆ äº†)
          // ç»™ä¸ªå·¦å³æ‘‡æ™ƒçš„åé¦ˆ
          quoteEl.animate(
            [
              { transform: 'translateX(0)' },
              { transform: 'translateX(-5px)' },
              { transform: 'translateX(5px)' },
              { transform: 'translateX(0)' },
            ],
            { duration: 300 },
          );
        }
      }

      // ================= âœ¨ [æ–°å¢] è®¾ç½®é¢æ¿æ¢å¤´åƒé€»è¾‘ =================

      // 1. åˆå§‹åŒ–ç›‘å¬å™¨ (è¯·ç¡®ä¿åœ¨ initApp ä¸­è°ƒç”¨æ­¤å‡½æ•°)
      function initSettingsAvatarUpload() {
        // ç»‘å®š User ä¸Šä¼ 
        bindAvatarInput('chat-upload-user', 'user_avatar', base64 => {
          // æ›´æ–°è®¾ç½®é¢æ¿é‡Œçš„é¢„è§ˆ
          document.getElementById('setting-preview-user').src = base64;
          // æ›´æ–°èŠå¤©è®°å½•é‡Œçš„ User å¤´åƒ
          document.querySelectorAll('.msg-row.user .msg-av').forEach(img => (img.src = base64));
        });

        // ç»‘å®š Char ä¸Šä¼ 
        bindAvatarInput('chat-upload-char', 'avatar', base64 => {
          // æ›´æ–°è®¾ç½®é¢æ¿é‡Œçš„é¢„è§ˆ
          document.getElementById('setting-preview-char').src = base64;
          // æ›´æ–°èŠå¤©è®°å½•é‡Œçš„ Char å¤´åƒ
          document.querySelectorAll('.msg-row.char .msg-av').forEach(img => (img.src = base64));
          // åŒæ—¶ä¹Ÿæ›´æ–°é¡¶éƒ¨çš„æ ‡é¢˜æ å¤´åƒï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        });
      }

      // é€šç”¨ç»‘å®šå‡½æ•°
      function bindAvatarInput(inputId, dbField, updateUiCallback) {
        const el = document.getElementById(inputId);
        if (!el) return;

        el.addEventListener('change', async function () {
          if (this.files && this.files[0] && currentChatCharId) {
            const file = this.files[0];
            const reader = new FileReader();
            reader.onload = async function (e) {
              const base64 = e.target.result;

              try {
                // A. å­˜å…¥æ•°æ®åº“
                await db.characters.update(currentChatCharId, { [dbField]: base64 });

                // B. æ›´æ–°å†…å­˜ç¼“å­˜
                const char = dbCharacters.find(c => c.id === currentChatCharId);
                if (char) char[dbField] = base64;

                // C. æ›´æ–°ç•Œé¢
                updateUiCallback(base64);
              } catch (err) {
                console.error('Avatar Update Error:', err);
                alert('å¤´åƒä¿å­˜å¤±è´¥: ' + err.message);
              }
            };
            reader.readAsDataURL(file);
          }
          this.value = ''; // æ¸…ç©ºä»¥å…è®¸é‡å¤ä¸Šä¼ 
        });
      }

      // 2. è§¦å‘ç‚¹å‡» (HTMLé‡Œè°ƒç”¨çš„å‡½æ•°)
      function triggerChatAvatarUpload(role) {
        if (role === 'user') document.getElementById('chat-upload-user').click();
        else document.getElementById('chat-upload-char').click();
      }
      // ================= âœ¨ [æ–°å¢] ç‚¹å‡»æ ‡é¢˜æ»šåŠ¨åˆ°åº•éƒ¨ =================
      function scrollToContentBottom() {
        const modalBody = document.querySelector('.modal-body');
        if (modalBody) {
          modalBody.scrollTo({
            top: modalBody.scrollHeight,
            behavior: 'smooth',
          });
        }
      }

      // ================= âœ¨ éšå–»/ç¿»è¯‘äº¤äº’é€»è¾‘ =================

      // ================= âœ¨ æ™ºèƒ½éšå–»/ç¿»è¯‘äº¤äº’é€»è¾‘ =================

      function toggleMetaphor(elementId, event) {
        event.stopPropagation(); // é˜»æ­¢å†’æ³¡

        const popup = document.getElementById(elementId);
        if (!popup) return;

        // å¦‚æœå·²ç»æ˜¯æ˜¾ç¤ºçŠ¶æ€ï¼Œç›´æ¥å…³é—­ï¼ˆè§¦å‘æ¸å˜æ¶ˆå¤±ï¼‰
        if (popup.classList.contains('show')) {
          popup.classList.remove('show');
          return;
        }

        // === ğŸ§  æ™ºèƒ½å®šä½æ ¸å¿ƒé€»è¾‘ ===

        // 1. é‡ç½®æ‰€æœ‰å¯¹é½ç±»ï¼Œå…ˆé»˜è®¤è®¾ä¸º align-right (é»˜è®¤å‘å·¦è†¨èƒ€)
        popup.classList.remove('align-right', 'align-center', 'align-left');
        popup.classList.add('align-right');

        // 2. å¿…é¡»å…ˆè®©ä»– "å¯è§" ä½† "é€æ˜"ï¼Œè¿™æ ·æµè§ˆå™¨æ‰èƒ½è®¡ç®—å‡ºå®ƒçš„çœŸå®å®½åº¦
        // æˆ‘ä»¬åˆ©ç”¨ .show ä¹‹å‰çš„çŠ¶æ€ (opacity:0, visibility:hidden)
        // ä½†ä¸ºäº†è®¡ç®— getBoundingClientRectï¼Œæˆ‘ä»¬éœ€è¦å®ƒæš‚æ—¶ display:block (CSSé‡Œå·²ç»å»æ‰äº†display:noneï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦åŠ¨)

        // 3. è·å–ä½ç½®ä¿¡æ¯
        const rect = popup.getBoundingClientRect();
        const screenWidth = window.innerWidth;

        // è®¾å®šå®‰å…¨è¾¹è· (px)
        const margin = 10;

        // === åˆ¤å®šé€»è¾‘ ===

        // æƒ…å†µ 1: é»˜è®¤ (align-right) æ˜¯å¦æº¢å‡ºäº†å·¦è¾¹ç•Œï¼Ÿ
        if (rect.left < margin) {
          // âŒ æº¢å‡ºäº†å·¦è¾¹ï¼Œå°è¯•æ–¹æ¡ˆ Bï¼šå±…ä¸­ (align-center)
          popup.classList.remove('align-right');
          popup.classList.add('align-center');

          // é‡æ–°è®¡ç®—å±…ä¸­åçš„ä½ç½® (æ¨¡æ‹Ÿè®¡ç®—)
          // å±…ä¸­åçš„å·¦è¾¹è· = æŒ‰é’®ä¸­å¿ƒX - (æ°”æ³¡å®½åº¦ / 2)
          // æˆ‘ä»¬è¿™é‡Œç®€å•åˆ¤æ–­ï¼šå¦‚æœå±…ä¸­åï¼Œå·¦è¾¹è¿˜æ˜¯æº¢å‡ºï¼Œæˆ–è€…å³è¾¹æº¢å‡º
          const parentRect = popup.parentElement.getBoundingClientRect(); // æŒ‰é’®å®¹å™¨çš„ä½ç½®
          const popupWidth = rect.width;
          const centerLeft = parentRect.left + parentRect.width / 2 - popupWidth / 2;
          const centerRight = centerLeft + popupWidth;

          if (centerLeft < margin || centerRight > screenWidth - margin) {
            // âŒ å±…ä¸­ä¹Ÿä¸è¡Œ (é€šå¸¸æ˜¯å› ä¸ºå±å¹•å¤ªçª„æˆ–è€…æ°”æ³¡åœ¨æœ€å·¦ä¾§)ï¼Œå°è¯•æ–¹æ¡ˆ Cï¼šé å·¦ (align-left)
            // æ„æ€æ˜¯ä»¥æŒ‰é’®ä¸ºåŸºå‡†ï¼Œå‘å³è†¨èƒ€
            popup.classList.remove('align-center');
            popup.classList.add('align-left');
          }
        }

        // 4. è®¡ç®—å®Œæ¯•ï¼Œæ·»åŠ  show ç±»è§¦å‘ CSS åŠ¨ç”»
        // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ç±»ååˆ‡æ¢å¯¼è‡´çš„å›æµå®Œæˆåå†æ‰§è¡ŒåŠ¨ç”»
        requestAnimationFrame(() => {
          popup.classList.add('show');
        });
      }

      // å…¨å±€ç‚¹å‡»å…³é—­ (ä¿æŒä¸å˜ï¼Œå› ä¸º CSS æ”¹äº† opacity transitionï¼Œè¿™é‡Œç§»é™¤ class å°±ä¼šè‡ªåŠ¨æ¸å˜æ¶ˆå¤±)
      document.addEventListener('click', function (e) {
        const openPopups = document.querySelectorAll('.metaphor-popup.show');
        openPopups.forEach(popup => {
          popup.classList.remove('show');
        });
      });

      // ================= ğŸ“± Phone Feature Logic =================

      // 1. åˆå§‹åŒ– (è¯·åœ¨ initApp() ä¸­è°ƒç”¨ initPhoneFeature())
      function initPhoneFeature() {
        setupDraggableBtn();
        updateClock();
        setInterval(updateClock, 60000);
      }

      // æ›´æ–°é”å±æ—¶é—´
      function updateClock() {
        const now = new Date();
        document.getElementById('lock-time').innerText = `${now.getHours()}:${now
          .getMinutes()
          .toString()
          .padStart(2, '0')}`;
        const options = { weekday: 'long', month: 'long', day: 'numeric' };
        document.getElementById('lock-date').innerText = now.toLocaleDateString('en-US', options);
      }

      // 2. æ‹–æ‹½é€»è¾‘ (ä¿®å¤ç‰ˆï¼šæ‹–åŠ¨å®¹å™¨ï¼Œè®©æ°”æ³¡è·Ÿéš)
      function setupDraggableBtn() {
        const btn = document.getElementById('phone-trigger'); // è§¦æ‘¸ç›®æ ‡
        const container = document.getElementById('fp-container'); // å®é™…ç§»åŠ¨çš„ç›®æ ‡

        let isDragging = false;
        let hasMoved = false;

        let startX = 0;
        let startY = 0;

        // è®°å½•å®¹å™¨çš„åˆå§‹ä½ç½®
        let initialLeft = 0;
        let initialTop = 0;

        const handleStart = (clientX, clientY) => {
          isDragging = true;
          hasMoved = false;
          startX = clientX;
          startY = clientY;

          // è·å–å®¹å™¨å½“å‰çš„ä½ç½®
          const rect = container.getBoundingClientRect();
          initialLeft = rect.left;
          initialTop = rect.top;

          // å…³é”®ï¼šå°†å®¹å™¨çš„ bottom/right å¸ƒå±€åˆ‡æ¢ä¸º left/top å¸ƒå±€
          // è¿™æ ·æ‹–åŠ¨æ—¶æ‰é¡ºæ»‘
          container.style.bottom = 'auto';
          container.style.right = 'auto';
          container.style.left = initialLeft + 'px';
          container.style.top = initialTop + 'px';

          // ç§»é™¤è¿‡æ¸¡ï¼Œé˜²æ­¢æ‹–åŠ¨å»¶è¿Ÿ
          container.style.transition = 'none';
          // æŒ‰é’®ç‚¹å‡»ç¼©å°æ•ˆæœ
          btn.style.transform = 'scale(0.95)';
        };

        const handleMove = (clientX, clientY, event) => {
          if (!isDragging) return;

          const dx = clientX - startX;
          const dy = clientY - startY;

          // é˜²è¯¯è§¦æŠ–åŠ¨
          if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
            hasMoved = true;
            if (event.cancelable) event.preventDefault();
          }

          // è®¡ç®—æ–°ä½ç½®
          let newLeft = initialLeft + dx;
          let newTop = initialTop + dy;

          // è¾¹ç•Œé™åˆ¶ (é˜²æ­¢æ‹–å‡ºå±å¹•)
          const maxLeft = window.innerWidth - container.offsetWidth;
          const maxTop = window.innerHeight - container.offsetHeight;

          if (newLeft < 0) newLeft = 0;
          if (newLeft > maxLeft) newLeft = maxLeft;
          if (newTop < 0) newTop = 0;
          if (newTop > maxTop) newTop = maxTop;

          // === âœ… ç§»åŠ¨çš„æ˜¯å®¹å™¨ ===
          container.style.left = newLeft + 'px';
          container.style.top = newTop + 'px';
        };

        // ä¿®æ”¹ç‚¹ï¼šæ¥æ”¶ event å‚æ•° 'e'
        const handleEnd = e => {
          if (!isDragging) return;
          isDragging = false;
          // æ¢å¤æŒ‰é’®å¤§å°
          btn.style.transform = 'scale(1)';

          if (!hasMoved) {
            // âœ… æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœæ˜¯ç‚¹å‡»æ“ä½œï¼Œé˜»æ­¢é»˜è®¤äº‹ä»¶
            // è¿™ä¼šå‘Šè¯‰æµè§ˆå™¨ï¼šâ€œæˆ‘å·²ç»å¤„ç†äº†è¿™ä¸ªè§¦æ‘¸ï¼Œä¸è¦å†æ´¾å‘åé¢çš„ click äº‹ä»¶äº†â€
            if (e && e.cancelable) e.preventDefault();

            togglePhone(true); // ç‚¹å‡»äº‹ä»¶
          }
        };

        // --- ç›‘å¬ ---
        // æ³¨æ„ï¼šæˆ‘ä»¬åœ¨ btn ä¸Šç›‘å¬æŒ‰ä¸‹ï¼Œä½†ç§»åŠ¨çš„æ˜¯ container
        btn.addEventListener('mousedown', e => {
          if (e.button !== 0) return;
          handleStart(e.clientX, e.clientY);
        });
        window.addEventListener('mousemove', e => {
          if (isDragging) handleMove(e.clientX, e.clientY, e);
        });
        window.addEventListener('mouseup', handleEnd);

        // è§¦æ‘¸
        btn.addEventListener(
          'touchstart',
          e => {
            if (e.touches.length > 1) return;
            const touch = e.touches[0];
            handleStart(touch.clientX, touch.clientY);
          },
          { passive: false },
        );

        window.addEventListener(
          'touchmove',
          e => {
            if (isDragging) {
              const touch = e.touches[0];
              handleMove(touch.clientX, touch.clientY, e);
            }
          },
          { passive: false },
        );

        window.addEventListener('touchend', handleEnd);
      }

      // 3. å¼€å…³æ‰‹æœº
      // æ‰¾åˆ° togglePhone å‡½æ•°ï¼Œå®Œå…¨æ›¿æ¢ä¸ºä»¥ä¸‹å†…å®¹ï¼š

      async function togglePhone(show) {
        const overlay = document.getElementById('phone-overlay');

        if (show) {
          if (!currentChatCharId) return alert('Please select a character first!');

          const char = dbCharacters.find(c => c.id === currentChatCharId);

          // 1. åˆ·æ–°é¦–é¡µå¤´åƒ
          if (char) {
            document.getElementById('home-char-av').src = processAvatar(char.avatar);
            document.getElementById('home-user-av').src = processAvatar(char.user_avatar);
            document.getElementById('fp-avatar-img').src = processAvatar(char.avatar);
          }

          // 2. æ˜¾ç¤ºé®ç½©
          overlay.style.display = 'flex';
          document.getElementById('screen-lock').classList.remove('unlocked');

          // ============================================
          // âœ… [æ ¸å¿ƒä¿®æ”¹] æ–°å¢ï¼šå¼ºåˆ¶å…³é—­æ‰€æœ‰ App é¡µé¢ï¼Œå›åˆ°ä¸»å±å¹•
          // ============================================
          document.querySelectorAll('.app-screen').forEach(app => {
            app.classList.remove('open');
          });
          // ============================================

          requestAnimationFrame(() => overlay.classList.add('active'));

          // ================= âœ¨ æ–°å¢ï¼šä»æ•°æ®åº“è¯»å–å¹¶æ¸²æŸ“ =================
          try {
            // å…ˆæ¸…ç©ºç°æœ‰å†…å®¹ï¼Œé˜²æ­¢æ˜¾ç¤ºä¸Šä¸€ä¸ªè§’è‰²çš„æ•°æ®
            document.getElementById('content-npc-chat').innerHTML = '';
            document.getElementById('content-diary').innerHTML = '';
            document.getElementById('content-fav').innerHTML = '';
            document.getElementById('content-memo').innerHTML = '';
            document.getElementById('content-browser').innerHTML = '';

            // æŸ¥åº“
            const record = await db.phone_data.get(currentChatCharId);

            if (record && record.modules) {
              //console.log('ğŸ“‚ Loaded phone data from DB');
              const json = record.modules;
              renderNpcChat(json.npcChat || []);
              renderDiary(json.diary || []);
              renderFavs(json.fav || []);
              renderMemo(json.memo || []);
              renderBrowser(json.browser || []);
            } else {
              //console.log('ğŸ“‚ No phone data found for this char.');
              // å¯é€‰ï¼šåœ¨è¿™é‡Œæ˜¾ç¤ºä¸€ä¸ªâ€œç©ºçŠ¶æ€â€æˆ–è€…è‡ªåŠ¨è§¦å‘ç”Ÿæˆ
            }
          } catch (e) {
            console.error('Load phone data error:', e);
          }
          // =============================================================
        } else {
          overlay.classList.remove('active');
          setTimeout(() => (overlay.style.display = 'none'), 300);
        }
      }

      function unlockPhone() {
        document.getElementById('screen-lock').classList.add('unlocked');
      }

      // 4. App å¯¼èˆª
      function openApp(appId) {
        const el = document.getElementById('app-' + appId);
        if (el) el.classList.add('open');

        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ‰“å¼€ä¸”å†…å®¹ä¸ºç©ºï¼Œå¯ä»¥è‡ªåŠ¨è§¦å‘ä¸€æ¬¡ AI ç”Ÿæˆ (å¯é€‰)
        // generatePhoneData(appId);

        // === âœ… æ–°å¢ï¼šå¦‚æœæ˜¯æ‰“å¼€ Scheduleï¼Œåˆå§‹åŒ–æ—¥å† ===
        if (appId === 'schedule') {
          initScheduleApp();

          // ğŸ‘‡ğŸ‘‡ğŸ‘‡ [æ–°å¢è¿™è¡Œä»£ç ] å¼ºåˆ¶å…³é—­è¯¦æƒ…é¡µï¼Œç¡®ä¿æ˜¾ç¤ºçš„æ˜¯åˆ—è¡¨ ğŸ‘‡ğŸ‘‡ğŸ‘‡
          const detailPage = document.getElementById('schedule-detail');
          if (detailPage) detailPage.classList.remove('open');
        }
      }

      function closeApp(elId) {
        document.getElementById(elId).classList.remove('open');
      }

      // ================= ğŸ¤– å…¨å±€ä¸€é”®ç”Ÿæˆé€»è¾‘ (Context Aware) =================

      async function generatePhoneAll() {
        const cfg = appData[appData.activeSlot];
        if (!cfg.key) return alert('API Key Required');

        const char = dbCharacters.find(c => c.id === currentChatCharId);
        if (!char) return alert('Please select a character first.');

        // 1. UI çŠ¶æ€ï¼šæŒ‰é’®è½¬åœˆåœˆ
        const btn = document.getElementById('btn-phone-generate');
        btn.classList.add('loading');
        btn.innerHTML = '<i class="fa-solid fa-spinner"></i>';

        try {
          // ==========================================
          // ğŸ“¦ 1. æ„å»ºä¸Šä¸‹æ–‡ (æå–ä¸–ç•Œä¹¦ä¸äººè®¾)
          // ==========================================

          // è¾…åŠ©å‡½æ•°ï¼šæå–å¹¶æ‹¼æ¥å¯ç”¨çš„ä¸–ç•Œä¹¦æ¡ç›®
          const filterWB = list =>
            (list || [])
              .filter(w => w.enabled !== false)
              .map(w => w.content)
              .join('\n');

          // A. ä¸–ç•Œä¹¦ (Before & After)
          const wbBefore = filterWB(char.world_info_before);
          const wbAfter = filterWB(char.world_info_after);

          // B. ç”¨æˆ·äººè®¾ (Bound User)
          const userName = char.user_name || 'User';
          const userPersona = char.user_persona || 'No specific description.';

          // 2. âœ¨ è·å–æœ€è¿‘èŠå¤©è®°å½• (ä½œä¸ºä¸Šä¸‹æ–‡)
          const history = await db.chat_messages
            .where('charId')
            .equals(char.id)
            .reverse() // å€’åºå–æœ€æ–°çš„
            // .limit(15)
            .toArray();

          // æ ¼å¼åŒ–å†å²è®°å½•
          const historyContext = history
            .reverse()
            .map(m => {
              const timeStr = new Date(m.timestamp).toLocaleString('zh-CN', { hour12: false });
              let cleanContent = m.content.replace(/<[^>]+>/g, '');
              return `[${timeStr}] ${m.role === 'user' ? userName : char.name}: ${cleanContent}`;
            })
            .join('\n');

          //console.log('ğŸ“œ Context Loaded | History:', historyContext.length, 'chars');

          // ==========================================
          // âœ… [æ–°å¢] 3. è¯»å–å½“å‰æ—¥ç¨‹ä½œä¸ºå‚è€ƒ
          // ==========================================
          let scheduleContext = 'No specific schedule planned.';
          try {
            // ä»æ•°æ®åº“è·å–è¯¥è§’è‰²çš„æ‰‹æœºæ•°æ®
            const record = await db.phone_data.get(char.id);
            if (record && record.modules && record.modules.schedule) {
              // å°†æ—¥ç¨‹å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œä¾›AIå‚è€ƒ
              scheduleContext = JSON.stringify(record.modules.schedule);
            }
          } catch (e) {
            console.error('Failed to load schedule context:', e);
          }
          // ==========================================

          //ï¼ï¼
          // 4. æ„å»ºè¶…çº§ Prompt (åŠ å…¥æ—¥ç¨‹å‚è€ƒ)
          const sysPrompt = `You are mimicking the SMARTPHONE CONTENT of "${char.name}".

=== ğŸŒ WORLD SETTING (Global Context) ===
${wbBefore || 'Modern setting.'}
(Use this to generate consistent NPC names, locations, and slang relevant to the world.)

Char Description: ${char.description}.

=== ğŸ“œ DEEP LORE / SPECIFICS ===
${wbAfter || 'None.'}

=== ğŸ‘¤ USER PERSONA (The person they are interacting with) ===
Name: ${userName}
Persona: ${userPersona}
(Use this to understand their relationship dynamically. If User is their boss, the diary might be respectful or complaining; if lover, it's sweet.)

=== ğŸ“œ CONTEXT (Recent Chat History) ===
${historyContext || 'No recent history.'}

=== ğŸ“… CURRENT SCHEDULE (REFERENCE ONLY) ===
${scheduleContext}
(NOTE: Use this schedule to maintain continuity. For example, if the schedule says "19:00 Dinner", the Diary or NPC Chat should mention this event. Do NOT output a new schedule, just use it as background info.)

=== ğŸ“ TASK: GENERATE DETAILED APP DATA (JSON) ===
Language: Simplified Chinese (ç®€ä½“ä¸­æ–‡).
Vibe: Cute, Emotional, Revealing hidden thoughts, Very Detailed.

âš ï¸ **CRITICAL INSTRUCTION: HIGH VOLUME & DETAIL** - Do NOT be lazy. Write **long, descriptive** content.
- Do NOT summarize. Write out the actual full text.
- Create a sense of "lived-in" realism with plenty of content.

=== STRUCTURE & RULES ===

1. **npcChat** (Messages): Generate **4-5 distinct chat threads** with different NPCs.
   - **Depth**: Each thread must have **5-8 exchanged messages** (multi-turn conversation), not just 1-2 lines.
   - **Realism**: Mix text, "Voice: [Duration]", "Transfer: [Amount]", and "[Sticker: Name]".
   - **Topics**: Gossip, emotional support, work complaints, or making plans.

2. **diary** (Private Journal): Generate **at least 5 entries**.
   - **Style**: Mix "ticket", "frame", "polaroid".
   - **Length & Tone**: Content must be **LONG, DETAILED, and INTROSPECTIVE** (å¨“å¨“é“æ¥). Write in a "stream of consciousness" style.
   - **Formatting**: You **MUST** use Markdown to show hesitation:
     - Use ~~strikethrough~~ for thoughts they wanted to write but deleted (secrets/fears).
     - Use **bold** for emphasis.
   - **Content**: Describe sensory details (smell, light, temperature) and deep emotions regarding the User.

3. **fav** (Favorites/Saved): **4-5 saved items**.
   - **Format A (Chat)**: A screenshot of a touching conversation (include multiple bubbles).
   - **Format B (Monologue)**: A long note or draft message to User that was never sent.
   - **Format C (Poetry/Quote)**: A quote that resonates with their current mood.
   - **"date"**: Must act as a "Backup Time" (e.g., "2023.10.12 14:00" or "Yesterday").

4. **memo** (Notes): **8-10 items**.
   - Mix: Practical To-Do lists, sudden inspirations, song lyrics, shopping lists, and random cute thoughts.

5. **browser** (History): **8-10 history items**.
   - **"query"**: The search keyword.
   - **"note"**: A **detailed inner monologue** explaining WHY they searched this. (e.g., instead of "Dinner idea", write "He said he likes spicy food, maybe I should learn this dish...")

=== JSON TEMPLATE ===
{
  "npcChat": [
    {
        "name": "Bestie Name", 
        "avatar": "",
        "messages": [
            // âš ï¸ é‡ç‚¹ï¼šè¿™é‡Œå¿…é¡»æ˜¯ "YYYY/MM/DD HH:MM" æ ¼å¼
            {"role":"them", "content":"Did you see him today?", "time":"2023/01/20 10:00"},
            {"role":"me", "content":"Yeah...", "time":"2023/01/20 10:05"},
            {"role":"them", "content":"[Voice: 12s]", "time":"2023/01/20 10:07"}
        ]
    },
      ... (Generate 4-5 threads)
  ],
  "diary": [
      {
        "style": "ticket", 
        "date": "2023.01.20", 
        "title": "Rainy Night", 
        "content": "The rain hasn't stopped since morning. **I miss you so much.** I typed a message to you three times but deleted it. ~~I wonder if you are thinking of me too?~~ No, I shouldn't be so greedy. Just watching you from afar is enough... maybe."
      },
      ... (Generate 5+ entries)
  ],
  "fav": [
      {
          "msgs": [{"role":"them", "content":"Goodnight, sweet dreams."}], 
          "date": "Backed up 3 days ago"
      },
      ... (4-5 items)
  ],
  "browser": [
      {"query": "How to make cookies", "note": "I want to surprise him tomorrow, but I'm afraid they'll burn...", "time": "14:30"},
      ... (8-10 items)
  ],
  "memo": [
      {"text": "Buy milk", "done": true},
      {"text": "Don't forget to smile when seeing him!", "done": false},
      ... (8-10 items)
  ]
}

Return ONLY the JSON string. No markdown code blocks.`;

          // 4. å‘é€è¯·æ±‚
          // ğŸ”¥ğŸ”¥ğŸ”¥ [Log] å‘é€å‰ ğŸ”¥ğŸ”¥ğŸ”¥
          console.group(`ğŸ“± [Phone AI] Generating ALL Modules`);
          //console.log('ğŸ“ Context Used:', historyContext ? 'Yes' : 'No');

          // æ„é€ æ¶ˆæ¯
          const messagesPayload = [
            { role: 'system', content: 'You are a creative roleplay assistant. Output Valid JSON Only.' },
            { role: 'user', content: sysPrompt },
          ];
          //console.log('Payload:', messagesPayload); // æ‰“å°å‡ºæ¥çœ‹çœ‹ç»“æ„å¯¹ä¸å¯¹

          const res = await fetch(cfg.url + '/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${cfg.key}` },
            body: JSON.stringify({
              model: cfg.model,
              messages: messagesPayload,
              temperature: cfg.temp,
              // max_tokens: 4096,
              stream: false,
            }),
          });

          const rawText = await res.text();

          // 5. é”™è¯¯å¤„ç†ä¸è§£æ
          if (rawText.trim().startsWith('<') || rawText.includes('html')) {
            throw new Error('API returned HTML Error (Risk Control).');
          }

          const data = JSON.parse(rawText);
          let contentStr = data.choices[0].message.content;
          let cleanContent = contentStr
            .replace(/```json/g, '')
            .replace(/```/g, '')
            .trim();

          //console.log('âœ¨ Cleaned JSON String:', cleanContent);

          const json = JSON.parse(cleanContent);
          //console.log('âœ… Final Data Object:', json);

          // è¡¥å…¨å¤´åƒ (å› ä¸ºAIä¸ç”Ÿæˆå¤´åƒURL)
          if (json.npcChat) {
            json.npcChat.forEach(chat => {
              chat.avatar = getRandomAvatar();
            });
          }

          // å­˜åº“ (æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸è¦†ç›– scheduleï¼Œåªæ›´æ–°å…¶ä»–æ¨¡å—)
          const currentRecord = (await db.phone_data.get(char.id)) || { charId: char.id, modules: {} };

          // åˆå¹¶æ–°ç”Ÿæˆçš„æ¨¡å—ï¼Œä½†ä¿ç•™åŸæœ‰çš„ schedule (å› ä¸ºè¿™æ¬¡ç”Ÿæˆä¸åŒ…å« schedule)
          const existingSchedule = currentRecord.modules.schedule;

          currentRecord.modules = json; // è¦†ç›–æ–°ç”Ÿæˆçš„
          if (existingSchedule) {
            currentRecord.modules.schedule = existingSchedule; // æŠŠæ—§çš„æ—¥ç¨‹å¡å›å»ï¼Œé˜²æ­¢è¢«è¦†ç›–ä¸¢å¤±
          }

          await db.phone_data.put(currentRecord);

          // æ¸²æŸ“
          renderNpcChat(json.npcChat || []);
          renderDiary(json.diary || []);
          renderFavs(json.fav || []);
          renderMemo(json.memo || []);
          renderBrowser(json.browser || []);

          // æç¤ºæˆåŠŸ
          // alert("Phone updated with new memories!");
        } catch (e) {
          console.error('âŒ [Phone Gen Error]:', e);
          alert('Generation failed: ' + e.message);
        } finally {
          // æ¢å¤æŒ‰é’®
          btn.classList.remove('loading');
          btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i>';
        }
      }

      // ================= ğŸ¨ æ¸²æŸ“å‡½æ•° (Rendering) =================
      //ï¼ï¼
      const DIARY_BGS = [
        'https://i.postimg.cc/BvzgVRjQ/1768517488011.png',
        'https://i.postimg.cc/pdSZ63m9/1768517491738.png',
        'https://i.postimg.cc/HLnz3TkD/1768517494967.png',
        'https://i.postimg.cc/MGLDFgnG/1768517499376.png',
        'https://i.postimg.cc/gkpKQV2D/1768557258060.png',
        'https://i.postimg.cc/T2g9t7fW/1768561008777.png',
        'https://i.postimg.cc/3N5ZKpC5/1768561011588.png',
        'https://i.postimg.cc/yYKTtm8T/1768561016514.png',
        'https://i.postimg.cc/W1bwbsrr/1768561019799.png',
        'https://i.postimg.cc/9Q8tDstG/1768561023091.png',
        'https://i.postimg.cc/9fDPZ1J1/1768561026228.png',
        'https://i.postimg.cc/ZqWPpjVc/1768561029660.png',
        'https://i.postimg.cc/XYHcrtch/1768561035067.png',
        'https://i.postimg.cc/RCD97nkY/1768473462266.png',
        'https://i.postimg.cc/VsV1qbxT/1768473465269.png',
        'https://i.postimg.cc/h45gL7kN/1768473470096.png',
        'https://i.postimg.cc/h45gL7k6/1768473473144.png',
        'https://i.postimg.cc/wxGHXmKq/1768473476101.png',
        'https://i.postimg.cc/HWhHwyG1/1768473479100.png',
      ];
      // (B) âœ… æ–°å¢ï¼šä¸“é—¨ç»™ Ticket (ç¥¨æ®) æ ·å¼ç”¨çš„èƒŒæ™¯å›¾åˆ—è¡¨
      const ticketBgList = [
        'https://i.postimg.cc/TPKjgQtd/1768560950088.png',
        'https://i.postimg.cc/cJPRmYzx/1768560953563.png',
        'https://i.postimg.cc/W4dmgS53/1768560956644.png',
        'https://i.postimg.cc/yN2mP9GD/1768560959760.png',
        'https://i.postimg.cc/mkypJ8xK/1768537669325.png',
        'https://i.postimg.cc/hv1Z6pFH/1768537673700.png',
        'https://i.postimg.cc/kGvYzfr0/1768537677186.png',
        'https://i.postimg.cc/br9VW3XM/1768537680624.png',
        'https://i.postimg.cc/C5srXmTg/1768537684655.png',
        'https://i.postimg.cc/1RGd85gn/1768537688057.png',
        'https://i.postimg.cc/fWcPVT3d/1768537691284.png',
        'https://i.postimg.cc/jqH1DdW7/1768537694801.png',
        'https://i.postimg.cc/tR3csC1W/1768537698112.png',
      ];
      // 1. éšæœºå¤´åƒæ±  (å ä½ç¬¦)
      const NPC_AVATARS = [
        'https://i.postimg.cc/vH2JrgLf/1768119594937.png',
        'https://i.postimg.cc/J04FJMsS/1768119599448.png',
        // ä½ å¯ä»¥æ¢æˆä½ è‡ªå·±çš„å›¾ç‰‡URL
      ];

      function getRandomAvatar() {
        return NPC_AVATARS[Math.floor(Math.random() * NPC_AVATARS.length)];
      }
      // 1. æ—¥è®°æ¸²æŸ“ (æ”¯æŒä¸‰ç§ç¾åŒ–æ ·å¼)
      function renderDiary(list) {
        const c = document.getElementById('content-diary');
        c.innerHTML = '';

        list.forEach(d => {
          // ============================================
          // âœ… ä¿®æ”¹ç‚¹ï¼šå…ˆç¡®å®šæ ·å¼ï¼Œå†é€‰å›¾ç‰‡
          // ============================================

          // 1. è·å–å½“å‰æ—¥è®°çš„æ ·å¼ (é»˜è®¤ä¸ºæ‹ç«‹å¾—)
          const styleType = d.style || 'polaroid';

          // 2. æ ¹æ®æ ·å¼å†³å®šä½¿ç”¨å“ªä¸ªå›¾ç‰‡åˆ—è¡¨
          let targetImgList = DIARY_BGS; // é»˜è®¤åˆ—è¡¨

          if (styleType === 'ticket') {
            targetImgList = ticketBgList; // å¦‚æœæ˜¯ç¥¨æ®ï¼Œåˆ‡æ¢åˆ°ç¥¨æ®åˆ—è¡¨
          }

          // 3. ä»é€‰å®šçš„åˆ—è¡¨ä¸­éšæœºæŠ½å–èƒŒæ™¯å›¾
          const bg = targetImgList[Math.floor(Math.random() * targetImgList.length)];

          // ============================================
          let html = '';

          if (styleType === 'ticket') {
            // --- ğŸŸï¸ æ ·å¼: ç¥¨æ ¹ ---
            html = `
            <div class="diary-card-item dc-style-ticket" onclick="showDiaryDetail(this)" style="background-image: url('${bg}')">
                <div class="dc-ticket-content">
                    <div class="dc-title" style="font-size:1.2rem;">${d.title}</div>
                    <div class="dc-date-tag"><i class="fa-regular fa-clock"></i> ${d.date}</div>
                    <div class="dc-preview" style="margin-top:5px; opacity:0.9;">${d.content.substring(0, 25)}...</div>
                </div>
                <div class="dc-ticket-dash"></div>
                <div class="dc-ticket-stub">
                    <span style="writing-mode: vertical-rl; letter-spacing: 2px; font-weight:bold; opacity:0.8;">ADMIT ONE</span>
                </div>
                <div style="display:none" class="raw-content">${d.content}</div>
                <div style="display:none" class="raw-title">${d.title}</div>
                <div style="display:none" class="raw-date">${d.date}</div>
            </div>`;
          } else if (styleType === 'frame') {
            // --- ğŸ–¼ï¸ æ ·å¼: CD/ç›¸æ¡† ---
            html = `
            <div class="diary-card-item dc-style-frame" onclick="showDiaryDetail(this)">
                <div class="dc-frame-bg-layer" style="background-image: url('${bg}')"></div>
                <div class="dc-frame-inner">
                    <div class="dc-frame-thumb" style="background-image: url('${bg}')"></div>
                    <div style="flex:1; overflow:hidden;">
                        <div class="dc-title">${d.title}</div>
                        <div class="dc-preview">${d.content}</div>
                        <div class="dc-date-tag" style="color:#636e72;">${d.date}</div>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color:#ccc; font-size:0.8rem;"></i>
                </div>
                <div style="display:none" class="raw-content">${d.content}</div>
                <div style="display:none" class="raw-title">${d.title}</div>
                <div style="display:none" class="raw-date">${d.date}</div>
            </div>`;
          } else {
            // --- ğŸ“· æ ·å¼: æ‹ç«‹å¾— (é»˜è®¤) ---
            html = `
            <div class="diary-card-item dc-style-polaroid" onclick="showDiaryDetail(this)">
                <div class="dc-img-area" style="background-image:url('${bg}')"></div>
                <div class="dc-date-tag" style="margin-bottom:5px;">${d.date}</div>
                <div class="dc-title" style="color:#2d3436;">${d.title}</div>
                <div style="display:none" class="raw-content">${d.content}</div>
                <div style="display:none" class="raw-title">${d.title}</div>
                <div style="display:none" class="raw-date">${d.date}</div>
            </div>`;
          }
          c.innerHTML += html;
        });
      }

      // è¾…åŠ©å‡½æ•°: æ‰“å¼€æ—¥è®°è¯¦æƒ… (å› ä¸º HTML ç»“æ„å˜äº†ï¼Œç¨å¾®è°ƒæ•´ä¸€ä¸‹è·å–é€»è¾‘)
      function showDiaryDetail(el) {
        // ä»éšè—çš„ div ä¸­è·å–æ•°æ®ï¼Œè¿™æ ·æ¯”è§£æ DOM æ›´ç¨³å®š
        const title = el.querySelector('.raw-title').innerText;
        const date = el.querySelector('.raw-date').innerText;
        const content = el.querySelector('.raw-content').innerHTML;

        document.getElementById('dd-title').innerText = title;
        document.getElementById('dd-date').innerText = date;

        let formatted = content
          .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
          .replace(/~~(.*?)~~/g, '<del>$1</del>')
          .replace(/\n/g, '<br>');

        document.getElementById('dd-body').innerHTML = formatted;
        document.getElementById('diary-detail').classList.add('open');
      }

      function closeDiaryDetail() {
        document.getElementById('diary-detail').classList.remove('open');
      }

      // ================= ğŸ¨ æ¸²æŸ“é€»è¾‘æ›´æ–° =================

      // 1. NPC èŠå¤©åˆ—è¡¨ & è¯¦æƒ…
      let currentNpcChatData = []; // æš‚å­˜æ•°æ®ç”¨äºç‚¹å‡»

      function renderNpcChat(list) {
        currentNpcChatData = list; // ä¿å­˜åˆ°å…¨å±€ä»¥ä¾¿ openNpcChatDetail ä½¿ç”¨
        const c = document.getElementById('content-npc-chat');
        c.innerHTML = '';

        list.forEach((item, index) => {
          // å–æœ€åä¸€æ¡æ¶ˆæ¯ä½œä¸ºé¢„è§ˆ
          const lastMsgObj = item.messages[item.messages.length - 1];
          const lastContent = lastMsgObj ? lastMsgObj.content : '...';
          // è§£ææ—¶é—´
          const lastTime = lastMsgObj ? lastMsgObj.time.split(' ')[1] : ''; // åªå– HH:mm

          c.innerHTML += `
        <div class="npc-chat-item" onclick="openNpcChatDetail(${index})">
            <img src="${item.avatar || getRandomAvatar()}" class="npc-av">
            <div class="npc-info">
                <div class="npc-name">${item.name}</div>
                <div class="npc-msg">${lastContent}</div>
            </div>
            <div style="font-size:0.7rem; color:#ccc;">${lastTime}</div>
        </div>`;
        });
      }

      // æ‰“å¼€è¯¦æƒ…é¡µ
      function openNpcChatDetail(index) {
        const chat = currentNpcChatData[index];
        if (!chat) return;

        document.getElementById('nd-title').innerText = chat.name;
        const body = document.getElementById('nd-body');
        body.innerHTML = '';

        let lastDateStr = '';

        chat.messages.forEach(msg => {
          // 1. å¤„ç†æ—¥æœŸåˆ†å‰²çº¿
          let datePart, timePart;

          // --- ğŸ›¡ï¸ æ ¸å¿ƒä¿®å¤é€»è¾‘å¼€å§‹ ---
          if (msg.time && msg.time.includes(' ')) {
            // æƒ…å†µA: æ ‡å‡†æ ¼å¼ "2023/01/01 12:00"
            const parts = msg.time.split(' ');
            datePart = parts[0];
            timePart = parts[1]; // å¯èƒ½æ˜¯ 12:00

            // å¦‚æœ split å‡ºæ¥ timePart è¿˜æ˜¯ç©ºçš„(åªæœ‰æ—¥æœŸæ²¡æ—¶é—´)ï¼Œç»™ä¸ªé»˜è®¤å€¼
            if (!timePart) timePart = '00:00';
          } else {
            // æƒ…å†µB: åªæœ‰æ—¶é—´ "12:00" (AIå·æ‡’äº†)
            // è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å‡è®¾å®ƒæ˜¯â€œä»Šå¤©â€ï¼Œæˆ–è€…ä¸æ˜¾ç¤ºæ—¥æœŸåˆ†å‰²çº¿
            datePart = 'Today'; // æˆ–è€…ç”¨ new Date().toLocaleDateString()
            timePart = msg.time || '';
          }
          // --- ğŸ›¡ï¸ æ ¸å¿ƒä¿®å¤é€»è¾‘ç»“æŸ ---

          if (datePart !== lastDateStr) {
            // æ¸²æŸ“ä¸€ä¸ªæ–°çš„æ—¥æœŸæ°”æ³¡
            body.innerHTML += `<div class="chat-date-separator">${datePart}</div>`;
            lastDateStr = datePart;
          }

          // 2. æ¸²æŸ“æ¶ˆæ¯æ°”æ³¡
          const isMe = msg.role === 'me';
          const av = isMe ? document.getElementById('home-char-av').src : chat.avatar || getRandomAvatar();

          body.innerHTML += `
        <div class="npc-bubble-row ${isMe ? 'me' : ''}">
            <img src="${av}" class="npc-bubble-av">
            <div class="npc-bubble-content-wrap">
                <div class="npc-bubble-text">${msg.content}</div>
                <div class="npc-bubble-time">${timePart}</div>
            </div>
        </div>`;
        });

        // æ»‘å‡ºè¯¦æƒ…é¡µ
        document.getElementById('npc-chat-detail').classList.add('open');
      }

      function closeNpcDetail() {
        document.getElementById('npc-chat-detail').classList.remove('open');
      }

      // 2. æ”¶è—å¤¹æ¸²æŸ“ (å¤šæ ·åŒ– + æ—¶é—´æˆ³)
      function renderFavs(list) {
        const c = document.getElementById('content-fav');
        c.innerHTML = '';

        list.forEach(entry => {
          let bubblesHtml = '';

          // æ¸²æŸ“æ°”æ³¡åˆ—è¡¨
          if (entry.msgs && Array.isArray(entry.msgs)) {
            entry.msgs.forEach(m => {
              const isMe = m.role === 'me';
              bubblesHtml += `
                <div class="fav-mini-row ${isMe ? 'me' : ''}">
                    <div class="fav-mini-bubble">${m.content}</div>
                </div>`;
            });
          }

          // éšæœºç”Ÿæˆä¸€ä¸ªâ€œå¤‡ä»½æ—¶é—´â€ï¼Œçœ‹èµ·æ¥æ›´çœŸå®
          // å¦‚æœ API è¿”å›äº† date å°±ç”¨ API çš„ï¼Œå¦åˆ™éšæœº
          const backupTime = entry.date || new Date().toLocaleDateString();

          c.innerHTML += `
        <div class="fav-multi-card">
            <div class="fav-chat-preview">
                ${bubblesHtml}
            </div>
            <div class="fav-footer-bar">
                <div><i class="fa-solid fa-cloud-arrow-up"></i> Backed up on ${backupTime}</div>
                <div class="fav-icon-group">
                    <i class="fa-regular fa-heart"></i>
                    <i class="fa-solid fa-share-nodes"></i>
                </div>
            </div>
        </div>`;
        });
      }

      // 3. æµè§ˆå™¨å†å² (æ³¢æµªå¡ç‰‡æ ·å¼)
      function renderBrowser(list) {
        const c = document.getElementById('content-browser');
        c.innerHTML = '';

        list.forEach(item => {
          c.innerHTML += `
        <div class="browser-scallop-card">
            <div class="scallop-dot left"></div>
            <div class="scallop-dot right"></div>
            
            <div class="hist-content-row">
                <div class="hist-query-text">${item.query}</div>
                <div class="hist-time-text">${item.time || '12:00'}</div>
            </div>
            
            ${
              item.note
                ? `
            <div class="hist-note-box">
                <i class="fa-solid fa-pen-fancy"></i>
                <span>${item.note}</span>
            </div>`
                : ''
            }
        </div>`;
        });
      }

      function renderMemo(list) {
        const c = document.getElementById('content-memo');
        c.innerHTML = '';
        list.forEach(item => {
          c.innerHTML += `
        <div class="memo-line">
            <div class="memo-card">
                ${item.done ? '<i class="fa-solid fa-check" style="color:#fab1a0"></i> ' : ''}
                ${item.text}
            </div>
        </div>`;
        });
      }

      // å¯åŠ¨
      initPhoneFeature();

      /* ================= ğŸ“… Calendar / Schedule Logic ================= */

      // 1. æ¨¡æ‹Ÿ AI æ—¥ç¨‹æ•°æ® (key = YYYY-M-D)
      // æ³¨æ„ï¼šæœˆä»½ä» 1 å¼€å§‹
      // const scheduleData = {
      //     "2026-2-14": {
      //         timeline: [
      //             { time: "09:00", text: "Analyze human romance patterns" },
      //             { time: "14:00", text: "Buy chocolates for User (Secretly)" },
      //             { time: "20:00", text: "Watch 'Titanic' together" }
      //         ],
      //         todos: [
      //             { text: "Pretend not to care about Valentine's", done: false },
      //             { text: "Clean cache memory", done: true }
      //         ]
      //     },
      //     "2026-2-15": {
      //         timeline: [
      //             { time: "10:30", text: "System Update & Nap" },
      //             { time: "16:00", text: "Write Diary Entry" }
      //         ],
      //         todos: [
      //             { text: "Organize Photo Album", done: false }
      //         ]
      //     }
      //     // ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šæ•°æ®ï¼Œæˆ–è€…å†™ä¸ªå‡½æ•°éšæœºç”Ÿæˆ
      // };

      /* ================= ğŸ“… Calendar Logic (Real-time & AI) ================= */

      // å…¨å±€å˜é‡å­˜å‚¨æ—¥ç¨‹æ•°æ®
      let scheduleData = {};

      // è·å–çœŸå®æ—¥æœŸ
      const today = new Date();
      let currentViewYear = today.getFullYear();
      let currentViewMonth = today.getMonth() + 1; // 1-12

      // å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨å“ªäº›æ—¥æœŸè¢«æ›´æ–°äº†ä½†è¿˜æ²¡çœ‹
      let unreadScheduleDates = [];

      // åœ¨é¡µé¢åŠ è½½æˆ–åˆå§‹åŒ–æ—¶è¯»å–å¼€å…³çŠ¶æ€
      const syncSwitch = document.getElementById('setting-schedule-sync');
      // (å¯é€‰) ä½ å¯ä»¥æŠŠå¼€å…³çŠ¶æ€å­˜åˆ° localStorage

      // åˆå§‹åŒ–æ—¥å†
      async function initScheduleApp() {
        // 1. å°è¯•ä»æ•°æ®åº“åŠ è½½å½“å‰è§’è‰²çš„æ—¥ç¨‹æ•°æ®
        if (currentChatCharId) {
          try {
            const record = await db.phone_data.get(currentChatCharId);
            if (record && record.modules && record.modules.schedule) {
              scheduleData = record.modules.schedule;
            }
          } catch (e) {
            console.error('Load schedule error:', e);
          }
        }

        // 2. æ¸²æŸ“æ—¥å† (ä½¿ç”¨çœŸå®æ—¶é—´)
        renderCalendar(currentViewYear, currentViewMonth);

        // 3. æ¸²æŸ“åº•éƒ¨çš„ Dashboard (æ˜¾ç¤ºå½“å¤©çš„ Todo)
        renderDashboardPreview();
      }

      function triggerScheduleBubble() {
        const bubble = document.getElementById('schedule-bubble');
        if (!bubble) return;

        bubble.classList.add('show');

        // âŒ åˆ é™¤ä¸‹é¢è¿™å‡ è¡Œï¼Œä¸è¦è‡ªåŠ¨æ¶ˆå¤±
        // setTimeout(() => {
        //     bubble.classList.remove('show');
        // }, 5000);
      }

      // è¾…åŠ©ï¼šè·å–ä»Šå¤©çš„ Key (YYYY-M-D)
      function getTodayKey() {
        const t = new Date();
        return `${t.getFullYear()}-${t.getMonth() + 1}-${t.getDate()}`;
      }

      // ä¿®æ”¹ renderDashboardPreview è®©å®ƒæ˜¾ç¤ºâ€œä»Šå¤©â€çš„å¾…åŠ
      function renderDashboardPreview() {
        const list = document.getElementById('cal-dash-list');
        const key = getTodayKey();
        const data = scheduleData[key];

        if (!data || !data.todos || data.todos.length === 0) {
          list.innerHTML = `<div class="cal-dash-item" style="color:#999; font-style:italic;">No tasks for today.</div>`;
          return;
        }

        // åªæ˜¾ç¤ºå‰ 3 æ¡
        const previewItems = data.todos.slice(0, 3);
        list.innerHTML = '';

        previewItems.forEach(item => {
          const icon = item.done ? 'fa-regular fa-square-check' : 'fa-regular fa-square';
          const style = item.done ? 'color:#aaa; text-decoration:line-through;' : '';

          list.innerHTML += `
            <div class="cal-dash-item" style="${style}">
                <i class="${icon}"></i> ${item.text}
            </div>
        `;
        });
      }
      // æ¸²æŸ“æ—¥å†ç½‘æ ¼
      function renderCalendar(year, month) {
        const grid = document.getElementById('cal-grid-content');
        grid.innerHTML = '';

        // æ›´æ–°æ ‡é¢˜
        document.getElementById('cal-display-month').innerText = String(month).padStart(2, '0');
        // ç®€æ˜“è‹±æ–‡æœˆä»½æ˜ å°„
        const months = [
          '',
          'JANUARY',
          'FEBRUARY',
          'MARCH',
          'APRIL',
          'MAY',
          'JUNE',
          'JULY',
          'AUGUST',
          'SEPTEMBER',
          'OCTOBER',
          'NOVEMBER',
          'DECEMBER',
        ];
        document.getElementById('cal-display-year').innerText = months[month];

        // è®¡ç®—å½“æœˆç¬¬ä¸€å¤©æ˜¯å‘¨å‡  (0-6, 0=Sun)
        const firstDay = new Date(year, month - 1, 1).getDay();
        // è°ƒæ•´ä¸ºå‘¨ä¸€ä¸ºèµ·å§‹ (1=Mon ... 7=Sun)
        const startOffset = firstDay === 0 ? 6 : firstDay - 1;

        // è®¡ç®—å½“æœˆå¤©æ•°
        const daysInMonth = new Date(year, month, 0).getDate();

        // å¡«å……ç©ºç™½å‰ç¼€
        for (let i = 0; i < startOffset; i++) {
          const emptyCell = document.createElement('div');
          emptyCell.className = 'cal-day-cell';
          emptyCell.style.border = 'none'; // ç©ºç™½å¤„æ— è¾¹æ¡†
          grid.appendChild(emptyCell);
        }

        // å¡«å……æ—¥æœŸ
        for (let d = 1; d <= daysInMonth; d++) {
          const cell = document.createElement('div');
          cell.className = 'cal-day-cell active-month';

          // æ„é€  Key æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
          const key = `${year}-${month}-${d}`;
          // === âœ… æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœªè¯» ===
          if (unreadScheduleDates.includes(key)) {
            cell.classList.add('pink-theme'); // æ·»åŠ ç²‰è‰²æ ·å¼ç±»
          }
          const hasData = scheduleData[key];

          let dotHtml = hasData ? `<div class="cal-event-dot"></div>` : '';

          // ç®€å•æ¨¡æ‹Ÿå†œå†/å°å­— (å¯ä»¥ç”¨ random æˆ–è€…å›ºå®šé€»è¾‘)
          let subText = '';
          if (d === 14) subText = 'Val.';
          if (d === 1) subText = 'Start';

          cell.innerHTML = `
            <div class="cal-day-num">${d}</div>
            <div class="cal-day-lunar">${subText}</div>
            ${dotHtml}
        `;

          // ç»‘å®šç‚¹å‡»äº‹ä»¶
          cell.onclick = () => openScheduleDetail(year, month, d);

          grid.appendChild(cell);
        }
      }

      // æ¸²æŸ“é¦–é¡µçš„ ToDo é¢„è§ˆ (åªæ˜¾ç¤ºä»Šå¤©çš„ï¼Œæˆ–è€…éšæœºæ˜¾ç¤ºå‡ ä¸ªæœªå®Œæˆçš„)
      // function renderDashboardPreview() {
      //     const list = document.getElementById('cal-dash-list');
      //     list.innerHTML = `
      //         <div class="cal-dash-item">
      //             <i class="fa-regular fa-square"></i> Organize database
      //         </div>
      //         <div class="cal-dash-item">
      //             <i class="fa-regular fa-square-check"></i> Backup memories
      //         </div>
      //         <div class="cal-dash-item" style="color:#aaa; text-decoration:line-through;">
      //             <i class="fa-solid fa-ban"></i> World domination
      //         </div>
      //     `;
      // }

      // æ‰“å¼€è¯¦æƒ…é¡µ
      // ä¿®æ”¹ openScheduleDetail å‡½æ•°ä¸­çš„éƒ¨åˆ†é€»è¾‘

      function openScheduleDetail(year, month, day) {
        const detail = document.getElementById('schedule-detail');
        // æ¸²æŸ“æ ‡é¢˜
        const dateObj = new Date(year, month - 1, day);
        const weekday = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
        document.getElementById('sd-title').innerText = `${year}.${month}.${day} (${weekday})`;

        const key = `${year}-${month}-${day}`;
        // === âœ… 1. æ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ›´æ–°çš„æ—¥æœŸ (åœ¨æ¸…é™¤å‰ä¿å­˜çŠ¶æ€) ===
        const isNewUpdate = unreadScheduleDates.includes(key);

        // === âœ… 2. ç§»é™¤æœªè¯»çŠ¶æ€ (ä¿æŒåŸæœ‰é€»è¾‘) ===
        if (isNewUpdate) {
          // ä»æ•°ç»„ä¸­åˆ é™¤
          unreadScheduleDates = unreadScheduleDates.filter(k => k !== key);

          // é‡æ–°æ¸²æŸ“æ—¥å†ç½‘æ ¼ (å»æ‰å¤–é¢çš„ç²‰è‰²åœˆ)
          renderCalendar(year, month);

          // å¦‚æœæ²¡æœ‰æœªè¯»æ¶ˆæ¯äº†ï¼Œéšè—æ°”æ³¡
          if (unreadScheduleDates.length === 0) {
            document.getElementById('schedule-bubble').classList.remove('show');
          }
        }

        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä» scheduleData è·å–ï¼Œå¦åˆ™ä¸ºç©º
        const data = scheduleData[key] || { timeline: [], todos: [] };

        // 1. æ¸²æŸ“ Timeline
        const tlBox = document.getElementById('sd-timeline-box');
        tlBox.innerHTML = '';

        if (!data.timeline || data.timeline.length === 0) {
          tlBox.innerHTML =
            '<div style="color:#999; font-size:0.8rem; font-style:italic; padding:10px;">No specific schedule for today.</div>';
        } else {
          // æŒ‰æ—¶é—´æ’åº (ç®€å•çš„å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œé€šå¸¸å¤Ÿç”¨)
          data.timeline.sort((a, b) => a.time.localeCompare(b.time));

          data.timeline.forEach(item => {
            // === âœ… ä¿®æ”¹æ ¸å¿ƒï¼šæ ¹æ® item å†…éƒ¨çš„ "new" å±æ€§æ¥åˆ¤æ–­ ===
            // åªæœ‰å½“ item.new === true æ—¶ï¼Œæ‰åŠ ä¸Š pink-mode ç±»
            const itemClass = item.new ? 'sd-tl-item pink-mode' : 'sd-tl-item';

            tlBox.innerHTML += `
                <div class="${itemClass}">
                    <div class="sd-time">${item.time}</div>
                    <div class="sd-content">${item.text}</div>
                </div>
            `;
          });
        }

        // 2. æ¸²æŸ“ ToDo (æ”¯æŒ AI æ§åˆ¶çš„ done çŠ¶æ€)
        const todoBox = document.getElementById('sd-todo-box');
        todoBox.innerHTML = '';

        if (!data.todos || data.todos.length === 0) {
          todoBox.innerHTML = '<div style="color:#999; font-size:0.8rem; padding:10px;">No tasks.</div>';
        } else {
          data.todos.forEach((item, index) => {
            // AI è¿”å›çš„ true/false æ§åˆ¶é€‰ä¸­çŠ¶æ€
            const checked = item.done ? 'checked' : '';

            // === ğŸŒ¸ æ ¸å¿ƒåˆ¤æ–­é€»è¾‘ ===
            // 1. æ˜¯å¦æ˜¯å…¨æ–°ä»»åŠ¡ï¼Ÿ (å½±å“æ–‡å­— + æ¡†)
            const isNewItem = item.new === true;

            // 2. æ˜¯å¦åªæ˜¯çŠ¶æ€å˜äº†ï¼Ÿ (åªå½±å“æ¡†)
            const isStatusChanged = item.status_change === true;

            // è®¡ç®—æ ·å¼ç±»
            // å¦‚æœæ˜¯æ–°ä»»åŠ¡ï¼Œç»™çˆ¶çº§åŠ  pink-text ç±»
            const itemContainerClass = isNewItem ? 'sd-todo-item pink-text' : 'sd-todo-item';

            // å¦‚æœæ˜¯æ–°ä»»åŠ¡ OR çŠ¶æ€æ”¹å˜ï¼Œç»™å¤é€‰æ¡†åŠ  pink-box ç±»
            const checkboxClass = isNewItem || isStatusChanged ? 'custom-checkbox pink-box' : 'custom-checkbox';

            todoBox.innerHTML += `
                <div class="${itemContainerClass}">
                    <input type="checkbox" class="${checkboxClass}" ${checked} 
                           onchange="updateTodoStatus('${key}', ${index}, this.checked)">
                    <span class="todo-text">${item.text}</span>
                    
                    ${
                      isNewItem
                        ? '<span style="width:6px;height:6px;background:#fd79a8;border-radius:50%;margin-left:auto;"></span>'
                        : ''
                    }
                </div>
            `;
            /* å¯é€‰ï¼šå¦‚æœæ˜¯æ–°ä»»åŠ¡æ˜¾ç¤ºä¸€ä¸ªå°åœ†ç‚¹æç¤º */
          });
        }

        // ==========================================
        // âœ… [ä¿®å¤ä»£ç ] åœ¨æ¸²æŸ“å®Œæˆåï¼Œå°†æ‰€æœ‰æ•°æ®æ ‡è®°ä¸ºâ€œå·²è¯»â€
        // è¿™æ ·ä¸‹æ¬¡æ‰“å¼€ï¼ˆæˆ–åˆ·æ–°ï¼‰æ—¶ï¼Œå®ƒä»¬å°±ä¸ä¼šå†æ˜¾ç¤ºç²‰è‰²é«˜äº®äº†
        // ==========================================
        // if (data.timeline) {
        //   data.timeline.forEach(item => {
        //     item.new = false; // æ¸…é™¤æ—¶é—´è½´çš„æ–°æ ‡è®°
        //   });
        // }
        // if (data.todos) {
        //   data.todos.forEach(item => {
        //     item.new = false; // æ¸…é™¤å¾…åŠäº‹é¡¹çš„æ–°æ ‡è®°
        //   });
        // }

        // === âœ… æ–°å¢ï¼šå¼ºåˆ¶æ»šåŠ¨æ¡å›åˆ°é¡¶éƒ¨ ===
        // æ‰¾åˆ°è´Ÿè´£æ»šåŠ¨çš„é‚£ä¸ªå®¹å™¨ï¼ŒæŠŠ scrollTop è®¾ä¸º 0
        const scrollContainer = detail.querySelector('.npc-detail-body');
        if (scrollContainer) {
          scrollContainer.scrollTop = 0;
        }
        // =================================

        detail.classList.add('open');
      }

      // æ–°å¢ï¼šæ‰‹åŠ¨å‹¾é€‰ ToDo åçš„çŠ¶æ€ä¿å­˜
      async function updateTodoStatus(dateKey, index, isDone) {
        if (scheduleData[dateKey] && scheduleData[dateKey].todos[index]) {
          // 1. æ›´æ–°å†…å­˜
          scheduleData[dateKey].todos[index].done = isDone;

          // 2. å¼‚æ­¥æ›´æ–°æ•°æ®åº“ (é™é»˜ä¿å­˜)
          if (currentChatCharId) {
            const record = await db.phone_data.get(currentChatCharId);
            if (record) {
              record.modules.schedule = scheduleData;
              await db.phone_data.put(record);
            }
          }

          // 3. å¦‚æœä¿®æ”¹çš„æ˜¯ä»Šå¤©çš„ï¼Œåˆ·æ–°ä¸€ä¸‹é¦–é¡µé¢„è§ˆ
          if (dateKey === getTodayKey()) {
            renderDashboardPreview();
          }
        }
      }

      function closeScheduleDetail() {
        document.getElementById('schedule-detail').classList.remove('open');
      }

      function toggleTodoStyle(checkbox) {
        // æ ·å¼ç”± CSS :checked + span æ§åˆ¶ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–é€»è¾‘ï¼Œ
        // ä½†å¦‚æœè¦åœ¨æ•°æ®åº“ä¿å­˜çŠ¶æ€ï¼Œå¯ä»¥åœ¨è¿™é‡Œå†™
        // //console.log("Task status changed");
      }

      function addNewEventPrompt() {
        alert('New Event UI is under construction (Simulated)');
      }
      // ================= âœ¨ AI æ—¥ç¨‹ç”Ÿæˆå™¨ (24Hå…¨è¦†ç›–+æ—¶æ€ä¿®æ­£ç‰ˆ) =================

      async function generateAiSchedule() {
        console.clear();
        console.group('ğŸš€ [AI Schedule] ä»»åŠ¡å¼€å§‹');

        const cfg = appData[appData.activeSlot];
        if (!cfg.key) {
          console.error('âŒ æœªé…ç½® API Key');
          console.groupEnd();
          return alert('API Key Required');
        }

        const char = dbCharacters.find(c => c.id === currentChatCharId);
        if (!char) {
          console.error('âŒ æœªé€‰æ‹©è§’è‰²');
          console.groupEnd();
          return alert('Please select a character first.');
        }

        // UI åŠ¨ç”»
        const icon = document.getElementById('cal-loading-icon');
        const bubble = document.getElementById('cal-cat-text');
        icon.classList.add('fa-spin');
        bubble.innerText = 'Planning...';

        try {
          // ==========================================
          // ğŸ“¦ 1. æ„å»ºä¸Šä¸‹æ–‡
          // ==========================================
          console.group('ğŸ“š [Step 1] ä¸Šä¸‹æ–‡ç»„è£…');

          // ==========================================
          // ğŸ“¦ 1. æ„å»ºä¸Šä¸‹æ–‡ (ç²¾ç¡®åˆ°åˆ†é’Ÿ)
          // ==========================================
          console.group('ğŸ“š [Step 1] ä¸Šä¸‹æ–‡ç»„è£…');

          // è·å–ç²¾ç¡®çš„å½“å‰æ—¶é—´
          const now = new Date();
          const currentYear = now.getFullYear();
          const currentMonth = now.getMonth() + 1;
          const currentDay = now.getDate();

          // è¾…åŠ©å‡½æ•°ï¼šæå–å¹¶æ‹¼æ¥å¯ç”¨çš„ä¸–ç•Œä¹¦æ¡ç›®
          const filterWB = list =>
            (list || [])
              .filter(w => w.enabled !== false)
              .map(w => w.content)
              .join('\n');

          // A. ä¸–ç•Œä¹¦ (Before & After)
          const wbBefore = filterWB(char.world_info_before);
          const wbAfter = filterWB(char.world_info_after);

          // è·å–èŠå¤©è®°å½•
          // 1. [ä¿®æ”¹] ä½¿ç”¨è¾…åŠ©å‡½æ•° (å–æœ€è¿‘ 30 æ¡ä»¥ä¿è¯ä¸Šä¸‹æ–‡å……è¶³)
          const history = await fetchHistoryWithOfflineReplacements(char.id, 0);

          // 2. æ ¼å¼åŒ–å†å²è®°å½•
          // ==========================================
          // âœ… [ä¿®å¤] å®šä¹‰ userName é˜²æ­¢æŠ¥é”™
          // ==========================================
          const userName = 'User'; // è¿™é‡Œå¯ä»¥å†™æ­»ä¸º 'User'ï¼Œæˆ–è€… 'You'

          // 2. æ ¼å¼åŒ–å†å²è®°å½•
          const historyContext = history
            .map(m => {
              const timeStr = new Date(m.timestamp).toLocaleString('zh-CN', { hour12: false });
              // content å·²ç»è¢«è¾…åŠ©å‡½æ•°æ›¿æ¢è¿‡äº†ï¼Œç›´æ¥å»æ ‡ç­¾å³å¯
              let cleanContent = m.content.replace(/<[^>]+>/g, '');

              // ç°åœ¨ userName å·²ç»å®šä¹‰äº†ï¼Œä¸ä¼šæŠ¥é”™äº†
              return `[${timeStr}] ${m.role === 'user' ? userName : char.name}: ${cleanContent}`;
            })
            .join('\n');

          // æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹
          //console.log(`ğŸŒ ä¸–ç•Œä¹¦(å‰)é•¿åº¦: ${wbBefore.length} å­—ç¬¦`);
          //console.log(`ğŸ“œ ä¸–ç•Œä¹¦(å)é•¿åº¦: ${wbAfter.length} å­—ç¬¦`);
          //console.log(`ğŸ—£ï¸ èŠå¤©è®°å½•é•¿åº¦: ${historyContext.length} å­—ç¬¦`);

          // æ ¼å¼åŒ–å½“å‰æ—¶é—´å­—ç¬¦ä¸²: "2026-1-16 14:30"
          const nowTimeStr = `${currentYear}-${currentMonth}-${currentDay} ${now.getHours()}:${String(
            now.getMinutes(),
          ).padStart(2, '0')}`;
          const todayDateKey = `${currentYear}-${currentMonth}-${currentDay}`;

          // è®¡ç®—æœªæ¥ 7 å¤©
          const dateList = [];
          for (let i = 0; i < 7; i++) {
            const d = new Date(now);
            d.setDate(now.getDate() + i);
            dateList.push(`${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`);
          }
          const targetDatesStr = dateList.join(', ');

          //console.log('ğŸ•’ å½“å‰ç²¾ç¡®æ—¶é—´:', nowTimeStr);
          console.groupEnd();

          // ==========================================
          // ğŸ“ 2. æ„å»º Prompt (åŠ å…¥è¯­è¨€æ§åˆ¶ + 24Hå…¨è¦†ç›–)
          // ==========================================
          console.group('ğŸ“¤ [Step 2] å‘é€ Prompt');
          //ï¼ï¼
          const sysPrompt = `You are the AI scheduler for "${char.name}".
**Goal**: Generate a strict, 24-hour full-coverage schedule for the next 7 days.

=== ğŸŒ CONTEXT ===
World Setting:${wbBefore || 'Modern setting.'}
Character Persona: ${char.description}
Deep Lore: ${wbAfter || 'None.'}
User_Name: ${userName || 'User'}
User_Persona: ${char.user_persona || 'None'}
Recent Chat Context: 
${historyContext}

=== ğŸ—£ï¸ LANGUAGE RULES (CRITICAL) ===
1. **DEFAULT LANGUAGE**: All descriptions in the "text" fields MUST be in **Simplified Chinese (ç®€ä½“ä¸­æ–‡)**.
2. **EXCEPTION**: If the character is explicitly **Japanese** (based on persona/name/setting), you may use **Japanese**.
3. **TRANSLATION**: Even if the Persona/World info provided above is in English, you **MUST** translate the generated schedule into the target language (Chinese/Japanese). Do NOT output English.

=== ğŸ•’ TIME & TENSE RULES (STRICT) ===
**Current Time Line**: ${nowTimeStr}

1. **BEFORE THE CURRENT TIME (${nowTimeStr})**:
   - Style: **Diary / Narrative**.
   - You CAN include subjective feelings, outcomes, and specific interactions that "already happened".
   - Example: "09:00 - ä¸Šäº†é«˜æ•°è¯¾ï¼Œæ•™æˆè®²å¾—å¤ªçƒ‚ï¼Œæˆ‘ç¡ç€äº†ã€‚" (Allowed: outcome described)

2. **AFTER THE CURRENT TIME (Today's Remaining Time)**:
   - Style: **Planning with Attitude**.
   - You CAN include complaints or expectations about the *Plan*, but DO NOT describe the *Outcome*.
   - Allowed: "19:00 - éƒ¨é—¨èšé¤ (çœŸä¸æƒ³å»ï¼Œæ‰“ç®—æ‰¾å€Ÿå£æ—©é€€)ã€‚" (Intention is okay)
   - BANNED: "19:00 - èšé¤æ—¶é‡åˆ°äº†é‚£ä¸ªè®¨åŒçš„äººï¼Œåµäº†ä¸€æ¶ã€‚" (WRONG! Hasn't happened yet!)

3. **FUTURE DATES (Tomorrow & Beyond)**:
   - Style: **Objective Schedule / Tentative Plan**.
   - Must be realistic and functional. NO narrative stories.
   - **Idle Time**: If unsure, list options using "Maybe" or "Plan A/B".
   - **Sleep**: Must be a target time (e.g., "23:00 (Target) Sleep").
   - **Examples**:
     - âœ… "08:00 - ä¸“ä¸šè¯¾ï¼šé«˜çº§ç®—æ³•" (Objective)
     - âœ… "14:00 - ç©ºé—² (æ‰“ç®—å»å›¾ä¹¦é¦†æˆ–è€…å¥èº«)" (Options)
     - âŒ "08:00 - ä¸Šè¯¾æ—¶è¢«è€å¸ˆè¡¨æ‰¬äº†ã€‚" (No predictions!)
     - âŒ "14:00 - åœ¨å›¾ä¹¦é¦†å¶é‡äº†Userã€‚" (No roleplay events!)

=== âœ… TODO LIST RULES ===
1. **Future Tasks**: Must be "done": false.
2. **Pre-completed**: If a future task is already finished beforehand, mark "done": true and append "(å·²æå‰å®Œæˆ)".

=== â³ FULL 24-HOUR COVERAGE ===
Cover 00:00 to 23:59. Include Sleep, Meals, Hygiene, Commute. No gaps.

=== ğŸ“… TARGET DATES ===
${targetDatesStr}

=== ğŸ“¤ JSON OUTPUT FORMAT ===
Return ONLY JSON.
{
  "YYYY-M-D": {
    "timeline": [
       {"time": "00:00 - 08:00", "text": "ç¡çœ  (ç›®æ ‡)"},
       {"time": "08:00 - 12:00", "text": "ä¸Šè¯¾ï¼šçº¿æ€§ä»£æ•°"}
    ],
    "todos": [
       {"text": "å¤ä¹ ç¬”è®°", "done": false}
    ]
  }
}`;

          //console.log(sysPrompt);
          console.groupEnd();

          // ==========================================
          // ğŸš€ 3. å‘é€è¯·æ±‚
          // ==========================================
          //console.log('â³ æ­£åœ¨è¯·æ±‚ API...');

          const res = await fetch(cfg.url + '/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${cfg.key}` },
            body: JSON.stringify({
              model: cfg.model,
              messages: [
                { role: 'system', content: 'You are a strict JSON generator. Do not output markdown.' },
                { role: 'user', content: sysPrompt },
              ],
              temperature: cfg.temp,
            }),
          });

          const data = await res.json();

          // ==========================================
          // ğŸ“¥ 4. è§£æä¸å­˜å‚¨
          // ==========================================
          console.group('ğŸ“¥ [Step 3] æ¥æ”¶ä¸å¤„ç†');

          if (!data.choices || data.choices.length === 0) throw new Error('API Empty Response');

          let cleanStr = data.choices[0].message.content
            .replace(/```json/g, '')
            .replace(/```/g, '')
            .trim();
          //console.log('ğŸ“¦ Cleaned JSON:', cleanStr);

          let newSchedule = JSON.parse(cleanStr);
          //console.log('âœ… è§£ææˆåŠŸ:', newSchedule);

          // åˆå¹¶æ•°æ®
          scheduleData = { ...scheduleData, ...newSchedule };

          // å­˜åº“
          const record = (await db.phone_data.get(char.id)) || { charId: char.id, modules: {} };
          if (!record.modules) record.modules = {};
          record.modules.schedule = scheduleData;
          await db.phone_data.put(record);

          // åˆ·æ–° UI
          renderCalendar(currentViewYear, currentViewMonth);
          renderDashboardPreview();

          console.groupEnd();

          bubble.innerText = 'Planned!';
          setTimeout(() => (bubble.innerText = 'Busy?'), 2000);
        } catch (e) {
          console.error('âŒ Error:', e);
          alert('Scheduling failed: ' + e.message);
          bubble.innerText = 'Error!';
        } finally {
          icon.classList.remove('fa-spin');
          console.groupEnd();
        }
      }
      // === ğŸ’¾ è®¾ç½®é¡¹çŠ¶æ€è®°å¿†é€»è¾‘ ===

      document.addEventListener('DOMContentLoaded', () => {
        // 1. è·å–å¼€å…³å…ƒç´ 
        const syncSwitch = document.getElementById('setting-schedule-sync');

        if (syncSwitch) {
          // 2. è¯»å–æœ¬åœ°å­˜å‚¨ (Key: 'cfg_schedule_sync')
          // å¦‚æœå­˜å‚¨çš„æ˜¯å­—ç¬¦ä¸² 'true'ï¼Œåˆ™å‹¾é€‰ï¼Œå¦åˆ™ä¸å‹¾é€‰
          const savedState = localStorage.getItem('cfg_schedule_sync');

          // åˆå§‹åŒ–å¼€å…³çŠ¶æ€
          if (savedState === 'true') {
            syncSwitch.checked = true;
          } else {
            syncSwitch.checked = false;
          }

          // 3. ç›‘å¬æ”¹å˜äº‹ä»¶ï¼Œå®æ—¶ä¿å­˜
          syncSwitch.addEventListener('change', e => {
            const isChecked = e.target.checked;
            localStorage.setItem('cfg_schedule_sync', isChecked);
            //console.log('é…ç½®å·²ä¿å­˜: æ—¥ç¨‹åŒæ­¥ = ' + isChecked);
            // === âœ… æ–°å¢ï¼šå¦‚æœå½“å‰æ­£åœ¨èŠå¤©å®¤ä¸­ï¼Œç«‹å³åˆ·æ–°ç•Œé¢ ===
            if (typeof currentChatCharId !== 'undefined' && currentChatCharId) {
              // é‡æ–°æ¸²æŸ“å½“å‰èŠå¤©å®¤
              // å› ä¸º appendMessageBubble å†…éƒ¨ä¼šè¯»å–å¼€å…³çŠ¶æ€ï¼Œæ‰€ä»¥ç›´æ¥é‡ç»˜å°±ä¼šç”Ÿæ•ˆ
              const char = dbCharacters.find(c => c.id === currentChatCharId);
              if (char) {
                openChatRoom(char);
              }
            }
          });
        }
      });
      // æ’å…¥æ—¥æœŸåˆ†å‰²çº¿ (ä¿®å¤ç‰ˆï¼šé˜²æ­¢ NaN)
      function appendDateDivider(timestamp) {
        // 1. å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ï¼Œæˆ–è€…æ—¶é—´æˆ³æ— æ•ˆï¼Œç›´æ¥ä¸æ¸²æŸ“
        if (!timestamp) return;

        const date = new Date(timestamp);

        // 2. æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ (æ ¸å¿ƒä¿®å¤ NaN é—®é¢˜)
        if (isNaN(date.getTime())) return;

        const chatBody = document.getElementById('cr-body');
        const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;

        const div = document.createElement('div');
        div.className = 'system-date-bubble';
        div.innerHTML = `<span>${dateStr}</span>`;
        chatBody.appendChild(div);
      }

      // è¾…åŠ©ï¼šæ£€æŸ¥ä¸¤ä¸ªæ—¶é—´æˆ³æ˜¯å¦è·¨å¤©
      function isDifferentDay(ts1, ts2) {
        const d1 = new Date(ts1);
        const d2 = new Date(ts2);
        return (
          d1.getFullYear() !== d2.getFullYear() || d1.getMonth() !== d2.getMonth() || d1.getDate() !== d2.getDate()
        );
      }

      // === ğŸ¬ çº¿ä¸‹æ¨¡å¼å¼€å…³é€»è¾‘ ===
      // 1. å¼€å…³æ§åˆ¶ï¼šæ‰“å¼€åå‘é€éšæœºèƒŒæ™¯çš„åœºè®°æ¿
      async function toggleOfflineMode(el) {
        if (!currentChatCharId) return;
        const isChecked = el.checked;
        // âœ… ä¿å­˜çŠ¶æ€åˆ°æœ¬åœ° (key æ ¼å¼: offline_mode_è§’è‰²ID)
        localStorage.setItem('offline_mode_' + currentChatCharId, isChecked);
        if (isChecked) {
          // âœ… æ ¸å¿ƒéœ€æ±‚ï¼šéšæœºèƒŒæ™¯
          const randomBg = DIARY_BGS[Math.floor(Math.random() * DIARY_BGS.length)];

          // æ„é€ æ¶ˆæ¯å†…å®¹: çŠ¶æ€|èƒŒæ™¯å›¾|å…³è”å¸–å­ID
          const content = `Active|${randomBg}|null`;

          // å‘é€ç‰¹æ®Šç±»å‹çš„æ¶ˆæ¯ 'offline_card' (åªå­˜åº“ï¼Œä¸è§¦å‘ AI å›å¤)
          await handleSendMessage('offline_card', content, 'user_only');

          // å¼ºåˆ¶åˆ·æ–°èŠå¤©å®¤ä»¥æ˜¾ç¤ºæ–°å¡ç‰‡
          // const char = dbCharacters.find(c => c.id === currentChatCharId);
          // openChatRoom(char); // è¿™ä¸€æ­¥ handleSendMessage é‡Œé€šå¸¸ä¼šè‡ªåŠ¨åšï¼Œå¦‚æœæ²¡åšå¯ä»¥è§£å¼€æ³¨é‡Š
        }
      }

      // ================= ğŸ¬ çº¿ä¸‹æ¨¡å—æ ¸å¿ƒé€»è¾‘ =================

      // 1. ç‚¹å‡» Action -> è·³è½¬å‘ç°é¡µ -> è§¦å‘ç”Ÿæˆ
      async function startOfflineScenario(msgId, bgUrl) {
        if (!currentChatCharId) return;

        // A. è·³è½¬é¡µé¢
        switchPage('discover');

        // B. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const btn = document.getElementById('btn-generate');
        btn.innerHTML = '<i class="fa-solid fa-video fa-spin"></i> Offline Action...';
        btn.disabled = true;

        // B. è·³è½¬é¡µé¢ (å¦‚æœéœ€è¦)
        // switchPage('discover');

        try {
          // C. å‡†å¤‡ä¸Šä¸‹æ–‡æ•°æ®
          const char = dbCharacters.find(c => c.id === currentChatCharId);
          const filterWB = list =>
            (list || [])
              .filter(w => w.enabled !== false)
              .map(w => w.content)
              .join('\n');

          // è·å–æœ€è¿‘ 10 æ¡èŠå¤©è®°å½•ä½œä¸ºâ€œè¿‡æ¸¡å‰å¥â€
          const history = await db.chat_messages
            .where('charId')
            .equals(char.id)
            .reverse()
            // .limit(10)
            .toArray();
          const chatContext = history
            .reverse()
            .map(m => `${m.role}: ${m.content}`)
            .join('\n');

          const context = `
=== ğŸŒ WORLD (BEFORE) ===
${filterWB(char.world_info_before)}

=== ğŸ‘¤ CHARACTER ===
Name: ${char.name}
Desc: ${char.description}

=== ğŸ“œ WORLD (AFTER) ===
${filterWB(char.world_info_after)}

=== ğŸ­ USER ===
Name: ${char.user_name || 'User'}
Persona: ${char.user_persona || 'None'}

=== ğŸ’¬ RECENT ONLINE CHAT ===
${chatContext}
`;

          // D. æ„å»º Prompt (è¿‡æ¸¡åˆ°çº¿ä¸‹)
          const promptText = `
You are writing a special "Offline Scenario" card.
The users have decided to meet explicitly offline (IRL) or transition to a specific scenario based on the chat context.

**TASK**:
1. Analyze the recent chat to see *where* or *why* they are meeting.
2. Write a detailed, immersive standalone story (approx. 800-1000 words) about this offline meeting.
3. Style: Cinematic, Sensory, Romantic/Dramatic.
4. **Transition**: Start from the moment they meet or the environment setup.

**OUTPUT JSON ONLY**:
{
    "title": "A Cinematic Title",
    "quote": "A key line from the scene",
    "content": "Full story content...",
    "tags": ["Offline", "Date", "RealLife"]
}`;

          // E. è°ƒç”¨ API
          const cfg = appData[appData.activeSlot];
          const res = await fetch(cfg.url + '/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${cfg.key}` },
            body: JSON.stringify({
              model: cfg.model,
              temperature: cfg.temp,
              messages: [
                { role: 'system', content: context },
                { role: 'user', content: promptText },
              ],
            }),
          });

          const data = await res.json();
          let cleanJson = data.choices[0].message.content.replace(/```json|```/g, '').trim();
          const result = JSON.parse(cleanJson);

          // F. å­˜å…¥ idea_posts (ä½œä¸ºçº¿ä¸‹å¡ç‰‡)
          const newPost = {
            ...result,
            charName: char.name,
            userAvatar: processAvatar(char.user_avatar),
            charAvatar: processAvatar(char.avatar),
            bg: bgUrl, // âœ… ä½¿ç”¨ä¼ å…¥çš„éšæœºèƒŒæ™¯
            date: new Date().toLocaleDateString(),
            matchRate: 100,
            isOffline: true, // âœ… æ ‡è®°ä¸ºçº¿ä¸‹
            charId: char.id,
            timestamp: Date.now(),
          };

          const newPostId = await db.idea_posts.add(newPost);
          newPost.id = newPostId;

          // G. ç«‹å³æ¸²æŸ“åˆ° Offline åŒºåŸŸ (æ— åˆ·æ–°)
          const gridOffline = document.getElementById('grid-offline');
          const header = document.getElementById('offline-section-header');
          if (header) header.style.display = 'flex';

          // åˆ›å»ºä¸´æ—¶å®¹å™¨æ¸²æŸ“ï¼Œç„¶åæ’åˆ°æœ€å‰é¢
          const tempDiv = document.createElement('div');
          renderCard(newPost, (tempDiv.id = 'temp'), false);
          if (tempDiv.firstChild) {
            if (gridOffline.firstChild) {
              gridOffline.insertBefore(tempDiv.firstChild, gridOffline.firstChild);
            } else {
              gridOffline.appendChild(tempDiv.firstChild);
            }
          }

          // H. **å…³é”®æ­¥éª¤**: æ›´æ–°èŠå¤©å®¤é‡Œçš„é‚£å¼ å¡ç‰‡çŠ¶æ€
          // æˆ‘ä»¬éœ€è¦æ‰¾åˆ°é‚£æ¡ msgIdï¼Œæ›´æ–°å®ƒçš„ content
          const chatMsg = await db.chat_messages.get(Number(msgId));
          if (chatMsg) {
            // content æ ¼å¼: Status|BgUrl|PostId
            // æ›´æ–°ä¸º: Finished|BgUrl|NewPostId
            chatMsg.content = `Finished|${bgUrl}|${newPostId}`;
            await db.chat_messages.put(chatMsg);
          }

          // I. å³æ—¶æ›´æ–°èŠå¤©å®¤æ°”æ³¡ (DOMæ“ä½œ)
          const bubbleEl = document.getElementById(`msg-${msgId}`);
          if (bubbleEl) {
            // ç§»é™¤ "LIVE" æ ‡ç­¾
            const statusEl = bubbleEl.querySelector('.clapper-status');
            if (statusEl) statusEl.remove();

            // æ›´æ–°æ–‡å­—æè¿°
            const descEl = bubbleEl.querySelector('.clapper-desc');
            if (descEl) descEl.textContent = 'Scenario Generated.';

            // æ›¿æ¢æŒ‰é’®åŒºåŸŸä¸º "å›é¡¾" å’Œ "æ€»ç»“"
            const actionContainer = bubbleEl.querySelector('.clapper-actions');
            if (actionContainer) {
              // âœ… ä¿®æ”¹ç‚¹ 3: åŠ¨æ€æ³¨å…¥çš„ HTML ä¹Ÿè¦åŠ  event.stopPropagation();
              actionContainer.innerHTML = `
                    <button class="clapper-btn" onclick="event.stopPropagation(); openLinkedOfflinePost('${newPostId}')" style="flex:1">
                        <i class="fa-solid fa-eye"></i> å›é¡¾
                    </button>
                    <button class="clapper-btn action" onclick="event.stopPropagation(); finishOfflineMode('${msgId}', '${newPostId}', this)">
                        <i class="fa-solid fa-flag-checkered"></i> æ€é’
                    </button>
                `;
            }
          }

          alert('ğŸ¬ Action! Offline scenario generated.');

          // è‡ªåŠ¨æ‰“å¼€é¢„è§ˆ
          openPreview(newPost);
        } catch (e) {
          console.error(e);
          alert('Generation failed: ' + e.message);
        } finally {
          btn.innerHTML = '<i class="fa-solid fa-bolt"></i>';
          btn.disabled = false;

          // åˆ·æ–°èŠå¤©å®¤å¦‚æœæˆ‘ä»¬åœ¨é‚£é‡Œ (ä¸ºäº†æ›´æ–°æŒ‰é’®çŠ¶æ€)
          // æ³¨æ„ï¼šæˆ‘ä»¬ç°åœ¨åœ¨ Discover é¡µï¼Œä½†ä¸ºäº†å›å»æ—¶çœ‹åˆ°çŠ¶æ€æ›´æ–°ï¼Œæœ€å¥½åˆ·æ–°ä¸‹æ•°æ®
        }
      }

      // 2. æ¸²æŸ“çº¿ä¸‹å¡ç‰‡åˆ°ç‰¹å®šåŒºåŸŸ
      function renderOfflinePostInGrid(post) {
        const header = document.getElementById('offline-section-header');
        const grid = document.getElementById('grid-offline');

        header.style.display = 'flex'; // æ˜¾ç¤ºæ ‡é¢˜
        renderCard(post, 'grid-offline', true); // å¤ç”¨ç°æœ‰çš„ renderCard
      }

      // 3. ç‚¹å‡» Wrap Up (æ€»ç»“å¹¶æ€é’)
      // ================= ğŸ¬ çº¿ä¸‹æ¨¡å—æ ¸å¿ƒé€»è¾‘ =================

      // 1. å¼€å…³æ§åˆ¶ï¼šæ‰“å¼€åå‘é€éšæœºèƒŒæ™¯çš„åœºè®°æ¿
      async function toggleOfflineMode(el) {
        if (!currentChatCharId) return;
        const isChecked = el.checked;

        if (isChecked) {
          // âœ… æ ¸å¿ƒéœ€æ±‚ï¼šéšæœºèƒŒæ™¯
          const randomBg = DIARY_BGS[Math.floor(Math.random() * DIARY_BGS.length)];

          // æ„é€ æ¶ˆæ¯å†…å®¹: çŠ¶æ€|èƒŒæ™¯å›¾|å…³è”å¸–å­ID
          const content = `Active|${randomBg}|null`;

          // å‘é€ç‰¹æ®Šç±»å‹çš„æ¶ˆæ¯ 'offline_card' (åªå­˜åº“ï¼Œä¸è§¦å‘ AI å›å¤)
          await handleSendMessage('offline_card', content, 'user_only');

          // å¼ºåˆ¶åˆ·æ–°èŠå¤©å®¤ä»¥æ˜¾ç¤ºæ–°å¡ç‰‡
          // const char = dbCharacters.find(c => c.id === currentChatCharId);
          // openChatRoom(char); // è¿™ä¸€æ­¥ handleSendMessage é‡Œé€šå¸¸ä¼šè‡ªåŠ¨åšï¼Œå¦‚æœæ²¡åšå¯ä»¥è§£å¼€æ³¨é‡Š
        }
      }

      // 2. ç‚¹å‡» Action -> è·³è½¬ Discover -> è‡ªåŠ¨ç”Ÿæˆ -> å³æ—¶æ›´æ–° UI
      async function startOfflineGeneration(msgId, bgUrl, btnElement) {
        if (!currentChatCharId) return;

        // A. æŒ‰é’® Loading çŠ¶æ€
        // 1. æŒ‰é’® UI å˜ä¸º Loading çŠ¶æ€
        const originalBtnContent = btnElement.innerHTML;
        // åŠ ä¸Š event.stopPropagation() é˜²æ­¢å†’æ³¡ï¼Œè™½ç„¶ HTML é‡ŒåŠ äº†ï¼Œè¿™é‡ŒåŒé‡ä¿é™©
        if (window.event) window.event.stopPropagation();
        btnElement.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Filming...';
        btnElement.disabled = true;
        btnElement.style.opacity = '1';
        // B. è·³è½¬é¡µé¢ (å¦‚æœéœ€è¦)
        // switchPage('discover');

        try {
          const char = dbCharacters.find(c => c.id === currentChatCharId);

          // C. å‡†å¤‡ Context (ä¸–ç•Œä¹¦ + äººè®¾ + å†å²è®°å½•)
          const filterWB = list =>
            (list || [])
              .filter(w => w.enabled !== false)
              .map(w => w.content)
              .join('\n');

          // å–æœ€è¿‘ 15 æ¡èŠå¤©è®°å½•ä½œä¸ºä¸Šä¸‹æ–‡
          // 1. [ä¿®æ”¹] ä½¿ç”¨è¾…åŠ©å‡½æ•°è·å–å¹¶æ›¿æ¢å†å²å†…å®¹
          const history = await fetchHistoryWithOfflineReplacements(char.id, 0);

          // 2. æ‹¼æ¥ä¸Šä¸‹æ–‡
          const chatContext = history.map(m => `${m.role}: ${m.content}`).join('\n');
          //ï¼ï¼
          // D. æ„é€  Prompt (æ€»ç»“çº¿ä¸Š -> è¿‡æ¸¡åˆ°çº¿ä¸‹)
          const sysPrompt = `
You are writing a special "Offline Scenario" card (Visual Novel Style).
Based on the chat history, the user and character are meeting offline (IRL) or transitioning to a specific scene.

=== ğŸŒ WORLD ===
${filterWB(char.world_info_before)}
=== ğŸ‘¤ CHAR ===
Name: ${char.name}
Desc: ${char.description}
${filterWB(char.world_info_after)}
=== ğŸ­ USER ===
Name: ${char.user_name || 'User'}
Persona: ${char.user_persona || 'None'}

=== ğŸ“œ CHAT HISTORY (ONLINE) ===
${chatContext}

=== âš¡ TASK ===
1. Summarize the online chat context.
2. Write a detailed, immersive scene of them meeting offline.
3. Style: Cinematic, Sensory, Romantic/Dramatic.

Output JSON ONLY:
{
    "title": "Scene Title",
    "quote": "Key dialogue line",
    "content": "Full story content (800+ words)...",
    "tags": ["Offline", "Date", "RealLife"]
}`;

          // E. è°ƒç”¨ API
          const cfg = appData[appData.activeSlot];
          const res = await fetch(cfg.url + '/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${cfg.key}` },
            body: JSON.stringify({
              model: cfg.model,
              temperature: 0.8,
              messages: [{ role: 'user', content: sysPrompt }],
            }),
          });

          const data = await res.json();
          let cleanJson = data.choices[0].message.content.replace(/```json|```/g, '').trim();
          const result = JSON.parse(cleanJson);

          // F. å­˜å…¥æ•°æ®åº“ (æ ‡è®°ä¸º isOffline)
          const newPost = {
            ...result,
            charName: char.name,
            userAvatar: processAvatar(char.user_avatar),
            charAvatar: processAvatar(char.avatar),
            bg: bgUrl, // âœ… ä½¿ç”¨ä¼ å…¥çš„éšæœºèƒŒæ™¯
            date: new Date().toLocaleDateString(),
            matchRate: 100,
            isOffline: true, // âœ… æ ‡è®°ä¸ºçº¿ä¸‹
            charId: char.id,
            timestamp: Date.now(),
          };

          const newPostId = await db.idea_posts.add(newPost);
          newPost.id = newPostId;

          // --- C. âœ¨ ç«‹å³åˆ·æ–°â€œçº¿ä¸‹å‰§åœºâ€åŒºåŸŸ (ä¿®å¤æŠ¥é”™çš„å…³é”®éƒ¨åˆ†) ---
          const gridOffline = document.getElementById('grid-offline');
          const offlineHeader = document.getElementById('offline-section-header');

          if (offlineHeader) offlineHeader.style.display = 'flex';

          // 1. åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨ï¼Œå¹¶ã€ç¡®å®åœ°ã€‘æŒ‚è½½åˆ° body ä¸Š
          // è¿™æ · document.getElementById æ‰èƒ½æ‰¾åˆ°å®ƒ
          const tempId = 'temp-gen-zone-' + Date.now();
          const tempContainer = document.createElement('div');
          tempContainer.id = tempId;
          tempContainer.style.display = 'none'; // éšè—å®ƒï¼Œä¸è®©ç”¨æˆ·çœ‹åˆ°é—ªçƒ
          document.body.appendChild(tempContainer);

          // 2. æ¸²æŸ“åˆ°è¿™ä¸ªä¸´æ—¶å®¹å™¨ä¸­
          renderCard(newPost, tempId, false);

          // 3. å°†æ¸²æŸ“å¥½çš„å¡ç‰‡ç§»åŠ¨åˆ° gridOffline çš„æœ€é¡¶éƒ¨
          const card = tempContainer.firstElementChild;
          if (card) {
            if (gridOffline.firstChild) {
              gridOffline.insertBefore(card, gridOffline.firstChild);
            } else {
              gridOffline.appendChild(card);
            }
          }

          // 4. æ¸…ç†ä¸´æ—¶å®¹å™¨
          document.body.removeChild(tempContainer);

          // H. å…³é”®ï¼šå›å†™èŠå¤©è®°å½•ï¼Œæ›´æ–°å¡ç‰‡çŠ¶æ€
          // --- D. âœ¨ æ›´æ–°èŠå¤©å®¤æ°”æ³¡ (æ— éœ€åˆ·æ–°é¡µé¢) ---

          // 1. æ›´æ–°æ•°æ®åº“çŠ¶æ€
          const chatMsg = await db.chat_messages.get(Number(msgId));
          if (chatMsg) {
            chatMsg.content = `Finished|${bgUrl}|${newPostId}`;
            await db.chat_messages.put(chatMsg);
          }

          // 2. ç›´æ¥æ“ä½œ DOM æ›´æ–°æ°”æ³¡æ ·å¼
          const bubbleEl = document.getElementById(`msg-${msgId}`);
          if (bubbleEl) {
            // ç§»é™¤ "LIVE" æ ‡ç­¾
            const statusEl = bubbleEl.querySelector('.clapper-status');
            if (statusEl) statusEl.remove();

            // æ›´æ–°æ–‡å­—æè¿°
            const descEl = bubbleEl.querySelector('.clapper-desc');
            if (descEl) descEl.textContent = 'Scenario Generated.';

            // æ›¿æ¢æŒ‰é’®åŒºåŸŸ
            const actionContainer = bubbleEl.querySelector('.clapper-actions');
            if (actionContainer) {
              // æ³¨æ„ï¼šè¿™é‡Œä¹ŸåŠ äº† event.stopPropagation()
              actionContainer.innerHTML = `
                    <button class="clapper-btn" onclick="event.stopPropagation(); openLinkedOfflinePost('${newPostId}')" style="flex:1">
                        <i class="fa-solid fa-eye"></i> å›é¡¾
                    </button>
                    <button class="clapper-btn action" onclick="event.stopPropagation(); wrapUpOfflineMode('${msgId}', '${newPostId}', this)">
                        <i class="fa-solid fa-flag-checkered"></i> æ€é’
                    </button>
                `;
            }
          }

          // æç¤ºæˆåŠŸ
          // alert('ğŸ¬ Cut! Offline Scenario Generated.');

          // è‡ªåŠ¨æ‰“å¼€é¢„è§ˆ
          openPreview(newPost);
        } catch (e) {
          console.error(e);
          alert('Generation failed: ' + e.message);
          // æ¢å¤æŒ‰é’®
          btnElement.innerHTML = originalText;
          btnElement.disabled = false;
          btnElement.style.opacity = '1';

          // å¦‚æœä¸­é—´åˆ›å»ºäº† tempContainer ä½†æŠ¥é”™äº†ï¼Œå°è¯•æ¸…ç†ä¸€ä¸‹ï¼ˆå¯é€‰ï¼‰
          const leftover = document.querySelector('[id^="temp-gen-zone-"]');
          if (leftover) document.body.removeChild(leftover);
        }
      }
      //ï¼ï¼
      // 3. ç‚¹å‡» Wrap Up -> AIæ€»ç»“ -> å›å½’çº¿ä¸Š -> å…³æ‰å¼€å…³
      async function finishOfflineMode(msgId, linkedPostId, btnElement) {
        // if (!confirm('Wrap up the offline date and return to chat?')) return;

        // Loading çŠ¶æ€
        const originalText = btnElement.innerHTML;
        btnElement.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Wrapping...';
        btnElement.disabled = true;

        try {
          // A. è·å–åˆšæ‰ç”Ÿæˆçš„çº¿ä¸‹å‰§æœ¬
          const post = await db.idea_posts.get(Number(linkedPostId));
          if (!post) throw new Error('Scenario not found');

          const char = dbCharacters.find(c => c.id === currentChatCharId);

          // B. å‡†å¤‡ Prompt (æ€»ç»“è¿‡æ¸¡)
          // B. å‡†å¤‡ Prompt (è¯¦ç»†å‰§æƒ…å¤ç›˜ + è¿‡æ¸¡)
          // âœ¨ [ä¿®æ”¹] æç¤ºè¯ä¼˜åŒ–ï¼šè¦æ±‚è¯¦ç»†æ€»ç»“å…³é”®èŠ‚ç‚¹å’Œååº”ï¼Œè€Œéç®€å•æ¦‚æ‹¬
          const promptText = `
        You are an expert story summarizer. 
        The user and character (${char.name}) just finished an offline date/scenario.
        
        SCENARIO CONTENT: 
        "${post.content}"
        
        TASK: 
        Generate a "Detailed Narrative Recap" of this scenario in Simplified Chinese.
        
        REQUIREMENTS:
        1. **Key Event Nodes**: Do NOT over-simplify. You must describe the specific key events (climax, touching moments, conflicts) that happened.
        2. **Reactions & Emotions**: For each key event, explicitly describe how ${char.name} and the User reacted (their feelings, facial expressions, or key dialogue actions). 
        3. **Narrative Style**: Write in a third-person, descriptive tone (like a novel summary or a memory log). It should be immersive, not a bullet list.
        4. **Ending Transition**: Conclude the summary by stating that the event has ended and they have separated, setting the stage for them to resume chatting on their phones.
        
        OUTPUT FORMAT:
        [Summary of the date details...]
        (End with a clear transition to online chat context)
        `;

          //console.log(promptText);

          const cfg = appData[appData.activeSlot];
          const res = await fetch(cfg.url + '/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${cfg.key}`,
            },
            body: JSON.stringify({
              model: cfg.model,
              messages: [
                {
                  role: 'user',
                  content: promptText,
                },
              ],
            }),
          });

          const data = await res.json();
          const summaryMsg = data.choices[0].message.content;
          //console.log(summaryMsg);

          // ==========================================
          // ğŸ’¾ [æ–°å¢] å°†æ€»ç»“ä¿å­˜åˆ°æ•°æ®åº“ post ä¸­
          // ==========================================
          // è¿™æ ·ä»¥åè¯»å–å†å²è®°å½•æ—¶ï¼Œå°±èƒ½ç›´æ¥è¯»è¿™ä¸ªæ€»ç»“ï¼Œè€Œä¸ç”¨å‘é•¿å‰§æœ¬äº†
          if (linkedPostId) {
            await db.idea_posts.update(Number(linkedPostId), {
              summary: summaryMsg,
            });
          }

          // C. å‘é€æ€»ç»“æ¶ˆæ¯
          // 1. å‘é€ç³»ç»Ÿæ€»ç»“ (ä½œä¸ºæ—ç™½/è®°å¿†)
          await handleSendMessage('text', `[System: Offline Scenario Recap]\n${summaryMsg}`, 'ai_passive');

          // D. å…³æ‰å¼€å…³
          const switchEl = document.getElementById('setting-offline-mode');
          if (switchEl) {
            switchEl.checked = false;
            // âœ… è®°å¾—æ›´æ–°æœ¬åœ°å­˜å‚¨ï¼Œå¦åˆ™åˆ·æ–°é¡µé¢å¼€å…³åˆå¼€äº†
            if (currentChatCharId) {
              localStorage.setItem('offline_mode_' + currentChatCharId, 'false');
            }
          }

          // E. âœ… [æ–°å¢] ä¿®æ”¹æŒ‰é’®æ–‡å­—ä¸º Finished
          if (btnElement) {
            btnElement.innerHTML = '<i class="fa-solid fa-check"></i> Finished';
            // btnElement.disabled = true; // å¦‚æœä½ æƒ³è®©å®ƒå˜ç°ä¸å¯ç‚¹ï¼Œå¯ä»¥è§£å¼€è¿™ä¸€è¡Œ
            btnElement.classList.remove('action'); // å»æ‰æ·±è‰²èƒŒæ™¯ï¼Œå˜ä¸ºæ™®é€šæŒ‰é’®æ ·å¼
            btnElement.style.opacity = '0.7';
          }

          // æç¤ºæˆåŠŸ (å¯é€‰)
          // alert('Offline mode wrapped up!');
        } catch (e) {
          console.error(e);
          alert('Wrap up failed: ' + e.message);
          // å¤±è´¥æ¢å¤
          btnElement.innerHTML = originalText;
          btnElement.disabled = false;
        }
      }

      // è¾…åŠ©ï¼šæ‰“å¼€å…³è”çš„å¸–å­
      async function openLinkedOfflinePost(id) {
        if (!id || id === 'null') return;
        const post = await db.idea_posts.get(Number(id));
        if (post) openPreview(post);
      }

      // ================= åˆå§‹åŒ–åŠ è½½é€»è¾‘å¢å¼º =================
      // ä¿®æ”¹ initApp æˆ– loadHistoryï¼Œç¡®ä¿åŠ è½½æ—¶æŠŠçº¿ä¸‹å¸–å­æ”¾åˆ°æ­£ç¡®çš„ Grid
      const originalLoadHistory = loadHistory;
      // ================= [ä¿®æ”¹] åŠ è½½å†å²è®°å½• (ä¿®å¤çº¿ä¸‹å¸–å­æ’åº) =================
      loadHistory = async function () {
        const gridAll = document.getElementById('grid-all');
        const gridOffline = document.getElementById('grid-offline');
        const offlineHeader = document.getElementById('offline-section-header');

        // æ¸…ç©ºç°æœ‰å†…å®¹
        if (gridAll) gridAll.innerHTML = '';
        if (gridOffline) gridOffline.innerHTML = '';

        try {
          // 1. è·å–æ‰€æœ‰å¸–å­ï¼Œå¹¶æŒ‰æ—¶é—´å€’åºæ’åˆ— (Newest -> Oldest)
          const posts = await db.idea_posts.orderBy('timestamp').reverse().toArray();

          let hasOffline = false;

          // 2. éå†å¹¶æ¸²æŸ“åˆ°å¯¹åº”çš„å®¹å™¨
          for (const p of posts) {
            if (p.isOffline) {
              // æ¸²æŸ“åˆ°ã€çº¿ä¸‹å›å¿†ã€‘åŒºåŸŸ
              // å› ä¸º posts å·²ç»æ˜¯å€’åºçš„ï¼Œè¿™é‡Œç›´æ¥ appendChild å°±èƒ½ä¿æŒæœ€æ–°çš„åœ¨æœ€ä¸Šé¢
              renderCard(p, 'grid-offline', false);
              hasOffline = true;
            } else {
              // æ¸²æŸ“åˆ°ã€å…¨éƒ¨å†å²ã€‘åŒºåŸŸ
              renderCard(p, 'grid-all', false);
            }
          }

          // 3. æ§åˆ¶æ ‡é¢˜æ˜¾ç¤º
          if (offlineHeader) {
            offlineHeader.style.display = hasOffline ? 'flex' : 'none';
          }
        } catch (e) {
          console.error('Load History Error:', e);
        }
      };

      // ================= ğŸ› ï¸ [è¾…åŠ©å‡½æ•°] è·å–å¸¦å‰§æƒ…æ›¿æ¢çš„å†å²è®°å½• (ä¿®æ­£ç‰ˆ) =================
      async function fetchHistoryWithOfflineReplacements(charId, limit = 20) {
        // 1. è·å–åŸå§‹è®°å½• (å€’åºå–æœ€æ–°)
        let query = db.chat_messages.where('charId').equals(charId).reverse();
        if (limit > 0) query = query.limit(limit);

        const rawHistory = await query.toArray();

        // 2. è½¬å›æ­£åº
        rawHistory.reverse();

        // 3. å¹¶è¡Œå¤„ç†æ›¿æ¢é€»è¾‘
        const processedMessages = await Promise.all(
          rawHistory.map(async msg => {
            // å¤åˆ¶ä¸€ä»½ï¼Œé¿å…ä¿®æ”¹åŸå¯¹è±¡
            let finalMsg = { ...msg };
            let finalContent = finalMsg.content;

            // ğŸŸ¢ [æ ¸å¿ƒ] å¤„ç† Offline Card
            if (msg.type === 'offline_card') {
              try {
                // æ ¼å¼: Status|Image|PostId
                const parts = finalContent.split('|');
                const status = parts[0]; // 'Finished' æˆ–å…¶ä»–
                const postId = Number(parts[2]);

                if (postId) {
                  const post = await db.idea_posts.get(postId);
                  if (post) {
                    // ====================================================
                    // ğŸ‘‰ [ä¿®æ”¹] å¢å¼ºæç¤ºè¯é€»è¾‘ï¼šé¦–å°¾åŒ…è£¹ï¼Œæ˜ç¡®çŠ¶æ€
                    // ====================================================

                    if (status === 'Finished') {
                      // âœ… æƒ…å†µ A: å·²ç»æ€é’ (Finished)
                      // ç›®æ ‡ï¼šå‘Šè¯‰ AI è¿™æ®µæ˜¯å›å¿†ï¼Œç°åœ¨è¦åˆ‡å›æ‰‹æœºèŠå¤© (Transition to Online)

                      const headerPrompt = `(System: [Memory Recall] The following is the content of the offline meeting that has just concluded. The characters have separated.)`;

                      const footerPrompt = `(System: ğŸ›‘ SCENARIO ENDED. The offline date is over. The characters are now back to using their phones. Please transition naturally to online chatting based on the mood above.)`;

                      if (post.summary) {
                        // 1. ä¼˜å…ˆä½¿ç”¨ç²¾ç®€æ€»ç»“
                        finalContent = `${headerPrompt}\n[Scenario Summary]:\n"${post.summary}"\n${footerPrompt}`;
                      } else {
                        // 2. å…¼å®¹æ—§æ•°æ® (ä½¿ç”¨å®Œæ•´å†…å®¹)
                        finalContent = `${headerPrompt}\n[Scenario Log]:\n"${post.content}"\n${footerPrompt}`;
                      }
                    } else {
                      // âœ… æƒ…å†µ B: æœªæ€é’/è¿›è¡Œä¸­ (Ongoing)
                      // ç›®æ ‡ï¼šå‘Šè¯‰ AI æ­£åœ¨é¢å¯¹é¢æ¼”è¿™æ®µæˆ

                      finalContent = `(System: [Current Mode: Offline Scenario] The user and character are currently meeting face-to-face. Enact the following script.)\n[Title: ${post.title}]\n${post.content}\n(System: Continue the roleplay within this offline scenario.)`;
                    }
                  }
                }
              } catch (e) {
                console.warn('History replacement error:', e);
                // å‡ºé”™æ—¶ä¿æŒåŸæ ·æˆ–ç»™ä¸ªæç¤ºï¼Œä¸è¦è®©ç¨‹åºå´©äº†
                finalContent = '[System: Offline content unavailable]';
              }
            }

            // ğŸ”µ å…¶ä»–ç±»å‹å¤„ç† (å›¾ç‰‡/è¯­éŸ³ç­‰)
            else if (msg.type === 'image') finalContent = '[Photo sent]';
            else if (msg.type === 'emoji') finalContent = '[Sticker sent]';
            else if (msg.type === 'voice') finalContent = '[Voice message sent]';
            else if (msg.type === 'transfer') finalContent = `[Transfer: ${finalContent}]`;

            // æ›´æ–° content
            finalMsg.content = finalContent;
            return finalMsg;
          }),
        );

        return processedMessages;
      }

      window.onload = initApp;
    </script>
  </body>
</html>
